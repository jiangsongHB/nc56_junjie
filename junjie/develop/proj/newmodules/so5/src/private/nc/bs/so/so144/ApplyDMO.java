/***************************************************************\
 *     The skeleton of this class is generated by an automatic *
 * code generator for NC product.                              *
 \***************************************************************/

package nc.bs.so.so144;

import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.Vector;

import javax.naming.NamingException;

import nc.bs.bank_cvp.formulainterface.RefCompilerBS;
import nc.bs.pub.DataManageObject;
import nc.bs.pub.SystemException;
import nc.bs.pub.pf.ICheckState3;
import nc.bs.pub.pf.IQueryData;
import nc.bs.pub.pf.IQueryData2;
import nc.bs.pub.pf.PfUtilTools;
import nc.bs.scm.plugin.InvokeEventProxy;
import nc.bs.scm.pub.smart.RichDMO;
import nc.bs.scm.pub.smart.SmartDMO;
import nc.bs.so.so142.ReturnpolicyDMO;
import nc.bs.so.so143.ReturnassignDMO;
import nc.impl.scm.so.back.Return2TO;
import nc.itf.scm.so.back.ISOApply;
import nc.itf.scm.so.pub.ICheckValueValidity;
import nc.itf.so.service.ISOToIC_DRP;
import nc.ui.pub.ClientEnvironment;
import nc.ui.pub.bill.BillStatus;
import nc.vo.bank_cvp.compile.datastruct.ArrayValue;
import nc.vo.pub.AggregatedValueObject;
import nc.vo.pub.BusinessException;
import nc.vo.pub.CircularlyAccessibleValueObject;
import nc.vo.pub.VOStatus;
import nc.vo.pub.compiler.PfParameterVO;
import nc.vo.pub.lang.UFBoolean;
import nc.vo.pub.lang.UFDate;
import nc.vo.pub.lang.UFDouble;
import nc.vo.scm.plugin.Action;
import nc.vo.scm.pub.SCMEnv;
import nc.vo.scm.pub.smart.SmartFieldMeta;
import nc.vo.scm.pub.smart.SmartVO;
import nc.vo.so.service.ToRetOrdVO;
import nc.vo.so.so142.ReturnpolicyVO;
import nc.vo.so.so144.ApplyHeaderVO;
import nc.vo.so.so144.ApplyItemVO;
import nc.vo.so.so144.ApplyVO;
import nc.vo.so.so146.TakeVO;
import nc.vo.so.so146.UpdateVO;
import nc.vo.sp.pub.GeneralSqlString;

/**
 * Apply的DMO类。
 * 
 * 创建日期：(2004-3-16)
 * 
 * @author：
 */
public class ApplyDMO extends DataManageObject implements IQueryData,
		IQueryData2, ICheckState3, ISOApply, nc.bs.pub.pf.IBackCheckState,nc.itf.scm.so.back.IISReferred {
	/**
	 * ApplyDMO 构造子注解。
	 * 
	 * @exception javax.naming.NamingException
	 *                父类构造子抛出的异常。
	 * @exception nc.bs.pub.SystemException
	 *                父类构造子抛出的异常。
	 */
	public ApplyDMO() throws javax.naming.NamingException, SystemException {
		super();
		// int i=0
	}

	/**
	 * ApplyDMO 构造子注解。
	 * 
	 * @param dbName
	 *            java.lang.String 在EJB Server中配置的数据库DataSource名称。
	 * @exception javax.naming.NamingException
	 *                父类构造子抛出的异常。
	 * @exception nc.bs.pub.SystemException
	 *                父类构造子抛出的异常。
	 */
	public ApplyDMO(String dbName) throws javax.naming.NamingException,
			SystemException {
		super(dbName);
	}
	/**
	 * @param sBids
	 * @return
	 * @throws Exception
	 */
	public ApplyItemVO[] queryApplyItemByUpsrcbids(String[] sBids) throws Exception {

		nc.impl.scm.so.so146.RichDMO dmo = new nc.impl.scm.so.so146.RichDMO();
		/*
		 * 修改：蒲强华
		 * 日期：2008-11-26
		 * 原因：根据最上游单据id查询应该用字段"cfirstbillbid"，不能用"csourcebillbodyid"
		 *       "csourcebillbodyid"只是上游单据id，并不是最上游
		 */
//		return (ApplyItemVO[]) dmo.queryVosByWhere(" 1=1 "+GeneralSqlString.formInSQL("csourcebillbodyid", sBids), ApplyItemVO.class);
		return (ApplyItemVO[]) dmo.queryVosByWhere(" 1=1 "+GeneralSqlString.formInSQL("cfirstbillbid", sBids), ApplyItemVO.class);
	}
	/**
	 * <p>
	 * 根据表头的主键查询一个VO。
	 * <p>
	 * 创建日期：(2004-3-16)
	 * 
	 * @param key
	 *            ??dbFieldType??
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyVO findByPrimaryKey(String key) throws Exception {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "findByPrimaryKey",
				new Object[] { key });
		/** ********************************************************** */
		ApplyVO vo = new ApplyVO();
		//
		ApplyHeaderVO header = findHeaderByPrimaryKey(key);
		ApplyItemVO[] items = null;
		if (header != null) {
			items = findItemsForHeader(header.getPk_apply());
			if (items != null && items.length > 0) {
				header.setCcalbodyid(items[0].getCcalbodyid());
				header.setCwarehouseid(items[0].getCbodywarehouseid());
        header.setCconsigncorpid(items[0].getCconsigncorpid());
				header.setCreceiptcustomerid(items[0].getCreceiptcorpid());
				header.setVreceiveaddress(items[0].getVreceiveaddress());
				header.setCcurrencytypeid(items[0].getCcurrencytypeid());
				header.setNdiscountrate(items[0].getNdiscountrate());
				header.setNtaxrate(items[0].getNtaxrate());
//				header.setNexchangeotoarate(items[0].getNexchangeotoarate());
				header.setNexchangeotobrate(items[0].getNexchangeotobrate());
			}
		}
		//
		vo.setParentVO(header);
		vo.setChildrenVO(items);
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "findByPrimaryKey",
				new Object[] { key });
		/** ********************************************************** */
		return vo;
	}

	/**
	 * 通过主键查找一个表头VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyHeaderVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyHeaderVO findHeaderByPrimaryKey(String key) throws Exception {

		if (key == null)
			return null;

		nc.bs.scm.pub.smart.RichDMO dmo = new nc.bs.scm.pub.smart.RichDMO();

		String wheresql = " pk_apply = '" + key + "' ";

		nc.vo.scm.pub.smart.SmartVO[] svo = dmo.selectBy(ApplyHeaderVO.class,
				null, wheresql);

		if ((svo != null) && (svo.length == 1)) {
			return (ApplyHeaderVO) svo[0];
		}
		return null;

	}

	/**
	 * 通过主键查找一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyItemVO findItemByPrimaryKey(String key) throws Exception {

		nc.bs.scm.pub.smart.RichDMO dmo = new nc.bs.scm.pub.smart.RichDMO();

		String wheresql = " pk_apply_b = '" + key + "' ";

		nc.vo.scm.pub.smart.SmartVO[] svo = dmo.selectBy(ApplyItemVO.class,
				null, wheresql);

		if ((svo != null) && (svo.length == 1)) {
			return (ApplyItemVO) svo[0];
		}
		return null;

	}

	/**
	 * 通过主键查找一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyItemVO[] findItemsForHeader(String pks) throws SQLException {

		if ((pks == null) || (pks.trim().equals("")))
			return null;

		ApplyItemVO[] apvos = null;
		try {
			nc.bs.scm.pub.smart.RichDMO dmo = new nc.bs.scm.pub.smart.RichDMO();

			String wheresql = " pk_apply ='" + pks.trim() + "' ";

			nc.vo.scm.pub.smart.SmartVO[] svo = dmo.selectBy(ApplyItemVO.class,
					null, wheresql);
			if (svo == null)
				return null;

			apvos = new ApplyItemVO[svo.length];
			for (int i = 0; i < svo.length; i++) {
				apvos[i] = (ApplyItemVO) svo[i];
			}
		} catch (Exception e) {
			if (e instanceof SQLException)
				throw (SQLException) e;
			throw new SQLException(nc.bs.ml.NCLangResOnserver.getInstance()
					.getStrByID("400630", "UPP400630-000276")/* @res "查询表体有误" */
					+ "--[" + e.getMessage() + "]");
		}

		return apvos;

	}

	/**
	 * 向数据库插入一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param node
	 *            nc.vo.so.so144.ApplyHeaderVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public String insertHeader(ApplyHeaderVO applyHeader)
			throws java.sql.SQLException, nc.bs.pub.SystemException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "insertHeader",
				new Object[] { applyHeader });
		/** ********************************************************** */
		String sPk = null;
		try {
			applyHeader.setStatus(VOStatus.NEW);
			applyHeader.setPrimaryKey(getOID());
			SmartDMO rdmo = new SmartDMO();
			rdmo.maintain(applyHeader);
			sPk = (String) applyHeader.getPrimaryKey();

		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			if (e instanceof SQLException) {
				throw (SQLException) e;
			} else if (e instanceof nc.bs.pub.SystemException) {
				throw (nc.bs.pub.SystemException) e;
			} else
				throw new SQLException(e.getMessage());
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "insertHeader",
				new Object[] { applyHeader });
		/** ********************************************************** */
		return sPk;
	}
	
	private Hashtable queryTotalBalanceMny(String[] ids)
	   throws java.sql.SQLException, SystemException, NamingException {
	 
	  
	  StringBuffer sql = new StringBuffer();
	  sql.append(" select fb.cksqsh , sum ( fb.jfbbje ) AS ntotalbalancemny ");
	  sql.append(" from arap_djzb zb ,  ");
	  sql.append("  arap_djfb fb  ");
	  sql.append(" WHERE zb.djdl = 'ys'  and ph = '3U' ");
	  sql.append(" and zb.lybz = 3 ");
	  sql.append(" and fb.dr = 0 and zb.dr = 0 and  zb.vouchid = fb.vouchid ");
	  sql.append(" and  fb.cksqsh in ");
	  sql.append(GeneralSqlString.formSubSql("fb.cksqsh", ids));
	  sql.append(" GROUP BY fb.cksqsh ");  
	  SmartDMO sdmo = new SmartDMO();
	  
	  Object[] o = sdmo.selectBy2(sql.toString());
	  Hashtable table = new Hashtable();
	  if(o!=null && o.length>0)
	  {
	   for (int i = 0; i < o.length; i++) {
	    Object[] onerow = (Object[])o[i];
	    if(onerow!=null && onerow.length>0)
	    {
	     table.put(onerow[0],onerow[1]);
	    }
	   }
	  }
	  return table;
	 
	 }

	/**
	 * 销售结算回写退货申请单--接口
	 * 
	 * @param sIds
	 *            申请单表体ID
	 * @param ntotalbalancenumbers
	 *            累计收入结算数量
	 * @param ntotlbalcostnums
	 *            累计成本结算数量
	 * @param ntalbalancemnys
	 *            累计收入结算金额
	 */
	public void reWriteTotalBal(String[] sIds, UFDouble[] ntotalbalancenumbers,
      UFDouble[] ntotlbalcostnums, UFDouble[] ntalbalancemnys, UFDouble[] nrushnums)
			throws BusinessException {
    if (sIds == null || ntotalbalancenumbers == null
        || ntotlbalcostnums == null || ntalbalancemnys == null || nrushnums == null
        || sIds.length == 0) {
      throw new BusinessException(nc.bs.ml.NCLangResOnserver
          .getInstance().getStrByID("400630", "UPP400630-000277")/*
                                       * @res
                                       * "回写退货数据不能为空"
                                       */);
    }
    int iLen = sIds.length;
    if (ntotalbalancenumbers.length != iLen
        || ntotlbalcostnums.length != iLen
        || ntalbalancemnys.length != iLen
        || nrushnums.length != iLen)
      throw new BusinessException(nc.bs.ml.NCLangResOnserver
          .getInstance().getStrByID("400630", "UPP400630-000278")/*
                                       * @res
                                       * "回写数据非法！数组长度不一致"
                                     */);
    try { 
    Hashtable balMny = queryTotalBalanceMny(sIds);
    String sql = "update so_apply_b set ntotalbalancenumber= isnull(ntotalbalancenumber,0) + ?,ntotlbalcostnum=isnull(ntotlbalcostnum,0)+? ,"
        + "ntalbalancemny= isnull(ntalbalancemny,0) + ?, nrushnum = isnull(nrushnum,0) + ? where pk_apply_b=? ";

    ArrayList alValues = new ArrayList();
    ArrayList alType = new ArrayList();
    ArrayList al = null;
    for (int i = 0; i < iLen; i++) {
      al = new ArrayList();
      al.add(ntotalbalancenumbers[i] == null ? new UFDouble(0)
          : ntotalbalancenumbers[i].multiply(-1));
      al.add(ntotlbalcostnums[i] == null ? new UFDouble(0)
          : ntotlbalcostnums[i].multiply(-1));
//      al.add(CreditUtil.convertObjToUFDouble(balMny.get(sIds[i])));
      al.add(ntalbalancemnys[i] == null ? new UFDouble(0): ntalbalancemnys[i].multiply(-1));
      al.add(nrushnums[i] == null ? new UFDouble(0)
      : nrushnums[i].multiply(-1));
      al.add(sIds[i]);
      alValues.add(al);
    }
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
    
      RichDMO dmo = new RichDMO();
      dmo.executeUpdateBatch(sql, alValues, alType);
    } catch (Exception e) {
      throw new BusinessException(e);
    }

  }

	/**
	 * 向数据库插入一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param node
	 *            nc.vo.so.so144.ApplyItemVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public String insertItem(ApplyItemVO applyItem)
			throws java.sql.SQLException, nc.bs.pub.SystemException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "insertItem",
				new Object[] { applyItem });
		/** ********************************************************** */
		String sPk = null;
		try {
			applyItem.setStatus(VOStatus.NEW);
			SmartDMO rdmo = new SmartDMO();
			rdmo.maintain(applyItem);
			sPk = (String) applyItem.getPrimaryKey();

		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			if (e instanceof SQLException) {
				throw (SQLException) e;
			} else if (e instanceof nc.bs.pub.SystemException) {
				throw (nc.bs.pub.SystemException) e;
			} else
				throw new SQLException(e.getMessage());
		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "insertItem",
				new Object[] { applyItem });
		/** ********************************************************** */
		return sPk;
	}

	/**
	 * <p>
	 * 向数据库插入一个VO对象。
	 * <p>
	 * 创建日期：(2004-3-16)
	 * 
	 * @param ApplyItem
	 *            nc.vo.so.so144.ApplyItemVO
	 * @param foreignKey
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public String insertItem(ApplyItemVO applyItem, String foreignKey)
			throws java.sql.SQLException, nc.bs.pub.SystemException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "insertItem", new Object[] {
				applyItem, foreignKey });
		/** ********************************************************** */

		applyItem.setPk_apply(foreignKey);
		String key = insertItem(applyItem);

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "insertItem", new Object[] {
				applyItem, foreignKey });
		/** ********************************************************** */

		return key;
	}

	/**
	 * <p>
	 * 删除母子表的所有内容。
	 * <p>
	 * 创建日期：(2004-3-16)
	 * 
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void delete(ApplyVO vo) throws Exception {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "delete",
				new Object[] { vo });
		/** ********************************************************** */

		ApplyItemVO[] items = (ApplyItemVO[]) vo.getChildrenVO();
		ApplyHeaderVO head = (ApplyHeaderVO) vo.getParentVO();

		ApplyItemVO[] oldItems = findItemsForHeader(head.getPrimaryKey());
		HashMap hash = new HashMap();
		for (int i = 0; i < oldItems.length; i++) {
			hash.put(oldItems[i].getPk_apply_b(), oldItems);
		}
		UpdateVO update = null;
		ApplyItemVO oldItem = null;

		Vector vecTemp = new Vector();
		for (int i = 0; i < items.length; i++) {
			oldItem = (ApplyItemVO) hash.get(items[i].getPk_apply_b());

			if (isTimeStampChanged(items[i], oldItem))
				throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
						.getStrByID("400630", "UPP400630-000256")/*
																	 * @res
																	 * "记录已经发生修改！请刷新后重做！"
																	 */);

			update = null;
			items[i].setStatus(VOStatus.DELETED);
			update = getUpdateVO(oldItem, items[i]);
			if (update != null)
				vecTemp.addElement(update);
		}
		if (vecTemp.size() > 0) {
			UpdateVO[] vos = new UpdateVO[vecTemp.size()];
			vecTemp.toArray(vos);
			callBackSaleOrder(vos);
		}

		deleteItemsForHeader(head.getPk_apply());
		deleteHeader(head);
		InvokeEventProxy pluginProxy=new InvokeEventProxy("so5","3U");
		if(pluginProxy!=null)
			pluginProxy.afterAction(Action.DELETE,new AggregatedValueObject[]{ vo}, null);

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "delete",
				new Object[] { vo });
		/** ********************************************************** */
	}

	/**
	 * 根据主键在数据库中删除一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param key
	 *            nc.vo.pub.oid.OID
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void deleteHeader(ApplyHeaderVO vo) throws java.sql.SQLException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "deleteHeader",
				new Object[] { vo });
		/** ********************************************************** */

		String sql = "delete from so_apply where pk_apply = ?";

		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			stmt.setString(1, vo.getPk_apply());
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "deleteHeader",
				new Object[] { vo });
		/** ********************************************************** */
	}

	/**
	 * 根据主键在数据库中删除一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param key
	 *            nc.vo.pub.oid.OID
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void deleteItem(ApplyItemVO vo) throws java.sql.SQLException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "deleteItem",
				new Object[] { vo });
		/** ********************************************************** */

		String sql = "delete from so_apply_b where pk_apply_b = ?";

		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			stmt.setString(1, vo.getPk_apply_b());
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "deleteItem",
				new Object[] { vo });
		/** ********************************************************** */
	}

	/**
	 * 根据主键在数据库中删除一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param key
	 *            nc.vo.pub.oid.OID
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void deleteItemsForHeader(String headerKey)
			throws java.sql.SQLException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "deleteItemsForHeader",
				new Object[] { headerKey });
		/** ********************************************************** */

		String sql = "delete from so_apply_b where pk_apply = ?";

		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			stmt.setString(1, headerKey);
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "deleteItemsForHeader",
				new Object[] { headerKey });
		/** ********************************************************** */
	}

	/**
	 * 用一个VO对象的属性更新数据库中的值。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param applyHeader
	 *            nc.vo.so.so144.ApplyHeaderVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void updateHeader(ApplyHeaderVO applyHeader)
			throws java.sql.SQLException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "updateHeader",
				new Object[] { applyHeader });
		/** ********************************************************** */
		try{
			SmartDMO dmo=new SmartDMO();
			applyHeader.setStatus(SmartVO.ACTION_UPDATE);
			dmo.maintain(applyHeader);
			
		}catch(Exception e){
			SCMEnv.error(e);
		}

//		String sql = "update so_apply set vreceiptcode = ?, dbilldate = ?, pk_corp = ?, csalecorpid = ?, cbiztype = ?, ccustomerid = ?, cdeptid = ?, cemployeeid = ?, creceiptcorpid = ?, ctransmodeid = ?, coperatorid = ?, dmakedate = ?, capproveid = ?, dapprovedate = ?, fstatus = ?, vsourcecode = ?, csourcetype = ?, vdef1 = ?, vdef2 = ?, vdef3 = ?, vdef4 = ?, vdef5 = ?,vdef6 = ?,vdef7 = ?,vdef8 = ?,vdef9 = ?,vdef10 = ?, nreturnfee = ?, pk_returnreason = ?, bcheckbill = ?, vnote = ?, creceipttype = ?, bbillfinish = ?, dr = ? where pk_apply = ?";
//
//		Connection con = null;
//		PreparedStatement stmt = null;
//		try {
//			con = getConnection();
//			stmt = con.prepareStatement(sql);
//			// update non PK fields:
//			if (applyHeader.getVreceiptcode() == null) {
//				stmt.setNull(1, Types.CHAR);
//			} else {
//				stmt.setString(1, applyHeader.getVreceiptcode());
//			}
//			if (applyHeader.getDbilldate() == null) {
//				stmt.setNull(2, Types.CHAR);
//			} else {
//				stmt.setString(2, applyHeader.getDbilldate().toString());
//			}
//			if (applyHeader.getPk_corp() == null) {
//				stmt.setNull(3, Types.CHAR);
//			} else {
//				stmt.setString(3, applyHeader.getPk_corp());
//			}
//			if (applyHeader.getCsalecorpid() == null) {
//				stmt.setNull(4, Types.CHAR);
//			} else {
//				stmt.setString(4, applyHeader.getCsalecorpid());
//			}
//			if (applyHeader.getCbiztype() == null) {
//				stmt.setNull(5, Types.CHAR);
//			} else {
//				stmt.setString(5, applyHeader.getCbiztype());
//			}
//			if (applyHeader.getCcustomerid() == null) {
//				stmt.setNull(6, Types.CHAR);
//			} else {
//				stmt.setString(6, applyHeader.getCcustomerid());
//			}
//			if (applyHeader.getCdeptid() == null) {
//				stmt.setNull(7, Types.CHAR);
//			} else {
//				stmt.setString(7, applyHeader.getCdeptid());
//			}
//			if (applyHeader.getCemployeeid() == null) {
//				stmt.setNull(8, Types.CHAR);
//			} else {
//				stmt.setString(8, applyHeader.getCemployeeid());
//			}
//			if (applyHeader.getCreceiptcorpid() == null) {
//				stmt.setNull(9, Types.CHAR);
//			} else {
//				stmt.setString(9, applyHeader.getCreceiptcorpid());
//			}
//			if (applyHeader.getCtransmodeid() == null) {
//				stmt.setNull(10, Types.CHAR);
//			} else {
//				stmt.setString(10, applyHeader.getCtransmodeid());
//			}
//			if (applyHeader.getCoperatorid() == null) {
//				stmt.setNull(11, Types.CHAR);
//			} else {
//				stmt.setString(11, applyHeader.getCoperatorid());
//			}
//			if (applyHeader.getDmakedate() == null) {
//				stmt.setNull(12, Types.CHAR);
//			} else {
//				stmt.setString(12, applyHeader.getDmakedate().toString());
//			}
//			if (applyHeader.getCapproveid() == null) {
//				stmt.setNull(13, Types.CHAR);
//			} else {
//				stmt.setString(13, applyHeader.getCapproveid());
//			}
//			if (applyHeader.getDapprovedate() == null) {
//				stmt.setNull(14, Types.CHAR);
//			} else {
//				stmt.setString(14, applyHeader.getDapprovedate().toString());
//			}
//			if (applyHeader.getFstatus() == null) {
//				stmt.setNull(15, Types.INTEGER);
//			} else {
//				stmt.setInt(15, applyHeader.getFstatus().intValue());
//			}
//			if (applyHeader.getVsourcecode() == null) {
//				stmt.setNull(16, Types.CHAR);
//			} else {
//				stmt.setString(16, applyHeader.getVsourcecode());
//			}
//			if (applyHeader.getCsourcetype() == null) {
//				stmt.setNull(17, Types.CHAR);
//			} else {
//				stmt.setString(17, applyHeader.getCsourcetype());
//			}
//			if (applyHeader.getVdef1() == null) {
//				stmt.setNull(18, Types.CHAR);
//			} else {
//				stmt.setString(18, applyHeader.getVdef1());
//			}
//			if (applyHeader.getVdef2() == null) {
//				stmt.setNull(19, Types.CHAR);
//			} else {
//				stmt.setString(19, applyHeader.getVdef2());
//			}
//			if (applyHeader.getVdef3() == null) {
//				stmt.setNull(20, Types.CHAR);
//			} else {
//				stmt.setString(20, applyHeader.getVdef3());
//			}
//			if (applyHeader.getVdef4() == null) {
//				stmt.setNull(21, Types.CHAR);
//			} else {
//				stmt.setString(21, applyHeader.getVdef4());
//			}
//			if (applyHeader.getVdef5() == null) {
//				stmt.setNull(22, Types.CHAR);
//			} else {
//				stmt.setString(22, applyHeader.getVdef5());
//			}
//			if (applyHeader.getVdef6() == null) {
//				stmt.setNull(23, Types.CHAR);
//			} else {
//				stmt.setString(23, applyHeader.getVdef6());
//			}
//			if (applyHeader.getVdef7() == null) {
//				stmt.setNull(24, Types.CHAR);
//			} else {
//				stmt.setString(24, applyHeader.getVdef7());
//			}
//			if (applyHeader.getVdef8() == null) {
//				stmt.setNull(25, Types.CHAR);
//			} else {
//				stmt.setString(25, applyHeader.getVdef8());
//			}
//			if (applyHeader.getVdef9() == null) {
//				stmt.setNull(26, Types.CHAR);
//			} else {
//				stmt.setString(26, applyHeader.getVdef9());
//			}
//			if (applyHeader.getVdef10() == null) {
//				stmt.setNull(27, Types.CHAR);
//			} else {
//				stmt.setString(27, applyHeader.getVdef10());
//			}
//
//			if (applyHeader.getNreturnfee() == null) {
//				stmt.setNull(28, Types.INTEGER);
//			} else {
//				stmt.setBigDecimal(28, applyHeader.getNreturnfee()
//						.toBigDecimal());
//			}
//			if (applyHeader.getPk_returnreason() == null) {
//				stmt.setNull(29, Types.CHAR);
//			} else {
//				stmt.setString(29, applyHeader.getPk_returnreason());
//			}
//			if (applyHeader.getBcheckbill() == null) {
//				stmt.setNull(30, Types.CHAR);
//			} else {
//				stmt.setString(30, applyHeader.getBcheckbill().toString());
//			}
//			if (applyHeader.getVnote() == null) {
//				stmt.setNull(31, Types.CHAR);
//			} else {
//				stmt.setString(31, applyHeader.getVnote());
//			}
//			if (applyHeader.getCreceipttype() == null) {
//				stmt.setNull(32, Types.CHAR);
//			} else {
//				stmt.setString(32, applyHeader.getCreceipttype());
//			}
//			if (applyHeader.getBbillfinish() == null) {
//				stmt.setNull(33, Types.CHAR);
//			} else {
//				stmt.setString(33, applyHeader.getBbillfinish().toString());
//			}
//			if (applyHeader.getDr() == null) {
//				stmt.setNull(34, Types.INTEGER);
//			} else {
//				stmt.setInt(34, applyHeader.getDr().intValue());
//			}
//			// find record by PK fields:
//			stmt.setString(35, applyHeader.getPk_apply());
//			//
//			stmt.executeUpdate();
//		} finally {
//			try {
//				if (stmt != null) {
//					stmt.close();
//				}
//			} catch (Exception e) {
//			}
//			try {
//				if (con != null) {
//					con.close();
//				}
//			} catch (Exception e) {
//			}
//		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "updateHeader",
				new Object[] { applyHeader });
		/** ********************************************************** */
	}

	/**
	 * 用一个VO对象的属性更新数据库中的值。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param applyItem
	 *            nc.vo.so.so144.ApplyItemVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void updateItem(ApplyItemVO applyItem) throws java.sql.SQLException {
		updateItem(new ApplyItemVO[] { applyItem });
	}

	/**
	 * 通过主键查找一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyHeaderVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyHeaderVO[] findHeaderByPrimaryKeys(String[] pks)
			throws Exception {

		if ((pks == null) || (pks.length == 0))
			return null;

		ApplyHeaderVO[] apvos = null;

		nc.bs.scm.pub.smart.RichDMO dmo = new nc.bs.scm.pub.smart.RichDMO();

		nc.bs.scm.pub.TempTableDMO tdmo = new nc.bs.scm.pub.TempTableDMO();

		String tempsql = tdmo.insertTempTable(pks, "temp_soreturn_formsq004",
				"pk_apply", "varchar(20)");

		String wheresql = " pk_apply in " + tempsql;

		nc.vo.scm.pub.smart.SmartVO[] svo = dmo.selectBy(ApplyHeaderVO.class,
				null, wheresql);
		if (svo == null)
			return null;

		apvos = new ApplyHeaderVO[svo.length];
		for (int i = 0; i < svo.length; i++) {
			apvos[i] = (ApplyHeaderVO) svo[i];
		}

		return apvos;
	}

	private String[] getAssignedPolicy(String strPk_Corp,
			String strPk_InvManDoc, String strPk_CustManDoc) throws Exception {
		ReturnassignDMO assignDMO = new ReturnassignDMO();
		return assignDMO.getAssignedPolicy(strPk_Corp, strPk_InvManDoc,
				strPk_CustManDoc);
	}

	/**
	 * 此处插入方法说明。 创建日期：(2003-11-25 15:03:39)
	 * 
	 * @return java.lang.String
	 * @param pk_corp
	 *            java.lang.String
	 */
	public String getOID(String pk_corp) {
		return super.getOID(pk_corp);
	}

	private String getStateDesc(int iState) {
		String strState = null;
		switch (iState) {
		case BillStatus.FREE:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"SCMCOMMON", "UPPSCMCommon-000340")/* @res "自由" */;
			break;
		case BillStatus.AUDIT:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"common", "UC001-0000027")/* @res "审批" */;
			break;
		case BillStatus.FREEZE:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"common", "UC001-0000030")/* @res "冻结" */;
			break;
		case BillStatus.CLOSE:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"SCMCOMMON", "UPPSCMCommon-000119")/* @res "关闭" */;
			break;
		case BillStatus.BLANKOUT:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"common", "UC001-0000005")/* @res "作废" */;
			break;
		case BillStatus.FINISH:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"SCMCOMMON", "UPPSCMCommon-000128")/* @res "结束" */;
			break;
		case BillStatus.AUDITING:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"SCMCOMMON", "UPPSCMCommon-000320")/* @res "正在审批中" */;
			break;
		case BillStatus.NOPASS:
			strState = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
					"SCMCOMMON", "UPPSCMCommon-000242")/* @res "审批未通过" */;
			break;
		}
		return strState;
	}

	/**
	 * 订单结束管理。
	 * 
	 * 创建日期：(2001-6-14)
	 * 
	 * @param saleexecute
	 *            nc.vo.pub.bill.SaleexecuteVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyVO[] mergeToApplyVO(ApplyItemVO[] vobodys) throws Exception {
		if (vobodys == null || vobodys.length <= 0)
			return null;
		Hashtable hs = new Hashtable();
		Vector vlist = null;
		for (int i = 0; i < vobodys.length; i++) {
			vlist = (Vector) hs.get(vobodys[i].getPk_apply());
			if (vlist != null) {
				vlist.add(vobodys[i]);
			} else {
				vlist = new Vector();
				hs.put(vobodys[i].getPk_apply(), vlist);
				vlist.add(vobodys[i]);
			}
		}
		String[] ids = (String[]) hs.keySet().toArray(new String[0]);
		nc.vo.pub.CircularlyAccessibleValueObject[] hvos = findHeaderByPrimaryKeys(ids);
		if (ids == null || ids.length <= 0)
			return null;
		ApplyVO[] saleorders = new ApplyVO[hvos.length];
		for (int i = 0; i < hvos.length; i++) {
			saleorders[i] = new ApplyVO();
			saleorders[i].setParentVO(hvos[i]);
			vlist = (Vector) hs.get(((ApplyHeaderVO) hvos[i]).getPk_apply());
			if (vlist != null)
				saleorders[i].setChildrenVO((ApplyItemVO[]) vlist
						.toArray(new ApplyItemVO[0]));
			else
				saleorders[i].setChildrenVO(null);
		}
		return saleorders;
	}

	/*
	 * 根排查询条件查VO
	 */
	public ApplyVO[] query(String where) throws Exception {
		ApplyHeaderVO[] headers = (ApplyHeaderVO[]) queryAllHeadData(where);

		// wsy 2004-5-31 增加非空性判断
		if ((headers == null) || (headers.length == 0))
			return null;

		ApplyVO[] apply = new ApplyVO[headers.length];
		for (int i = 0; i < headers.length; i++) {
			apply[i] = new ApplyVO();
			apply[i].setParentVO(headers[i]);
			ApplyItemVO[] items = findItemsForHeader(headers[i].getPk_apply());
			if (items != null && items.length > 0) {
				headers[i].setCcalbodyid(items[0].getCcalbodyid());
				headers[i].setCwarehouseid(items[0].getCbodywarehouseid());
				headers[i].setCreceiptcustomerid(items[0].getCreceiptcorpid());
				headers[i].setCcurrencytypeid(items[0].getCcurrencytypeid());
				headers[i].setNdiscountrate(items[0].getNdiscountrate());
				headers[i].setNtaxrate(items[0].getNtaxrate());
//				headers[i]
//						.setNexchangeotoarate(items[0].getNexchangeotoarate());
				headers[i]
						.setNexchangeotobrate(items[0].getNexchangeotobrate());
			}
			apply[i].setChildrenVO((CircularlyAccessibleValueObject[]) items);
		}
		return apply;
	}

	public nc.vo.pub.CircularlyAccessibleValueObject[] queryAllBodyData(
			String key) throws BusinessException {
		try {
			return findItemsForHeader(key);
		} catch (SQLException e) {
			throw new BusinessException(e.getMessage());
		}
	}

	/*
	 * 由表头主键和条件查询表体数据
	 * 
	 */
	public nc.vo.pub.CircularlyAccessibleValueObject[] queryAllBodyData(
			String key, String where) throws BusinessException {
		nc.vo.pub.CircularlyAccessibleValueObject[] vos = null;
		try {
			StringBuffer sbfSql = new StringBuffer();

			sbfSql.append(" left outer join so_apply ");
			sbfSql.append(" on so_apply.pk_apply=so_apply_b.pk_apply ");
			String strWhere = null;
			if (key != null) {
				strWhere = " where so_apply.pk_apply = '" + key + "'";

				sbfSql.append(strWhere);
			}

			if (where != null) {
				if (strWhere != null)
					sbfSql.append(where);
				else
					sbfSql.append(" where " + where);
			}

			String sSqlwhere = nc.impl.scm.so.so146.RichDMO.getSelectString(
					ApplyItemVO.class, null, sbfSql.toString());

			RichDMO dmo = new RichDMO();
			vos = dmo.selectBySql(sSqlwhere, ApplyItemVO.class);
		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			if (e instanceof BusinessException) {
				throw (BusinessException) e;
			}
			throw new BusinessException(e.getMessage());
		}

		return vos;
	}

	/**
	 * 获取单据状态信息
	 * 
	 * @param sPk
	 * @return
	 * @throws Exception
	 */
	public ArrayList queryStatus(String sPk) throws Exception {
		if (sPk == null || sPk.trim().length() == 0)
			return null;
		SmartDMO sdmo = new SmartDMO();
		ArrayList al = new ArrayList();
		SmartVO[] cvo = sdmo.selectBy(ApplyHeaderVO.class, new String[] {
				"pk_apply", "ts", "fstatus", "capproveid", "dapprovedate",
				"dbilltime", "daudittime", "dmoditime" }, "pk_apply='" + sPk
				+ "'");
		if (cvo == null || cvo.length == 0)
			return null;
		al.add(cvo[0].getAttributeValue("pk_apply"));
		al.add(cvo[0].getAttributeValue("ts"));
		al.add(cvo[0].getAttributeValue("fstatus"));
		al.add(cvo[0].getAttributeValue("capproveid"));
		al.add(cvo[0].getAttributeValue("dapprovedate"));
		al.add(cvo[0].getAttributeValue("dbilltime"));
		al.add(cvo[0].getAttributeValue("daudittime"));
		al.add(cvo[0].getAttributeValue("dmoditime"));

		al.add(queryBodyStatus(sPk));
		return al;
		// String sSql = "select "

	}

	public Hashtable queryBodyStatus(String sPk) throws Exception {
		if (sPk == null || sPk.trim().length() == 0)
			return null;
		SmartDMO sdmo = new SmartDMO();
		Hashtable al = new Hashtable();
		SmartVO[] cvo = sdmo.selectBy(ApplyItemVO.class, new String[] {
				"pk_apply_b", "ts", "ntakenumber", "ntakepacknumber",
				"biftakefinish", "pk_returnpolicy"}, "pk_apply='" + sPk + "'");
		if (cvo == null || cvo.length == 0)
			return null;
		for (int i = 0, iLen = cvo.length; i < iLen; i++) {
			al.put(cvo[i].getAttributeValue("pk_apply_b"), cvo[i]);
		}
		return al;
		// String sSql = "select "

	}

	/*
	 * 由表头表体条件查表头数据 2004-8-16 增加vdef6-vdef10 wsy 2004-10-11 改用smart实现
	 */
	public CircularlyAccessibleValueObject[] queryAllHeadData(String where)
			throws BusinessException {

		ApplyHeaderVO[] heads = null;
		// 临时表
		String sTable = null;
		RichDMO dmo = null;
		try {
			String sqlwhere=" ";
			String sqlhead=" left outer join so_apply_b  on  so_apply.pk_apply=so_apply_b.pk_apply  ";
			if(where==null)
				where="";
			
			if (where.indexOf("bd_invcl")>=0){
				  sqlwhere=sqlwhere+"  INNER JOIN bd_invbasdoc ON so_apply_b .cinvbasdocid=bd_invbasdoc.pk_invbasdoc ";
				  sqlwhere=sqlwhere+"  INNER JOIN bd_invcl ON bd_invbasdoc.pk_invcl=bd_invcl.pk_invcl ";
			  }
			  else if (where.indexOf("bd_invbasdoc")>=0 || where.indexOf("bd_invmandoc")>=0){
				  sqlwhere=sqlwhere+"  INNER JOIN bd_invbasdoc ON so_apply_b .cinvbasdocid=bd_invbasdoc.pk_invbasdoc ";
				  sqlwhere=sqlwhere+"  INNER JOIN bd_invmandoc ON bd_invmandoc.pk_invbasdoc=bd_invbasdoc.pk_invbasdoc ";
			  }
			  if (where.indexOf("bd_areacl")>=0){
				  sqlwhere=sqlwhere+"  INNER JOIN bd_cumandoc on so_apply.ccustomerid=bd_cumandoc.pk_cumandoc ";
				  sqlwhere=sqlwhere+"  INNER JOIN bd_cubasdoc ON bd_cumandoc.pk_cubasdoc=bd_cubasdoc.pk_cubasdoc ";
				  sqlwhere=sqlwhere+"  INNER JOIN bd_areacl ON bd_cubasdoc.pk_areacl=bd_areacl.pk_areacl ";
			  }
			  else if (where.indexOf("bd_cubasdoc")>=0|| where.indexOf("bd_cumandoc")>=0){
				  sqlwhere=sqlwhere+"  INNER JOIN bd_cumandoc on so_apply.ccustomerid=bd_cumandoc.pk_cumandoc ";
				  sqlwhere=sqlwhere+"  INNER JOIN bd_cubasdoc ON bd_cumandoc.pk_cubasdoc=bd_cubasdoc.pk_cubasdoc ";
			  }
//====DONE 恒安V56 modified by 张磊 恒安代配送业务处理 需要连接业务类型表进行查询(根据业务类型编码)
			  if (where.indexOf("bd_busitype")>=0){
				  sqlwhere=sqlwhere+" INNER JOIN bd_busitype ON so_apply.cbiztype=bd_busitype.pk_busitype ";
			  }
//====END 恒安V56 modified by 张磊	
			  if(where.indexOf("bd_deptdoc")>=0){
				  sqlwhere=sqlwhere+"  INNER JOIN bd_deptdoc ON so_apply.cdeptid=bd_deptdoc.pk_deptdoc ";
			  }
			  sqlwhere+=" where "+where;
			  
			  sqlhead+=sqlwhere+" order by so_apply.pk_apply ";

			String sSqlwhere = nc.impl.scm.so.so146.RichDMO.getSelectString(
					ApplyHeaderVO.class, null, sqlhead.toString());

			dmo = new RichDMO();
			heads = (ApplyHeaderVO[]) dmo.selectBySql(sSqlwhere,
					ApplyHeaderVO.class);
			if ((heads == null) || (heads.length == 0))
				return null;
			Hashtable ht = new Hashtable();
			for (int i = 0, iLen = heads.length; i < iLen; i++) {
				ht.put(heads[i].getPk_apply(), heads[i]);
			}
			// 查询子表
//			StringBuffer sbfTmp = new StringBuffer();
//			sbfTmp
//					.append(" select distinct ")
//					.append(
//							"so_apply_b.pk_apply as pk_apply,so_apply_b.cconsigncorpid as cconsigncorpid, so_apply_b.ccalbodyid as ccalbodyid,so_apply_b.cbodywarehouseid as cbodywarehouseid,so_apply_b.creceiptcorpid as creceiptcorpid,so_apply_b.ccurrencytypeid as ccurrencytypeid,so_apply_b.ndiscountrate as ndiscountrate,so_apply_b.ntaxrate as ntaxrate,so_apply_b.nexchangeotobrate as nexchangeotobrate,so_apply_b.vreceiveaddress as vreceiveaddress")
//					.append(" from so_apply_b ")
//					.append(" inner join so_apply ").append(
//							" on  so_apply_b.pk_apply=so_apply.pk_apply  ");
//			if (where != null && !where.equals("")) {
//				sbfTmp.append(" where ");
//				sbfTmp.append(where);
//			}
			String sqlbody="select so_apply_b.pk_apply as pk_apply,so_apply_b.cconsigncorpid as cconsigncorpid, so_apply_b.ccalbodyid as ccalbodyid,so_apply_b.cbodywarehouseid as cbodywarehouseid,so_apply_b.creceiptcorpid as creceiptcorpid,so_apply_b.ccurrencytypeid as ccurrencytypeid,so_apply_b.ndiscountrate as ndiscountrate,so_apply_b.ntaxrate as ntaxrate,so_apply_b.nexchangeotobrate as nexchangeotobrate,so_apply_b.vreceiveaddress as vreceiveaddress ";
			sqlbody+=" from so_apply_b  inner join so_apply  on  so_apply_b.pk_apply=so_apply.pk_apply  ";
			sqlbody+=sqlwhere;
			
			// dmo.executeUpdate(sbfTmp.toString(),new ArrayList(),new
			// ArrayList());

			/**
			 * 修改：陈云云
			 * 日期：2009-8-6
			 * CQ号：NCdp200940885
			 * 原因：flag设置错误，只有第一行记录的表头被设置上库存组织和仓库值，而
			 *       之后的记录表头没有被复制上表体的库存组织和仓库值
			 */
			Hashtable<String, Boolean> flagHT = new Hashtable<String,Boolean>();
			for (Iterator iterator = ht.keySet().iterator(); iterator.hasNext(); ) {
				String key = (String)iterator.next();
				flagHT.put(key, false);	
			}
			ApplyItemVO[] avos = (ApplyItemVO[]) dmo.selectBySql(sqlbody, ApplyItemVO.class);
			ApplyHeaderVO hvo = null;
			/**
			 * 修改：陈云云
			 * 日期：2009-8-6
			 * CQ号：NCdp200940885
			 * 原因：flag设置错误，只有第一行记录的表头被设置上库存组织和仓库值，而
			 *       之后的记录表头没有被复制上表体的库存组织和仓库值
			 */
//			boolean blnFilled = false;
			for (int i = 0, iLen = avos.length; i < iLen; i++) {
				hvo = (ApplyHeaderVO) ht.get(avos[i].getPk_apply());
				Boolean blnFilled = flagHT.get(avos[i].getPk_apply());
				if (hvo != null) {
					if(!blnFilled){
						hvo.setCcalbodyid(avos[i].getCcalbodyid());
						hvo.setCconsigncorpid(avos[i].getCconsigncorpid());
						hvo.setCwarehouseid(avos[i].getCbodywarehouseid());
						hvo.setCreceiptcustomerid(avos[i].getCreceiptcorpid());
						hvo.setCcurrencytypeid(avos[i].getCcurrencytypeid());
						hvo.setNdiscountrate(avos[i].getNdiscountrate());
						hvo.setNtaxrate(avos[i].getNtaxrate());
	//					hvo.setNexchangeotoarate(avos[i].getNexchangeotoarate());
						hvo.setNexchangeotobrate(avos[i].getNexchangeotobrate());
						hvo.setVreceiveaddress(avos[i].getVreceiveaddress());
						ht.remove(avos[i].getPk_apply());
						blnFilled=true;
					}

				}
			}
		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			if (e instanceof BusinessException) {
				throw (BusinessException) e;
			}
			throw new BusinessException(e.getMessage(),e);
		}
		return heads;
	}

	/**
	 * 查询。 创建日期：(2001-4-23 9:38:18)
	 * 
	 * @return nc.vo.so.so001.SaleOrderVO
	 * @param strCondition
	 *            java.lang.String
	 */
	public ApplyItemVO[] queryApplyEnd(String strWhere) throws SQLException {
		String strSql = "select pk_apply_b,  fstatus, so_apply_b.pk_apply,cinvbasdocid,nnumber,ntaxnetprice, nsummny,"
				+ "nnumber-isnull(ntakenumber,0) as ntakenumber,biftakefinish,nnumber-isnull(ninnumber,0) as ninnumber,bifinvfinish,"
				+ "frowstatus,so_apply.ts,so_apply_b.ts "
				+ "FROM so_apply INNER JOIN so_apply_b ON so_apply.pk_apply = so_apply_b.pk_apply "
				+ " WHERE 1=1 and so_apply.dr=0 and so_apply.fstatus not in (0,1,5) ";
		if (strWhere != null && !strWhere.equals(""))
			strSql = strSql + " and " + strWhere;
		strSql = strSql + "order by so_apply_b.pk_apply,pk_apply_b";
		ApplyItemVO[] applyItems = null;
		Vector v = new Vector();
		Connection con = null;
		PreparedStatement stmt = null;
		con = getConnection();
		try {
			stmt = con.prepareStatement(strSql);
			ResultSet rs = stmt.executeQuery();
			//
			while (rs.next()) {
				ApplyItemVO item = new ApplyItemVO();
				//
				String pk_apply_b = rs.getString("pk_apply_b");
				item.setPk_apply_b(pk_apply_b == null ? null : pk_apply_b
						.trim());
				//
				Object fstatus = rs.getObject("fstatus");
				item.setBifinvfinish(new UFBoolean(Integer.valueOf(
						fstatus.toString()).intValue() == BillStatus.FINISH));
				//
				String pk_apply = rs.getString("pk_apply");
				item.setPk_apply(pk_apply == null ? null : pk_apply.trim());
				//
				String cinvbasdocid = rs.getString("cinvbasdocid");
				item.setCinvbasdocid(cinvbasdocid == null ? null : cinvbasdocid
						.trim());
				//
				Object o = rs.getObject("nnumber");
				if (o != null) {
					BigDecimal nnumber = new BigDecimal(o.toString());
					item.setNnumber(nnumber == null ? null : new UFDouble(
							nnumber));
				}
				//
				o = rs.getObject("ntaxnetprice");
				if (o != null) {
					BigDecimal ntaxnetprice = new BigDecimal(o.toString());
					item.setNtaxnetprice(ntaxnetprice == null ? null
							: new UFDouble(ntaxnetprice));
				}
				//
				o = rs.getObject("nsummny");
				if (o != null) {
					BigDecimal nsummny = new BigDecimal(o.toString());
					item.setNsummny(nsummny == null ? null : new UFDouble(
							nsummny));
				}
				//
				o = rs.getObject("ntakenumber");
				if (o != null) {
					BigDecimal ntakenumber = new BigDecimal(o.toString());
					item.setNtakenumber(ntakenumber == null ? null
							: new UFDouble(ntakenumber));
				}
				//
				String biftakefinish = rs.getString("biftakefinish");
				item.setBiftakefinish(biftakefinish == null ? null
						: new UFBoolean(biftakefinish.trim()));
				//
				o = rs.getObject("ninnumber");
				if (o != null) {
					BigDecimal ninnumber = new BigDecimal(o.toString());
					item.setNinnumber(ninnumber == null ? null : new UFDouble(
							ninnumber));
				}
				//
				String bifinvfinish = rs.getString("bifinvfinish");
				item.setBifinvfinish(bifinvfinish == null ? null
						: new UFBoolean(bifinvfinish.trim()));
				item.setFrowstatus(new Integer(rs.getInt("frowstatus")));
				// //hts
				// String ts = rs.getString(17);
				// item.m_headts = ts == null ? null : new
				// UFDateTime(ts.trim());
				// //ts
				// ts = rs.getString(18);
				// item.m_ts = ts == null ? null : new UFDateTime(ts.trim());
				v.addElement(item);
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		applyItems = new ApplyItemVO[v.size()];
		if (v.size() > 0) {
			v.copyInto(applyItems);
		}
		return applyItems;
	}

	public String[] queryIDs(String strSql) throws Exception {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "queryIDs",
				new Object[] { strSql });
		/** ********************************************************** */
		String sql = "select  pk_apply from so_apply";
		if (strSql != null)
			sql += " where " + strSql;
		Connection con = null;
		PreparedStatement stmt = null;
		Vector vecResult = new Vector();
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			ResultSet rs = stmt.executeQuery();
			//
			if (rs.next()) {
				vecResult.addElement(rs.getString(1));
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "queryIDs",
				new Object[] { strSql });
		/** ********************************************************** */
		String[] strResult = new String[vecResult.size()];
		vecResult.toArray(strResult);
		return strResult;
	}

	public void setBillAuditState(String strPk_Apply, String strPk_Approved,
			String strApprovedate, int iNewState) throws SQLException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "setBillState",
				new Object[] { strPk_Apply, strPk_Approved, strApprovedate,
						new Integer(iNewState) });
		/** ********************************************************** */
		String sql = "update so_apply set capproveid = ?, dapprovedate = ?, fstatus = ? where pk_apply = ?";
		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			// update non PK fields:
			if (strPk_Approved == null) {
				stmt.setNull(1, Types.CHAR);
			} else {
				stmt.setString(1, strPk_Approved);
			}

			if (strApprovedate == null) {
				stmt.setNull(2, Types.CHAR);
			} else {
				stmt.setString(2, strApprovedate);
			}
			stmt.setInt(3, iNewState);
			// find record by PK fields:
			stmt.setString(4, strPk_Apply);
			//
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "update", new Object[] {
				strPk_Apply, strPk_Approved, strApprovedate,
				new Integer(iNewState) });
		/** ********************************************************** */
	}

	/**
	 * 用一个VO对象的属性更新数据库中的值。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param applyItems
	 *            nc.vo.so.so144.ApplyItemVO
	 * @exception java.sql.SQLException
	 *                异常说明。 2005-4-19 wsy 此方法作U
	 */
	public void updateItem(ApplyItemVO[] applyItems)
			throws java.sql.SQLException {
		try{
			if(applyItems==null||applyItems.length==0)return ;
		(new nc.impl.scm.so.so146.RichDMO()).model1_EditBatch(applyItems[0].getPk_corp(), applyItems, true);
		}
		catch(Exception e){
			SCMEnv.out(e);
			throw new java.sql.SQLException(e.getMessage());
			
		}
	}

	/**
	 * <p>
	 * 将VO插入母子表。
	 * <p>
	 * 创建日期：(2001-6-24)
	 * 
	 * @param vo
	 *            nc.vo.so.so006.ApplyVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ArrayList insert(ApplyVO vo) throws javax.naming.NamingException,
			SQLException, nc.vo.pub.BusinessException, SystemException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so006.SalequotationDMO", "insert",
				new Object[] { vo });
		/** ********************************************************** */
		ArrayList listID = new ArrayList();
		try {
			ICheckValueValidity dmocode = getICheckValueValidity();
			Object o = vo.getParentVO().getAttributeValue("vreceiptcode");
			String vreceiptcode = "";
			check(vo);
			try {
				vreceiptcode = dmocode.getSysBillNO(vo);
			} catch (Exception ex) {
				throw new BusinessException(ex.getMessage());
			}
			vo.getParentVO().setAttributeValue("vreceiptcode", vreceiptcode);
			check(vo);
			// 插入表头：
			String newHeadID = insertHeader((ApplyHeaderVO) vo.getParentVO());
			// 插入表体各项：
			listID.add(newHeadID);
			listID.add(vreceiptcode);
			// 插入附表数据
			ApplyItemVO[] items = (ApplyItemVO[]) vo.getChildrenVO();
			Vector vecTemp = new Vector();
			for (int i = 0; i < items.length; i++) {
				String newItemId = insertItem(items[i], newHeadID);
				listID.add(newItemId);

				// 为回写订单作准备
				UpdateVO update = getUpdateVO(null, items[i]);
				if (update != null)
					vecTemp.addElement(update);
			}
			if (vecTemp.size() > 0) {
				UpdateVO[] updateVos = new UpdateVO[vecTemp.size()];
				vecTemp.toArray(updateVos);
				callBackSaleOrder(updateVos);
			}
		} catch (Exception e) {
			try {
				if (!e.getMessage().equals(
						nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
								"400630", "UPP400630-000274")/*
																 * @res
																 * "获取单据号出错!"
																 */)) {
					ICheckValueValidity dmocode = getICheckValueValidity();
					dmocode.returnBillNo(vo, "vreceiptcode");
				}
			} catch (Exception ex) {
				throw new nc.vo.pub.BusinessException(
						nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
								"400630", "UPP400630-000283")/*
																 * @res
																 * "回退单据号出错!"
																 */);
			}
			throw new nc.bs.pub.SystemException(e.getMessage());
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so006.ApplyDMO", "insert",
				new Object[] { vo });
		/** ********************************************************** */
		return listID;
	}

	/**
	 * 通过主键获得VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyVO
	 * @param key
	 *            String
	 * @exception java.rmi.Exception
	 *                异常说明。
	 */
	public void blankOut(String strPk_Apply) throws Exception {
		try {
			ApplyVO apply = findByPrimaryKey(strPk_Apply);
			ApplyHeaderVO head = (ApplyHeaderVO) apply.getParentVO();
			ApplyItemVO[] items = (ApplyItemVO[]) apply.getChildrenVO();

			UpdateVO update = null;

			Vector vecTemp = new Vector();
			for (int i = 0; i < items.length; i++) {
				update = null;
				items[i].setStatus(VOStatus.DELETED);
				update = getUpdateVO(items[i], items[i]);
				if (update != null)
					vecTemp.addElement(update);
			}

			int iStatus = 0;
			if (head.getFstatus() != null)
				iStatus = head.getFstatus().intValue();
			if (iStatus != BillStatus.FREE)
				throw new BusinessException(nc.bs.ml.NCLangResOnserver
						.getInstance().getStrByID("400630", "UPP400630-000284",
								null, new String[] { getStateDesc(iStatus) }));
			// /*@res "单据在{0}状态下，不能进行作废处理！"*/ + getStateDesc(iStatus) +
			// "状态下，不能进行作废处理！");
			iStatus = BillStatus.BLANKOUT;
			setBillState(strPk_Apply, new Integer(iStatus));

			if (vecTemp.size() > 0) {
				UpdateVO[] vos = new UpdateVO[vecTemp.size()];
				vecTemp.toArray(vos);
				callBackSaleOrder(vos);
			}
			// nc.bs.so.pub.CheckValueValidity dmocode = new
			// nc.bs.so.pub.CheckValueValidity();
			// dmocode.returnBillNo((AggregatedValueObject)head,head.getVreceiptcode());
			// CheckValueValidity dmocode = new CheckValueValidity();

			// 退单据号
			try {
				// dmocode.returnBillNo(apply, "vreceiptcode");
				ICheckValueValidity dmocode = getICheckValueValidity();
				dmocode.returnBillNo(apply, "vreceiptcode");

			} catch (Exception e) {
				throw new BusinessException(nc.bs.ml.NCLangResOnserver
						.getInstance().getStrByID("400630", "UPP400630-000285")/*
																				 * @res
																				 * "回退单据号错误!"
																				 */);
			}

		} catch (Exception e) {
			reportException(e);
			throw e;
		}
	}

	/**
	 * 通过主键获得VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyVO
	 * @param key
	 *            String
	 * @exception java.rmi.Exception
	 *                异常说明。
	 */
	public void close(String strPk_Apply, Boolean blnForward) throws Exception {
		try {
			ApplyVO apply = findByPrimaryKey(strPk_Apply);

			ApplyHeaderVO head = (ApplyHeaderVO) apply.getParentVO();
			int iStatus = 0;
			if (head.getFstatus() != null)
				iStatus = head.getFstatus().intValue();

			if (blnForward.booleanValue() && iStatus != BillStatus.AUDIT)
				throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
						.getStrByID("400630", "UPP400630-000286", null,
								new String[] { getStateDesc(iStatus) }));
			// /*@res
			// "单据在{0}状态下，不能进行关闭！"*/+getStateDesc(iStatus)+"状态下，不能进行关闭！");

			if (!blnForward.booleanValue() && iStatus != BillStatus.CLOSE)
				throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
						.getStrByID("400630", "UPP400630-000287", null,
								new String[] { getStateDesc(iStatus) }));
			// /*@res
			// "单据在{0}状态下，不能进行打开！"*/+getStateDesc(iStatus)+"状态下，不能进行打开！");

			iStatus = BillStatus.CLOSE;
			if (!blnForward.booleanValue())
				iStatus = BillStatus.AUDIT;
			setBillState(strPk_Apply, new Integer(iStatus));
			// /wsy
			setBillBodyState(strPk_Apply, iStatus == BillStatus.CLOSE ? "Y"
					: "N");
		} catch (Exception e) {
			reportException(e);
			throw e;
		}
	}

	/**
	 * 通过主键获得VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyVO
	 * @param key
	 *            String
	 * @exception java.rmi.Exception
	 *                异常说明。
	 */
	public void freeze(String strPk_Apply, Boolean blnForward) throws Exception {
		try {
			ApplyVO apply = findByPrimaryKey(strPk_Apply);
			ApplyHeaderVO head = (ApplyHeaderVO) apply.getParentVO();
			int iState = 0;
			if (head.getFstatus() != null)
				iState = head.getFstatus().intValue();
			if (blnForward.booleanValue() && iState != BillStatus.AUDIT)
				throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
						.getStrByID("400630", "UPP400630-000288", null,
								new String[] { getStateDesc(iState) }));
			// /*@res "单据在{0}状态下，不能进行冻结！"*/ + getStateDesc(iState) +
			// "状态下，不能进行冻结！");
			if (!blnForward.booleanValue() && iState != BillStatus.FREEZE)
				throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
						.getStrByID("400630", "UPP400630-000289", null,
								new String[] { getStateDesc(iState) }));
			// /*@res "单据在{0}状态下，不能进行解冻！"*/ + getStateDesc(iState) +
			// "状态下，不能进行解冻！");
			int iStatus = BillStatus.FREEZE;
			if (!blnForward.booleanValue())
				iStatus = BillStatus.AUDIT;
			setBillState(strPk_Apply, new Integer(iStatus));
		} catch (Exception e) {
			reportException(e);
			throw e;
		}
	}

	public String getInvCodeByBasID(String strID) throws Exception {
		String sql = "select invcode from bd_invbasdoc where pk_invbasdoc = ?";
		String strCode = null;
		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			stmt.setString(1, strID);
			ResultSet rs = stmt.executeQuery();
			if (rs.next()) {
				strCode = rs.getString(1);
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		return strCode;
	}

	public void setBillState(String strPk_Apply, Integer iNewState)
			throws SQLException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "setBillState",
				new Object[] { strPk_Apply, iNewState });
		/** ********************************************************** */
		String sql = null;
		String sqlb = null;

		if (iNewState.intValue() == BillStatus.BLANKOUT) {
			sql = "update so_apply set  fstatus = ?,dr = 1 where pk_apply = ?";
			sqlb = " update so_apply_b set dr=1 where pk_apply='" + strPk_Apply
					+ "'";
		} else
			sql = "update so_apply set  fstatus = ? where pk_apply = ?";
		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);

			stmt.setInt(1, iNewState.intValue());
			// find record by PK fields:
			stmt.setString(2, strPk_Apply);
			//
			stmt.executeUpdate();
			if (sqlb != null) {
				stmt = con.prepareStatement(sqlb);
				stmt.executeUpdate();
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "update", new Object[] {
				strPk_Apply, iNewState });
		/** ********************************************************** */
	}

	/**
	 * <p>
	 * 使用VO的值更新母子表。
	 * <p>
	 * 创建日期：(2001-6-24)
	 * 
	 * @param vo
	 *            nc.vo.so.so006.SalequotationVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ArrayList update(ApplyVO vo) throws SQLException, BusinessException,
			SystemException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "update",
				new Object[] { vo });
		/** ********************************************************** */
		ApplyItemVO[] items = (ApplyItemVO[]) vo.getChildrenVO();
		ApplyHeaderVO head = (ApplyHeaderVO) vo.getParentVO();
		ArrayList listID = new ArrayList();
		String strPrimarykey = head.getPrimaryKey();
		Vector vecTemp = new Vector();
		try {
			if (head.getVreceiptcode() != null)
				check(vo);
			if (head.getVreceiptcode() == null
					|| head.getVreceiptcode().trim().equals("")) {
				ICheckValueValidity dmocode = getICheckValueValidity();
				try {
					String vreceiptcode = dmocode.getSysBillNO(vo);
					head.setAttributeValue("vreceiptcode", vreceiptcode);
				} catch (Exception e) {
					throw new BusinessException(nc.bs.ml.NCLangResOnserver
							.getInstance().getStrByID("400630",
									"UPP400630-000290")/* @res "获得单据号出错!" */);
				}
				check(vo);
			}
			ApplyHeaderVO oldHeader = (ApplyHeaderVO) findHeaderByPrimaryKey(head
					.getPrimaryKey());
			ApplyItemVO[] oldItems = findItemsForHeader(head.getPrimaryKey());
			HashMap hash = new HashMap();
			for (int i = 0; i < oldItems.length; i++) {
				hash.put(oldItems[i].getPk_apply_b(), oldItems[i]);
			}

			UpdateVO update = null;
			ApplyItemVO oldItem = null;
			for (int i = 0; i < items.length; i++) {
				update = null;
				oldItem = (ApplyItemVO) hash.get(items[i].getPk_apply_b());
				switch (items[i].getStatus()) {
				case VOStatus.NEW:
					items[i].setPk_apply(strPrimarykey);
					String itemID = insertItem(items[i]);
					listID.add(itemID);

					update = getUpdateVO(null, items[i]);
					break;
				case VOStatus.UPDATED:
					if (isTimeStampChanged(items[i], oldItem))
						throw new Exception(nc.bs.ml.NCLangResOnserver
								.getInstance().getStrByID("400630",
										"UPP400630-000256")/*
															 * @res
															 * "记录已经发生修改！请刷新后重做！"
															 */);
					updateItem(items[i]);
					update = getUpdateVO(oldItem, items[i]);
					break;
				case VOStatus.DELETED:
					if (isTimeStampChanged(items[i], oldItem))
						throw new Exception(nc.bs.ml.NCLangResOnserver
								.getInstance().getStrByID("400630",
										"UPP400630-000256")/*
															 * @res
															 * "记录已经发生修改！请刷新后重做！"
															 */);
					deleteItem(items[i]);
					update = getUpdateVO(oldItem, items[i]);
					break;
				}
				if (update != null)
					vecTemp.addElement(update);
			}

			if (isTimeStampChanged(head, oldHeader)) {
				throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
						.getStrByID("400630", "UPP400630-000291")/*
																	 * @res
																	 * "数据发生改变，请刷新后重新做！"
																	 */);
			}
			updateHeader((ApplyHeaderVO) vo.getParentVO());
			if (head.getVreceiptcode() == null
					|| head.getVreceiptcode().trim().equals("")) {
				ICheckValueValidity dmocode = getICheckValueValidity();
				// 退单据号
				try {
					dmocode.returnBillNo(vo, "vreceiptcode");
				} catch (Exception e) {
					throw new BusinessException(nc.bs.ml.NCLangResOnserver
							.getInstance().getStrByID("400630",
									"UPP400630-000285")/* @res "回退单据号错误!" */);
				}
			}
			if (vecTemp.size() > 0) {
				UpdateVO[] updates = new UpdateVO[vecTemp.size()];
				vecTemp.toArray(updates);
				callBackSaleOrder(updates);
			}
			/** ********************************************************** */
			// 保留的系统管理接口：
			afterCallMethod("nc.bs.so.so144.ApplyDMO", "update",
					new Object[] { vo });
			/** ********************************************************** */
		} catch (Exception e) {
			try {
				if (!e.getMessage().equals(
						nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
								"400630", "UPP400630-000290")/*
																 * @res
																 * "获得单据号出错!"
																 */)) {
					if (head.getVreceiptcode() == null
							|| head.getVreceiptcode().trim().equals("")) {
						ICheckValueValidity dmocode = getICheckValueValidity();
						// 退单据号
						dmocode.returnBillNo(vo, "vreceiptcode");
					}
				}
			} catch (Exception ex) {
				throw new nc.vo.pub.BusinessException(
						nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
								"400630", "UPP400630-000283")/*
																 * @res
																 * "回退单据号出错!"
																 */);
			}
			throw new nc.bs.pub.SystemException(e.getMessage());
		}
		return listID;
	}

	public void updateInNumber(UpdateVO[] vos) throws Exception {

		long s = System.currentTimeMillis();
		SCMEnv.out("开始回写退货申请表：");
		SmartDMO sdmo = new SmartDMO();

		HashMap hash = getItemsForUpdateVO(vos);
		String sql = "update so_apply_b set ninnumber = ?, ninpacknumber = ?, bifinvfinish = ?,biftakefinish = ?,browfinish= ? where dr = 0 and pk_apply_b = ?";

		ArrayList alValues = new ArrayList();
		ArrayList<Integer> alType = new ArrayList<Integer>();
		ArrayList<Object> al = null;

		Vector vecTemp = new Vector();

		UFDouble dblTemp = null;
		UFBoolean blnFinished = null;
		// UFBoolean browFinished = null;
		for (int i = 0; i < vos.length; i++) {
			al = new ArrayList<Object>();
			// 首先读取数据库中的子表数据
			ApplyItemVO oldItem = (ApplyItemVO) hash.get(vos[i].getPk());
			blnFinished = new UFBoolean(false);

			dblTemp = new UFDouble(0);
			if (vos[i].getNumber() != null) {
				//获得	
				dblTemp = dblTemp.add(vos[i].getNumber());
			}

			if (oldItem.getNinnumber() != null)
				//获得已经入库数量，并相加
				dblTemp = dblTemp.add(oldItem.getNinnumber());
			al.add(dblTemp);

			// 拒收数量
			if (oldItem.getNrefusenumber() != null) {
				dblTemp = dblTemp.add(oldItem.getNrefusenumber());
			}

			int iResult = dblTemp.abs().compareTo(oldItem.getNnumber().abs());
			
			if (iResult >= 0) {
				blnFinished = new UFBoolean(true);
			}
			else{
				blnFinished = new UFBoolean(false);
			}
			dblTemp = new UFDouble(0);
			if (vos[i].getPackNumber() != null) {
				dblTemp = dblTemp.add(vos[i].getPackNumber());
			}
			if (oldItem.getNinpacknumber() != null)
				dblTemp = dblTemp.add(oldItem.getNinpacknumber());
			al.add(dblTemp);
			al.add(blnFinished);
			if (blnFinished.booleanValue()) {
				// 入旖Y束，t接收也Y束
				al.add(blnFinished);
			} else {
				al.add(oldItem.getBiftakefinish());
			}
			al.add(blnFinished);
			al.add(vos[i].getPk());

			if (oldItem.getCsourcebillbodyid() != null
					&& oldItem.getCsourcebilltype().equals("3U")) {
				vos[i].setPk(oldItem.getCsourcebillbodyid());
				// vecTemp.addElement(vos[i]);
			}

			if (!vecTemp.contains(oldItem.getPk_apply()))
				vecTemp.add(oldItem.getPk_apply());
			alValues.add(al);
		}
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
		sdmo.executeUpdateBatch(sql, alValues, alType);
		SCMEnv.out("退货申请表回写完毕：" + (System.currentTimeMillis() - s) / 1000);

		if (vecTemp.size() > 0) {
			String[] pks = new String[vecTemp.size()];
			vecTemp.copyInto(pks);
			closeHead(pks);
		}

		//增加检查: 已入库数量 > 申请数量, 抛异常
		//2007-09-26 xhq
		
		//add by ouyangzhb 2013-01-22 注销，不需要“已入库数量 > 申请数量” 检查
//		String sqlsql = "select pk_apply_b from so_apply_b where dr = 0 and abs(isnull(ninnumber,0)) > abs(isnull(nnumber,0)) and pk_apply_b in ('";
//		for(int i = 0; i < vos.length - 1; i++) sqlsql += vos[i].getPk() + "','";
//		sqlsql += vos[vos.length - 1].getPk() + "')";
//		
//		Connection con = null;
//		PreparedStatement stmt = null;
//		ResultSet rs = null;
//		try {
//			con = getConnection();
//			stmt = con.prepareStatement(sqlsql);
//			rs = stmt.executeQuery();
//			
//			while(rs.next()){
//				throw new BusinessException(nc.bs.ml.NCLangResOnserver
//						.getInstance().getStrByID("400630", "UPP400630-000405")/*"入库数量超出申请数量!"*/);
//			}
//		}catch(Exception e){
//			throw e;
//		}finally{
//			if(stmt != null) stmt.close();
//			if(con != null) con.close();
//		}
	}

	/**
	 * 申位拒收盗 需要同rSo入旖Y束、整行Y束、整谓Y束
	 * 
	 * @param vos
	 * @throws Exception
	 */
	public void updateRefuseNumber(UpdateVO[] vos) throws Exception {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so146.TakeDMO", "updateRefuseNumber",
				new Object[] { vos });
		/** ********************************************************** */
		HashMap hash = getItemsForUpdateVO(vos);

		if (vos == null || vos.length == 0)
			return;
		nc.bs.scm.pub.smart.SmartDMO sdmo = new nc.bs.scm.pub.smart.SmartDMO();
		String sql = "update so_apply_b set nrefusenumber = ?, nrefusepacknum = ? , bifinvfinish = ? ,biftakefinish = ?,browfinish= ? where pk_apply_b = ?";

		ArrayList alValues = new ArrayList();
		ArrayList alType = new ArrayList();
		ArrayList al = null;
		UFDouble dblTemp = null;
		UFBoolean blnFinished;
		Vector vecTemp = new Vector();

		for (int i = 0; i < vos.length; i++) {
			al = new ArrayList();

			// 首先读取数据库中的子表数据
			ApplyItemVO oldItem = (ApplyItemVO) hash.get(vos[i].getPk());
			blnFinished = new UFBoolean(false);
			dblTemp = new UFDouble(0);
			if (vos[i].getNumber() != null) {
				dblTemp = vos[i].getNumber();
			}
			dblTemp = dblTemp.add(oldItem.getNrefusenumber());
			al.add(dblTemp);

			dblTemp = dblTemp.add(oldItem.getNinnumber());
			int iResult = dblTemp.compareTo(oldItem.getNnumber());
			// if (iResult > 0) {
			// throw new BusinessException(nc.bs.ml.NCLangResOnserver
			// .getInstance().getStrByID("400630", "UPP400630-000293"));///*@res
			// // "退货申请单要入库主数量与拒收主数量之和超过申请退货数量！"
			// } else
			if (iResult <= 0) {
				blnFinished = new UFBoolean(true);
			}

			dblTemp = new UFDouble(0);
			if (vos[i].getPackNumber() != null) {
				dblTemp = vos[i].getPackNumber();
			}
			dblTemp = dblTemp.add(oldItem.getNrefusepacknum());
			al.add(dblTemp);

			dblTemp = dblTemp.add(oldItem.getNinpacknumber());
			// iResult = dblTemp.compareTo(oldItem.getNpacknumber());
			// if (iResult > 0)
			// {
			// throw new Exception("退货申请单要入库辅数量与拒收辅数量之和超过申请退货数量！");
			// }
			al.add(blnFinished);
			if (blnFinished.booleanValue()) {
				// 入旖Y束，t接收也Y束
				al.add(blnFinished);
			} else {
				al.add(oldItem.getBiftakefinish());
			}
			al.add(blnFinished);

			// find record by PK fields:
			al.add(vos[i].getPk());

			if (!vecTemp.contains(oldItem.getPk_apply()))
				vecTemp.add(oldItem.getPk_apply());

			alValues.add(al);
		}

		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
		sdmo.executeUpdateBatch(sql, alValues, alType);
		if (vecTemp.size() > 0) {
			String[] pks = new String[vecTemp.size()];
			vecTemp.copyInto(pks);
			closeHead(pks);
		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so146.TakeDMO", "updateRefuseNumber",
				new Object[] { vos });
		/** ********************************************************** */
	}

	private static final int OPERATION_DELETE = 3;

	private static final int OPERATION_INSERT = 1;

	private static final int OPERATION_UPDATE = 2;

	// 回写订单
	private void callBackSaleOrder(UpdateVO[] updateVos) throws Exception {
		if (updateVos == null)
			return;
		ToRetOrdVO[] toretvos = new ToRetOrdVO[updateVos.length];
		for (int i = 0; i < updateVos.length; i++) {
			toretvos[i] = new ToRetOrdVO();
			toretvos[i].setCsale_bid(updateVos[i].getPk());
			toretvos[i].setNtotalreturnnumber(updateVos[i].getNumber());
		}
		getISOToIC().setReturnNum(toretvos);
	}

	/**
	 * 此处插入方法说明。 创建日期：(2001-12-15 15:34:24)
	 * 
	 * @param apply
	 *            nc.vo.so.so006.ApplyVO
	 * @exception javax.naming.NamingException
	 *                异常说明。
	 * @exception java.sql.SQLException
	 *                异常说明。
	 * @exception nc.bs.pub.SystemException
	 *                异常说明。
	 * @exception nc.vo.pub.BusinessException
	 *                异常说明。
	 */
	public void check(ApplyVO apply) throws javax.naming.NamingException,
			java.sql.SQLException, nc.bs.pub.SystemException,
			nc.vo.pub.BusinessException {
		// 检测单据号
		try {
			if (((ApplyHeaderVO) apply.getParentVO()).getVreceiptcode() != null
					&& ((ApplyHeaderVO) apply.getParentVO()).getVreceiptcode()
							.trim().length() > 0) {
				ICheckValueValidity dmocode = getICheckValueValidity();
				dmocode.isValueValidity(apply);
			}
			// 增加对存货和库存组织一致性的较验
			ApplyItemVO[] ivos = (ApplyItemVO[]) apply.getChildrenVO();
			for (int i = 0; i < ivos.length; i++) {
				boolean bif = ifInvInCal(ivos[i].getCcalbodyid(), ivos[i]
						.getCinventoryid(), ivos[i].getPk_corp());
				if (!bif)
					throw new BusinessException(nc.bs.ml.NCLangResOnserver
							.getInstance().getStrByID("400630",
									"UPP400630-000270", null,
									new String[] { String.valueOf(i + 1) }));
				// /*@res "存在：存货不属于库存组织的行(第{0}修改行)，请检查"*/+(i+1)+"修改行)，请检查");
			}

		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			if (e instanceof BusinessException)
				throw new nc.vo.pub.BusinessException(e.getMessage());

			throw new BusinessException(nc.bs.ml.NCLangResOnserver
					.getInstance().getStrByID("400630", "UPP400630-000294")/*
																			 * @res
																			 * "数据检验失败:"
																			 */
					+ e.getMessage());
		}
	}

	public Vector getInvForbidForRet(String[] strInvDocManIDs) throws Exception {
		nc.bs.scm.pub.TempTableDMO tdmo = new nc.bs.scm.pub.TempTableDMO();

		String tempsql = tdmo.insertTempTable(strInvDocManIDs,
				"temp_soreturn_050621_01", "pk_invmandoc", "varchar(20)");

		String sql = "select pk_invmandoc from bd_invmandoc where isinvreturned='Y' and pk_invmandoc  in"
				+ tempsql;
		SmartDMO sdmo = new SmartDMO();
		Object[] o = sdmo.selectBy2(sql);
		Vector vecResult = new Vector();
		if (o == null || o.length == 0)
			return vecResult;
		
		Vector vTemp = new Vector();
		for (int i = 0; i < o.length; i++) vTemp.addElement(((Object[]) o[i])[0]);
		for (int i = 0; i < strInvDocManIDs.length; i++) {
			if(vTemp.contains(strInvDocManIDs[i])) 	vecResult.add(strInvDocManIDs[i]);
		}
		return vecResult;
	}

	/**
	 * 通过主键查找一个组子表对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	private HashMap getItemsForUpdateVO(UpdateVO[] updateVos) throws Exception {
		// Vector vt = new Vector();
		//	
		// for(int i=0;i<updateVos.length;i++){
		// if(updateVos[i].getPk()!=null)
		// vt.add(updateVos[i].getPk());
		// }
		// if(vt.size()==0)return new HashMap();
		// String[] sPks = new String[vt.size()];
		// vt.copyInto(sPks);
		return findItemByPrimaryKeys(nc.impl.scm.so.so146.RichDMO
				.getPksFromUpdateVOs(updateVos));
	}

	/**
	 * 返回源头订单日期 创建日期：(2004-4-22 17:03:40)
	 * 
	 * @return java.lang.String
	 * @param strSaleID
	 *            java.lang.String
	 */
	public String getSaleInvoiceDate(String strSaleID) throws SQLException {
		StringBuffer sbfSql = new StringBuffer("select dbilldate ");
		sbfSql.append("from so_saleinvoice ");
		sbfSql.append("where so_saleinvoice.csaleid ='" + strSaleID + "' ");
		Connection con = getConnection();
		PreparedStatement stmt = con.prepareStatement(sbfSql.toString());
		String strDate = null;
		try {
			ResultSet rs = stmt.executeQuery();
			if (rs.next()) {
				strDate = rs.getString(1);
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		return strDate;
	}

	/**
	 * 返回源头订单日期 创建日期：(2004-4-22 17:03:40)
	 * 
	 * @return java.lang.String
	 * @param strSaleID
	 *            java.lang.String
	 */
	public String getSaleOrderDate(String strSaleID) throws SQLException {
		StringBuffer sbfSql = new StringBuffer("select dbilldate ");
		sbfSql.append("from so_sale ");
		sbfSql.append("where so_sale.csaleid ='" + strSaleID + "' ");
		Connection con = getConnection();
		PreparedStatement stmt = con.prepareStatement(sbfSql.toString());
		String strDate = null;
		try {
			ResultSet rs = stmt.executeQuery();
			if (rs.next()) {
				strDate = rs.getString(1);
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		return strDate;
	}

	/**
	 * 返回源头订单日期 创建日期：(2004-4-22 17:03:40)
	 * 
	 * @return java.lang.String
	 * @param strSaleID
	 *            java.lang.String
	 */
	public String getSaleOutDate(String strSaleID) throws SQLException {
		StringBuffer sbfSql = new StringBuffer("select dbilldate ");
		sbfSql.append("from ic_general_h ");
		sbfSql.append("where ic_general_h.cgeneralhid ='" + strSaleID + "' ");
		Connection con = getConnection();
		PreparedStatement stmt = con.prepareStatement(sbfSql.toString());
		String strDate = null;
		try {
			ResultSet rs = stmt.executeQuery();
			if (rs.next()) {
				strDate = rs.getString(1);
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		return strDate;
	}

	/**
	 * 此处插入方法说明。 创建日期：(2004-4-21 11:17:18)
	 * 
	 * @return nc.vo.so.so146.UpdateVO
	 */
	private UpdateVO getUpdateVO(ApplyItemVO oldItem, ApplyItemVO newItem) {
		// 为回写订单作准备
		String strSourceType = newItem.getCsourcebilltype();
		String strFirstType = newItem.getCfirsttype();
		String strBillBodyID = null;
		if (strSourceType != null && strSourceType.equals("30")) {
			strBillBodyID = newItem.getCsourcebillbodyid();
		} else if (strFirstType != null && strFirstType.equals("30")) {
			strBillBodyID = newItem.getCfirstbillbid();
		}

		UpdateVO updateVO = null;
		if (strBillBodyID != null && strBillBodyID.trim().length() > 0) {
			updateVO = new UpdateVO();
			if (newItem.getStatus() == VOStatus.NEW) {
				updateVO = new UpdateVO();
				updateVO.setPk(strBillBodyID);
				updateVO.setNumber(newItem.getNnumber());
			} else if (newItem.getStatus() == VOStatus.UPDATED) {
				updateVO = new UpdateVO();
				updateVO.setPk(strBillBodyID);
				updateVO.setNumber(newItem.getNnumber().sub(
						oldItem.getNnumber()));
			} else if (newItem.getStatus() == VOStatus.DELETED) {
				updateVO = new UpdateVO();
				updateVO.setPk(strBillBodyID);
				updateVO.setNumber(oldItem.getNnumber().multiply(-1));
			}
		}

		return updateVO;
	}

	/**
	 * 此处插入方法说明。 功能描述: 输入参数: 返回值: 异常处理: 日期:
	 * 
	 * @return boolean
	 * @param vo
	 *            nc.vo.so.so102.InvcalbodyVO
	 */
	private boolean isTimeStampChanged(ApplyHeaderVO newHeader,
			ApplyHeaderVO oldHeader) throws SQLException {
		if (newHeader.getTs() == null) {
			return false;
		}
		String strOldTs = oldHeader.getTs().toString();
		String strNewTs = newHeader.getTs().toString();
		return !strNewTs.equals(strOldTs);
	}

	/**
	 * 此处插入方法说明。 功能描述: 输入参数: 返回值: 异常处理: 日期:
	 * 
	 * @return boolean
	 * @param vo
	 *            nc.vo.so.so102.InvcalbodyVO
	 */
	private boolean isTimeStampChanged(ApplyItemVO newItem, ApplyItemVO oldItem)
			throws SQLException {
		if (newItem.getTs() == null) {
			return false;
		}
		String strOldTs = oldItem.getTs().toString();
		String strNewTs = newItem.getTs().toString();
		return !strNewTs.equals(strOldTs);
	}

	/**
	 * 此处插入方法说明。 创建日期：(2004-4-9 19:23:12)
	 */
	public void outTake(String strPK_Apply, String strDate) throws Exception {
		ApplyVO apply = findByPrimaryKey(strPK_Apply);

		PfParameterVO pfVO = new PfParameterVO();
		pfVO.m_currentDate = strDate;
		TakeVO outVO = (TakeVO) PfUtilTools.runChangeData("3U", "3V", apply,
				pfVO);

		nc.vo.so.so146.TakeHeaderVO head = (nc.vo.so.so146.TakeHeaderVO) outVO
				.getParentVO();
		nc.bs.pub.pf.PfUtilBO pf = new nc.bs.pub.pf.PfUtilBO();
		Hashtable keyHas = new java.util.Hashtable();
		Hashtable methodReturnHas = new java.util.Hashtable();

		nc.vo.pub.pf.PfUtilWorkFlowVO pfWVO = new nc.vo.pub.pf.PfUtilWorkFlowVO();
		pf.processAction("PUSHWRITE", "3V", strDate, pfWVO, outVO, null);
	}

	public void updateBillFinishFlag(String strPk_apply) throws Exception {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "updateBillFinishFlag",
				new Object[] { strPk_apply });
		/** ********************************************************** */
		StringBuffer sbfSql = new StringBuffer(
				"update so_apply set bbillfinish = 'Y' where pk_apply = '"
						+ strPk_apply + "' ");
		sbfSql.append("and not exists(select pk_apply_b from so_apply_b ");
		sbfSql.append("where so_apply.pk_apply = so_apply_b.pk_apply ");
		sbfSql
				.append("and (so_apply_b.biftakefinish = 'N' or so_apply_b.biftakefinish is null))");
		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sbfSql.toString());
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "updateBillFinishFlag",
				new Object[] { strPk_apply });
		/** ********************************************************** */
	}

	/**
	 * 申位接收盗浚 需要同r回接收Y束苏I 2005-06-21
	 * 
	 * @param vos
	 * @throws Exception
	 */
	public void updateTakeNumber(UpdateVO[] vos) throws Exception {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "updateTakeNumber",
				new Object[] { vos });
		/** ********************************************************** */
		HashMap hash = getItemsForUpdateVO(vos);

		if (vos == null || vos.length == 0)
			return;
		nc.bs.scm.pub.smart.SmartDMO sdmo = new nc.bs.scm.pub.smart.SmartDMO();
		String sql = "update so_apply_b set ntakenumber = ?, ntakepacknumber = ?, biftakefinish = ? where pk_apply_b = ?";

		ArrayList alValues = new ArrayList();
		ArrayList alType = new ArrayList();
		ArrayList al = null;
		UFDouble dblTemp = null;
		UFBoolean blnFinished = null;

		for (int i = 0; i < vos.length; i++) {
			al = new ArrayList();

			// 首先读取数据库中的子表数据
			ApplyItemVO oldItem = (ApplyItemVO) hash.get(vos[i].getPk());

			blnFinished = new UFBoolean(false);
			dblTemp = new UFDouble(0);

			if (vos[i].getNumber() != null) {
				dblTemp = vos[i].getNumber();
			}
			dblTemp = dblTemp.add(oldItem.getNtakenumber());

			int iResult = dblTemp.compareTo(oldItem.getNnumber());
			// if (iResult > 0) {
			// throw new BusinessException(nc.bs.ml.NCLangResOnserver
			// .getInstance().getStrByID("400630", "UPP400630-000295"));//*@res
			// // "申请单要接收主数量超过申请退货数量！/
			// } else
			/**
			 * zhy2009-07-29 
			 * CQ:NCdp200927607　退货接收单参照退货申请单部分数量时，申请单的表体存货显示接收结束
			 * 该问题来源于项目问题：国泰控股集团　
			 * 问题描述:退货接收单参照退货申请单生成,当退货接收单维护部分退货数量后,接收数量自动变为结束状态,如果需要多次退货,就要将接收结束打开.多次操作就要多次打开.
			 * 该问题存在的历史原因：
			 * 以前需求要求的。严格控制。 
			   原来订单也有类似的处理，后来订单加了容差，退货没有加
               后来有客户提过，不能严格控制，好象jdm说要把退货和订单合在一块，所以也只是出了专项补丁，没合进产品。
			 * 
			 */
//			if (iResult <= 0) {
//			blnFinished = new UFBoolean(!vos[i].isDirty());
//			}
			if(iResult>=0){//如果接收数量＞＝退货申请数量，则自动关闭，否则不关闭
				blnFinished = new UFBoolean(true);
			}
			al.add(dblTemp);

			dblTemp = new UFDouble(0);
			if (vos[i].getPackNumber() != null) {
				dblTemp = vos[i].getPackNumber();
			}
			if (oldItem.getNtakepacknumber() != null)
				dblTemp = dblTemp.add(oldItem.getNtakepacknumber());

			al.add(dblTemp);
			al.add(blnFinished.toString());
			al.add(vos[i].getPk());

			alValues.add(al);

		}

		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFDOUBLE));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
		sdmo.executeUpdateBatch(sql, alValues, alType);

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "updateTakeNumber",
				new Object[] { vos });
		/** ********************************************************** */
	}

	public void setBillBodyState(String strPk_Apply, String strNewState)
			throws SQLException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "setBillBodyState",
				new Object[] { strPk_Apply, strNewState });
		/** ********************************************************** */
		String sql = "update so_apply_b set  browfinish = ? where pk_apply = ?";
		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);

			stmt.setString(1, strNewState);
			// find record by PK fields:
			stmt.setString(2, strPk_Apply);
			//
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "setBillBodyState",
				new Object[] { strPk_Apply, strNewState });
		/** ********************************************************** */
	}

	/**
	 * 王森阳
	 * 
	 * 创建日期：(2004-6-8)
	 * 
	 * 过滤退货接收是否依据质检结果入库(存货属性)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyItemVO[] filtOutInstoByChk(ApplyItemVO[] ivos) throws Exception {

		if (ivos == null)
			return null;
		ApplyItemVO[] aivos = null;

		Vector vt = new Vector();
		for (int i = 0; i < ivos.length; i++) {
			if (!isInvretinstoByChk(ivos[i].getCinventoryid(), ivos[i]
					.getPk_corp())) {
				vt.add(ivos[i]);
			}
		}
		if (vt.size() > 0) {
			aivos = new ApplyItemVO[vt.size()];
			vt.copyInto(aivos);
			return aivos;
		}
		return null;
	}

	/*
	 * //王森阳 2004-5-25 param:库存组织，存货管理档案，公司 fun:看存货和库存组织是否一致 return:boolean
	 */
	public boolean ifInvInCal(String pk_calbody, String pk_invmandoc,
			String pk_corp) throws Exception {

		if ((pk_calbody == null) || (pk_invmandoc == null) || (pk_corp == null))
			return false;
		String sql = null;
		nc.bs.scm.pub.smart.SmartDMO dmo = new nc.bs.scm.pub.smart.SmartDMO();

		sql = " select pk_calbody ";
		sql += " from bd_produce  where pk_calbody ='" + pk_calbody + "'";
		sql += " and pk_invmandoc ='" + pk_invmandoc + "'";
		sql += " and pk_corp= '" + pk_corp + "'";
		sql += " and dr=0 ";
		Object[] o = dmo.selectBy2(sql);
		if ((o == null) || (o.length == 0))
			return false;

		return true;
	}

	/*
	 * //王森阳 2004-5-25 param:，存货管理档案，公司 fun:取"销售退货是否依据检验结果入库"标志 return:boolean
	 */
	private boolean isInvretinstoByChk(String pk_invmandoc, String pk_corp)
			throws Exception {

		if ((pk_invmandoc == null) || (pk_corp == null))
			return false;

		String sql = null;
		nc.bs.scm.pub.smart.SmartDMO dmo = new nc.bs.scm.pub.smart.SmartDMO();

		sql = " select isinvretinstobychk ";
		sql += " from bd_invmandoc  where ";
		sql += " pk_invmandoc ='" + pk_invmandoc + "'";
		sql += " and pk_corp= '" + pk_corp + "'";
		sql += " and dr=0 ";
		Object[] o = dmo.selectBy2(sql);
		if ((o == null) || (o.length == 0)) {
			throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
					.getStrByID("400630", "UPP400630-000296")/* @res "查无此存货" */);
		}
		Object[] o1 = (Object[]) o[0];

		if ((o1[0] == null) || ("".equals(o1[0])))
			return false;

		UFBoolean bChk = new UFBoolean(o1[0].toString());

		return bChk.booleanValue();
	}

	/*
	 * 王森阳 2004-6-2
	 * 
	 * 提供给出 出库单的接口，判断出库单是否为退货申请单所用 param: 出库单号,单据类型 return:
	 * boolean:true:已被使用;false:未使用
	 */
	public boolean isSaleUsedInApply(String sCsaleid, String sBillType)
			throws BusinessException {

		if ((sCsaleid == null) || (sCsaleid.equals("")))
			return false;

		String sql = null;
		try {
			nc.bs.scm.pub.smart.SmartDMO dmo = new nc.bs.scm.pub.smart.SmartDMO();

			sql = " select csourcebillid ";
			sql += " from so_apply_b  where dr=0 and csourcebillid ='"
					+ sCsaleid + "' ";
			if ((sBillType != null) && (!sBillType.equals("")))
				sql += " and csourcebilltype ='" + sBillType + "'";
			sql += " and pk_apply in(select pk_apply from so_apply where fstatus!=5)";

			Object[] o = dmo.selectBy2(sql);

			if ((o == null) || (o.length == 0))
				return false;

		} catch (Exception e) {
			throw new BusinessException(e);
		}
		return true;
	}

	/**
	 * 根据主键在数据库中删除一个VO对象。
	 * 
	 * 创建日期：(2001-4-20)
	 * 
	 * @param key
	 *            nc.vo.pub.oid.OID
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public boolean checkGoing(AggregatedValueObject vo, String strApproveId,
			String strApproveDate, String checkNote) {
		if (vo == null || vo.getParentVO() == null)
			return false;
		try {
			String strBillID = ((ApplyHeaderVO) vo.getParentVO()).getPk_apply();
			// updateForCheck((ApplyItemVO[]) vo.getChildrenVO());
//			setBillState(strBillID, new Integer(BillStatus.AUDITING));
			setBillState(strBillID, strApproveId, strApproveDate, new Integer(BillStatus.AUDITING));
			InvokeEventProxy pluginProxy=new InvokeEventProxy("so5","3U");
			if(pluginProxy!=null)
				pluginProxy.afterAction(Action.AUDIT,new AggregatedValueObject[]{ vo}, null);
		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			return false;
		}
		return true;
	}

	/**
	 * 根据主键在数据库中删除一个VO对象。
	 * 
	 * 创建日期：(2001-4-20)
	 * 
	 * @param key
	 *            nc.vo.pub.oid.OID
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public boolean checkNoPass(AggregatedValueObject vo, String strApproveID,
			String strApproveDate, String checkNote) {
		if (vo == null || vo.getParentVO() == null)
			return false;

		try {
			String strBillID = ((ApplyHeaderVO) vo.getParentVO()).getPk_apply();
			// updateForCheck((ApplyItemVO[])vo.getChildrenVO());
			setBillState(strBillID, new Integer(BillStatus.NOPASS));
		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			return false;
		}
		return true;
	}

	/**
	 * 方法为根据单据Id设置单据通过 审批说明与当前审批人 创建日期：(2001-7-19 23:12:37)
	 * 
	 * @return boolean
	 */
	public boolean checkPass(AggregatedValueObject vo, String strApproveId,
			String strApproveDate, String checkNote) throws java.lang.Exception {
		if (vo == null || vo.getParentVO() == null)
			return false;

		String strBillID = ((ApplyHeaderVO) vo.getParentVO()).getPk_apply();
		// updateForCheck((ApplyItemVO[])vo.getChildrenVO());
		setBillState(strBillID, strApproveId, strApproveDate, new Integer(
				BillStatus.AUDIT));
		return true;
	}

	/*
	 * 整单结束 王森阳 2004-8-4 20:37
	 */
	private void closeHead(String[] strPk_Applys) throws Exception {
		if (strPk_Applys == null || strPk_Applys.length == 0)
			return;
		Hashtable ht = isHeaderCanBeFinished(strPk_Applys);
		Integer[] iStatus = new Integer[strPk_Applys.length];

		for (int i = 0; i < strPk_Applys.length; i++) {
			if (ht.containsKey(strPk_Applys[i]))
				iStatus[i] = new Integer(BillStatus.AUDIT);
			else
				iStatus[i] = new Integer(BillStatus.FINISH);
		}
		setArrayBillClose(strPk_Applys, iStatus);

		/*
		 * 2005-4-19 wsy 效率 for(int i=0;i <strPk_Applys.length;i++){
		 * if(!isHeaderCanBeFinished(strPk_Applys[i])){
		 * setBillClose(strPk_Applys[i],new Integer(BillStatus.FINISH)); } else{
		 * setBillClose(strPk_Applys[i],new Integer(BillStatus.AUDIT)); } }
		 */

	}

	/**
	 * 王森阳
	 * 
	 * 创建日期：(2004-6-8)
	 * 
	 * 过滤退货接收是否依据质检结果入库(存货属性) 并进行拆分
	 * 
	 * @return nc.vo.so.so144.ApplyVO[]
	 * @param nc.vo.so.so144.ApplyVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public ApplyVO[] filtOutInstoByChk(ApplyVO vo) throws Exception {

		if (vo == null)
			return null;
		ApplyItemVO[] ivos = (ApplyItemVO[]) vo.getChildrenVO();
		if (ivos == null)
			return null;

		ApplyItemVO[] aivos = null;
		ApplyVO[] vos = null;

		Vector vt = new Vector();
		for (int i = 0; i < ivos.length; i++) {
			if (!isInvretinstoByChk(ivos[i].getCinventoryid(), ivos[i]
					.getPk_corp())&&!Return2TO.isTo5D(ivos[i])) {
				vt.add(ivos[i]);
			}
		}
		if (vt.size() > 0) {
			aivos = new ApplyItemVO[vt.size()];
			vt.copyInto(aivos);
			vo.setChildrenVO(aivos);
		} else {
			return null;
		}
		vos = splitVOs(vo);

		return vos;
	}

	/**
	 * 通过主键查找一个VO对象。
	 * 
	 * 创建日期：(2004-7-1)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public HashMap findItemByPrimaryKeys(String[] pks) throws Exception {

		if ((pks == null) || (pks.length == 0))
			return null;

		ApplyItemVO apvo = null;
		nc.bs.scm.pub.smart.RichDMO dmo = new nc.bs.scm.pub.smart.RichDMO();

		nc.bs.scm.pub.TempTableDMO tdmo = new nc.bs.scm.pub.TempTableDMO();

		String tempsql = tdmo.insertTempTable(pks, "temp_soreturn_formsq003",
				"pk_apply_b", "varchar(20)");

		String wheresql = " pk_apply_b in " + tempsql;

		nc.vo.scm.pub.smart.SmartVO[] svo = dmo.selectBy(ApplyItemVO.class,
				null, wheresql);
		if (svo == null)
			return null;
		HashMap hp = new HashMap();

		for (int i = 0; i < svo.length; i++) {
			apvo = (ApplyItemVO) svo[i];

			hp.put(apvo.getPk_apply_b(), apvo);
		}

		return hp;

	}

	/**
	 * 通过主键查找一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	private boolean findItemsForHeader(Connection con, PreparedStatement stmt,
			String key) throws SQLException {

		String sql = "select count(*) from so_apply_b where browfinish = 'N' and  pk_apply = ?";

		// ApplyItemVO[] applyItems = null;
		Vector v = new Vector();
		// Connection con = null;
		// PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			stmt.setString(1, key);
			ResultSet rs = stmt.executeQuery();
			//
			while (rs.next()) {
				return true;
			}
			return false;
		} finally {
		}
	}

	private String getCndtnExpress(String sCndtncode, String sPk_corp)
			throws Exception {

		if ((sCndtncode == null) || (sCndtncode.trim().length() == 0))
			return null;
		nc.vo.so.back.ReturncndtnVO[] rnvo = null;
		nc.impl.scm.so.back.SOReturnEJBImpl rndbo = new nc.impl.scm.so.back.SOReturnEJBImpl();

		String sWheres = " dr=0 and vconditioncode='" + sCndtncode + "' ";
		rnvo = rndbo.Returncndtn_queryByWhere(sWheres, sPk_corp);

		if ((rnvo == null) || (rnvo.length == 0))
			return null;

		return rnvo[0].getVexpresscode();
	}

	// 销售订单金额（时间区间）
	// 主要是为自定义函数处理增加本方法（目前过滤条件为已审核订单）
	public UFDouble getCustOrderMny(String strCustID, String cinventoryid,
			UFDate queryDate, Integer queryDay) throws SQLException {
		UFDate startDate = queryDate.getDateBefore(queryDay.intValue());
		UFDate endDate = queryDate;
		StringBuffer sbfSql = new StringBuffer(
				"select sum(so_saleorder_b.nmny) ");
		sbfSql.append("from so_saleorder_b left join so_sale ");
		sbfSql.append("on so_sale.csaleid = so_saleorder_b.csaleid ");
		sbfSql.append("where so_sale.dbilldate<='" + endDate.toString() + "' ");
		sbfSql.append("and so_sale.dbilldate>='" + startDate.toString() + "' ");
		sbfSql.append("and so_sale.ccustomerid ='" + strCustID + "' ");
		// cinventoryid
		sbfSql.append("and so_saleorder_b.cinventoryid ='" + cinventoryid
				+ "' ");
		sbfSql.append("and so_sale.fstatus=2 ");
		Connection con = getConnection();
		PreparedStatement stmt = con.prepareStatement(sbfSql.toString());
		UFDouble orderMny = null;
		try {
			ResultSet rs = stmt.executeQuery();
			if (rs.next()) {
				double dblMny = rs.getDouble(1);
				orderMny = new UFDouble(dblMny);
			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		return orderMny;
	}

	/**
	 * 客户实际出库数量 创建日期：(2001-10-15 15:30:49)
	 * 
	 * @return 返回值为此时间段内此库存组织此存货的实际出库量
	 * @param ccustmanid
	 *            客户管理档案ID
	 * @param dDate
	 *            时间段结束时间
	 * @param iDays
	 *            时间跨度
	 */
	public UFDouble getCustOutNum(String ccustmanid, String cinventoryid,
			UFDate dDate, Integer iDays) throws SQLException {

		UFDate startDate = dDate.getDateBefore(iDays.intValue());
		UFDate endDate = dDate;

		if (startDate == null || endDate == null || ccustmanid == null
				|| ccustmanid == null)
			return null;

		String sql = null;
		UFDouble ufd = null;

		sql = "select  sum(coalesce(noutnum,0.0))  from ic_general_h h inner join ic_general_b b on h.cgeneralhid=b.cgeneralhid where  b.dbizdate >=? and b.dbizdate<=?  and h.ccustomerid=? and b.cinventoryid =? ";

		Connection con = null;
		PreparedStatement stmt = null;
		ResultSet rs = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);

			stmt.setString(1, startDate.toString());
			stmt.setString(2, endDate.toString());
			stmt.setString(3, ccustmanid);
			stmt.setString(4, cinventoryid);

			rs = stmt.executeQuery();
			//

			if (rs.next()) {

				BigDecimal num = rs.getBigDecimal(1);
				ufd = num == null ? null : new UFDouble(num);

			}
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
			try {
				if (rs != null)
					rs.close();
			} catch (Exception e) {
			}
		}

		return ufd;
	}

	private String getExpress(String sExpcode, String sPk_corp)
			throws Exception {

		if (sExpcode == null)
			return null;
		String sExpress = "";
		String stmp = null;
		int ifirst = 0, inext = 0, imid = 0;
		while (true) {
			ifirst = sExpcode.indexOf('(', inext);
			if (ifirst == -1) {
				if (inext != sExpcode.length())
					sExpress += sExpcode.substring(inext, sExpcode.length());
				break;
			}
			imid = sExpcode.indexOf("judge", inext);
			stmp = sExpcode.substring(inext, imid);
			sExpress += stmp;
			inext = sExpcode.indexOf(')', ifirst);
			if (inext == -1) {
				throw new BusinessException(nc.bs.ml.NCLangResOnserver
						.getInstance().getStrByID("400630", "UPP400630-000297")/*
																				 * @res
																				 * "公式错误(没有正确的')')"
																				 */);
			}
			stmp = sExpcode.substring(ifirst + 2, inext - 1);

			sExpress += getCndtnExpress(stmp, sPk_corp);
			inext++;
		}

		return sExpress;
	}

	/**
	 * 获得存货信息。 创建日期：(2001-9-3 9:30:24)
	 * 
	 * @return nc.vo.pub.lang.UFDouble
	 */
	public String getInvInfo(String strID) throws SQLException {
		String info = "";

		String strSQL = "Select invcode,invname From ";
		String strField = null;

		strSQL = strSQL + " bd_invbasdoc ";
		strField = "pk_invbasdoc";

		strSQL = strSQL + " Where " + strField + " =  ?";

		Connection con = null;
		PreparedStatement stmt = null;
		ResultSet rs = null;

		try {
			con = getConnection();
			stmt = con.prepareStatement(strSQL);

			// pk
			stmt.setString(1, strID);

			rs = stmt.executeQuery();
			//
			if (rs.next()) {
				String code = rs.getString(1);
				String name = rs.getString(2);

				info = nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
						"common", "UC000-0001439")/* @res "存货" */
						+ "[" + code + "] ";
			}
		} finally {
			try {
				if (rs != null) {
					rs.close();
				}
			} catch (Exception e) {
			}
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}

		return info;
	}

	private ArrayList getMatchedPolicy(String[] strPk_Policys,
			ApplyHeaderVO head, ApplyItemVO item) throws Exception {
		ReturnpolicyDMO policyDMO = new ReturnpolicyDMO();
		FunctionContex context = new FunctionContex(head, item);
		nc.bs.bank_cvp.compile.registry.Register.getInstance().getAllSMethods();
		ArrayList re = new ArrayList();
		for (int i = 0; i < strPk_Policys.length; i++) {
			ReturnpolicyVO policy = policyDMO
					.findByPrimaryKey(strPk_Policys[i]);

			// 2004-6-4,不可能发生的事发生了
			// 退货政策分配里的，居然在数据库中找不到？？
			if (policy == null)
				continue;

			String strExpress = policy.getVexpresscode();
			// RefCompilerBS compiler = new RefCompilerBS();
			strExpress = getExpress(strExpress, head.getPk_corp());

			ArrayValue v = RefCompilerBS.getExpressionResult(strExpress,
					context);
			Object objTemp = v.getValue();
			if (objTemp instanceof Boolean) {
				Boolean bln = (Boolean) objTemp;
				if (bln.booleanValue()) {
					re.add(strPk_Policys[i]);
					re.add(new UFBoolean(true));
					re.add(policy.getVpolicyname());
					return re;
				} else {
					re.add(strPk_Policys[i]);
					re.add(new UFBoolean(false));
					re.add(policy.getVpolicyname());
					return re;
				}
			} else if (objTemp instanceof String) {
				if (objTemp.equals("true")) {
					re.add(strPk_Policys[i]);
					re.add(new UFBoolean(true));
					re.add(policy.getVpolicyname());
					return re;
				} else if (objTemp.equals("false")) {
					re.add(strPk_Policys[i]);
					re.add(new UFBoolean(false));
					re.add(policy.getVpolicyname());
					return re;
				}
			}

		}
		return null;
	}

	/**
	 * 通过主键查找一个VO对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public boolean isDownCode(String csourcebillid) throws SQLException {

		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "findItemByPrimaryKey",
				new Object[] { csourcebillid });
		/** ********************************************************** */
		if (csourcebillid == null || csourcebillid.trim().length() == 0)
			return false;
		String sql = "select pk_apply_b from so_apply_b inner join so_apply on so_apply_b.pk_apply=so_apply.pk_apply where so_apply_b.csourcebillid = ? and so_apply.fstatus<>5 ";

		Connection con = null;
		PreparedStatement stmt = null;
		boolean b = false;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);
			stmt.setString(1, csourcebillid);
			ResultSet rs = stmt.executeQuery();
			//
			while (rs.next()) {
				b = true;
			}

		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}

		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "findItemByPrimaryKey",
				new Object[] { csourcebillid });
		/** ********************************************************** */

		return b;
	}

	/**
	 * 通过主键查找一对象。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @return nc.vo.so.so144.ApplyItemVO
	 * @param key
	 *            String
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	private Hashtable isHeaderCanBeFinished(String[] key) throws Exception {

		nc.bs.scm.pub.TempTableDMO dmo = new nc.bs.scm.pub.TempTableDMO();

		String tempsql = dmo.insertTempTable(key, "temp_soreturn_formsq002",
				"pk_apply", "varchar(20)");

		String sql = "select pk_apply from so_apply_b where browfinish <> 'Y' and  pk_apply in"
				+ tempsql;

		SmartDMO sdmo = new SmartDMO();

		Object[] o = sdmo.selectBy2(sql);
		Hashtable ht = new Hashtable();
		if (o == null || o.length == 0)
			return ht;
		Object[] o1 = null;
		for (int i = 0; i < o.length; i++) {
			o1 = (Object[]) o[i];
			if (o1 != null && o1[0] != null) {
				ht.put(o1[0], o1);
			}
		}
		return ht;

		/*
		 * 2005-4-19 wsy 效率 //ApplyItemVO[] applyItems = null; Vector v = new
		 * Vector(); Connection con = null; PreparedStatement stmt = null; try {
		 * con = getConnection(); stmt = con.prepareStatement(sql);
		 * stmt.setString(1, key); ResultSet rs = stmt.executeQuery(); // while
		 * (rs.next()) { return true; } return false; } finally { try { if (stmt !=
		 * null) { stmt.close(); } } catch (Exception e) { } try { if (con !=
		 * null) { con.close(); } } catch (Exception e) { } }
		 */
	}

	public nc.vo.pub.lang.UFBoolean judge(nc.vo.so.so144.ApplyVO avo)
			throws java.rmi.RemoteException {

		if (avo == null)
			return new nc.vo.pub.lang.UFBoolean(true);

		ApplyHeaderVO head = (ApplyHeaderVO) avo.getParentVO();
		if (head == null)
			return new nc.vo.pub.lang.UFBoolean(true);

		ApplyItemVO[] items = (ApplyItemVO[]) avo.getChildrenVO();
		if ((items == null) || (items.length == 0))
			return new nc.vo.pub.lang.UFBoolean(true);

		String strConditionCode = null;

		FunctionContex context = null;

		String strPk_Corp = head.getPk_corp();
		StringBuffer err = new StringBuffer();
		String strPk_Policy = null;
		// boolean bchecked = true;
		// ReturncndtnVO returncndtn = null;
		try {
			String strPk_InvManDoc = null;
			strPk_Corp = head.getPk_corp();
			String strPk_CustManDoc = head.getCcustomerid();
			ArrayList rewritePolicyItems = new ArrayList();
			for (int i = 0; i < items.length; i++) {
				context = new FunctionContex(head, items[i]);
				strConditionCode = null;

				// err.append(i).append(",");
				strPk_InvManDoc = items[i].getCinventoryid();
				String[] strPk_Policys = getAssignedPolicy(strPk_Corp,
						strPk_InvManDoc, strPk_CustManDoc);
				if (strPk_Policys == null || strPk_Policys.length == 0) {
					items[i].setBconfirm(new UFBoolean(true));
					// err.append("Y,").append("null;");
					continue;
				} else {
					strPk_Policy = null;

					ArrayList policyList = getMatchedPolicy(strPk_Policys,
							head, items[i]);
					if (policyList == null) {
						// err.append("N,").append("null;");
						err.append(nc.bs.ml.NCLangResOnserver.getInstance()
								.getStrByID("400630", "UPP400630-000298", null,
										new String[] { items[i].getCrowno() }));
						// /*@res "行号为<-{0}->
						// 检查不通过，引用退货政策为空！\n"*/).append(items[i].getCrowno()).append("->");
						// err.append(" 检查不通过，引用退货政策为空！\n");
						// if (bchecked)
						// bchecked = false;
					} else
						strPk_Policy = (String) policyList.get(0);

					if (strPk_Policy != null) {

						items[i].setPk_returnpolicy(strPk_Policy);
						items[i].setBconfirm((UFBoolean) policyList.get(1));
						rewritePolicyItems.add(items[i]);
						if (items[i].getBconfirm() == null
								|| !items[i].getBconfirm().booleanValue()) {
							// err.append("N,").append(strPk_Policy).append(";");
							err.append(nc.bs.ml.NCLangResOnserver.getInstance()
									.getStrByID(
											"400630",
											"UPP400630-000299",
											null,
											new String[] {
													items[i].getCrowno(),
													policyList.get(2)
															.toString() }));
							// /*@res
							// "行号为<-{0}->检查不通过，引用退货政策为{1}！\n"*/).append(items[i].getCrowno()).append("->");
							// err.append("
							// 检查不通过，引用退货政策为").append(policyList.get(2)).append("！\n");
							// if (bchecked)
							// bchecked = false;
						}
						// else
						// err.append("Y,").append(strPk_Policy).append(";");

					} else {
						// err.append("N,").append("null;");
						err.append(nc.bs.ml.NCLangResOnserver.getInstance()
								.getStrByID("400630", "UPP400630-000298", null,
										new String[] { items[i].getCrowno() }));
						// /*@res "行号为<-{0}->
						// 检查不通过，引用退货政策为空！\n"*/).append(items[i].getCrowno()).append("->");
						// err.append(" 检查不通过，引用退货政策为空！\n");
						// if (bchecked)
						// bchecked = false;
					}
				}
			}
			// if (!bchecked)
			if (err.length() > 0)
				throw new nc.vo.pub.BusinessException(
						nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
								"400630", "UPP400630-000300")/*
																 * @res
																 * "退货政策检查失败;"
																 */
								+ err.toString());
			if(!rewritePolicyItems.isEmpty()){
			  rewritePolicy(rewritePolicyItems);
			}
			return new nc.vo.pub.lang.UFBoolean(true);

		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			throw new java.rmi.RemoteException("Remote Call", e);
		}
	}

	/**
	 * 回写审批后匹配上的退货政策
   * @param rewritePolicyItems
   */
  private void rewritePolicy(ArrayList rewritePolicyItems) throws Exception {
    /** ********************************************************** */
    // 保留的系统管理接口：
    beforeCallMethod("nc.bs.so.so144.ApplyDMO", "rewritePolicy",
        new Object[] { rewritePolicyItems });
    /** ********************************************************** */
    
    nc.bs.scm.pub.smart.SmartDMO sdmo = new nc.bs.scm.pub.smart.SmartDMO();
    String sql = "update so_apply_b set pk_returnpolicy = ? where pk_apply_b = ?";

    ArrayList alValues = new ArrayList();
    ArrayList alType = new ArrayList();
    
    ArrayList al = null;

    for (int i = 0; i < rewritePolicyItems.size(); i++) {
      al = new ArrayList();

      al.add(((ApplyItemVO)rewritePolicyItems.get(i)).getPk_returnpolicy());
      al.add(((ApplyItemVO)rewritePolicyItems.get(i)).getPk_apply_b());

      alValues.add(al);

    }
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
    alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));

    sdmo.executeUpdateBatch(sql, alValues, alType);
    /** ********************************************************** */
    // 保留的系统管理接口：
    afterCallMethod("nc.bs.so.so144.ApplyDMO", "findItemByPrimaryKey",
        new Object[] { rewritePolicyItems });
    /** ********************************************************** */

    
  }

  /**
	 * 创建者：王森阳 功能：查ts 参数： 返回： 例外： 日期：(2004-6-30 11:46:08) 修改日期，修改人，修改原因，注释标志：
	 */
	public String queryBillHeadTs(String sHeadPK) throws SQLException,
			BusinessException, SystemException {
		Connection con = null;
		PreparedStatement stmt = null;
		ResultSet rs = null;
		String sTs = null; // 时间戳
		try {

			con = getConnection();
			stmt = con
					.prepareStatement("select ts  from so_apply where  pk_apply = ? AND dr=0 ");
			stmt.setString(1, sHeadPK);
			rs = stmt.executeQuery();
			if (rs.next())
				sTs = rs.getString(1);

		} catch (Exception e) {
			nc.vo.scm.pub.SCMEnv.out(e.getMessage());
		} finally {
			try {
				if (rs != null)
					rs.close();
			} catch (Exception e) {
				nc.vo.scm.pub.SCMEnv.out(e.getMessage());
			}
			try {
				if (stmt != null)
					stmt.close();
			} catch (Exception e) {
			}
			try {
				if (con != null)
					con.close();
			} catch (Exception e) {

			}
		}
		return sTs;
	}

	/**
	 * 根据条件查询表头VO(不关联子表条件)
	 * 
	 * 创建人：王森阳 创建日期：(2004-10-16)
	 * 
	 * @return nc.vo.so.so146.ApplyHeaderVO[]
	 * @param String
	 * @exception java.sql.Exception
	 *                异常说明。
	 */
	public ApplyHeaderVO[] queryHeadByWhere(String Sqlwhere) throws Exception {

		nc.impl.scm.so.so146.RichDMO dmo = new nc.impl.scm.so.so146.RichDMO();

		return (ApplyHeaderVO[]) dmo.queryVosByWhere(Sqlwhere,
				ApplyHeaderVO.class);

	}

	/**
	 * 根据条件查询表体VO
	 * 
	 * 创建人：王森阳 创建日期：(2004-10-16)
	 * 
	 * @return nc.vo.so.so146.ApplyItemVO[]
	 * @param String
	 * @exception java.sql.Exception
	 *                异常说明。
	 */
	public ApplyItemVO[] queryItemByWhere(String Sqlwhere) throws Exception {

		nc.impl.scm.so.so146.RichDMO dmo = new nc.impl.scm.so.so146.RichDMO();

		return (ApplyItemVO[]) dmo.queryVosByWhere(Sqlwhere, ApplyItemVO.class);
	}

	public void setBillClose(String strPk_Apply, Integer iNewState)
			throws SQLException {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "setBillClose",
				new Object[] { strPk_Apply, iNewState });
		/** ********************************************************** */
		String sql = "update so_apply set  fstatus = ? ,bbillfinish = ? where pk_apply = ?";
		Connection con = null;
		PreparedStatement stmt = null;
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);

			stmt.setInt(1, iNewState.intValue());
			if (iNewState.intValue() == BillStatus.FINISH) {
				stmt.setString(2, "Y");
			} else {
				stmt.setString(2, "N");
			}
			// find record by PK fields:
			stmt.setString(3, strPk_Apply);
			//
			stmt.executeUpdate();
		} finally {
			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (Exception e) {
			}
			try {
				if (con != null) {
					con.close();
				}
			} catch (Exception e) {
			}
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "setBillClose",
				new Object[] { strPk_Apply, iNewState });
		/** ********************************************************** */
	}

	public void setArrayBillClose(String[] strPk_Apply, Integer[] iNewState)
			throws Exception {

		long s = System.currentTimeMillis();
		nc.vo.scm.pub.SCMEnv.out("开始设置申请单结束标志及状态：");

		nc.bs.scm.pub.smart.SmartDMO sdmo = new nc.bs.scm.pub.smart.SmartDMO();
		// StringBuffer sbf = new StringBuffer();
		String sql = "update so_apply set  fstatus = ? ,bbillfinish = ? where pk_apply = ?";
		ArrayList alValues = new ArrayList();
		ArrayList alType = new ArrayList();
		ArrayList al = null;
		for (int i = 0, iLen = strPk_Apply.length; i < iLen; i++) {
			al = new ArrayList();
			al.add(iNewState[i]);

			if (iNewState[i].intValue() == BillStatus.FINISH) {
				al.add(new UFBoolean("Y"));
			} else {
				al.add(new UFBoolean("N"));
			}
			al.add(strPk_Apply[i]);
			alValues.add(al);
		}
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_INTEGER));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
		alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
		sdmo.executeUpdateBatch(sql, alValues, alType);
		nc.vo.scm.pub.SCMEnv.out("退货申请单状态标志设置完毕："
				+ (System.currentTimeMillis() - s) / 1000);

	}

	private void setBillState(Connection con, PreparedStatement stmt,
			String strPk_Apply, Integer iNewState) throws SQLException {

		String sql = "update so_apply set  fstatus = ? where pk_apply = ?";
		try {
			con = getConnection();
			stmt = con.prepareStatement(sql);

			stmt.setInt(1, iNewState.intValue());
			// find record by PK fields:
			stmt.setString(2, strPk_Apply);
			//
			stmt.executeUpdate();
		} finally {
		}
	}

	/**
	 * 根据仓库进行分单。 创建日期：(2002-5-31 8:56:45)
	 */
	public ApplyVO[] splitVOs(ApplyVO tagVo) throws Exception {

		ApplyHeaderVO parent = (ApplyHeaderVO) tagVo.getParentVO();
		ApplyItemVO[] bodys = (ApplyItemVO[]) tagVo.getChildrenVO();

		ApplyVO[] retVos = new ApplyVO[bodys.length];

		for (int i = 0; i < bodys.length; i++) {
			ApplyHeaderVO tempHead = (ApplyHeaderVO) parent.clone();
			ApplyItemVO[] vos = new ApplyItemVO[1];
			vos[0] = (ApplyItemVO) bodys[i].clone();
			ApplyItemVO[] tempBody = vos;
			retVos[i] = new ApplyVO();
			retVos[i].setParentVO(tempHead);
			retVos[i].setChildrenVO(tempBody);

		}

		retVos = (ApplyVO[]) nc.vo.scm.pub.vosplit.SplitBillVOs.getSplitVOs(
				ApplyVO.class.getName(), ApplyHeaderVO.class.getName(),
				ApplyItemVO.class.getName(), retVos, null,
				new String[] { "cbodywarehouseid" });

		for (int i = 0; i < retVos.length; i++) {
			ApplyHeaderVO tempHead = (ApplyHeaderVO) retVos[i].getParentVO();
			ApplyItemVO[] tempBody = (ApplyItemVO[]) retVos[i].getChildrenVO();
			tempHead.setAttributeValue("cwarehouseid", tempBody[0]
					.getAttributeValue("cbodywarehouseid"));
		}
		return retVos;
	}

	/**
	 * 用一个VO对象的属性更新数据库中的值。
	 * 
	 * 创建日期：(2004-3-16)
	 * 
	 * @param applyItems
	 *            nc.vo.so.so144.ApplyItemVO
	 * @exception java.sql.SQLException
	 *                异常说明。
	 */
	public void updateForCheck(ApplyItemVO[] applyItems) throws Exception {
		/** ********************************************************** */
		// 保留的系统管理接口：
		beforeCallMethod("nc.bs.so.so144.ApplyDMO", "updateItem",
				new Object[] { applyItems });
		/** ********************************************************** */
		String sql = "update so_apply_b set  pk_returnpolicy = ?, bconfirm = ? where pk_apply_b = ?";
		nc.bs.scm.pub.smart.SmartDMO sdmo = new nc.bs.scm.pub.smart.SmartDMO();

		ArrayList alValues = new ArrayList();
		ArrayList alType = new ArrayList();
		ArrayList al = null;
		try {
			// update non PK fields:
			for (int i = 0; i < applyItems.length; i++) {
				al = new ArrayList();
				al.add(applyItems[i].getPk_returnpolicy());
				al.add(applyItems[i].getBconfirm());
				al.add(applyItems[i].getPk_apply_b());

				//
				alValues.add(al);

			}
			alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
			alType.add(new Integer(SmartFieldMeta.JAVATYPE_UFBOOLEAN));
			alType.add(new Integer(SmartFieldMeta.JAVATYPE_STRING));
			sdmo.executeUpdateBatch(sql, alValues, alType);

		} finally {
		}
		/** ********************************************************** */
		// 保留的系统管理接口：
		afterCallMethod("nc.bs.so.so144.ApplyDMO", "updateItem",
				new Object[] { applyItems });
		/** ********************************************************** */
	}

	/**
	 * 反审为审批进行中 参数：单据Id,审批人ID,反审批日期,反审批语 创建日期：(2002-12-9 15:29:39)
	 * 
	 * @param approveId
	 *            java.lang.String
	 * @exception java.lang.Exception
	 *                异常说明。
	 */
	public void backGoing(String billId, String approveId, String approveDate,
			String backNote) throws java.lang.Exception {

	}

	/**
	 * 反审为自由状态 参数：单据Id,审批人ID,反审批日期,反审批语 创建日期：(2002-12-9 15:29:39)
	 * 
	 * @param approveId
	 *            java.lang.String
	 * @exception java.lang.Exception
	 *                异常说明。
	 */
	public void backNoState(String billId, String approveId,
			String approveDate, String backNote) throws java.lang.Exception {
		long s = System.currentTimeMillis();
		nc.vo.scm.pub.SCMEnv.out("审批采购计划后台更改审批状态开始...[驳回]：");

		setBillState(billId, null, null, new Integer(BillStatus.FREE));
		//弃审之后清除匹配的退货政策
		clearPolicyId(billId);
		
		
		nc.vo.scm.pub.SCMEnv.out("审批采购计划后台更改审批状态用时[驳回]：["
				+ (System.currentTimeMillis() - s) + "]" + "ms");

	}

	/**
	 * jianghp+ 2007-11-23
	 * 退货申请单审批之后回写匹配的退货政策,所以弃审之后需清除
   * @param billId
   */
  private void clearPolicyId(String billId) throws Exception {
    // TODO Auto-generated method stub
    if (billId == null)
      return;
    SmartDMO sdmo = new SmartDMO();
    StringBuffer sbuf = new StringBuffer("update so_apply_b");

    sbuf.append(" set  pk_returnpolicy = null").append(" where pk_apply = '").append(billId.trim()).append(
        "'");

    sdmo.executeUpdate(sbuf.toString(), new ArrayList(), new ArrayList());
  }

  /**
	 * ****************************************** 功能：根据pk设置审批弃审单据。 王森阳
	 * 
	 * 创建日期：(2004-8-18 16:51:20)
	 * 
	 * @param：pk,autid,autdate,status
	 * 
	 * @return：void ******************************************
	 */

	public void setBillState(String strPk_Apply, String sApproveid,
			String sApproveDate, Integer iNewState) throws Exception {

		if ((strPk_Apply == null) || (strPk_Apply.trim().equals(""))
				|| (iNewState == null))
			return;
		SmartDMO sdmo = new SmartDMO();
		StringBuffer sbuf = new StringBuffer("update so_apply");

		sbuf.append(" set  fstatus = ").append(String.valueOf(iNewState));
		if (sApproveid == null) {
			sbuf.append(",capproveid =null ");
		} else {
			sbuf.append(",capproveid ='").append(sApproveid).append("'");
		}
		if (sApproveDate == null) {
			sbuf.append(",dapprovedate =null ");
			sbuf.append(",daudittime =null ");
		} else {
			sbuf.append(",dapprovedate ='").append(sApproveDate).append("'");
			sbuf.append(",daudittime ='").append(
					ClientEnvironment.getServerTime()).append("'");
		}

		sbuf.append(" where pk_apply = '").append(strPk_Apply.trim()).append(
				"'");

		sdmo.executeUpdate(sbuf.toString(), new ArrayList(), new ArrayList());
	}

	/*
	 * wsy 2004-6-29 查看是否出库 参数：String 返回 boolean
	 * 
	 */
	public UFBoolean isOutStock(String sPk) throws Exception {

		if ((sPk == null) || (sPk.trim().length() == 0))
			return new UFBoolean(false);

		nc.bs.scm.pub.smart.SmartDMO dmo = new nc.bs.scm.pub.smart.SmartDMO();

		StringBuffer sb = new StringBuffer();
		sb.append(" select ic_general_h.cgeneralhid ").append(
				" from ic_general_h left outer join ic_general_b ").append(
				" on ic_general_h.cgeneralhid=ic_general_b.cgeneralhid ")
				.append(" where ").append(
						" ic_general_h.dr=0 and ic_general_b.dr=0 ").append(
						" and ic_general_b.csourcebillhid ='").append(sPk)
				.append("' ").append(" and ic_general_b.csourcetype='3U' ");

		Object[] o = dmo.selectBy2(sb.toString());
		if ((o != null) && (o.length > 0))
			return new UFBoolean(true);
		else
			return new UFBoolean(false);

	}

	public static ICheckValueValidity getICheckValueValidity() {
		return (ICheckValueValidity) nc.bs.framework.common.NCLocator
				.getInstance().lookup(ICheckValueValidity.class.getName());
	}

	public static ISOToIC_DRP getISOToIC() throws Exception {
		return (ISOToIC_DRP) nc.bs.framework.common.NCLocator.getInstance()
				.lookup(ISOToIC_DRP.class.getName());
	}
	public boolean isReferred(String id) throws BusinessException {
 
	String strSql = "select cpriceitemtable from so_apply_b where cpriceitemtable = ?";
	//
	Connection con = null;
	PreparedStatement stmt = null;
	try {
		con = getConnection();
		stmt = con.prepareStatement(strSql);
		stmt.setString(1,id);
		ResultSet rs = stmt.executeQuery();

		if(rs.next()) {
			return true;
		}
	}
	catch (Exception e) {
		throw new BusinessException(e);
	}
	finally {
		try {
			if (stmt != null) {
				stmt.close();
			}
		}catch (Exception e) {}
		try {
			if (con != null) {
				con.close();
			}
		}catch (Exception e) {}
	}
	return false;
 
}
}