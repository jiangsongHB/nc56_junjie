/*******************************************************************************
 * *************************************************************\ The skeleton
 * of this class is generated by an automatic * code generator for NC product. * \
 ******************************************************************************/

package nc.bs.ps.settle;

import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.Vector;

import javax.naming.NamingException;

import nc.bs.bd.b21.BusinessCurrencyRateUtil;
import nc.bs.framework.common.NCLocator;
import nc.bs.logging.Logger;
import nc.bs.ml.NCLangResOnserver;
import nc.bs.pi.InvoiceDMO;
import nc.bs.pi.InvoiceImpl;
import nc.bs.ps.estimate.EstimateDMO;
import nc.bs.ps.estimate.EstimateImpl;
import nc.bs.pu.ic.ToICDMO;
import nc.bs.pu.pub.BsPuTool;
import nc.bs.pu.pub.GetSysBillCode;
import nc.bs.pu.pub.PubDMO;
import nc.bs.pu.pub.PubImpl;
import nc.bs.pub.SystemException;
import nc.bs.pub.billcodemanage.BillcodeGenerater;
import nc.bs.pub.formulaparse.FormulaParse;
import nc.bs.pub.pf.PfUtilTools;
import nc.bs.scm.inter.ArapHelper;
import nc.bs.scm.pub.TempTableDMO;
import nc.bs.scm.pub.bill.SQLUtil;
import nc.itf.arap.pub.IArapForGYLPublic;
import nc.itf.ia.service.IIAToPU;
import nc.itf.ps.estimate.IEstimate;
import nc.itf.ps.settle.ISettle;
import nc.itf.pu.inter.IPuToIc_SettleImpl;
import nc.itf.pu.pub.fw.LockTool;
import nc.itf.scm.cenpur.service.TempTableUtil;
import nc.itf.uap.IUAPQueryBS;
import nc.itf.uap.busibean.ISysInitQry;
import nc.itf.uap.pf.IPFBusiAction;
import nc.itf.uap.pf.IPFMetaModel;
import nc.itf.uap.sf.ICreateCorpQueryService;
import nc.jdbc.framework.processor.BeanListProcessor;
import nc.ui.pub.para.SysInitBO_Client;
import nc.vo.arap.change.VoTools;
import nc.vo.ep.dj.DJZBHeaderVO;
import nc.vo.ep.dj.DJZBItemVO;
import nc.vo.ep.dj.DJZBVO;
import nc.vo.ia.bill.BillHeaderVO;
import nc.vo.ia.bill.BillItemVO;
import nc.vo.ia.bill.BillVO;
import nc.vo.ic.pub.bill.GeneralBillHeaderVO;
import nc.vo.ic.pub.bill.GeneralBillItemVO;
import nc.vo.ic.pub.bill.GeneralBillVO;
import nc.vo.pi.InvoiceHeaderVO;
import nc.vo.pi.InvoiceItemVO;
import nc.vo.pi.InvoiceVO;
import nc.vo.ps.estimate.EstimateVO;
import nc.vo.ps.estimate.GeneralBb3VO;
import nc.vo.ps.estimate.GeneralHHeaderVO;
import nc.vo.ps.estimate.GeneralHItemVO;
import nc.vo.ps.factor.CostfactorHeaderVO;
import nc.vo.ps.factor.CostfactorVO;
import nc.vo.ps.settle.FeeDetailVO;
import nc.vo.ps.settle.FeeinvoiceVO;
import nc.vo.ps.settle.IAdjuestVO;
import nc.vo.ps.settle.IBillHeaderVO;
import nc.vo.ps.settle.IBillItemVO;
import nc.vo.ps.settle.IdTsData;
import nc.vo.ps.settle.IinvoiceVO;
import nc.vo.ps.settle.MaterialVO;
import nc.vo.ps.settle.OorderVO;
import nc.vo.ps.settle.SaledataVO;
import nc.vo.ps.settle.SettlebillHeaderVO;
import nc.vo.ps.settle.SettlebillItemVO;
import nc.vo.ps.settle.SettlebillVO;
import nc.vo.ps.settle.StockVO;
import nc.vo.pu.util.PuUtils;
import nc.vo.pub.BusinessException;
import nc.vo.pub.CircularlyAccessibleValueObject;
import nc.vo.pub.compiler.PfParameterVO;
import nc.vo.pub.formulaset.VarryVO;
import nc.vo.pub.formulaset.util.StringUtil;
import nc.vo.pub.lang.UFBoolean;
import nc.vo.pub.lang.UFDate;
import nc.vo.pub.lang.UFDateTime;
import nc.vo.pub.lang.UFDouble;
import nc.vo.pub.pfflow04.MessagedriveVO;
import nc.vo.pub.query.ConditionVO;
import nc.vo.scm.constant.ScmConst;
import nc.vo.scm.pattern.pub.ListToArrayTool;
import nc.vo.scm.pu.BillStatus;
import nc.vo.scm.pu.BillTypeConst;
import nc.vo.scm.pu.PuPubVO;
import nc.vo.scm.pu.RelationsCalVO;
import nc.vo.scm.pu.Timer;
import nc.vo.scm.pub.SCMEnv;
import nc.vo.scm.pub.TempTableVO;
import nc.vo.scm.pub.bill.IExamAVO;
import nc.vo.scm.pub.session.ClientLink;
import nc.vo.scm.pub.vosplit.SplitBillVOs;

/**
 * Settlebill的BO类 创建日期：(2001-5-26)
 * 
 * @author：
 */
public class SettleImpl implements ISettle, IPuToIc_SettleImpl {

  /**
   * SettlebillImpl 构造子注解。
   */
  public SettleImpl() {
    super();
  }

  /*
   * 结算时入库单VO转换为库存入库单VO,服务于暂估VO对照 StockVO --> GeneralBillVO 2007-03-20 xhq
   */
  private GeneralBillVO switchVOFromStock2IC(StockVO stockVO) {
    GeneralBillItemVO bodyVO = new GeneralBillItemVO();

    bodyVO.setCgeneralbid(stockVO.getCgeneralbid());
    bodyVO.setCgeneralhid(stockVO.getCgeneralhid());

    bodyVO.setCinventoryid(stockVO.getCmangid());
    bodyVO.setVbatchcode(stockVO.getVbatchcode());
    bodyVO.setNinnum(stockVO.getNinnum());
    bodyVO.setNmny(stockVO.getNmoney());
    bodyVO.setNprice(stockVO.getNprice());

    bodyVO.setCaccountunitid(stockVO.getCastunitid());
    bodyVO.setHsl(stockVO.getHsl());
    if (stockVO.getHsl() != null
        && Math.abs(stockVO.getHsl().doubleValue()) > 0)
      stockVO.setNassistinnum(stockVO.getNinnum().div(stockVO.getHsl()));
    bodyVO.setNinassistnum(stockVO.getNassistinnum());
    // since v502
    bodyVO.setCastunitid(stockVO.getCastunitid());
    bodyVO.setHsl(stockVO.getHsl());

    bodyVO.setCfirstbillhid(stockVO.getCfirstbillhid());
    bodyVO.setCfirstbillbid(stockVO.getCfirstbillbid());
    bodyVO.setCfirsttype(stockVO.getCfirsttype());

    bodyVO.setVfree1(stockVO.getVfree1());
    bodyVO.setVfree2(stockVO.getVfree2());
    bodyVO.setVfree3(stockVO.getVfree3());
    bodyVO.setVfree4(stockVO.getVfree4());
    bodyVO.setVfree5(stockVO.getVfree5());

    bodyVO.setCprojectid(stockVO.getCprojectid());
    bodyVO.setCprojectphaseid(stockVO.getCprojectphaseid());

    bodyVO.setVuserdef1(stockVO.getVuserdefb1());
    bodyVO.setVuserdef2(stockVO.getVuserdefb2());
    bodyVO.setVuserdef3(stockVO.getVuserdefb3());
    bodyVO.setVuserdef4(stockVO.getVuserdefb4());
    bodyVO.setVuserdef5(stockVO.getVuserdefb5());
    bodyVO.setVuserdef6(stockVO.getVuserdefb6());
    bodyVO.setVuserdef7(stockVO.getVuserdefb7());
    bodyVO.setVuserdef8(stockVO.getVuserdefb8());
    bodyVO.setVuserdef9(stockVO.getVuserdefb9());
    bodyVO.setVuserdef10(stockVO.getVuserdefb10());

    bodyVO.setAttributeValue("vuserdef11", stockVO.getVuserdefb11());
    bodyVO.setAttributeValue("vuserdef12", stockVO.getVuserdefb12());
    bodyVO.setAttributeValue("vuserdef13", stockVO.getVuserdefb13());
    bodyVO.setAttributeValue("vuserdef14", stockVO.getVuserdefb14());
    bodyVO.setAttributeValue("vuserdef15", stockVO.getVuserdefb15());
    bodyVO.setAttributeValue("vuserdef16", stockVO.getVuserdefb16());
    bodyVO.setAttributeValue("vuserdef17", stockVO.getVuserdefb17());
    bodyVO.setAttributeValue("vuserdef18", stockVO.getVuserdefb18());
    bodyVO.setAttributeValue("vuserdef19", stockVO.getVuserdefb19());
    bodyVO.setAttributeValue("vuserdef20", stockVO.getVuserdefb20());

    bodyVO.setAttributeValue("pk_defdoc1", stockVO.getPk_defdocb1());
    bodyVO.setAttributeValue("pk_defdoc2", stockVO.getPk_defdocb2());
    bodyVO.setAttributeValue("pk_defdoc3", stockVO.getPk_defdocb3());
    bodyVO.setAttributeValue("pk_defdoc4", stockVO.getPk_defdocb4());
    bodyVO.setAttributeValue("pk_defdoc5", stockVO.getPk_defdocb5());
    bodyVO.setAttributeValue("pk_defdoc6", stockVO.getPk_defdocb6());
    bodyVO.setAttributeValue("pk_defdoc7", stockVO.getPk_defdocb7());
    bodyVO.setAttributeValue("pk_defdoc8", stockVO.getPk_defdocb8());
    bodyVO.setAttributeValue("pk_defdoc9", stockVO.getPk_defdocb9());
    bodyVO.setAttributeValue("pk_defdoc10", stockVO.getPk_defdocb10());

    bodyVO.setAttributeValue("pk_defdoc11", stockVO.getPk_defdocb11());
    bodyVO.setAttributeValue("pk_defdoc12", stockVO.getPk_defdocb12());
    bodyVO.setAttributeValue("pk_defdoc13", stockVO.getPk_defdocb13());
    bodyVO.setAttributeValue("pk_defdoc14", stockVO.getPk_defdocb14());
    bodyVO.setAttributeValue("pk_defdoc15", stockVO.getPk_defdocb15());
    bodyVO.setAttributeValue("pk_defdoc16", stockVO.getPk_defdocb16());
    bodyVO.setAttributeValue("pk_defdoc17", stockVO.getPk_defdocb17());
    bodyVO.setAttributeValue("pk_defdoc18", stockVO.getPk_defdocb18());
    bodyVO.setAttributeValue("pk_defdoc19", stockVO.getPk_defdocb19());
    bodyVO.setAttributeValue("pk_defdoc20", stockVO.getPk_defdocb20());

    bodyVO.setDbizdate(stockVO.getDbizdate());
    bodyVO.setCvendorid(stockVO.getCvendorid());

    GeneralBillHeaderVO headVO = new GeneralBillHeaderVO();
    headVO.setPk_corp(stockVO.getPk_corp());
    headVO.setCbilltypecode(stockVO.getCbilltype());
    headVO.setCgeneralhid(stockVO.getCgeneralhid());

    headVO.setCdispatcherid(stockVO.getCdispatcherid());

    headVO.setCbiztypeid(stockVO.getCbiztype());
    headVO.setPk_calbody(stockVO.getCstoreorganization());
    headVO.setCwarehouseid(stockVO.getCwarehouseid());

    headVO.setCdptid(stockVO.getCdeptid());
    headVO.setCproviderid(stockVO.getCprovidermangid());

    headVO.setVnote(stockVO.getVnote());
    headVO.setCwhsmanagerid(stockVO.getCwhsmanagerid());
    headVO.setCbizid(stockVO.getCoperatorid());

    headVO.setVbillcode(stockVO.getVbillcode());
    headVO.setIscalculatedinvcost(stockVO.getBcalculatecost());

    headVO.setVuserdef1(stockVO.getVuserdefh1());
    headVO.setVuserdef2(stockVO.getVuserdefh2());
    headVO.setVuserdef3(stockVO.getVuserdefh3());
    headVO.setVuserdef4(stockVO.getVuserdefh4());
    headVO.setVuserdef5(stockVO.getVuserdefh5());
    headVO.setVuserdef6(stockVO.getVuserdefh6());
    headVO.setVuserdef7(stockVO.getVuserdefh7());
    headVO.setVuserdef8(stockVO.getVuserdefh8());
    headVO.setVuserdef9(stockVO.getVuserdefh9());
    headVO.setVuserdef10(stockVO.getVuserdefh10());

    headVO.setAttributeValue("vuserdef11", stockVO.getVuserdefh11());
    headVO.setAttributeValue("vuserdef12", stockVO.getVuserdefh12());
    headVO.setAttributeValue("vuserdef13", stockVO.getVuserdefh13());
    headVO.setAttributeValue("vuserdef14", stockVO.getVuserdefh14());
    headVO.setAttributeValue("vuserdef15", stockVO.getVuserdefh15());
    headVO.setAttributeValue("vuserdef16", stockVO.getVuserdefh16());
    headVO.setAttributeValue("vuserdef17", stockVO.getVuserdefh17());
    headVO.setAttributeValue("vuserdef18", stockVO.getVuserdefh18());
    headVO.setAttributeValue("vuserdef19", stockVO.getVuserdefh19());
    headVO.setAttributeValue("vuserdef20", stockVO.getVuserdefh20());

    headVO.setAttributeValue("pk_defdoc1", stockVO.getPk_defdoch1());
    headVO.setAttributeValue("pk_defdoc2", stockVO.getPk_defdoch2());
    headVO.setAttributeValue("pk_defdoc3", stockVO.getPk_defdoch3());
    headVO.setAttributeValue("pk_defdoc4", stockVO.getPk_defdoch4());
    headVO.setAttributeValue("pk_defdoc5", stockVO.getPk_defdoch5());
    headVO.setAttributeValue("pk_defdoc6", stockVO.getPk_defdoch6());
    headVO.setAttributeValue("pk_defdoc7", stockVO.getPk_defdoch7());
    headVO.setAttributeValue("pk_defdoc8", stockVO.getPk_defdoch8());
    headVO.setAttributeValue("pk_defdoc9", stockVO.getPk_defdoch9());
    headVO.setAttributeValue("pk_defdoc10", stockVO.getPk_defdoch10());

    headVO.setAttributeValue("pk_defdoc11", stockVO.getPk_defdoch11());
    headVO.setAttributeValue("pk_defdoc12", stockVO.getPk_defdoch12());
    headVO.setAttributeValue("pk_defdoc13", stockVO.getPk_defdoch13());
    headVO.setAttributeValue("pk_defdoc14", stockVO.getPk_defdoch14());
    headVO.setAttributeValue("pk_defdoc15", stockVO.getPk_defdoch15());
    headVO.setAttributeValue("pk_defdoc16", stockVO.getPk_defdoch16());
    headVO.setAttributeValue("pk_defdoc17", stockVO.getPk_defdoch17());
    headVO.setAttributeValue("pk_defdoc18", stockVO.getPk_defdoch18());
    headVO.setAttributeValue("pk_defdoc19", stockVO.getPk_defdoch19());
    headVO.setAttributeValue("pk_defdoc20", stockVO.getPk_defdoch20());

    GeneralBillVO VO = new GeneralBillVO(1);
    VO.setParentVO(headVO);
    VO.setChildrenVO(new GeneralBillItemVO[] {
      bodyVO
    });
    return VO;
  }

  /*
   * 结算时入库单VO转换为库存入库单VO,服务于暂估VO对照 GeneralHHeaderVO,GeneralHItemVO -->
   * GeneralBillVO 2007-03-20 xhq
   */
  private GeneralBillVO switchVOFromGeneral2IC(
      GeneralHHeaderVO generalHHeaderVO, GeneralHItemVO generalHItemVO) {
    GeneralBillItemVO bodyVO = new GeneralBillItemVO();

    // since v502,by czp
    bodyVO.setCastunitid(generalHItemVO.getCastunitid());
    //
    bodyVO.setCgeneralbid(generalHItemVO.getCgeneralbid());
    bodyVO.setCgeneralhid(generalHItemVO.getCgeneralhid());

    bodyVO.setCinventoryid(generalHItemVO.getCinventoryid());
    bodyVO.setVbatchcode(generalHItemVO.getVbatchcode());
    bodyVO.setNinnum(generalHItemVO.getNinnum());
    bodyVO.setNmny(generalHItemVO.getNmny());
    bodyVO.setNprice(generalHItemVO.getNprice());

    bodyVO.setCaccountunitid(generalHItemVO.getCastunitid());
    bodyVO.setHsl(generalHItemVO.getHsl());
    if (generalHItemVO.getNinnum() != null && generalHItemVO.getHsl() != null
        && Math.abs(generalHItemVO.getHsl().doubleValue()) > 0)
      generalHItemVO.setNinassistnum(generalHItemVO.getNinnum().div(
          generalHItemVO.getHsl()));
    bodyVO.setNinassistnum(generalHItemVO.getNinassistnum());

    bodyVO.setCfirstbillhid(generalHItemVO.getCfirstbillhid());
    bodyVO.setCfirstbillbid(generalHItemVO.getCfirstbillbid());
    bodyVO.setCfirsttype(generalHItemVO.getCfirsttype());

    bodyVO.setVfree1(generalHItemVO.getVfree1());
    bodyVO.setVfree2(generalHItemVO.getVfree2());
    bodyVO.setVfree3(generalHItemVO.getVfree3());
    bodyVO.setVfree4(generalHItemVO.getVfree4());
    bodyVO.setVfree5(generalHItemVO.getVfree5());

    bodyVO.setCprojectid(generalHItemVO.getCprojectid());
    bodyVO.setCprojectphaseid(generalHItemVO.getCprojectphaseid());

    bodyVO.setVuserdef1(generalHItemVO.getVuserdef1());
    bodyVO.setVuserdef2(generalHItemVO.getVuserdef2());
    bodyVO.setVuserdef3(generalHItemVO.getVuserdef3());
    bodyVO.setVuserdef4(generalHItemVO.getVuserdef4());
    bodyVO.setVuserdef5(generalHItemVO.getVuserdef5());
    bodyVO.setVuserdef6(generalHItemVO.getVuserdef6());
    bodyVO.setVuserdef7(generalHItemVO.getVuserdef7());
    bodyVO.setVuserdef8(generalHItemVO.getVuserdef8());
    bodyVO.setVuserdef9(generalHItemVO.getVuserdef9());
    bodyVO.setVuserdef10(generalHItemVO.getVuserdef10());

    bodyVO.setAttributeValue("vuserdef11", generalHItemVO.getVuserdef11());
    bodyVO.setAttributeValue("vuserdef12", generalHItemVO.getVuserdef12());
    bodyVO.setAttributeValue("vuserdef13", generalHItemVO.getVuserdef13());
    bodyVO.setAttributeValue("vuserdef14", generalHItemVO.getVuserdef14());
    bodyVO.setAttributeValue("vuserdef15", generalHItemVO.getVuserdef15());
    bodyVO.setAttributeValue("vuserdef16", generalHItemVO.getVuserdef16());
    bodyVO.setAttributeValue("vuserdef17", generalHItemVO.getVuserdef17());
    bodyVO.setAttributeValue("vuserdef18", generalHItemVO.getVuserdef18());
    bodyVO.setAttributeValue("vuserdef19", generalHItemVO.getVuserdef19());
    bodyVO.setAttributeValue("vuserdef20", generalHItemVO.getVuserdef20());

    bodyVO.setAttributeValue("pk_defdoc1", generalHItemVO.getPk_defdoc1());
    bodyVO.setAttributeValue("pk_defdoc2", generalHItemVO.getPk_defdoc2());
    bodyVO.setAttributeValue("pk_defdoc3", generalHItemVO.getPk_defdoc3());
    bodyVO.setAttributeValue("pk_defdoc4", generalHItemVO.getPk_defdoc4());
    bodyVO.setAttributeValue("pk_defdoc5", generalHItemVO.getPk_defdoc5());
    bodyVO.setAttributeValue("pk_defdoc6", generalHItemVO.getPk_defdoc6());
    bodyVO.setAttributeValue("pk_defdoc7", generalHItemVO.getPk_defdoc7());
    bodyVO.setAttributeValue("pk_defdoc8", generalHItemVO.getPk_defdoc8());
    bodyVO.setAttributeValue("pk_defdoc9", generalHItemVO.getPk_defdoc9());
    bodyVO.setAttributeValue("pk_defdoc10", generalHItemVO.getPk_defdoc10());

    bodyVO.setAttributeValue("pk_defdoc11", generalHItemVO.getPk_defdoc11());
    bodyVO.setAttributeValue("pk_defdoc12", generalHItemVO.getPk_defdoc12());
    bodyVO.setAttributeValue("pk_defdoc13", generalHItemVO.getPk_defdoc13());
    bodyVO.setAttributeValue("pk_defdoc14", generalHItemVO.getPk_defdoc14());
    bodyVO.setAttributeValue("pk_defdoc15", generalHItemVO.getPk_defdoc15());
    bodyVO.setAttributeValue("pk_defdoc16", generalHItemVO.getPk_defdoc16());
    bodyVO.setAttributeValue("pk_defdoc17", generalHItemVO.getPk_defdoc17());
    bodyVO.setAttributeValue("pk_defdoc18", generalHItemVO.getPk_defdoc18());
    bodyVO.setAttributeValue("pk_defdoc19", generalHItemVO.getPk_defdoc19());
    bodyVO.setAttributeValue("pk_defdoc20", generalHItemVO.getPk_defdoc20());

    bodyVO.setDbizdate(generalHItemVO.getDbizdate());
    bodyVO.setCvendorid(generalHItemVO.getCvendorid());

    GeneralBillHeaderVO headVO = new GeneralBillHeaderVO();
    headVO.setPk_corp(generalHHeaderVO.getPk_corp());
    headVO.setCbilltypecode(generalHHeaderVO.getCbilltypecode());
    headVO.setCgeneralhid(generalHHeaderVO.getCgeneralhid());

    headVO.setCdispatcherid(generalHHeaderVO.getCdispatcherid());

    headVO.setCbiztypeid(generalHHeaderVO.getCbiztype());
    headVO.setPk_calbody(generalHHeaderVO.getCstoreorganization());
    headVO.setCwarehouseid(generalHHeaderVO.getCwarehouseid());

    headVO.setCdptid(generalHHeaderVO.getCdptid());
    headVO.setCproviderid(generalHHeaderVO.getCproviderid());

    headVO.setVnote(generalHHeaderVO.getVnote());
    headVO.setCwhsmanagerid(generalHHeaderVO.getCwhsmanagerid());
    headVO.setCbizid(generalHHeaderVO.getCoperatorid());

    headVO.setVbillcode(generalHHeaderVO.getVbillcode());
    headVO.setIscalculatedinvcost(generalHHeaderVO.getBcalculatecost());

    headVO.setVuserdef1(generalHHeaderVO.getVuserdef1());
    headVO.setVuserdef2(generalHHeaderVO.getVuserdef2());
    headVO.setVuserdef3(generalHHeaderVO.getVuserdef3());
    headVO.setVuserdef4(generalHHeaderVO.getVuserdef4());
    headVO.setVuserdef5(generalHHeaderVO.getVuserdef5());
    headVO.setVuserdef6(generalHHeaderVO.getVuserdef6());
    headVO.setVuserdef7(generalHHeaderVO.getVuserdef7());
    headVO.setVuserdef8(generalHHeaderVO.getVuserdef8());
    headVO.setVuserdef9(generalHHeaderVO.getVuserdef9());
    headVO.setVuserdef10(generalHHeaderVO.getVuserdef10());

    headVO.setAttributeValue("vuserdef11", generalHHeaderVO.getVuserdef11());
    headVO.setAttributeValue("vuserdef12", generalHHeaderVO.getVuserdef12());
    headVO.setAttributeValue("vuserdef13", generalHHeaderVO.getVuserdef13());
    headVO.setAttributeValue("vuserdef14", generalHHeaderVO.getVuserdef14());
    headVO.setAttributeValue("vuserdef15", generalHHeaderVO.getVuserdef15());
    headVO.setAttributeValue("vuserdef16", generalHHeaderVO.getVuserdef16());
    headVO.setAttributeValue("vuserdef17", generalHHeaderVO.getVuserdef17());
    headVO.setAttributeValue("vuserdef18", generalHHeaderVO.getVuserdef18());
    headVO.setAttributeValue("vuserdef19", generalHHeaderVO.getVuserdef19());
    headVO.setAttributeValue("vuserdef20", generalHHeaderVO.getVuserdef20());

    headVO.setAttributeValue("pk_defdoc1", generalHHeaderVO.getPk_defdoc1());
    headVO.setAttributeValue("pk_defdoc2", generalHHeaderVO.getPk_defdoc2());
    headVO.setAttributeValue("pk_defdoc3", generalHHeaderVO.getPk_defdoc3());
    headVO.setAttributeValue("pk_defdoc4", generalHHeaderVO.getPk_defdoc4());
    headVO.setAttributeValue("pk_defdoc5", generalHHeaderVO.getPk_defdoc5());
    headVO.setAttributeValue("pk_defdoc6", generalHHeaderVO.getPk_defdoc6());
    headVO.setAttributeValue("pk_defdoc7", generalHHeaderVO.getPk_defdoc7());
    headVO.setAttributeValue("pk_defdoc8", generalHHeaderVO.getPk_defdoc8());
    headVO.setAttributeValue("pk_defdoc9", generalHHeaderVO.getPk_defdoc9());
    headVO.setAttributeValue("pk_defdoc10", generalHHeaderVO.getPk_defdoc10());

    headVO.setAttributeValue("pk_defdoc11", generalHHeaderVO.getPk_defdoc11());
    headVO.setAttributeValue("pk_defdoc12", generalHHeaderVO.getPk_defdoc12());
    headVO.setAttributeValue("pk_defdoc13", generalHHeaderVO.getPk_defdoc13());
    headVO.setAttributeValue("pk_defdoc14", generalHHeaderVO.getPk_defdoc14());
    headVO.setAttributeValue("pk_defdoc15", generalHHeaderVO.getPk_defdoc15());
    headVO.setAttributeValue("pk_defdoc16", generalHHeaderVO.getPk_defdoc16());
    headVO.setAttributeValue("pk_defdoc17", generalHHeaderVO.getPk_defdoc17());
    headVO.setAttributeValue("pk_defdoc18", generalHHeaderVO.getPk_defdoc18());
    headVO.setAttributeValue("pk_defdoc19", generalHHeaderVO.getPk_defdoc19());
    headVO.setAttributeValue("pk_defdoc20", generalHHeaderVO.getPk_defdoc20());

    GeneralBillVO VO = new GeneralBillVO(1);
    VO.setParentVO(headVO);
    VO.setChildrenVO(new GeneralBillItemVO[] {
      bodyVO
    });
    return VO;
  }

  /**
   * 功能描述:结算单作废时向应付系统传送数据 输入参数: String cGeneralhid[], 入库单头ID[] String cOperator,
   * 操作员ID 作者：熊海情 修改：晁志平 For V30
   */
  private void deleteBillForARAP(String cGeneralhid[], String cOperator)
      throws BusinessException {
    // DJZBBO myService = null;
    // try {
    // myService = new DJZBBO();
    // myService.deleteOutBill(cGeneralhid, cOperator);
    // new InterServBO().getInterResult(ProductCode.PROD_AP,
    // InterRegister.AP0002, null,
    // InterRegister.AP0002_deleteOutBill, new Object[] {
    // cGeneralhid, cOperator });
    // } catch (Exception e) {
    /* 调用采购公用方法按规范抛出异常 */
    // reportException(e);
    // nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    // }
    ArapHelper.deleteOutArapBillByPks(cGeneralhid);
  }

  /**
   * 功能描述:结算单作废时向存货核算系统传送数据--VMI 输入参数:SettlebillVO settleVO 结算单VO 作者：熊海情 修改：晁志平
   * For V30
   * 
   * @deprecated since v502, 废弃的方法
   */
  private void deleteBillFromOutter(SettlebillVO settleVO, String strCorpId,
      String strOperatorId) throws BusinessException {
    // BillBO myService = null;
    // IIAToPUBill myService = null;
    // try {
    // if (settleVO == null || settleVO.getParentVO() == null
    // || settleVO.getParentVO().getPrimaryKey() == null) {
    // SCMEnv.out("无法获取结算单头ID，没有存货核算单据被删除，直接返回!");
    // return;
    // }
    // // myService = new BillBO();
    // // myService = (IIAToPUBill) new
    // //
    // InterServBO().getInterInstance(ProductCode.PROD_IA,InterRegister.IA0101);
    // myService = (IIAToPUBill) NCLocator.getInstance().lookup(
    // IIAToPUBill.class.getName());
    // myService.deleteBillFromOutterArray(new String[] { settleVO
    // .getParentVO().getPrimaryKey() }, strCorpId, strOperatorId);
    // } catch (Exception e) {
    // /* 调用采购公用方法按规范抛出异常 */
    // // reportException(e);
    // nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    // }
  }

  /**
   * 功能描述:航天中汇专用(获得供应商管理档案中custflag为2或3的pk_cubasdoc及custname,custflag)
   * 日期:2002/09/14
   */
  public void deleteVendorRecord(String pk_cubasdoc[]) throws BusinessException {
    try {
      SettleDMO dmo = new SettleDMO();
      dmo.deleteVendorRecord(pk_cubasdoc);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
  }

  /*
   * 过滤掉虚拟发票，返回
   */
  private IinvoiceVO[] getRealUpdateVos(IinvoiceVO[] iinvoiceVOs,
      String[] saHidVirtual) {
    if (iinvoiceVOs == null || iinvoiceVOs.length == 0) {
      return null;
    }
    if (saHidVirtual == null || saHidVirtual.length == 0) {
      return iinvoiceVOs;
    }
    HashMap<String, String> mapVirtualHids = new HashMap<String, String>();
    for (String strHid : saHidVirtual) {
      if (strHid == null) {
        continue;
      }
      mapVirtualHids.put(strHid, "");
    }
    if (mapVirtualHids.size() == saHidVirtual.length) {
      return null;
    }
    //
    ArrayList<IinvoiceVO> listRealUpdateVos = new ArrayList<IinvoiceVO>();
    for (IinvoiceVO vo : iinvoiceVOs) {
      if (vo == null || vo.getCinvoiceid() == null) {
        continue;
      }
      // 非虚拟发票才更新
      if (!mapVirtualHids.containsKey(vo.getCinvoiceid())) {
        listRealUpdateVos.add(vo);
      }
    }
    //
    if (listRealUpdateVos.size() == 0) {
      return null;
    }
    IinvoiceVO[] voaRealUpdate = listRealUpdateVos
        .toArray(new IinvoiceVO[listRealUpdateVos.size()]);
    //
    return voaRealUpdate;
  }

  /*
   * 作废结算单 
   */
  private void discardSettlebill(ArrayList listPara, UFBoolean ufbZGYF) throws BusinessException {
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    if (listPara == null || listPara.size() < 8) {
      SCMEnv.out("程序BUG:传入参数错误，直接返回！");
      return;
    }
    SettlebillVO settleVO = (SettlebillVO) listPara.get(0); // 结算单VO
    StockVO[] stockVOs = (StockVO[]) listPara.get(1); // 恢复的入库单VO
    IinvoiceVO[] iinvoiceVOs = (IinvoiceVO[]) listPara.get(2); // 发票VO
    FeeinvoiceVO[] feeVOs = (FeeinvoiceVO[]) listPara.get(3); // 费用发票VO
    FeeinvoiceVO[] discountVOs = (FeeinvoiceVO[]) listPara.get(4); // 折扣VO
    FeeinvoiceVO[] specialVOs = (FeeinvoiceVO[]) listPara.get(5); // 特殊发票VO
    String strOperatorId = (String) listPara.get(6); // 操作员
    String strCorpId = (String) listPara.get(7); // 登录公司
    //
    SettleDMO dmo = null;
    InvoiceImpl myService1 = null;
    ICreateCorpQueryService myService0 = null;
    boolean bLock = false;
    
    //{发票体ID=是否传应付}
    Hashtable<String, UFBoolean> hInvoiceApFlag = new Hashtable<String, UFBoolean>();
    //{发票体ID=是否虚拟发票}
    Hashtable<String, UFBoolean> hInvoiceVirtual = new Hashtable<String, UFBoolean>();
    if (iinvoiceVOs != null && iinvoiceVOs.length > 0) {
      for (int i = 0; i < iinvoiceVOs.length; i++){
        hInvoiceApFlag.put(iinvoiceVOs[i].getCinvoice_bid(), iinvoiceVOs[i].getApFlag());
        hInvoiceVirtual.put(iinvoiceVOs[i].getCinvoice_bid(), 
            new UFBoolean(iinvoiceVOs[i].getIInvoiceType() != null && iinvoiceVOs[i].getIInvoiceType().intValue() == 3));
      }
    }
    //

    // 组合所有需要加锁的主键
    String sKeys[] = getSettleLockKeys(stockVOs, iinvoiceVOs, feeVOs,
        discountVOs, specialVOs, null, null);

    timer.addExecutePhase("组合所有需要加锁的主键");

    // 结算单头主键需要加锁
    Vector v = new Vector();
    for (int i = 0; i < sKeys.length; i++)
      v.addElement(sKeys[i]);
    SettlebillItemVO[] voaSettlebillItem = settleVO.getBodyVO();
    v.addElement(settleVO.getHeadVO().getCsettlebillid());

    // vmi主键需要加锁
    for (int i = 0; i < voaSettlebillItem.length; i++) {
      if (voaSettlebillItem[i].getCvmiid() != null && !v.contains(voaSettlebillItem[i].getCvmiid()))
        v.addElement(voaSettlebillItem[i].getCvmiid());
    }

    sKeys = new String[v.size()];
    v.copyInto(sKeys);

    try {
      dmo = new SettleDMO();
      // 对单据加锁
      bLock = LockTool.setLockForPks(sKeys, strOperatorId);
      if (!bLock) {
        throw new BusinessException(NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000009")/*@res"正在进行相关操作，请稍后再试！"*/);
      }

      timer.addExecutePhase("对单据加锁");

      // 判断时间戳是否改变
      String sMessage = isTimeStampChangedForDepose(stockVOs, iinvoiceVOs,
          feeVOs, discountVOs, specialVOs, new SettlebillVO[] { settleVO });
      if (sMessage != null && sMessage.length() > 0) {
        sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID("40040502", "UPP40040502-000002")/*@res "请刷新！\n"*/;
        throw new BusinessException(sMessage);
      }

      timer.addExecutePhase("判断时间戳是否改变(总)");

      // 公司启用暂估应付参数[PO52=‘Y’]、普通采购发票已经传应付后不允许删除结算单
      if (hInvoiceApFlag.size() > 0 && settleVO != null) {
        UFBoolean bApFlag = UFBoolean.FALSE;
        UFBoolean bVirFlag = null;
        for (int i = 0; i < voaSettlebillItem.length; i++) {
          String cinvoice_bid = voaSettlebillItem[i].getCinvoice_bid();
          if(cinvoice_bid != null){
            if(bApFlag == null || !bApFlag.booleanValue()){
              bApFlag = hInvoiceApFlag.get(cinvoice_bid);
            }
            if(bVirFlag == null || bVirFlag.booleanValue()){
              bVirFlag = hInvoiceVirtual.get(cinvoice_bid);
            }
          }
        }
        // 暂估应付启用、已经传应付、非虚拟发票：不允许删除结算单
        if (ufbZGYF.booleanValue() && bApFlag!=null && bApFlag.booleanValue() &&
            (bVirFlag == null || !bVirFlag.booleanValue())) {
          throw new BusinessException(NCLangResOnserver.getInstance().
              getStrByID("40040502", "UPP40040502-000239")/* "公司启用暂估应付参数[PO52=‘Y’]、普通采购发票已经传应付后不允许删除结算单" */);
        }
      }

      // 恢复入库单
      if (stockVOs != null && stockVOs.length > 0) {
        dmo.updateStock(stockVOs, false);
      }

      if (isFeeSettle(settleVO)) {// 更新入库单累计费用结算次数
        ArrayList<String> srlist = new ArrayList<String>();
        SettlebillItemVO[] itemVO = settleVO.getBodyVO();
        for (int i = 0; i < itemVO.length; i++) {
          if (itemVO[i].getCstockrow() != null
              && itemVO[i].getCstockrow().trim().length() != 0) {
            if (!srlist.contains(itemVO[i].getCstockrow()))
              srlist.add(itemVO[i].getCstockrow());
          }
        }
        dmo.updateFeeSettletimes(srlist, false);
      }

      timer.addExecutePhase("恢复入库单");

      // 作废虚拟发票
      String[] saHidVirtual = null;
      if (settleVO != null) {
        saHidVirtual = discardVirtualInvoices(settleVO, iinvoiceVOs);
      }

      timer.addExecutePhase("作废虚拟发票");

      // 过滤虚拟发票
      IinvoiceVO[] iinvoiceVOsReal = getRealUpdateVos(iinvoiceVOs, saHidVirtual);

      timer.addExecutePhase("过滤虚拟发票");

      // 恢复一般发票(虚拟发票不必更新)
      if (iinvoiceVOsReal != null && iinvoiceVOsReal.length > 0) {
        dmo.updateInvoice(iinvoiceVOsReal);
      }

      timer.addExecutePhase("恢复发票");

      // 恢复费用发票
      if (feeVOs != null && feeVOs.length > 0) {
        dmo.updateFee(feeVOs);
      }

      timer.addExecutePhase("恢复费用发票");

      // 恢复折扣
      if (discountVOs != null && discountVOs.length > 0) {
        dmo.updateDiscount(discountVOs);
      }

      timer.addExecutePhase("恢复折扣");

      // 恢复一般发票
      if (specialVOs != null && specialVOs.length > 0) {
        dmo.updateDiscount(specialVOs);
      }

      timer.addExecutePhase("恢复一般发票");

      // 作废结算单
      dmo.discardSettlebill(settleVO);

      timer.addExecutePhase("作废结算单");

      // 如果为受托代销结算单，则应回写销售发票的累计结算数量，作废发票
      boolean bIsFrmSaleData = false;
      if (voaSettlebillItem != null && voaSettlebillItem.length > 0 && voaSettlebillItem[0] != null
          && voaSettlebillItem[0].getCsale_bid() != null
          && voaSettlebillItem[0].getCsale_bid().trim().length() > 0) {
        bIsFrmSaleData = true;
      }
      if (bIsFrmSaleData) {
        // 回写采购销售数据表
        int iLen = voaSettlebillItem == null ? 0 : voaSettlebillItem.length;
        for (int i = 0; i < iLen; i++) {
          if (voaSettlebillItem[i].getNsettlenum() != null) {
            voaSettlebillItem[i].setNsettlenum(voaSettlebillItem[i].getNsettlenum().multiply(-1.0));
          }
        }
        dmo.updateSaleDataBatch(voaSettlebillItem, false);

        if (iinvoiceVOs != null && iinvoiceVOs.length > 0)
          dmo.updateAccumInvoiceNumForOrder(iinvoiceVOs);

        timer.addExecutePhase("受托代销结算单回写销售发票的累计结算数量");

        // 发票ID唯一性集合
        Vector vTemp = new Vector();
        String s1 = voaSettlebillItem[0].getCinvoiceid();
        if (s1 != null && s1.trim().length() > 0)
          vTemp.addElement(s1.trim());
        for (int i = 1; i < voaSettlebillItem.length; i++) {
          s1 = voaSettlebillItem[i].getCinvoiceid();
          if (s1 != null && s1.trim().length() > 0) {
            if (!vTemp.contains(s1.trim()))
              vTemp.addElement(s1.trim());
          }
        }

        if (vTemp.size() > 0) {
          String s[] = new String[vTemp.size()];
          vTemp.copyInto(s);

          myService1 = new InvoiceImpl();
          myService1.discardInvoiceForSettle(s);
        }

        timer.addExecutePhase("受托代销结算单作废发票");
      }
      // 回写VMI明细
      rewriteVMIAntiSettle(settleVO);

      timer.addExecutePhase("回写VMI明细");

      // 判断存货核算和应付是否启用
      if (settleVO != null) {
        String unitCode = settleVO.getHeadVO().getPk_corp();
        myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
            .getInstance().lookup(ICreateCorpQueryService.class.getName());
        //
        boolean bIsFromVMI = isFromVMI(settleVO);
        // 结算单作废时向存货核算系统传送数据
        boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");
        if (bIAStartUp) {
          // 调用接口
          IIAToPU srvIa = (IIAToPU) NCLocator.getInstance().lookup(
              IIAToPU.class.getName());
          if (!bIsFromVMI) {
            String s[] = new String[1];
            s[0] = settleVO.getBodyVO()[0].getCsettlebillid();
            deleteBillFromOutters(s, strCorpId, strOperatorId);

            timer.addExecutePhase("结算单作废时向存货核算系统传送数据-非VMI");

          }
          // since v53, 删除VMI与普通单据分开调用
          else {
            srvIa.unSettleVMI(new String[] {
              settleVO.getParentVO().getPrimaryKey()
            }, PuUtils.getClintLink(strCorpId, strOperatorId, BsPuTool
                .getLoginDate()));
            timer.addExecutePhase("结算单作废时向存货核算系统传送数据-VMI");
          }
        }
        // 非VMI类型的结算单作废时向应付系统传送数据；since v502, 有虚拟发票时才需要删除收付单据
        if (!bIsFromVMI && saHidVirtual != null && saHidVirtual.length > 0) {
          boolean bAPStartUp = myService0.isEnabled(unitCode, "AP");
          if (bAPStartUp) {
            /*
             * 根据虚拟发票头ID获取入库单表体ID(虚拟发票表体的上层行ID为入库单行ID 参见NoneUI.doGeneration())
             */
            Hashtable hashHidClbh = new PubDMO()
                .queryHtResultFromAnyTable(
                    "po_invoice, po_invoice_b",
                    "po_invoice.cinvoiceid",
                    new String[] {
                        "po_invoice.clbh", "po_invoice_b.cupsourcebillrowid"
                    },
                    " po_invoice.cinvoiceid = po_invoice_b.cinvoiceid and po_invoice.cinvoiceid in "
                        + new TempTableUtil().getSubSql(saHidVirtual));
            Map<String, Map<String, String>> clbhs = new HashMap<String, Map<String, String>>();
            Map<String, String> mapDdhh = null;
            String strClbh = null;
            String strIcBillBid = null;
            Vector vClbh = null;
            IAdjuestVO[] voaAdjust = new IAdjuestVO[saHidVirtual.length];
            String strLylx = "1";
            for (int i = 0; i < saHidVirtual.length; i++) {
              voaAdjust[i] = new IAdjuestVO();
              voaAdjust[i].setCinvoiceid(saHidVirtual[i]);
              vClbh = (Vector) hashHidClbh.get(saHidVirtual[i]);
              if (vClbh == null || vClbh.size() == 0) {
                continue;
              }
              for (int j = 0; j < vClbh.size(); j++) {
                strClbh = (String) ((Object[]) vClbh.get(j))[0];
                if (PuPubVO.getString_TrimZeroLenAsNull(strClbh) == null) {
                  continue;
                }
                strIcBillBid = (String) ((Object[]) vClbh.get(j))[1];
                mapDdhh = clbhs.get(strClbh);
                if (mapDdhh == null) {
                  mapDdhh = new HashMap<String, String>();
                }
                mapDdhh.put(strIcBillBid, strLylx);
                clbhs.put(strClbh, mapDdhh);
              }
            }
            // 如果已结入库单未暂估，则不必冲减，此处也不必做处理编号的处理
            if (clbhs != null && clbhs.size() > 0) {
              IArapForGYLPublic iArap = (IArapForGYLPublic) NCLocator
                  .getInstance().lookup(IArapForGYLPublic.class.getName());
              iArap.unAdjuestForGC(clbhs, unitCode);

              // 更新处理编号
              new InvoiceDMO().updateClbh(voaAdjust, null, null, true);
            }
            else {
              SCMEnv.out("没有需要冲减的数据(结算单对应的入库单未暂估情况)");/*-=notranslate=-*/
            }
          }
        }
        
        
        //add by ouyangzhb 2011-07-07 判断是否需要冲减暂估应付
        InvoiceVO[] invoicevo = this.getInvoiceVO(iinvoiceVOs);
        ArrayList idlist = new ArrayList();
        ArrayList clbhs = new ArrayList();
        for(int i=0;i<stockVOs.length;i++){
        	idlist.add(stockVOs[i].getCgeneralbid());
        }
        for(int i=0;i<iinvoiceVOs.length; i++){
        	clbhs.add(invoicevo[i].getParentVO().getAttributeValue("clbh"));
        }
        Hashtable hashHidClbh = new Hashtable();
        if(idlist!=null&&idlist.size()>0){
        	String inclbh = SQLUtil.formInSQL("arap_djfb.clbh", clbhs);
        	String ids = SQLUtil.formInSQL("arap_djfb.ckdid", idlist);
        	 hashHidClbh = new PubDMO()
            .queryHtResultFromAnyTable(
                "arap_djfb, arap_djzb",
                "arap_djfb.fb_oid",
                new String[] {
                    "arap_djfb.clbh"
                },
                " arap_djfb.vouchid = arap_djzb.vouchid and arap_djzb.zgyf=2 and arap_djzb.dr=0 "+inclbh+"and arap_djfb.dr=0  "+ids );
        }
        if(hashHidClbh!=null&&hashHidClbh.size()>0){
        	 //add by ouyangzhb 冲减入库单的暂估应付单
            InvoiceImpl impl = new InvoiceImpl();
            impl.unAdjustForSettle(invoicevo,settleVO);
            //add end 
        	
        }
        
        //add end
        
        
        
      }

      timer.showAllExecutePhase("作废结算单(discardSettlebill(ArrayList))时间分布");
      //
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    finally {
      try {
        // 对单据解锁
        if (bLock){
          LockTool.releaseLockForPks(sKeys, strOperatorId);
        }
      }
      catch (Exception e) {
        PubDMO.throwBusinessException(e);
      }
    }
  }

  /**
   * 判断结算单是否为费用结算单 判断依据：查看结算行是否含有货物发票 zhf true --- 费用结算单 false ---- 非费用结算单
   */
  private boolean isFeeSettle(SettlebillVO vo) {
    if (vo != null) {
      SettlebillItemVO[] itemVO = vo.getBodyVO();
      if (itemVO == null || itemVO.length == 0)
        return false;
      if (itemVO[0].getCinvoice_bid() == null
          || itemVO[0].getCinvoice_bid().trim().length() == 0)
        return true;
    }
    return false;
  }

  /**
   * 功能描述:作废结算单，专为直运业务类型时发票作废调用 输入参数:发票VO 作者：熊海情 修改：晁志平 For V30
   */
  public void discardSettlebillSpecially(InvoiceVO invoiceVO, String cOperator)
      throws BusinessException {
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    SettleDMO dmo = null;
    ICreateCorpQueryService myService0 = null;
    try {
      // 通过发票查找结算单
      InvoiceHeaderVO invoiceHeadVO = invoiceVO.getHeadVO();
      String invoiceKey = invoiceHeadVO.getCinvoiceid().trim();
      String sCondition = " and cinvoiceid = '" + invoiceKey + "'";
      dmo = new SettleDMO();
      SettlebillItemVO settlebillItemVOs[] = dmo.querySettleBody(invoiceHeadVO
          .getPk_corp(), sCondition);
      if (settlebillItemVOs == null || settlebillItemVOs.length == 0) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000003")/* @res "未发现符合条件的结算单！" */);
      }
      timer.addExecutePhase("通过发票查找结算单--表体");

      String settlebillKey = settlebillItemVOs[0].getCsettlebillid().trim();
      sCondition = " and A.csettlebillid = '" + settlebillKey + "'";
      SettlebillHeaderVO settlebillHeaderVOs[] = dmo.querySettlebillHead_Stock(
          invoiceHeadVO.getPk_corp(), sCondition);
      if (settlebillHeaderVOs == null || settlebillHeaderVOs.length == 0) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000003")/* @res "未发现符合条件的结算单！" */);
      }
      timer.addExecutePhase("通过发票查找结算单--表头");
      // 作废结算单
      SettlebillVO vo = new SettlebillVO(settlebillItemVOs.length);
      vo.setParentVO(settlebillHeaderVOs[0]);
      vo.setChildrenVO(settlebillItemVOs);
      dmo.discardSettlebill(vo);

      timer.addExecutePhase("作废结算单");

      // 结算单作废时向存货核算系统传送数据
      if (vo != null) {
        String unitCode = vo.getHeadVO().getPk_corp();
        myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
            .getInstance().lookup(ICreateCorpQueryService.class.getName());
        boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");
        if (bIAStartUp) {
          String s[] = new String[1];
          s[0] = vo.getHeadVO().getCsettlebillid();
          deleteBillFromOutters(s, unitCode, cOperator);
        }
      }
      timer.addExecutePhase("结算单作废时向存货核算系统传送数据");

      // 取消结算成功,回退结算单号
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      billCode.returnBillNo(vo);
      timer.addExecutePhase("回退结算单号");
      //
      timer.showAllExecutePhase("作废结算单，专为直运业务类型时发票作废调用时间分布");
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 功能描述:作废虚拟发票 输入参数:SettlebillVO VO,结算单VO 日期:2002/09/19 作者：熊海情 修改：晁志平 For V30
   */
  private String[] discardVirtualInvoices(SettlebillVO VO,
      IinvoiceVO[] iinvoiceVOs) throws BusinessException {
    // boolean bVirtual = false;// 是否存在虚拟发票

    SettlebillItemVO itemVOs[] = VO.getBodyVO();
    if (itemVOs == null || itemVOs.length == 0) {
      return null;
    }
    // 发票哈希表
    int iCnt = iinvoiceVOs == null ? 0 : iinvoiceVOs.length;
    HashMap<String, IinvoiceVO> mapIinvoiceVo = new HashMap<String, IinvoiceVO>();
    for (int i = 0; i < iCnt; i++) {
      mapIinvoiceVo.put(iinvoiceVOs[i].getCinvoice_bid(), iinvoiceVOs[i]);
    }
    // 查询结算单中的发票头ID
    String cInvoiceID[] = null;
    Vector vTemp1 = new Vector(), vTemp2 = new Vector();
    IinvoiceVO voIinvoice = null;
    for (int i = 0; i < itemVOs.length; i++) {
      String sTemp = itemVOs[i].getCinvoiceid();
      if (sTemp != null && sTemp.trim().length() > 0 && !vTemp1.contains(sTemp)) {
        vTemp1.addElement(sTemp);
      }

      InvoiceItemVO itemVO = new InvoiceItemVO();
      itemVO.setNinvoicenum(itemVOs[i].getNsettlenum().multiply(-1));
      itemVO.setCupsourcebillrowid(itemVOs[i].getCstockrow());
      itemVO.setCupsourcebillid(itemVOs[i].getCstockid());
      if (itemVOs[i].getCinvoice_bid() != null
          && mapIinvoiceVo.get(itemVOs[i].getCinvoice_bid()) != null) {
        voIinvoice = (IinvoiceVO) mapIinvoiceVo.get(itemVOs[i]
            .getCinvoice_bid());
        itemVO.setCsourcebillrowid(voIinvoice.getCorder_bid());
        itemVO.setCsourcebillid(voIinvoice.getCorderid());
        itemVO.setCsourcebilltype(ScmConst.PO_Order);
        itemVO.setCorder_bid(voIinvoice.getCorder_bid());
        itemVO.setCorderid(voIinvoice.getCorderid());
      }
      vTemp2.addElement(itemVO);
    }
    if (vTemp1.size() == 0) {
      return null;
    }
    cInvoiceID = new String[vTemp1.size()];
    vTemp1.copyInto(cInvoiceID);
    // 判断发票是否为虚拟发票
    InvoiceImpl myService = null;
    try {
      SettleDMO dmo = new SettleDMO();
      cInvoiceID = dmo.getVirtualInvoices(cInvoiceID);
      if (cInvoiceID != null && cInvoiceID.length > 0) {
        // 调用发票维护提供的接口作废虚拟发票
        myService = new InvoiceImpl();
        myService.discardInvoiceForSettle(cInvoiceID);

        // 更新入库单累计开票数量
        if (vTemp2.size() > 0) {
          InvoiceItemVO itemVO[] = new InvoiceItemVO[vTemp2.size()];
          vTemp2.copyInto(itemVO);
          dmo.updateSignNum(itemVO, true, true);/* 第二个参数对本调用不起作用，为生成虚拟发票时设计 */
          // 回冲累计暂估应付数量
          updateAccumWashNumForIC(itemVO, VO.getHeadVO().getPk_corp());
        }
      }
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }

    return cInvoiceID;
  }

  /**
   * 虚拟发票作废时，恢复累计冲减暂估应付数量
   */
  private void updateAccumWashNumForIC(InvoiceItemVO[] itemVOs, String strCorpId)
      throws BusinessException {

    try {
      // 参数正确性检查
      if (itemVOs == null || itemVOs.length == 0) {
        return;
      }
      // 判断应付是否启用
      ICreateCorpQueryService myService0 = null;
      myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ICreateCorpQueryService.class.getName());
      boolean bAPStartUp = myService0.isEnabled(strCorpId, "AP");
      if (!bAPStartUp) {
        return;
      }
      int iLen = itemVOs.length;
      ArrayList<String> listBid = new ArrayList<String>();
      ArrayList<UFDouble> listShl = new ArrayList<UFDouble>();
      ArrayList<String> listBidVmi = new ArrayList<String>();
      ArrayList<UFDouble> listShlVmi = new ArrayList<UFDouble>();
      for (int i = 0; i < iLen; i++) {
        if (itemVOs[i].getCupsourcebillrowid() != null
            && itemVOs[i].getCupsourcebilltype() != ScmConst.PO_Order
            && itemVOs[i].getCupsourcebilltype() != ScmConst.SC_Order) {
          if(itemVOs[i].getCupsourcebilltype() != null
              && itemVOs[i].getCupsourcebilltype() == ScmConst.IC_VMI){
            listBidVmi.add(itemVOs[i].getCupsourcebillrowid());
            listShlVmi.add(PuPubVO.getUFDouble_NullAsZero(itemVOs[i].getNinvoicenum()));
          }else{
            listBid.add(itemVOs[i].getCupsourcebillrowid());
            listShl.add(PuPubVO.getUFDouble_NullAsZero(itemVOs[i].getNinvoicenum()));
          }
        }
      }
      // 回写ic_general_bb3上的暂估应付累计回冲数量
      if (listBid.size() > 0) {
        String[] saBid = listBid.toArray(new String[listBid.size()]);
        UFDouble[] uaShl = listShl.toArray(new UFDouble[listShl.size()]);
        new InvoiceDMO().updateAccumWashNumForIC(saBid, uaShl, true);// 发票数量已经被设置为负
      }
      // 回写ic_sum_vmi上的暂估应付累计回冲数量
      if (listBidVmi.size() > 0) {
        String[] saBid = listBid.toArray(new String[listBid.size()]);
        UFDouble[] uaShl = listShl.toArray(new UFDouble[listShl.size()]);
        new InvoiceDMO().updateAccumWashNumForVmi(saBid, uaShl, true);// 发票数量已经被设置为负
      }
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 功能描述:自动结算 作者：熊海情 修改：晁志平 For V30, V502
   */
  private java.util.ArrayList doAutoBalance(ArrayList listPara,
      IinvoiceVO m_invoiceVOs[], StockVO m_stockVOs[], boolean m_bStockRB,
      boolean m_bInvoiceRB) throws BusinessException {

    nc.vo.scm.pu.Timer timeDebug = new nc.vo.scm.pu.Timer();
    timeDebug.start();

    // 解析参数
    String m_sUnitCode = (String) listPara.get(0);
    Vector vAllItems = new Vector();
    java.util.ArrayList listRet = new java.util.ArrayList();
    // 入库单，发票进入自动结算标志
    boolean b1[] = null;
    boolean b2[] = null;
    if (m_stockVOs != null && m_stockVOs.length > 0) {
      b1 = new boolean[m_stockVOs.length];
      for (int i = 0; i < m_stockVOs.length; i++)
        b1[i] = false;
    }
    if (m_invoiceVOs != null && m_invoiceVOs.length > 0) {
      b2 = new boolean[m_invoiceVOs.length];
      for (int i = 0; i < m_invoiceVOs.length; i++)
        b2[i] = false;
    }
    timeDebug.addExecutePhase("初始化未结算标志");
    //
    String sBiztype1 = null, sVendorID1 = null, sDeptID1 = null, sInvID1 = null, pk_corp1 = null;
    String sBiztype2 = null, sVendorID2 = null, sDeptID2 = null, sInvID2 = null, pk_corp2 = null;
    String s = null, ss = null;
    double nNosettlenum1 = 0.0, nNosettlemny1 = 0.0;
    double nNosettlenum2 = 0.0, nNosettlemny2 = 0.0;
    // 组合能自动结算的红/蓝入库单，并过滤掉满足自动结算条件的入库单
    // 已暂估应付的入库单行应过滤掉
    StockVO stockVOs[] = null;
    if (m_bStockRB) {
      Vector v1 = new Vector();
      if (m_stockVOs != null && m_stockVOs.length > 0) {
        Vector vv = new Vector();
        for (int i = 0; i < m_stockVOs.length - 1; i++) {
          if (b1[i] || m_stockVOs[i].getBzgyfflag().booleanValue()) {
            continue;
          }
          sBiztype1 = m_stockVOs[i].getCbiztype();
          if (sBiztype1 == null || sBiztype1.trim().length() == 0)
            continue;
          sBiztype1 = sBiztype1.trim();
          sVendorID1 = m_stockVOs[i].getCproviderbaseid();
          if (sVendorID1 == null || sVendorID1.trim().length() == 0)
            continue;
          sVendorID1 = sVendorID1.trim();
          sDeptID1 = m_stockVOs[i].getCdeptid();
          if (sDeptID1 == null || sDeptID1.trim().length() == 0)
            continue;
          sDeptID1 = sDeptID1.trim();
          pk_corp1 = m_stockVOs[i].getPk_stockcorp();
          if (pk_corp1 == null || pk_corp1.trim().length() == 0)
            continue;
          pk_corp1 = pk_corp1.trim();
          sInvID1 = m_stockVOs[i].getCbaseid().trim();
          nNosettlenum1 = m_stockVOs[i].getNnosettlenum().doubleValue();
          nNosettlemny1 = m_stockVOs[i].getNnosettlemny().doubleValue();
          for (int j = i + 1; j < m_stockVOs.length; j++) {
            if (b1[j] || m_stockVOs[j].getBzgyfflag().booleanValue()) {
              continue;
            }
            sBiztype2 = m_stockVOs[j].getCbiztype();
            if (sBiztype2 == null || sBiztype2.trim().length() == 0)
              continue;
            sBiztype2 = sBiztype2.trim();
            sVendorID2 = m_stockVOs[j].getCproviderbaseid();
            if (sVendorID2 == null || sVendorID2.trim().length() == 0)
              continue;
            sVendorID2 = sVendorID2.trim();
            sDeptID2 = m_stockVOs[j].getCdeptid();
            if (sDeptID2 == null || sDeptID2.trim().length() == 0)
              continue;
            sDeptID2 = sDeptID2.trim();
            pk_corp2 = m_stockVOs[j].getPk_stockcorp();
            if (pk_corp2 == null || pk_corp2.trim().length() == 0)
              continue;
            pk_corp2 = pk_corp2.trim();
            sInvID2 = m_stockVOs[j].getCbaseid().trim();
            nNosettlenum2 = m_stockVOs[j].getNnosettlenum().doubleValue();
            nNosettlemny2 = m_stockVOs[j].getNnosettlemny().doubleValue();
            if (sBiztype1.equals(sBiztype2) && sVendorID1.equals(sVendorID2)
                && sDeptID1.equals(sDeptID2) && sInvID1.equals(sInvID2)
                && pk_corp1.equals(pk_corp2) && nNosettlenum1 == -nNosettlenum2
                && nNosettlemny1 == -nNosettlemny2) {
              v1.addElement(m_stockVOs[i]);
              v1.addElement(m_stockVOs[j]);
              b1[j] = true;
              b1[i] = true;
              break;
            }
          }
          if (!b1[i])
            vv.addElement(m_stockVOs[i]);
        }
//        if (!b1[m_stockVOs.length - 1])
//          vv.addElement(m_stockVOs[m_stockVOs.length - 1]);
//        stockVOs = new StockVO[vv.size()];
//        vv.copyInto(stockVOs);
        stockVOs=getAutoSettleVO(b1, m_stockVOs);
        if (v1.size() > 0) {
          Vector vTmp = doAutoBalanceStockRedBlue(m_sUnitCode, v1);
          if (vTmp != null && vTmp.size() > 0) {
            int iSize = vTmp.size();
            for (int i = 0; i < iSize; i++) {
              vAllItems.addElement(vTmp.elementAt(i));
            }
          }
        }
      }
    }
    else {
      stockVOs = m_stockVOs;
    }
    timeDebug.addExecutePhase("组合能自动结算的红/蓝入库单，并过滤掉满足自动结算条件的入库单");

    // 组合能自动结算的红/蓝发票，并过滤掉满足自动结算条件的发票
    IinvoiceVO invoiceVOs[] = null;
    if (m_bInvoiceRB) {
      Vector v2 = new Vector();
      if (m_invoiceVOs != null && m_invoiceVOs.length > 0) {
        Vector vv = new Vector();
        for (int i = 0; i < m_invoiceVOs.length - 1; i++) {
          if (b2[i]) {
            continue;
          }
          sBiztype1 = m_invoiceVOs[i].getCbiztype();
          if (sBiztype1 == null || sBiztype1.trim().length() == 0)
            continue;
          sBiztype1 = sBiztype1.trim();
          sVendorID1 = m_invoiceVOs[i].getCvendorbaseid();
          if (sVendorID1 == null || sVendorID1.trim().length() == 0)
            continue;
          sVendorID1 = sVendorID1.trim();
          sDeptID1 = m_invoiceVOs[i].getCdeptid();
          if (sDeptID1 == null || sDeptID1.trim().length() == 0)
            continue;
          sDeptID1 = sDeptID1.trim();
          sInvID1 = m_invoiceVOs[i].getCbaseid().trim();
          nNosettlenum1 = m_invoiceVOs[i].getNnosettlenum().doubleValue();
          nNosettlemny1 = m_invoiceVOs[i].getNnosettlemny().doubleValue();
          for (int j = i + 1; j < m_invoiceVOs.length; j++) {
            if (b2[j]) {
              continue;
            }
            sBiztype2 = m_invoiceVOs[j].getCbiztype();
            if (sBiztype2 == null || sBiztype2.trim().length() == 0)
              continue;
            sBiztype2 = sBiztype2.trim();
            sVendorID2 = m_invoiceVOs[j].getCvendorbaseid();
            if (sVendorID2 == null || sVendorID2.trim().length() == 0)
              continue;
            sVendorID2 = sVendorID2.trim();
            sDeptID2 = m_invoiceVOs[j].getCdeptid();
            if (sDeptID2 == null || sDeptID2.trim().length() == 0)
              continue;
            sDeptID2 = sDeptID2.trim();
            sInvID2 = m_invoiceVOs[j].getCbaseid().trim();
            nNosettlenum2 = m_invoiceVOs[j].getNnosettlenum().doubleValue();
            nNosettlemny2 = m_invoiceVOs[j].getNnosettlemny().doubleValue();
            if (sBiztype1.equals(sBiztype2) && sVendorID1.equals(sVendorID2)
                && sDeptID1.equals(sDeptID2) && sInvID1.equals(sInvID2)
                && nNosettlenum1 == -nNosettlenum2
                && nNosettlemny1 == -nNosettlemny2 && nNosettlemny1 != 0.0
                && nNosettlemny1 != 0.0) {
              v2.addElement(m_invoiceVOs[i]);
              v2.addElement(m_invoiceVOs[j]);
              b2[j] = true;
              b2[i] = true;
              break;
            }
          }
          if (!b2[i])
            vv.addElement(m_invoiceVOs[i]);
        }
//        if (!b2[m_invoiceVOs.length - 1])
//          vv.addElement(m_invoiceVOs[m_invoiceVOs.length - 1]);
//        invoiceVOs = new IinvoiceVO[vv.size()];
//        vv.copyInto(invoiceVOs);
        invoiceVOs=getAutoSettleVO(b2, m_invoiceVOs);
        if (v2.size() > 0) {
          Vector vTmp = doAutoBalanceInvoiceRedBlue(m_sUnitCode, v2);
          if (vTmp != null && vTmp.size() > 0) {
            int iSize = vTmp.size();
            for (int i = 0; i < iSize; i++) {
              vAllItems.addElement(vTmp.elementAt(i));
            }
          }
        }
      }
    }
    else {
      invoiceVOs = m_invoiceVOs;
    }
    timeDebug.addExecutePhase("组合能自动结算的红/蓝入库单，并过滤掉满足自动结算条件的入库单");

    // 组合能自动结算的入库单/发票
    Vector v = new Vector();
    if (stockVOs != null && invoiceVOs != null) {
      b1 = new boolean[invoiceVOs.length];
      for (int i = 0; i < b1.length; i++)
        b1[i] = false;
      b2 = new boolean[stockVOs.length];
      for (int i = 0; i < b2.length; i++)
        b2[i] = false;

      // 首先匹配:发票源于入库单＋业务类型＋供应商＋部门＋存货＋未结算数量
      for (int i = 0; i < invoiceVOs.length; i++) {
        if (b1[i]) {
          continue;
        }
        sBiztype1 = invoiceVOs[i].getCbiztype();
        if (sBiztype1 == null || sBiztype1.trim().length() == 0)
          continue;
        sBiztype1 = sBiztype1.trim();
        sVendorID1 = invoiceVOs[i].getCvendorbaseid();
        if (sVendorID1 == null || sVendorID1.trim().length() == 0)
          continue;
        sVendorID1 = sVendorID1.trim();
        sDeptID1 = invoiceVOs[i].getCdeptid();
        if (sDeptID1 == null || sDeptID1.trim().length() == 0)
          continue;
        sDeptID1 = sDeptID1.trim();
        sInvID1 = invoiceVOs[i].getCbaseid().trim();
        nNosettlenum1 = invoiceVOs[i].getNnosettlenum().doubleValue();
        s = invoiceVOs[i].getCupsourcebillrowid();
        if (s == null || s.trim().length() == 0)
          continue;
        for (int j = 0; j < stockVOs.length; j++) {
          if (b2[j]) {
            continue;
          }
          sBiztype2 = stockVOs[j].getCbiztype();
          if (sBiztype2 == null || sBiztype2.trim().length() == 0)
            continue;
          sBiztype2 = sBiztype2.trim();
          sVendorID2 = stockVOs[j].getCproviderbaseid();
          if (sVendorID2 == null || sVendorID2.trim().length() == 0)
            continue;
          sVendorID2 = sVendorID2.trim();
          sDeptID2 = stockVOs[j].getCdeptid();
          if (sDeptID2 == null || sDeptID2.trim().length() == 0)
            continue;
          sDeptID2 = sDeptID2.trim();
          sInvID2 = stockVOs[j].getCbaseid().trim();
          nNosettlenum2 = stockVOs[j].getNnosettlenum().doubleValue();
          ss = stockVOs[j].getCgeneralbid();
          if (sBiztype1.equals(sBiztype2) && sVendorID1.equals(sVendorID2)
              && sDeptID1.equals(sDeptID2) && sInvID1.equals(sInvID2)
              && nNosettlenum1 == nNosettlenum2 && s.equals(ss)) {
            Vector vTemp = new Vector();
            vTemp.addElement(stockVOs[j]);
            vTemp.addElement(invoiceVOs[i]);
            v.addElement(vTemp);
            b1[i] = true;
            b2[j] = true;
            break;
          }
        }
      }

      // 其次匹配来源于同一张订单的入库单、发票(源头单据行ID相同)
      for (int i = 0; i < invoiceVOs.length; i++) {
        s = invoiceVOs[i].getCsourcebillbid();
        if (s == null || s.trim().length() == 0) {
          continue;
        }
        if (b1[i]) {
          continue;
        }
        sBiztype1 = invoiceVOs[i].getCbiztype();
        if (sBiztype1 == null || sBiztype1.trim().length() == 0)
          continue;
        sBiztype1 = sBiztype1.trim();
        sVendorID1 = invoiceVOs[i].getCvendormangid();
        if (sVendorID1 == null || sVendorID1.trim().length() == 0)
          continue;
        sVendorID1 = sVendorID1.trim();
        sDeptID1 = invoiceVOs[i].getCdeptid();
        if (sDeptID1 == null || sDeptID1.trim().length() == 0)
          continue;
        sDeptID1 = sDeptID1.trim();
        sInvID1 = invoiceVOs[i].getCmangid().trim();
        nNosettlenum1 = invoiceVOs[i].getNnosettlenum().doubleValue();
        for (int j = 0; j < stockVOs.length; j++) {
          if (b2[j]) {
            continue;
          }
          if (stockVOs[j].getCfirstbillbid() == null
              || stockVOs[j].getCfirstbillbid().trim().equals("")
              || !stockVOs[j].getCfirstbillbid().trim().equals(s.trim()))
            continue;
          sBiztype2 = stockVOs[j].getCbiztype();
          if (sBiztype2 == null || sBiztype2.trim().length() == 0)
            continue;
          sBiztype2 = sBiztype2.trim();
          sVendorID2 = stockVOs[j].getCprovidermangid();
          if (sVendorID2 == null || sVendorID2.trim().length() == 0)
            continue;
          sVendorID2 = sVendorID2.trim();
          sDeptID2 = stockVOs[j].getCdeptid();
          if (sDeptID2 == null || sDeptID2.trim().length() == 0)
            continue;
          sDeptID2 = sDeptID2.trim();
          sInvID2 = stockVOs[j].getCmangid().trim();
          nNosettlenum2 = stockVOs[j].getNnosettlenum().doubleValue();
          ss = stockVOs[j].getCfirstbillbid();
          if (sBiztype1.equals(sBiztype2) && sVendorID1.equals(sVendorID2)
              && sDeptID1.equals(sDeptID2) && sInvID1.equals(sInvID2)
              && nNosettlenum1 == nNosettlenum2 && s.equals(ss)) {
            Vector vTemp = new Vector();
            vTemp.addElement(stockVOs[j]);
            vTemp.addElement(invoiceVOs[i]);
            v.addElement(vTemp);
            b1[i] = true;
            b2[j] = true;
            break;
          }
        }
      }

      // 再次匹配:业务类型＋供应商＋部门＋存货＋未结算数量
      for (int i = 0; i < invoiceVOs.length; i++) {

        if (b1[i]) {
          continue;
        }
        sBiztype1 = invoiceVOs[i].getCbiztype();
        if (sBiztype1 == null || sBiztype1.trim().length() == 0)
          continue;
        sBiztype1 = sBiztype1.trim();
        sVendorID1 = invoiceVOs[i].getCvendormangid();
        if (sVendorID1 == null || sVendorID1.trim().length() == 0)
          continue;
        sVendorID1 = sVendorID1.trim();
        sDeptID1 = invoiceVOs[i].getCdeptid();
        if (sDeptID1 == null || sDeptID1.trim().length() == 0)
          continue;
        sDeptID1 = sDeptID1.trim();
        sInvID1 = invoiceVOs[i].getCmangid().trim();
        nNosettlenum1 = invoiceVOs[i].getNnosettlenum().doubleValue();
        // 再匹配
        for (int j = 0; j < stockVOs.length; j++) {
          if (b2[j]) {
            continue;
          }
          sBiztype2 = stockVOs[j].getCbiztype();
          if (sBiztype2 == null || sBiztype2.trim().length() == 0)
            continue;
          else
            sBiztype2 = sBiztype2.trim();
          sVendorID2 = stockVOs[j].getCprovidermangid();
          if (sVendorID2 == null || sVendorID2.trim().length() == 0)
            continue;
          else
            sVendorID2 = sVendorID2.trim();
          sDeptID2 = stockVOs[j].getCdeptid();
          if (sDeptID2 == null || sDeptID2.trim().length() == 0)
            continue;
          else
            sDeptID2 = sDeptID2.trim();
          sInvID2 = stockVOs[j].getCmangid().trim();
          nNosettlenum2 = stockVOs[j].getNnosettlenum().doubleValue();
          if (sBiztype1.equals(sBiztype2) && sVendorID1.equals(sVendorID2)
              && sDeptID1.equals(sDeptID2) && sInvID1.equals(sInvID2)
              && nNosettlenum1 == nNosettlenum2) {
            Vector vTemp = new Vector();
            vTemp.addElement(stockVOs[j]);
            vTemp.addElement(invoiceVOs[i]);
            v.addElement(vTemp);
            b1[i] = true;
            b2[j] = true;
            break;
          }
        }
      }

      if (v.size() > 0) {
        Vector vTmp = doAutoBalanceRedBlue(m_sUnitCode, v);
        if (vTmp != null && vTmp.size() > 0) {
          int iSize = vTmp.size();
          for (int i = 0; i < iSize; i++) {
            vAllItems.addElement(vTmp.elementAt(i));
          }
        }
      }
    }
    timeDebug.addExecutePhase("组合能自动结算的入库单/发票");

    // 所有结算单体
    if (vAllItems == null || vAllItems.size() == 0) {
      throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
          .getStrByID("40040502", "UPP40040502-000004")/*
                                                         * @res
                                                         * "没有符合条件的入库单/发票，结算失败！"
                                                         */);
    }
    SettlebillItemVO[] m_settleVOs = null;
    m_settleVOs = new SettlebillItemVO[vAllItems.size()];
    vAllItems.copyInto(m_settleVOs);
    // 修改入库单和发票的数据并返回结算单VO
    SettlebillVO vo = doAutoBalanceModification(m_invoiceVOs, m_stockVOs,
        listPara, m_settleVOs);
    timeDebug.addExecutePhase("修改入库单和发票的数据并返回结算单VO");

    timeDebug.showAllExecutePhase("自动结算-doAutoBalance()-时间分布(总-1)");

    vo.getHeadVO().setTmaketime((new UFDateTime(new Date())).toString());
    listRet.add(vo);
    return listRet;
  }

  /**
   * 功能描述:红/蓝发票自动结算 作者：熊海情 修改：晁志平 For V30
   */
  private Vector doAutoBalanceInvoiceRedBlue(String m_sUnitCode, Vector v) {
    // 设置表体
    Vector vv = new Vector();
    int iSize = v.size();
    SettlebillItemVO body = null;
    IinvoiceVO tempVO = null;
    ISysInitQry myService = (ISysInitQry) nc.bs.framework.common.NCLocator
        .getInstance().lookup(ISysInitQry.class.getName());
    int nPriceDecimal = 8;
    try {
      nPriceDecimal = myService.getParaInt(m_sUnitCode, "BD505");
    }
    catch (Exception e) {
      SCMEnv.out(e);
    }
    for (int i = 0; i < iSize; i++) {
      tempVO = (IinvoiceVO) v.elementAt(i);
      body = new SettlebillItemVO();
      body.setPk_corp(m_sUnitCode);
      body.setCinvoice_bid(tempVO.getCinvoice_bid());
      body.setCinvoiceid(tempVO.getCinvoiceid());
      body.setCmangid(tempVO.getCmangid());
      body.setCbaseid(tempVO.getCbaseid());
      body.setNmoney(tempVO.getNnosettlemny());
      body.setNsettlenum(tempVO.getNnosettlenum());
      // 获得结算单价
      UFDouble d1 = body.getNmoney();
      UFDouble d2 = body.getNsettlenum();
      if (d1 != null && d2 != null) {
        if (d2.doubleValue() != 0.0) {
          // double d = d1.doubleValue() / d2.doubleValue();
          // body.setNprice(new UFDouble(d));
          body.setNprice(d1.div(d2, nPriceDecimal));
        }
      }
      // 获得发票号
      body.setVinvoicecode(tempVO.getVinvoicecode());
      vv.addElement(body);
    }
    return vv;
  }

  /**
   * 功能描述:修改入库单、发票数据；调用手工结算传存货核算 参数说明：listPara,ArrayList |-公司主键 |-查询条件VO[] |-操作员
   * |-会计年度 |-业务日期 作者：熊海情 修改：晁志平 For V30\V502
   */
  private SettlebillVO doAutoBalanceModification(IinvoiceVO m_invoiceVOs[],
      StockVO m_stockVOs[], ArrayList listPara, SettlebillItemVO[] m_settleVOs)
      throws BusinessException {

    nc.vo.scm.pu.Timer timeDebug = new nc.vo.scm.pu.Timer();
    timeDebug.start();

    // 解析参数
    String strLoginCorp = (String) listPara.get(0);
    String strOprId = (String) listPara.get(2);
    String strAccYear = (String) listPara.get(3);
    UFDate dateLogin = (UFDate) listPara.get(4);

    // 入库单行主键归类
    Vector vStockKey = new Vector();
    for (int i = 0; i < m_settleVOs.length - 1; i++) {
      String s = m_settleVOs[i].getCstockrow();
      if (s == null || s.length() == 0)
        continue;
      s = s.trim();
      boolean b = false;
      for (int j = i + 1; j < m_settleVOs.length; j++) {
        String ss = m_settleVOs[j].getCstockrow();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          b = true;
          break;
        }
      }
      if (!b)
        vStockKey.addElement(s);
    }
    String sss = m_settleVOs[m_settleVOs.length - 1].getCstockrow();
    UFDouble ddd = m_settleVOs[m_settleVOs.length - 1].getNsettlenum();
    if (sss != null && sss.length() > 0 && ddd != null)
      vStockKey.addElement(sss);

    timeDebug.addExecutePhase("入库单行主键归类");

    // 发票行主键归类（不包括费用发票和折扣）
    Vector vInvoiceKey = new Vector();
    for (int i = 0; i < m_settleVOs.length - 1; i++) {
      String s = m_settleVOs[i].getCinvoice_bid();
      UFDouble d = m_settleVOs[i].getNsettlenum();
      if (d == null)
        continue;
      if (s == null || s.length() == 0)
        continue;
      s = s.trim();
      boolean b = false;
      for (int j = i + 1; j < m_settleVOs.length; j++) {
        String ss = m_settleVOs[j].getCinvoice_bid();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          b = true;
          break;
        }
      }
      if (!b)
        vInvoiceKey.addElement(s);
    }
    sss = m_settleVOs[m_settleVOs.length - 1].getCinvoice_bid();
    ddd = m_settleVOs[m_settleVOs.length - 1].getNsettlenum();
    if (sss != null && sss.length() > 0 && ddd != null)
      vInvoiceKey.addElement(sss);

    timeDebug.addExecutePhase("发票行主键归类（不包括费用发票和折扣）");

    // 修改入库单数据
    StockVO stockVOs[] = doAutoBalanceModifyStock(m_stockVOs, vStockKey,
        m_settleVOs);

    timeDebug.addExecutePhase("修改入库单数据");

    // 修改发票数据
    IinvoiceVO iinvoiceVOs[] = doAutoBalanceModifyInvoice(m_invoiceVOs,
        vInvoiceKey, m_settleVOs);

    timeDebug.addExecutePhase("修改发票数据");

    // 设置结算单表头
    SettlebillHeaderVO head = new SettlebillHeaderVO();
    head.setPk_corp(strLoginCorp);
    head.setCaccountyear(strAccYear);
    head.setDsettledate(dateLogin);
    head.setIbillstatus(new Integer(0));
    head.setCbilltype(ScmConst.PO_SettleBill);
    head.setCoperator(strOprId);
    head.setTmaketime((new UFDateTime(new Date())).toString());

    // 设置结算单
    SettlebillVO settlebillVO = new SettlebillVO(m_settleVOs.length);
    settlebillVO.setParentVO(head);
    settlebillVO.setChildrenVO(m_settleVOs);

    // 插入结算单，更新入库单，发票
    String m_sEstimateMode = null;
    String m_sDifferenceMode = null;
    UFBoolean m_bIc2PiSettle = new UFBoolean(false);// 是否部分暂估
    UFBoolean m_bZGYF = new UFBoolean(false);// 是否暂估应付
    int nMoneyDecimal = 2;// 本币金额精度
    ISysInitQry myService = (ISysInitQry) nc.bs.framework.common.NCLocator
        .getInstance().lookup(ISysInitQry.class.getName());
    // 获得系统设置的暂估方式和差异转入方式
    Hashtable t = null;
    try {
      t = myService.queryBatchParaValues(strLoginCorp, new String[] {
          "PO51", "PO52", "PO12", "PO13"
      });
      nMoneyDecimal = BsPuTool.getCCurrDecimal(strLoginCorp);
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    if (t == null || t.size() == 0) {
      throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
          .getStrByID("40040502", "UPP40040502-000005")/*
                                                         * @res
                                                         * "未取得采购参数：暂估方式和差异转入方式，请检查采购参数设置是否正确!"
                                                         */);
    }
    else {
      Object temp = null;
      if (t.get("PO51") != null) {
        temp = t.get("PO51");
        m_bIc2PiSettle = new UFBoolean(temp.toString());
      }
      if (t.get("PO52") != null) {
        temp = t.get("PO52");
        m_bZGYF = new UFBoolean(temp.toString());
      }
      if (t.get("PO12") != null) {
        temp = t.get("PO12");
        m_sEstimateMode = temp.toString();
      }
      if (t.get("PO13") != null) {
        temp = t.get("PO13");
        m_sDifferenceMode = temp.toString();
      }
    }
    timeDebug.addExecutePhase("设置结算单、获得系统设置的暂估方式和差异转入方式");

    String headKey = null;
    SettlebillVO VO = null;
    try {
      // 调用手工结算传存货核算
      ArrayList listPara1 = new ArrayList();
      listPara1.add(settlebillVO);
      listPara1.add(stockVOs);
      listPara1.add(iinvoiceVOs);
      listPara1.add(null);
      listPara1.add(null);
      listPara1.add(m_sEstimateMode);
      listPara1.add(m_sDifferenceMode);
      listPara1.add(strOprId);
      listPara1.add(m_bIc2PiSettle);
      listPara1.add(m_bZGYF);
      listPara1.add(new Integer(nMoneyDecimal));
      listPara1.add(new UFBoolean(false));// 是否异存货结算
      listPara1.add(strLoginCorp);

      headKey = doManualBalance(listPara1);
      // 返回结算单
      if (headKey != null && headKey.trim().length() > 0) {
        try {
          VO = querySettlebillByHeadKey(strLoginCorp, headKey);
        }
        catch (Exception e) {
          SCMEnv.out(e);
          throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
              .getStrByID("40040502", "UPP40040502-000006")/*
                                                             * @res
                                                             * "自动结算成功完成，但显示自动结算产生的结算单时出现异常，请到“维护结算单”节点查看新生成的结算单"
                                                             */);
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    timeDebug.addExecutePhase("调用手工结算传存货核算");

    timeDebug
        .showAllExecutePhase("修改入库单、发票数据；调用手工结算传存货核算-doAutoBalanceModification()-时间分布(总-1-1)");

    return VO;
  }

  /**
   * 功能描述:成功结算后，根据结算单修改发票数据 输入参数： IinvoiceVO m_invoiceVOs[],发票VO[] Vector
   * vInvoiceKey,发票主键向量 SettlebillItemVO[] m_settleVOs，结算单体VO[] 作者：熊海情 修改：晁志平
   * For V30
   */
  private IinvoiceVO[] doAutoBalanceModifyInvoice(IinvoiceVO m_invoiceVOs[],
      Vector vInvoiceKey, SettlebillItemVO[] m_settleVOs)
      throws BusinessException {
    Vector v = new Vector();
    for (int i = 0; i < vInvoiceKey.size(); i++) {
      String s = (String) vInvoiceKey.elementAt(i);
      double nSettlenum = 0.0;
      double nSettlemny = 0.0;
      String s0 = "";
      for (int j = 0; j < m_settleVOs.length; j++) {
        String ss = m_settleVOs[j].getCinvoice_bid();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          nSettlenum += m_settleVOs[j].getNsettlenum().doubleValue();
          nSettlemny += m_settleVOs[j].getNmoney().doubleValue();
          s0 = m_settleVOs[j].getCinvoiceid();
        }
      }
      // 查询对应的发票
      int k = -1;
      for (int j = 0; j < m_invoiceVOs.length; j++) {
        String s1 = m_invoiceVOs[j].getCinvoice_bid().trim();
        String s2 = m_invoiceVOs[j].getCinvoiceid().trim();
        if (s.equals(s1) && s0.equals(s2)) {
          k = j;
          break;
        }
      }
      if (k == -1) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000007")/* @res "修改发票数据错误！" */);
      }
      // 修改累计结算数量和累计结算金额
      double d = m_invoiceVOs[k].getNaccumsettlenum().doubleValue();
      d += nSettlenum;
      m_invoiceVOs[k].setNaccumsettlenum(new UFDouble(d));
      d = m_invoiceVOs[k].getNaccumsettlemny().doubleValue();
      d += nSettlemny;
      m_invoiceVOs[k].setNaccumsettlemny(new UFDouble(d));
      // 需要更新的发票VO返回
      v.addElement(m_invoiceVOs[k]);
    }
    if (v.size() > 0) {
      IinvoiceVO vos[] = new IinvoiceVO[v.size()];
      v.copyInto(vos);
      return vos;
    }
    return null;
  }

  /**
   * 功能描述:成功结算后，根据结算单修改入库单数据 输入参数： IinvoiceVO m_invoiceVOs[],入库单VO[] Vector
   * vInvoiceKey,入库单主键向量 SettlebillItemVO[] m_settleVOs，结算单体VO[] 返回值:需要更新的入库单VO
   * 作者：熊海情 修改：晁志平 For V30
   */
  private StockVO[] doAutoBalanceModifyStock(StockVO m_stockVOs[],
      Vector vStockKey, SettlebillItemVO[] m_settleVOs)
      throws BusinessException {
    Vector v = new Vector();
    for (int i = 0; i < vStockKey.size(); i++) {
      String s = (String) vStockKey.elementAt(i);
      double nSettlenum = 0.0;
      double nGaugemny = 0.0;
      String s0 = "";
      for (int j = 0; j < m_settleVOs.length; j++) {
        String ss = m_settleVOs[j].getCstockrow();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          nSettlenum += m_settleVOs[j].getNsettlenum().doubleValue();
          nGaugemny += m_settleVOs[j].getNgaugemny().doubleValue();
          s0 = m_settleVOs[j].getCstockid();
        }
      }
      // 查询对应的入库单
      int k = -1;
      for (int j = 0; j < m_stockVOs.length; j++) {
        String s1 = m_stockVOs[j].getCgeneralbid().trim();
        String s2 = m_stockVOs[j].getCgeneralhid().trim();
        if (s.equals(s1) && s0.equals(s2)) {
          k = j;
          break;
        }
      }
      if (k == -1) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000008")/* @res "修改入库单数据错误！" */);
      }
      // 修改累计结算数量和累计结算金额
      double d = m_stockVOs[k].getNaccumsettlenum().doubleValue();
      d += nSettlenum;
      m_stockVOs[k].setNaccumsettlenum(new UFDouble(d));
      d = m_stockVOs[k].getNaccumsettlemny().doubleValue();
      d += nGaugemny;
      m_stockVOs[k].setNaccumsettlemny(new UFDouble(d).add(new UFDouble(0.0),
          BsPuTool.getCCurrDecimal(null)));
      // 需要更新的入库单VO返回
      v.addElement(m_stockVOs[k]);
    }
    if (v.size() > 0) {
      StockVO vos[] = new StockVO[v.size()];
      v.copyInto(vos);
      return vos;
    }
    return null;
  }

  /**
   * 功能描述:入库单/发票自动结算 输入参数： String m_sUnitCode, 公司主键 Vector v,拆分结算汇总表数据：入库单、发票对
   * 作者：熊海情 修改：晁志平 For V30
   */
  private Vector doAutoBalanceRedBlue(String sUnitCode, Vector v)
      throws BusinessException {
    // 拆分结算汇总表数据：settleVO1 入库单；settleVO2 发票
    Vector v1 = new Vector();
    Vector v2 = new Vector();
    for (int i = 0; i < v.size(); i++) {
      Vector vTemp = (Vector) v.elementAt(i);
      v1.addElement(vTemp.elementAt(0));
      v2.addElement(vTemp.elementAt(1));
    }
    StockVO settleVO1[] = new StockVO[v1.size()];
    IinvoiceVO settleVO2[] = new IinvoiceVO[v2.size()];
    v1.copyInto(settleVO1);
    v2.copyInto(settleVO2);

    // 按龙旗项目调整，取单据上的单价并按单据汇率转换，单价为空时按本币金额/除以数量
    BusinessCurrencyRateUtil dmoCurrArith = null;
    try {
      dmoCurrArith = new BusinessCurrencyRateUtil(sUnitCode);
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    // 是否主辅币核算
    // boolean bBlnLocalFrac = dmoCurrArith.isBlnLocalFrac();

    // 单价精度
    ISysInitQry myService = (ISysInitQry) nc.bs.framework.common.NCLocator
        .getInstance().lookup(ISysInitQry.class.getName());
    int nPriceDecimal = myService.getParaInt(sUnitCode, "BD505");

    // 设置表体
    Vector vv = new Vector();
    SettlebillItemVO body = null;
    int iSize = v.size();
    UFDouble ufdPrice = null;
    for (int i = 0; i < iSize; i++) {
      body = new SettlebillItemVO();
      body.setPk_corp(sUnitCode);
      body.setPk_stockcorp(settleVO1[i].getPk_stockcorp());
      body.setCinvoice_bid(settleVO2[i].getCinvoice_bid());
      body.setCinvoiceid(settleVO2[i].getCinvoiceid());
      body.setCstockrow(settleVO1[i].getCgeneralbid());
      body.setCstockid(settleVO1[i].getCgeneralhid());
      body.setVstockbilltype(settleVO1[i].getBillTypeNullAs45());
      body.setCmangid(settleVO1[i].getCmangid());
      body.setCbaseid(settleVO1[i].getCbaseid());
      body.setNmoney(settleVO2[i].getNnosettlemny());
      body.setNsettlenum(settleVO1[i].getNnosettlenum());
      body.setNgaugemny(settleVO1[i].getNnosettlemny());

      // 如果金额与未结算金额相同，而且单价非空，非零时按单价折算
      if (settleVO2[i].getNnosettlemny() != null
          && settleVO2[i].getNnosettlemny().equals(settleVO2[i].getNmoney())) {
        ufdPrice = PuPubVO.getUFDouble_ZeroAsNull(settleVO2[i]
            .getNoriginalcurprice());
      }
      else {
        ufdPrice = null;
      }
      ufdPrice = IinvoiceVO.getNpriceArith(settleVO2[i].getNmoney(),
          settleVO2[i].getNinvoicenum(), ufdPrice, nPriceDecimal, settleVO2[i]
              .getNexchangeotobrate(), settleVO2[i].getCcurrencytypeid(),
          dmoCurrArith, sUnitCode);
      body.setNprice(ufdPrice);
      // 获得入库单号
      body.setVbillcode(settleVO1[i].getVbillcode());
      // 获得发票号
      body.setVinvoicecode(settleVO2[i].getVinvoicecode());
      vv.addElement(body);
    }
    return vv;
  }

  /**
   * 功能描述:红/蓝入库单自动结算 作者：熊海情 修改：晁志平 For V30
   */
  private Vector doAutoBalanceStockRedBlue(String m_sUnitCode, Vector v) {
    // 设置表体
    SettlebillItemVO body = null;
    Vector vv = new Vector();
    int iSize = v.size();
    for (int i = 0; i < iSize; i++) {
      StockVO tempVO = (StockVO) v.elementAt(i);
      body = new SettlebillItemVO();
      body = new SettlebillItemVO();
      body.setPk_corp(m_sUnitCode);
      body.setPk_stockcorp(tempVO.getPk_stockcorp());
      body.setCstockrow(tempVO.getCgeneralbid());
      body.setCstockid(tempVO.getCgeneralhid());
      body.setVstockbilltype(tempVO.getBillTypeNullAs45());
      body.setCmangid(tempVO.getCmangid());
      body.setCbaseid(tempVO.getCbaseid());
      body.setNmoney(tempVO.getNnosettlemny());
      body.setNsettlenum(tempVO.getNnosettlenum());
      body.setNgaugemny(tempVO.getNnosettlemny());
      // 获得结算单价
      body.setNprice(tempVO.getNprice());
      // 获得入库单号
      body.setVbillcode(tempVO.getVbillcode());
      //
      vv.addElement(body);
    }
    return vv;
  }

  /**
   * 功能描述:费用单独结算 作者：熊海情 修改：晁志平 For V30
   */
  public void doFeeBalance(SettlebillVO settlebillVO, StockVO stockVOs[],
      FeeinvoiceVO feeVOs[], FeeinvoiceVO discountVOs[],
      FeeinvoiceVO specialVOs[], UFBoolean[] m_bIsentercost, String sDiffMode,
      String cOperator) throws BusinessException {

    SettleDMO dmo = null;
    ICreateCorpQueryService myService0 = null;
    boolean bLock = false;
    boolean bGetBillCodeSucc = false;

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    // 组合所有需要加锁的主键
    String sKeys[] = getSettleLockKeys(stockVOs, null, feeVOs, discountVOs,
        specialVOs, null, null);

    try {
      dmo = new SettleDMO();
      // 对单据加锁
      bLock = LockTool.setLockForPks(sKeys, cOperator);
      if (!bLock)
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000009")/*
                                                           * @res
                                                           * "正在进行相关操作，请稍后再试！"
                                                           */);

      timer.addExecutePhase("对单据加锁");

      // 判断时间戳是否改变
      String sMessage = isTimeStampChangedForSettle(stockVOs, null, feeVOs,
          discountVOs, specialVOs);
      if (sMessage != null && sMessage.length() > 0) {
        sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
            "40040502", "UPP40040502-000002")/*
                                               * @res "请刷新！\n"
                                               */;
        throw new BusinessException(sMessage);
      }

      timer.addExecutePhase("判断时间戳是否改变");

      SettlebillHeaderVO head = settlebillVO.getHeadVO();
      head.setTmaketime((new UFDateTime(new Date())).toString());

      // 获得结算单号
      String vSettleCode = getSettleBillCode(head);
      head.setAttributeValue("vsettlebillcode", vSettleCode);
      bGetBillCodeSucc = true;
      //

      timer.addExecutePhase("获得结算单号");

      // 插入结算单
      String key = dmo.insertHead(head);

      timer.addExecutePhase("插入结算单--头");

      SettlebillItemVO body[] = settlebillVO.getBodyVO();
      String s[] = dmo.insertBody(body, key);
      for (int i = 0; i < body.length; i++) {
        body[i].setCsettlebill_bid(s[i]);
        body[i].setCsettlebillid(key);
      }

      timer.addExecutePhase("插入结算单--体");

      // 更新入库子表 入库采购费用结算累计次数
      if (stockVOs != null && stockVOs.length > 0) {
        ArrayList<String> stockRowList = new ArrayList<String>();
        for (StockVO vo : stockVOs) {
          if (!stockRowList.contains(vo.getCgeneralbid().trim()))
            stockRowList.add(vo.getCgeneralbid().trim());
        }
        dmo.updateFeeSettletimes(stockRowList, true);
      }

      timer.addExecutePhase("更新入库单--体");

      // 更新费用发票
      if (feeVOs != null && feeVOs.length > 0) {
        dmo.updateFee(feeVOs);
      }

      timer.addExecutePhase("更新费用发票");

      // 更新折扣
      if (discountVOs != null && discountVOs.length > 0) {
        dmo.updateDiscount(discountVOs);
      }

      timer.addExecutePhase("更新折扣");

      // 更新一般发票
      if (specialVOs != null && specialVOs.length > 0) {
        dmo.updateDiscount(specialVOs);
      }

      timer.addExecutePhase("更新一般发票");

      // 存货核算启用时向存货核算传数据
      if (stockVOs != null && stockVOs.length > 0) {
        String unitCode = stockVOs[0].getPk_corp();
        if (unitCode == null || unitCode.trim().length() == 0) {// zhf add v55
          // 先取开票公司如不存在取收货公司（支持其他入库单情况）
          unitCode = stockVOs[0].getPk_stockcorp();
        }
        myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
            .getInstance().lookup(ICreateCorpQueryService.class.getName());
        boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");

        if (bIAStartUp) {
          // 支持运费暂估zhf
          ArrayList<String> feeStockList = new ArrayList<String>();// 在本次费用结算中进行了暂估费用项分摊的入库行id
          HashMap<String, UFDouble> feeEstiMap = new HashMap<String, UFDouble>();// ---stockrow:nfeemny，费用项对应的成本要素号[1,2,3,4,5]
          HashMap feeFirstMap = null;
          for (StockVO vo : stockVOs) {
            if (vo.getCfeeid() != null && vo.getCfeeid().trim().length() > 0) {
              for (FeeinvoiceVO feeVO : feeVOs) {
                if (vo.getCfeeid().trim().equals(feeVO.getCmangid())) {
                  feeStockList.add(vo.getCgeneralbid().trim());
                  feeEstiMap.put(vo.getCgeneralbid().trim(), vo.getNfeemny());
                  break;
                }
              }
            }
          }
          if (feeStockList != null && feeStockList.size() > 0) {
            feeFirstMap = new PubDMO().queryArrayValues("po_settlebill_b",
                "cstockrow", new String[] {
                  "byffirstsettle"
                }, feeStockList.toArray(new String[0]),
                " dr=0 and byffirstsettle='Y'");
          }
          if (feeFirstMap != null && feeFirstMap.size() > 0) {
            for (Object okey : feeFirstMap.keySet()) {
              if (feeEstiMap.containsKey(okey)) {
                feeEstiMap.remove(okey);
                feeStockList.remove(okey);
              }
            }
          }
          // end
          
          // 2008.11.28合并项目需求-200805071248590242-采购费用结算传递费用发票的供应商
          // V55 联调问题号:NCdp200609247测试人:tangmc,开发组长:czp
          String[] saVendorId = getVendorId(feeVOs, discountVOs, specialVOs);

          ISysInitQry sysQryTool = (ISysInitQry) NCLocator.getInstance()
              .lookup(ISysInitQry.class.getName());
          String strEstiDealMode = sysQryTool.getParaString(unitCode, "PO12");

          saveBillFromOutterForFee(sDiffMode, settlebillVO, feeEstiMap,
              m_bIsentercost, unitCode, cOperator, head.getDsettledate(),
              strEstiDealMode, saVendorId);
        }
        // 结算完毕自动传应付
        new InvoiceImpl().settleAllToARAP(body, unitCode, cOperator, null);
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
            billCode.returnBillNo(settlebillVO);
          }
          catch (Exception ex) {
            PubDMO.throwBusinessException(ex);
          }
        }
      }

      timer.addExecutePhase("存货核算启用时向存货核算传数据");

      timer.showAllExecutePhase("费用单独结算");
    }
    catch (Exception e) {
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(settlebillVO);
        }
        catch (Exception ex) {
          PubDMO.throwBusinessException(e);
        }
      }
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    finally {
      try {
        // 对单据解锁
        if (bLock)
          LockTool.releaseLockForPks(sKeys, cOperator);
      }
      catch (Exception e) {
        nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      }
    }

    return;
  }

  /**
   * 功能描述:手工结算 参数：ArrayList结构 |-SettlebillVO settlebillVO,结算单VO |-StockVO
   * stockVOs[],入库单VO[] |-IinvoiceVO iinvoiceVOs[],发票VO[] |-FeeinvoiceVO
   * feeVOs[],费用发票VO[] |-FeeinvoiceVO discountVOs[],折扣发票VO[] |-String
   * sEstMode,暂估方式 |-String sDiffMode,差异转入方式 |-String cOperator,操作员
   * 返回值:结算单头主键（自动结算使用） 作者：熊海情 修改：晁志平 For V30、 V502
   */
  public String doManualBalance(ArrayList listPara) throws BusinessException {
    if (listPara == null || listPara.size() < 8) {
      SCMEnv.out("传入参数为空或参数不足，直接返回 NULL！");
      return null;
    }
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    //
    SettlebillVO settlebillVO = (SettlebillVO) listPara.get(0);
    StockVO[] stockVOs = (StockVO[]) listPara.get(1);
    IinvoiceVO[] iinvoiceVOs = (IinvoiceVO[]) listPara.get(2);
    FeeinvoiceVO[] feeVOs = (FeeinvoiceVO[]) listPara.get(3);
    FeeinvoiceVO[] discountVOs = (FeeinvoiceVO[]) listPara.get(4);
    String sEstMode = (String) listPara.get(5);
    String sDiffMode = (String) listPara.get(6);
    String cOperator = (String) listPara.get(7);
    UFBoolean bIc2PiSettle = (UFBoolean) listPara.get(8);// 入库单部分结算是否暂估
    UFBoolean bZGYF = (UFBoolean) listPara.get(9);// 是否暂估应付
    int nMnyDecimal = ((Integer) listPara.get(10)).intValue();// 金额精度
    UFBoolean bDifferSettle = (UFBoolean) listPara.get(11);// 是否异存货结算
    String strLoginCorpId = (String) listPara.get(12);// 登录公司
    // zhf add since v55
    int nPriceDecimal = BsPuTool.getPriceDigit(strLoginCorpId);
    // end

    // 异存货结算, 不允许暂估应付,2006-11-15 xhq
    if (bDifferSettle.booleanValue()) {
      if (bZGYF.booleanValue()) {
        // 如果参数"暂估应付"为"是",则不允许暂估
        bIc2PiSettle = new UFBoolean(false);
      }
      bZGYF = new UFBoolean(false);
    }
    // 2006-11-15 xhq

    SettleDMO dmo = null;
    ICreateCorpQueryService myService0 = null;
    boolean bLock = false;
    String key = null;
    boolean bGetBillCodeSucc = false;
    // 组合所有需要加锁的主键
    String sKeys[] = getSettleLockKeys(stockVOs, iinvoiceVOs, feeVOs,
        discountVOs, null, null, null);
    try {
      dmo = new SettleDMO();
      // 对单据加锁
      bLock = LockTool.setLockForPks(sKeys, cOperator);
      if (!bLock) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000009")/*
                                                           * @res
                                                           * "正在进行相关操作，请稍后再试！"
                                                           */);
      }
      timer.addExecutePhase(nc.bs.ml.NCLangResOnserver.getInstance()
          .getStrByID("40040502", "UPP40040502-000010")/*
                                                         * @res "组合所有需要加锁的主键"
                                                         */);
      // 判断时间戳是否改变
      String sMessage = isTimeStampChangedForSettle(stockVOs, iinvoiceVOs,
          feeVOs, discountVOs, null);
      if (sMessage != null && sMessage.length() > 0) {
        sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
            "40040502", "UPP40040502-000002")/*
                                               * @res "请刷新！\n"
                                               */;
        throw new BusinessException(sMessage);
      }
      // 测试并发控制
      SimpleDateFormat dateForamte=new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SS");
      StringBuilder msg=new StringBuilder();
      msg.append("手工结算已经通过并发检验：[")
      .append(dateForamte.format(new Date()))
      .append("]操作员ID[")
      .append(cOperator)
      .append("]锁定的单据ID[");
      for(String lockedid:sKeys)
        msg.append(lockedid+",");
      msg.append("]");
      Logger.info(msg);
      // 测试并发控制 end
      
      timer.addExecutePhase("判断时间戳是否改变");
      SettlebillHeaderVO head = settlebillVO.getHeadVO();
      head.setTmaketime((new UFDateTime(new Date())).toString());

      // 获得结算单号
      String vSettleCode = getSettleBillCode(head);
      head.setAttributeValue("vsettlebillcode", vSettleCode);
      bGetBillCodeSucc = true;

      timer.addExecutePhase("获得结算单号");
      //
      SettlebillItemVO body[] = settlebillVO.getBodyVO();

      // 支持部分结算后暂估
      // 需要暂估的入库单行:未暂估,未结算过,累计结算数量<入库数量(入库单部分结算)

      /*
       * 联通华盛暂不支持分收集结下的部分结算后暂估， 考虑： A、联通华盛项目没有要求 B、稳定性
       * C、暂时与V5011处理一致，仍不支持(2007-07-11-czp-注) 如果支持，需要调整：
       * 1)、调整转换VO算法，暂估VO要记录各个公司(采购、收票、收货公司)；
       * 2)、取价算法(将设置价格操作放到转换VO之后，可共用暂估时的算法)；
       * 3)、计算金额时的精度要用收票公司(采购公司)的，而不再是用收货公司的精度 V502，支持部分结算后暂估， Czp , 2007-08-14
       */
      if (bIc2PiSettle.booleanValue() && stockVOs != null
          && stockVOs.length > 0) {
        Vector vTemp = new Vector();
        for (int i = 0; i < stockVOs.length; i++) {
          if (!stockVOs[i].getBzgflag().booleanValue()
              && !stockVOs[i].getBsettled().booleanValue()
              && Math.abs(stockVOs[i].getNinnum().doubleValue()
                  - stockVOs[i].getNaccumsettlenum().doubleValue()) > 0
              // &&
              // stockVOs[i].getPk_corp().equals(stockVOs[i].getPk_stockcorp()))
              // 收货公司与登录公司相同
              && (stockVOs[i].getPk_corp()
                  .equals(stockVOs[i].getPk_stockcorp())
              // since v502,采购公司<>收货公司、采购公司=收票公司
              || (!stockVOs[i].getPk_purcorp().equals(
                  stockVOs[i].getPk_stockcorp()) && stockVOs[i].getPk_purcorp()
                  .equals(stockVOs[i].getPk_corp()))))
            vTemp.addElement(stockVOs[i]);
        }
        if (vTemp.size() > 0) {
          StockVO zgStockVOs[] = new StockVO[vTemp.size()];
          vTemp.copyInto(zgStockVOs);

          // //获取暂估单价
          // zgStockVOs = dmo.replacePrice(zgStockVOs);
          // 设置暂估标记和暂估日期
          for (int i = 0; i < zgStockVOs.length; i++) {
            zgStockVOs[i].setBzgflag(new UFBoolean(true));
            zgStockVOs[i].setDzgdate(head.getDsettledate());
          }

          EstimateVO[] estVOs = switchVOForZGYF(zgStockVOs, bZGYF);

          // 取结算价作为暂估单价 发票上单价 但又要支持原币 从发票上取 币种 汇率 原币单价
          // 特殊情况：如果一行入库单匹配到不同单价的多行发票时取第一行发票单价作为暂估价

          HashMap<String, String> InvStockMap = new HashMap<String, String>();
          // 入库单----结算单体 用于计算 ：暂估单价 = 结算金额/(结算数量+合理损耗数量)
          // SettlebillItemVO[] settleItemVos = settlebillVO.getBodyVO();
          for (SettlebillItemVO vo : body) {
            if (vo.getCstockrow() != null && vo.getCinvoice_bid() != null
                && !InvStockMap.containsKey(vo.getCstockrow())) {
              InvStockMap.put(vo.getCstockrow(), vo.getCinvoice_bid());
            }
          }

          HashMap retMap = null;

          // by zhaoyha at 2008.10.28
          ArrayList<String> invoiceBIDs=new ArrayList<String>();
          for (IinvoiceVO vo : iinvoiceVOs) {
            if (vo.getCinvoice_bid() != null
                && vo.getCinvoice_bid().trim().length() != 0) {
              invoiceBIDs.add(vo.getCinvoice_bid());
            }
          }
          
          // 原币币种、折本汇率、原币净无税单价、原币净含税单价
          // 注意,(根据需求)对于多张发票部分结算时,自动暂估的原币价随机从发票上取
          // 算法中保证一般取第一张发票价格
          retMap = (HashMap) new PubDMO().queryArrayValues("po_invoice_b",
              "cinvoice_bid", new String[] {
                  "ccurrencytypeid", "nexchangeotobrate","noriginalcurprice"
              },invoiceBIDs.toArray(new String[0]), " dr=0");

          for (int i = 0; i < estVOs.length; i++) {
            Object[] objs = (Object[]) retMap.get(InvStockMap.get(estVOs[i]
                .getCgeneralbid()));
            
            if (objs != null) {

              //取发票原币币种,折本汇率
              String cutypeId = (String) objs[0];
              UFDouble exchRate = PuPubVO.getUFDouble_NullAsZero(objs[1]);
              //取发票的原币价
              UFDouble nOrgnetPrice=new UFDouble(0.0);
              if(objs[2]!=null && objs[2].toString().length()!=0){
                nOrgnetPrice=new UFDouble(objs[2].toString());
              }
              estVOs[i].setCurrencytypeid(cutypeId);
              estVOs[i].setNexchangeotobrate(exchRate);
              estVOs[i].setNoriginalnetprice(nOrgnetPrice);
            }
          }
          // by zhaoyha end

          // ISysInitQry myService = (ISysInitQry)
          // NCLocator.getInstance().lookup(
          // ISysInitQry.class.getName());
          // String sPricePolicy = myService.getParaString(strLoginCorpId,
          // "PO28");
          // int nPricePolicy = RelationsCalVO.TAXPRICE_PRIOR_TO_PRICE;
          // if (OrderPubVO.TAXPRICE_PRIOR_TO_PRICE_NAME.equals(sPricePolicy)) {
          // nPricePolicy = RelationsCalVO.PRICE_PRIOR_TO_TAXPRICE;
          // }
          EstimateVO.calculateOrgTaxPriceForEstimateVO(estVOs,
              RelationsCalVO.PRICE_PRIOR_TO_TAXPRICE);
          EstimateDMO estDmo = new EstimateDMO();
          BusinessCurrencyRateUtil curTool = new BusinessCurrencyRateUtil(
              strLoginCorpId);
          String localCurId = PubDMO.getLocalCurrId(strLoginCorpId);

          for (int i = 0; i < estVOs.length; i++) {
            //只折算暂估成本的本币信息 by zhaoyha at 2008.9.24
            estDmo.setLocalPriceMnyFrmOrg(estVOs[i], strLoginCorpId,
                localCurId, curTool, nPriceDecimal, nMnyDecimal);
            //只折算暂估应付的本币信息by zhaoyha at 2008.9.24
            estDmo.setYFLocalPriceMnyFrmOrg(estVOs[i], strLoginCorpId,
                localCurId, curTool, nPriceDecimal, nMnyDecimal);
          }
          // --------------------------------------end----------
          // 并设置结算单暂估金额=暂估单价*结算数量
          // 这里只需要处理自动暂估的zgStockVOs by zhaoyha at 2009.6.1
          for (int i = 0; i < zgStockVOs.length; i++) {
            double d3 = 0;
            if (estVOs != null) {
			  zgStockVOs[i].setNprice(estVOs[i].getNprice());
			  zgStockVOs[i].setNmoney(estVOs[i].getNmoney());
			}
            // 重新设置暂估金额
            double d1 = zgStockVOs[i].getNprice().doubleValue();

            for (int j = 0; j < body.length; j++) {
            	if (body[j].getCstockrow() == null)
            		continue;
            	if (body[j].getCstockrow().equals(zgStockVOs[i].getCgeneralbid())) {
            		double d2 = body[j].getNsettlenum().doubleValue();

            		d3 += d2;
            		body[j].setNgaugemny(new UFDouble(PubDMO.getRoundDouble(
            				nMnyDecimal, d1 * d2)));
            		// 不能跳出，因为可能存在两个不同的结算单行来自同一张入库单的情况，金六福项目问题，since
            		// v502
            		// break;
            	}
            }

            // 暂估后, 需要重新计算入库单的累计结算金额
            d3 *= stockVOs[i].getNprice().doubleValue();
            d3 = PubDMO.getRoundDouble(nMnyDecimal, d3);
            d3 += zgStockVOs[i].getNaccumsettlemny().doubleValue();
            zgStockVOs[i].setNaccumsettlemny(new UFDouble(d3).add(new UFDouble(
                0.0), BsPuTool.getCCurrDecimal(null)));
          }
          // 进行暂估-----zhf
          estimateForPartSettle(zgStockVOs, estVOs, cOperator, head
              .getDsettledate(), bZGYF, strLoginCorpId);
        }
      }

      // since v55,
      // 支持费用暂估，处理StockVO，记录暂估费用ID：cfeeid,暂估费用金额：nfeemny,暂估的费用存货对应的成本要素信息...)
      dealStockVosUseEstFeeInfos(stockVOs, strLoginCorpId);
      // since v55, 支持费用暂估，处理第一次费用结算标志
      dealFirstFeeSettle(body, stockVOs);

      // if (true) throw new BusinessException("Stop Here!");

      // 插入结算单
      key = dmo.insertHead(head);
      String s[] = dmo.insertBody(body, key);
      for (int i = 0; i < body.length; i++) {
        body[i].setCsettlebill_bid(s[i]);
        body[i].setCsettlebillid(key);
      }
      timer.addExecutePhase("插入结算单");
      // 更新入库单
      if (stockVOs != null && stockVOs.length > 0) {
        dmo.updateStock(stockVOs, false);
      }
      timer.addExecutePhase("更新入库单");
      // 更新发票
      if (iinvoiceVOs != null && iinvoiceVOs.length > 0) {
        dmo.updateInvoice(iinvoiceVOs);
      }
      timer.addExecutePhase("更新发票");
      
      // 更新费用发票
      if (feeVOs != null && feeVOs.length > 0) {
        dmo.updateFee(feeVOs);
      }
      timer.addExecutePhase("更新费用发票");
      // 更新折扣
      if (discountVOs != null && discountVOs.length > 0) {
        dmo.updateDiscount(discountVOs);
      }
      timer.addExecutePhase("更新折扣");
      // 判断存货核算是否启用
      if (stockVOs != null && stockVOs.length > 0) {
        String unitCode = stockVOs[0].getPk_corp();
        myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
            .getInstance().lookup(ICreateCorpQueryService.class.getName());
        boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");
        if (bIAStartUp) {
          // 向存货核算传送数据
          GeneralHItemVO generalHItemVO[] = new GeneralHItemVO[stockVOs.length];
          for (int i = 0; i < stockVOs.length; i++) {
            generalHItemVO[i] = new GeneralHItemVO();
            generalHItemVO[i].setCgeneralhid(stockVOs[i].getCgeneralhid());
            generalHItemVO[i].setCgeneralbid(stockVOs[i].getCgeneralbid());
            generalHItemVO[i].setVfree1(stockVOs[i].getVfree1());
            generalHItemVO[i].setVfree2(stockVOs[i].getVfree2());
            generalHItemVO[i].setVfree3(stockVOs[i].getVfree3());
            generalHItemVO[i].setVfree4(stockVOs[i].getVfree4());
            generalHItemVO[i].setVfree5(stockVOs[i].getVfree5());

            generalHItemVO[i].setBzgflag(stockVOs[i].getBzgflag());
            generalHItemVO[i].setNinnum(stockVOs[i].getNinnum());
            generalHItemVO[i].setNmny(stockVOs[i].getNmoney());
          }
          listPara = new ArrayList();
          listPara.add(sEstMode);
          listPara.add(sDiffMode);
          listPara.add(settlebillVO);
          listPara.add(cOperator);
          listPara.add(head.getDsettledate());
          listPara.add(generalHItemVO);
          listPara.add(stockVOs);
          listPara.add(iinvoiceVOs);// since v55
          listPara.add(feeVOs);// since v55
          saveBillFromOutter1(listPara);
        }
        // 结算完毕自动传应付
        new InvoiceImpl().settleAllToARAP(body, strLoginCorpId, cOperator, null);
        
      //add by ouyangzhb 冲减入库单的暂估应付单
        InvoiceImpl impl = new InvoiceImpl();
        impl.adjustForSettle(this.getInvoiceVO(iinvoiceVOs));
        //add end 
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
            billCode.returnBillNo(settlebillVO);
          }
          catch (Exception ex) {
            /* 已经抛出异常!{此处注释针对工具检测未抛出} */
            // reportException(ex);
            nc.bs.pu.pub.PubDMO.throwBusinessException(ex);
          }
        }
      }
      timer.addExecutePhase("向存货核算传送数据-saveBillFromOutter1-(总)");

      timer.showAllExecutePhase("手工结算-doManualBalance()-时间分布");

    }
    catch (Exception e) {
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(settlebillVO);
        }
        catch (Exception ex) {
          /* 已经抛出异常!{此处注释针对工具检测未抛出} */
          // reportException(e);
          nc.bs.pu.pub.PubDMO.throwBusinessException(e);
        }
      }
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    finally {
      try {
        // if (myService != null) {
        // 对单据解锁
        if (bLock)
          // myService.freePKArrayByUser(sKeys, cOperator, "");
          LockTool.releaseLockForPks(sKeys, cOperator);
        // }
      }
      catch (Exception e) {
        nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      }
    }
    return key;
  }

  /*
   * since v55, 处理第一次费用结算标志 , 如果只有非暂估费用手工结算时，不应该回冲暂估费用 <p>注：本方法的一个重要前提就是如果没有货物发票，是不支持手工结算的。结算单表体数据格式如下，
   * <p>---------------------------------------------------------------------------------------
   * <p> 入库单行ID | 发票行ID | 结算金额 | 成本要素 <p>---------------------------------------------------------------------------------------
   * <p> ic0001 | pi0001 | 100+25 | 25 <p>---------------------------------------------------------------------------------------
   * <p> ic0002 | pi0002 | 200+25 | 25 <p>---------------------------------------------------------------------------------------
   * <p> |pi0003(非暂估费用)| 50 | 50 ----如果只有非暂估费用手工结算时，不应该回冲暂估费用 <p>---------------------------------------------------------------------------------------
   * <p> |pi0003(暂估费用)| 50 | 50 <p>---------------------------------------------------------------------------------------
   */
  private void dealFirstFeeSettle(SettlebillItemVO[] bodys, StockVO[] stocks)
      throws BusinessException {
    if (bodys == null || bodys.length == 0 || stocks == null
        || stocks.length == 0) {
      return;
    }
    // Step 1 : 记录有过分摊的货物结算单行的入库单行ID
    ArrayList<String> listStockRowId = new ArrayList<String>();
    // 费用存货ID
    ArrayList<String> listFeeMangId = new ArrayList<String>();
    for (SettlebillItemVO item : bodys) {
      // 是分摊过的入库单行且没有记录过
      if (item.isDistribute() && !listStockRowId.contains(item.getCstockrow())) {
        listStockRowId.add(item.getCstockrow());
        continue;
      }
      // 记录费用存货ID：未分摊过，或者同行入库单行出现过，且是费用行
      if (item.isFeeRow()) {
        listFeeMangId.add(item.getCmangid());
      }
      // 未分摊过，或者同行入库单行不是第一次出现，则不是第一次费用结算
      item.setByffirstsettle(UFBoolean.FALSE);
    }
    // 所有行未分摊过，则所有行均已设置为不是第一次费用结算，直接返回
    if (listStockRowId.size() == 0) {
      return;
    }
    // Step 2 : 哈希表{入库单行ID=费用ID},“入库单行有暂估费用项且与本次参与分摊之费用存货存在匹配”是第一次回冲标志的前提
    HashMap<String, String> mapStockRowIdFeeId = new HashMap<String, String>();
    for (StockVO vo : stocks) {
      if (vo == null || vo.getCgeneralbid() == null) {
        continue;
      }
      if (PuPubVO.getString_TrimZeroLenAsNull(vo.getCfeeid()) == null) {
        continue;
      }
      mapStockRowIdFeeId.put(vo.getCgeneralbid(), vo.getCfeeid());
    }

    // Step 3 : 设置表体行第一次费用结算标志-------------------------bgn

    // 本次参与分摊的行已经分摊过哈希表{货物入库单行ID+费用存货管理ID=""}
    HashMap<String, String> mapStockRowIdMangId = null;
    try {
      mapStockRowIdMangId = new SettleDMO().queryFeiYongFirstHash(
          listStockRowId, listFeeMangId);
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    listStockRowId = new ArrayList<String>();
    // 未查询到第一次费用结算标志为“Y”的行，说明，本次参与分摊的行均是第一次分摊
    if (mapStockRowIdMangId == null || mapStockRowIdMangId.size() == 0) {
      for (SettlebillItemVO item : bodys) {
        if (item.isDistribute()
            && !listStockRowId.contains(item.getCstockrow())) {
          listStockRowId.add(item.getCstockrow());
          // “入库单行有暂估费用项且与本次参与分摊之费用存货存在匹配”是第一次回冲标志的前提
          item.setByffirstsettle(PuPubVO.getUFBoolean_NullAs(listFeeMangId
              .contains(mapStockRowIdFeeId.get(item.getCstockrow())),
              UFBoolean.FALSE));
          continue;
        }
      }
      return;
    }
    // 按结算单行循环处理
    listStockRowId = new ArrayList<String>();
    int iFeeCnt = listFeeMangId.size();
    String strStockRowId = null;
    for (SettlebillItemVO item : bodys) {
      // 费用行,处理成N
      if (item.isFeeRow()) {
        item.setByffirstsettle(UFBoolean.FALSE);
        continue;
      }
      // 本次未参与分摊，或者已经处理过，已经处理成N
      strStockRowId = item.getCstockrow();
      if (!item.isDistribute() || listStockRowId.contains(strStockRowId)) {
        continue;
      }
      listStockRowId.add(strStockRowId);
      // 按费用项循环处理：当前货物行ID+每个费用项，数据库中未打费用结算标志的才打标志
      item.setByffirstsettle(UFBoolean.FALSE);
      for (int i = 0; i < iFeeCnt; i++) {
        if (!mapStockRowIdMangId.containsKey(strStockRowId
            + listFeeMangId.get(i))) {
          // “入库单行有暂估费用项且与本次参与分摊之费用存货存在匹配”是第一次回冲标志的前提
          item.setByffirstsettle(PuPubVO
              .getUFBoolean_NullAs(listFeeMangId.contains(mapStockRowIdFeeId
                  .get(strStockRowId)), UFBoolean.FALSE));
          break;
        }
      }
    }

    // if (true) throw new BusinessException("Stop Here!");

    // 设置表体行第一次费用结算标志-------------------------end
  }

  /**
   * 功能描述:无发票结算 作者：熊海情 修改：晁志平 For V30
   */
  public void doNoneBalance(SettlebillVO settlebillVO, StockVO stockVOs[],
      InvoiceVO invoiceVOs[], String sEstMode, String sDiffMode,
      String strLoginUser, String currType) throws BusinessException {
    SettleDMO dmo = null;
    boolean bLock = false;
    boolean bGetBillCodeSucc = false;
    String sTime = (new UFDateTime(new Date())).toString();
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    // 组合所有需要加锁的主键
    String sKeys[] = getSettleLockKeys(stockVOs, null, null, null, null, null,null);
    try {
      dmo = new SettleDMO();
      //对单据加锁
      bLock = LockTool.setLockForPks(sKeys, strLoginUser);
      if (!bLock){
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000009")/*@res"正在进行相关操作，请稍后再试！"*/);
      }
      timer.addExecutePhase("对单据加锁");

      // 判断时间戳是否改变
      String sMessage = isTimeStampChangedForSettle(stockVOs, null, null, null,
          null);
      if (sMessage != null && sMessage.length() > 0) {
        sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID("40040502", "UPP40040502-000002")/*@res "请刷新"*/;
        throw new BusinessException(sMessage);
      }
      timer.addExecutePhase("判断时间戳是否改变");

      //since v55, 将此处单独写的传应付重构到传应付组件，发票记录审批人(操作员)、审批日期(业务登录日期)
      ICreateCorpQueryService srvCreateCorpQuery = null;
      srvCreateCorpQuery = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
        .getInstance().lookup(ICreateCorpQueryService.class.getName());
      boolean bAPStartUp = srvCreateCorpQuery.isEnabled(BsPuTool.getLoginCorp(null), "AP");
      UFDate dateLogin = BsPuTool.getLoginDate();
      // 插入虚拟发票
      Vector vKey1 = new Vector(); // 发票头主键
      Vector vKey2 = new Vector(); // 发票体主键
      Set<String> orderid= new HashSet<String>();
      if (invoiceVOs != null && invoiceVOs.length > 0) {
        Vector v = new Vector();
        for (int i = 0; i < invoiceVOs.length; i++) {
          InvoiceHeaderVO headVO = invoiceVOs[i].getHeadVO();
          if(bAPStartUp){
            headVO.setIbillstatus(BillStatus.AUDITED);
            headVO.setCauditpsn(strLoginUser);
            headVO.setDauditdate(dateLogin);
            
          }
          InvoiceItemVO itemVOs[] = invoiceVOs[i].getBodyVO();
          //保存来源的订单ID,用于查询收付款协议
          if(itemVOs[0].getCorderid()!=null && itemVOs[0].getCorderid().trim().length()>0)
            orderid.add(itemVOs[0].getCorderid());
          //查询来源订单的收付款协议信息
          if(orderid.size()>0){
            //查询订单的收付款协议
            Hashtable t=new EstimateDMO().getOrderInvoiceReceiver(orderid.toArray(new String[0]));
            String proto[]=(String[])t.get(itemVOs[0].getCorderid());
            if(proto!=null && proto.length>1 && proto[1]!=null){
              headVO.setCtermprotocolid(proto[1]);
            }
            orderid.clear();
          }
          // 获取发票号
          String vInvoiceCode = getInvoiceCode(headVO);
          headVO.setVinvoicecode(vInvoiceCode);
          headVO.setTmaketime(sTime);
          headVO.setTlastmaketime(sTime);
          //since v55, 虚拟发票，打上传应付标志
          headVO.setBapflag(UFBoolean.TRUE);
          //
          String s = dmo.insertInvoiceHead(headVO);
          // since v502
          headVO.setCinvoiceid(s);
          //
          for (int j = 0; j < itemVOs.length; j++) {
            itemVOs[j].setCinvoiceid(s);
            v.addElement(itemVOs[j]);
          }
          String ss[] = dmo.insertInvoiceBody(itemVOs);
          for (int j = 0; j < itemVOs.length; j++) {
            itemVOs[j].setCinvoice_bid(ss[j]);
            vKey1.addElement(s);
            vKey2.addElement(ss[j]);
          }
        }
        // 更新入库单(采购订单)累计开票数量
        if (v.size() > 0) {
          InvoiceItemVO itemVOs[] = new InvoiceItemVO[v.size()];
          v.copyInto(itemVOs);
          dmo.updateSignNum(itemVOs, false, settlebillVO.isUserConfirmed());
        }
      }
      
      timer.addExecutePhase("插入虚拟发票");

      SettlebillHeaderVO head = settlebillVO.getHeadVO();
      head.setTmaketime(sTime);

      // 获得结算单号
      String vSettleCode = getSettleBillCode(head);
      head.setAttributeValue("vsettlebillcode", vSettleCode);
      bGetBillCodeSucc = true;

      timer.addExecutePhase("获得结算单号");

      // 插入结算单
      String key = dmo.insertHead(head);

      timer.addExecutePhase("插入结算单--表头");

      SettlebillItemVO body[] = settlebillVO.getBodyVO();
      if (vKey1 != null && vKey1.size() > 0) {
        for (int i = 0; i < body.length; i++) {
          body[i].setCinvoiceid((String) vKey1.elementAt(i));
          body[i].setCinvoice_bid((String) vKey2.elementAt(i));
        }
      }
      String s[] = dmo.insertBody(body, key);
      for (int i = 0; i < body.length; i++) {
        body[i].setCsettlebill_bid(s[i]);
        body[i].setCsettlebillid(key);
      }

      timer.addExecutePhase("插入结算单--表体");

      // 更新入库单
      if (stockVOs != null && stockVOs.length > 0) {
        dmo.updateStock(stockVOs, false);
      }

      timer.addExecutePhase("更新入库单");

      // 判断存货核算和应付是否启用
      if (stockVOs != null && stockVOs.length > 0) {
        String unitCode = stockVOs[0].getPk_corp();
        boolean bIAStartUp = srvCreateCorpQuery.isEnabled(unitCode, "IA");

        if (bIAStartUp) {
          // 向存货核算传送数据
          ArrayList listPara = new ArrayList();
          listPara.add(sEstMode);
          listPara.add(sDiffMode);
          listPara.add(settlebillVO);
          listPara.add(strLoginUser);
          listPara.add(head.getDsettledate());
          listPara.add(null);
          listPara.add(null);
          listPara.add(null);// since v55
          listPara.add(null);// since v55
          saveBillFromOutter1(listPara);
        }
        timer.addExecutePhase("向存货核算传送数据(总)");

        // 向应付传送数据
        if (bAPStartUp) {
          // 调用N_strType_SAVE脚本，正式应付
          IPFBusiAction bsBusiAction = (IPFBusiAction) NCLocator.getInstance().lookup(IPFBusiAction.class.getName());
          for(InvoiceVO voInvoice : invoiceVOs){
            bsBusiAction.processAction("CRTAPBILL", BillTypeConst.PO_INVOICE, 
                dateLogin+"", null, voInvoice, null, null);
          }
          timer.addExecutePhase("调用N_strType_SAVE脚本，正式应付");
        }
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            GetSysBillCode billCode = new GetSysBillCode();
            billCode.returnBillNo(settlebillVO);
          }
          catch (Exception ex) {
            PubDMO.throwBusinessException(ex);
          }
        }
      }
      timer.showAllExecutePhase("无发票结算时间分布");

    }
    catch (Exception e) {
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          GetSysBillCode billCode = new GetSysBillCode();
          billCode.returnBillNo(settlebillVO);
        }
        catch (Exception ex) {
          PubDMO.throwBusinessException(e);
        }
      }PubDMO.throwBusinessException(e);
    }
    finally {
      try {
        if (bLock){
          LockTool.releaseLockForPks(sKeys, strLoginUser);
        }
      }
      catch (Exception e) {
        nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      }
    }

    return;
  }

  /**
   * 功能描述:根据销售结算 输入参数: ArrayList [0]:InvoiceVO invoiceVO,发票VO [1]:String sKey,主键
   * [2]:SettlebillVO settlebillVO, 结算单VO [3]:StockVO[] stockVOs,入库单VO[]
   * [4]:IinvoiceVO[] iinvoiceVOs,发票VO[] [5]:String sEstMode,暂估方式 [6]:String
   * sDiffMode,差异转入方式 [7]:String cOperator,操作员 [8]:OorderVO[] orderVOs,订单VO[]
   * [9]:IdTsData struIdTs,销售发票时间戳数据 返回值: ArrayList [0]:采购订单表体新时间戳
   * [1]:采购入库单子表新时间戳 [2]:采购入库单子子表3新时间戳 [3]:采购结算表新时间戳 [4]:发票头、发票体主键...、发票号和结算单头主键
   * 作者：熊海情 修改：晁志平 For V30
   */
  public ArrayList doSaleBalance(ArrayList listPara) throws BusinessException {
    if (listPara == null || listPara.size() < 10) {
      SCMEnv.out("传入参数为空或参数不足，直接返回 NULL！");
      return null;
    }

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    /** 获取参数 */
    InvoiceVO invoiceVO = (InvoiceVO) listPara.get(0);
    String sKey = (String) listPara.get(1);
    SettlebillVO settlebillVO = (SettlebillVO) listPara.get(2);
    StockVO[] stockVOs = (StockVO[]) listPara.get(3);
    IinvoiceVO[] iinvoiceVOs = (IinvoiceVO[]) listPara.get(4);
    String sEstMode = (String) listPara.get(5);
    String sDiffMode = (String) listPara.get(6);
    String cOperator = (String) listPara.get(7);
    OorderVO[] orderVOs = (OorderVO[]) listPara.get(8);
    IdTsData struIdTs = (IdTsData) listPara.get(9);

    String sTime = (new UFDateTime(new Date())).toString();
    //

    // 过滤StockVO中不参与本次结算的
    if (stockVOs != null && stockVOs.length > 0 && iinvoiceVOs != null
        && iinvoiceVOs.length > 0) {
      Vector v1 = new Vector(), v2 = new Vector();
      for (int i = 0; i < iinvoiceVOs.length; i++) {
        if (!v2.contains(iinvoiceVOs[i].getCupsourcebillrowid()))
          v2.addElement(iinvoiceVOs[i].getCupsourcebillrowid());
      }
      for (int i = 0; i < stockVOs.length; i++) {
        if (v2.contains(stockVOs[i].getCgeneralbid()))
          v1.addElement(stockVOs[i]);
      }
      stockVOs = new StockVO[v1.size()];
      v1.copyInto(stockVOs);
    }
    //

    SettleDMO dmo = null;
    String key = "";
    Vector vRet = new Vector();
    int iSize = 5;
    ArrayList listRet = new ArrayList(iSize);
    for (int i = 0; i < iSize; i++) {
      listRet.add(null);
    }
    IdTsData dataIdTs = null;
    ICreateCorpQueryService myService0 = null;
    boolean bLock = false;
    /** 组合所有需要加锁的主键 */
    String sKeys[] = getSettleLockKeys(stockVOs, null, null, null, null,
        orderVOs, null);
    if (struIdTs != null && struIdTs.getIDs() != null && sKeys != null
        && sKeys.length > 0) {
      Vector vTmp = new Vector();
      int iLen = sKeys.length;
      for (int i = 0; i < iLen; i++) {
        vTmp.addElement(sKeys[i]);
      }
      iLen = struIdTs.getIDs().length;
      for (int i = 0; i < iLen; i++) {
        vTmp.addElement(struIdTs.getIDs()[i]);
      }
      sKeys = new String[vTmp.size()];
      vTmp.copyInto(sKeys);
    }
    try {
      dmo = new SettleDMO();
      /** 加锁 */
      bLock = LockTool.setLockForPks(sKeys, cOperator);
      if (!bLock) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000009")/*
                                                           * @res
                                                           * "正在进行相关操作，请稍后再试！"
                                                           */);
      }
      timer.addExecutePhase(nc.bs.ml.NCLangResOnserver.getInstance()
          .getStrByID("40040502", "UPP40040502-000011")/*
                                                         * @res "加锁"
                                                         */);

      /** 并发判断(时间戳是否改变) */
      String sMessage = isTimeStampChangedForSales(stockVOs, orderVOs, struIdTs);
      if (sMessage != null && sMessage.length() > 0
          && (sKey == null || sKey.trim().equals(""))) {
        sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
            "40040502", "UPP40040502-000002")/*
                                               * @res "请刷新！\n"
                                               */;
        throw new BusinessException(sMessage);
      }
      timer.addExecutePhase("并发判断");

      /** 插入发票 */
      InvoiceHeaderVO headVO = invoiceVO.getHeadVO();
      InvoiceItemVO bodyVO[] = invoiceVO.getBodyVO();
      String vInvoiceCode = getInvoiceCode(headVO);
      headVO.setVinvoicecode(vInvoiceCode);
      headVO.setTmaketime(sTime);
      headVO.setTlastmaketime(sTime);
      String key1 = dmo.insertInvoiceHead(headVO);
      vRet.addElement(key1);
      for (int i = 0; i < bodyVO.length; i++) {
        bodyVO[i].setCinvoiceid(key1);
      }
      String key2[] = dmo.insertInvoiceBody(bodyVO);
      for (int i = 0; i < bodyVO.length; i++) {
        vRet.addElement(key2[i]);
      }
      timer.addExecutePhase("插入发票");

      // 更新订单的累计发票数量（发票数量+订单的累计发票数量）
      dataIdTs = dmo.updateOrderInvoiceNum(bodyVO, true);
      timer.addExecutePhase("更新订单的累计发票数量");
      // 返回采购订单子表新时间戳
      listRet.add(0, dataIdTs);
      timer.addExecutePhase("返回采购订单子表新时间戳");
      // 返回发票号
      vRet.addElement(vInvoiceCode);
      /** 插入结算单 */
      SettlebillHeaderVO head = settlebillVO.getHeadVO();
      head.setTmaketime(sTime);
      if (sKey == null || sKey.trim().length() == 0) {
        String vSettleCode = getSettleBillCode(head);
        head.setAttributeValue("vsettlebillcode", vSettleCode);
        key = dmo.insertHead(head);
      }
      else {
        key = sKey;
      }
      timer.addExecutePhase("插入结算单");
      // 返回结算单ID
      vRet.addElement(key);
      SettlebillItemVO body[] = settlebillVO.getBodyVO();
      for (int i = 0; i < body.length; i++) {
        body[i].setCinvoiceid(key1);
        body[i].setCinvoice_bid((String) vRet.elementAt(i + 1));
        // 设置发票号
        body[i].setVinvoicecode(vInvoiceCode);
      }
      String s[] = dmo.insertBody(body, key);
      for (int i = 0; i < body.length; i++) {
        body[i].setCsettlebill_bid(s[i]);
        body[i].setCsettlebillid(key);
      }
      /** 更新入库单 */
      IdTsData[] datas = null;
      if (stockVOs != null && stockVOs.length > 0) {
        datas = dmo.updateStock(stockVOs, true);
        // 返回入库单子表新时间戳
        listRet.add(1, datas[0]);
        listRet.add(2, datas[1]);
      }
      timer.addExecutePhase("更新入库单");
      /** 更新发票 */
      if (iinvoiceVOs != null && iinvoiceVOs.length > 0) {
        for (int i = 0; i < iinvoiceVOs.length; i++) {
          iinvoiceVOs[i].setCinvoiceid((String) vRet.elementAt(0));
          iinvoiceVOs[i].setCinvoice_bid((String) vRet.elementAt(i + 1));
        }
        dmo.updateInvoice(iinvoiceVOs);
      }
      timer.addExecutePhase("更新发票");
      /** 更新采购销售发票数据 */
      if (settlebillVO != null) {
        dataIdTs = dmo.updateSaleDataBatch(settlebillVO.getBodyVO(), true);
        // 返回采购销售数据表新时间戳
        listRet.add(3, dataIdTs);
      }
      timer.addExecutePhase("更新采购销售发票数据");
      /** 向存货核算传数据 */
      if (stockVOs != null && stockVOs.length > 0) {
        String unitCode = stockVOs[0].getPk_corp();
        myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
            .getInstance().lookup(ICreateCorpQueryService.class.getName());
        boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");
        if (bIAStartUp) {
          listPara = new ArrayList();
          listPara.add(sEstMode);
          listPara.add(sDiffMode);
          listPara.add(settlebillVO);
          listPara.add(cOperator);
          listPara.add(head.getDsettledate());
          listPara.add(null);
          listPara.add(null);
          listPara.add(null);// since v55
          listPara.add(null);// since v55
          saveBillFromOutter1(listPara);
        }
        // 结算完毕自动传应付
        new InvoiceImpl().settleAllToARAP(body, unitCode, cOperator, null);
      }
      else {
        // 结算失败,回退结算单号
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(settlebillVO);
        }
        catch (Exception ex) {
          /* 已经抛出异常!{此处注释针对工具检测未抛出} */
          // reportException(ex);
          nc.bs.pu.pub.PubDMO.throwBusinessException(ex);
        }
      }
      timer.addExecutePhase("向存货核算传数据(总)");

      timer.showAllExecutePhase("根据销售结算");

    }
    catch (Exception e) {
      // 结算失败,回退结算单号
      try {
        nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
        billCode.returnBillNo(settlebillVO);
      }
      catch (Exception ex) {
        /* 已经抛出异常!{此处注释针对工具检测未抛出} */
        // reportException(e);
        nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      }
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    finally {
      try {
        // if (myService != null) {
        if (bLock)
          // myService.freePKArrayByUser(sKeys, cOperator, "");
          LockTool.releaseLockForPks(sKeys, cOperator);
        // }
      }
      catch (Exception e) {
        nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      }
    }
    if (vRet.size() > 0) {
      String sReturn[] = new String[vRet.size()];
      vRet.copyInto(sReturn);
      listRet.add(4, sReturn);
    }
    //
    return listRet;
  }

  /**
   * 功能描述:退税率统一处理 处理步骤： 1）获得采购公共参数：是否按外贸退税、退税率在自由项中的位置、退税调整项目ID
   * 2）如果按外贸退税而且退税率不为17或0或空，则另外向存货核算传送入库成本调整单（I9）， 调整金额为（17-退税率）/100*结算金额
   * 3）涉及的结算方式包括：手工结算、自动结算、异存货结算、入库单生成发票即时结算 输入参数:存货入库单VO，结算金额，入库单体VO[]
   * 返回值:存货入库成本调整单 日期:2002/09/17 作者：熊海情 修改：晁志平 For V30、 V502
   */
  private BillVO generateI9ForWithraw(BillVO billVO, UFDouble nSettleMny,
      GeneralHItemVO generalHItemVOs[], ArrayList tsList)
      throws BusinessException, nc.vo.pub.BusinessException {
    IBillHeaderVO headerVO = (IBillHeaderVO) billVO.getParentVO();
    IBillItemVO itemVO[] = (IBillItemVO[]) billVO.getChildrenVO();

    if (headerVO == null)
      return null;
    if (itemVO == null || itemVO.length == 0)
      return null;
    if (generalHItemVOs == null || generalHItemVOs.length == 0)
      return null;

    String sWithdraw = null; // 是否外贸退税
    String sWithdrawPos = null; // 退税率在自由项中的位置
    String sWithdrawID = null; // 退税调整项目ID
    UFBoolean bWithdraw = new UFBoolean(false);
    if (tsList != null && tsList.size() > 1) {
      sWithdraw = (String) tsList.get(2);
      sWithdrawPos = (String) tsList.get(3);
      sWithdrawID = (String) tsList.get(4);
      if (sWithdraw != null)
        bWithdraw = new UFBoolean(sWithdraw.trim());
    }
    if (!bWithdraw.booleanValue())
      return null;

    // 手工结算时，3张采购入库单行和3张采购发票行结算，可能生成5张结算单行，因此必须根据存货入库单VO
    // 的行ID匹配到需进行退税调整的采购入库单行ID
    GeneralHItemVO generalHItemVO = null;
    for (int i = 0; i < generalHItemVOs.length; i++) {
      String s1 = generalHItemVOs[i].getCgeneralbid().trim();
      for (int j = 0; j < itemVO.length; j++) {
        String s2 = itemVO[j].getCbill_bid();
        if (s2 == null || s2.trim().length() == 0)
          continue;
        s2 = s2.trim();
        if (s1.equals(s2)) {
          generalHItemVO = new GeneralHItemVO();
          generalHItemVO = generalHItemVOs[i];
          i = generalHItemVOs.length;
          break;
        }
      }
    }
    if (generalHItemVO == null)
      return null;
    //

    Vector vReturn = new Vector();
    try {
      if (sWithdrawID == null || sWithdrawID.trim().length() == 0)
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000012")/* @res "未设置退税调整ID！" */);
      sWithdrawID = sWithdrawID.trim();

      // 如果自由项的退税率非17%、非0%，则向存货核算加传入库成本调整单
      String sWithdrawRate = null;
      if (sWithdrawPos.equals("1"))
        sWithdrawRate = generalHItemVO.getVfree1();
      else if (sWithdrawPos.equals("2"))
        sWithdrawRate = generalHItemVO.getVfree2();
      else if (sWithdrawPos.equals("3"))
        sWithdrawRate = generalHItemVO.getVfree3();
      else if (sWithdrawPos.equals("4"))
        sWithdrawRate = generalHItemVO.getVfree4();
      else if (sWithdrawPos.equals("5"))
        sWithdrawRate = generalHItemVO.getVfree5();

      UFDouble dWithdrawRate = new UFDouble(0);
      if (sWithdrawRate != null && sWithdrawRate.trim().length() > 0)
        dWithdrawRate = new UFDouble(sWithdrawRate.trim());
      if (dWithdrawRate.doubleValue() < 0 || dWithdrawRate.doubleValue() > 17)
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000013")/*
                                                           * @res
                                                           * "退税率必须在0~17之间！"
                                                           */);

      if (dWithdrawRate.doubleValue() != 17 && dWithdrawRate.doubleValue() != 0) {
        // 生成入库成本调整单
        BillVO gbillVO = new BillVO();
        IBillHeaderVO gheaderVO = (IBillHeaderVO) headerVO.clone();
        IBillItemVO gitemVO = (IBillItemVO) itemVO[0].clone();
        gitemVO.setCastunitid(null);
        gitemVO.setNassistnum(null);
        gheaderVO.setCbilltypecode("I9");
        gitemVO.setCbilltypecode("I9");
        gitemVO.setNnumber(null);
        gitemVO.setNprice(null);
        gitemVO.setCprojectid(sWithdrawID);
        if (nSettleMny != null) {
          double d = nSettleMny.doubleValue();
          gitemVO.setNmoney(new UFDouble(d * (17 - dWithdrawRate.doubleValue())
              / 100.0));
        }

        Vector vTemp = new Vector();
        vTemp.addElement(gitemVO);
        IBillItemVO tempVO[] = new IBillItemVO[1];
        vTemp.copyInto(tempVO);
        gbillVO.setChildrenVO(tempVO);
        gbillVO.setParentVO(gheaderVO);

        ((IBillHeaderVO) gbillVO.getParentVO()).setBestimateflag(headerVO
            .getBestimateflag());

        // 对调整单,若金额为空或为0,不向存货核算传送
        if (gitemVO.getNmoney() != null
            && gitemVO.getNmoney().doubleValue() != 0.0) {
          vReturn.addElement(gbillVO);
        }
      }

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    if (vReturn.size() > 0) {
      return (BillVO) vReturn.elementAt(0);
    }

    return null;
  }

  /**
   * 功能描述:供应商默认的开户银行ID（优化效率，提供批次处理功能） 输入参数:供应商基础ID 修改日期：2003/02/11 xhq 作者：熊海情
   * 修改：晁志平 For V30
   */
  public String[] getAccountBankIDBatch(String cVendorBaseID[])
      throws BusinessException {
    FormulaParse f = new FormulaParse();

    // 获得开户银行ID
    String sExpress = "getColValue(bd_custbank,pk_custbank,pk_cubasdoc,cVendorBaseID)";
    f.setExpress(sExpress);
    VarryVO varry = f.getVarry();
    Hashtable table = new Hashtable();
    String sParam[] = new String[cVendorBaseID.length];
    for (int i = 0; i < cVendorBaseID.length; i++)
      sParam[i] = StringUtil.toString(cVendorBaseID[i]);
    table.put(varry.getVarry()[0], sParam);
    f.setDataS(table);
    String sBankKey[] = f.getValueS();

    if (sBankKey != null && sBankKey.length > 0)
      return sBankKey;
    return null;
  }

  /**
   * 功能描述:航天中汇专用(获得供应商管理档案的公司ID) 日期:2002/09/14 作者：熊海情 修改：晁志平 For V30
   */
  public String[] getCorpIDs() throws BusinessException {
    String s[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      s = dmo.getCorpIDs();
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return s;
  }

  /**
   * 功能描述:航天中汇专用(获得供应商管理档案中custflag为2或3的pk_cubasdoc及custname,custflag)
   * 日期:2002/09/14 作者：熊海情 修改：晁志平 For V30
   */
  public Vector getCustIDAndNameFromCust(String pk_corp)
      throws BusinessException {
    Vector v = null;
    try {
      SettleDMO dmo = new SettleDMO();
      v = dmo.getCustIDAndNameFromCust(pk_corp);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return v;
  }

  /**
   * 功能描述:航天中汇专用(获得供应商管理档案中custflag为1或空的pk_cubasdoc及custname,custflag)
   * 日期:2002/09/14 作者：熊海情 修改：晁志平 For V30
   */
  public Vector getCustIDAndNameFromVendor(String pk_corp)
      throws BusinessException {
    Vector v = null;
    try {
      SettleDMO dmo = new SettleDMO();
      v = dmo.getCustIDAndNameFromVendor(pk_corp);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return v;
  }

  /**
   * 功能描述:获得发票号 作者：熊海情 修改：晁志平 For V30
   */

  private String getInvoiceCode(InvoiceHeaderVO headVO)
      throws BusinessException {
    String vBillCode = null;
    BillcodeGenerater myService = null;

    // 获取发票号
    try {
      nc.vo.pub.billcodemanage.BillCodeObjValueVO vo = new nc.vo.pub.billcodemanage.BillCodeObjValueVO();

      String sNames[] = {
          "公司", "部门", "业务类型"
      };
      String sKeys[] = {
          "pk_corp", "cdeptid", "cbiztype"
      };
      for (int i = 0; i < sNames.length; i++) {
        Object o = headVO.getAttributeValue(sKeys[i]);
        vo.setAttributeValue(sNames[i], o);
      }

      myService = new BillcodeGenerater();

      vBillCode = headVO.getVinvoicecode();
      if (vBillCode == null || vBillCode.length() == 0)
        vBillCode = null;

      vBillCode = myService.getBillCode(headVO.getCbilltype(), headVO
          .getPk_corp(), vBillCode, vo);

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return vBillCode;
  }

  /**
   * 功能描述:得到发票需要加锁的主键集合(服务于发票,费用发票,折扣发票和无数量的一般发票) 作者：熊海情 修改：晁志平 For V30
   */
  private Vector getInvoiceLockKeys(IinvoiceVO invoiceVOs[],
      FeeinvoiceVO feeVOs[], FeeinvoiceVO discountVOs[],
      FeeinvoiceVO specialVOs[], Vector v) {
    if (v == null || v.size() == 0)
      v = new Vector();

    // 所有发票的表头主键和表体主键集合
    Vector v1 = new Vector();
    Vector v2 = new Vector();
    if (invoiceVOs != null && invoiceVOs.length > 0) {
      for (int i = 0; i < invoiceVOs.length; i++) {
        v1.addElement(invoiceVOs[i].getCinvoiceid());
        v2.addElement(invoiceVOs[i].getCinvoice_bid());
      }
    }
    if (feeVOs != null && feeVOs.length > 0) {
      for (int i = 0; i < feeVOs.length; i++) {
        v1.addElement(feeVOs[i].getCinvoiceid());
        v2.addElement(feeVOs[i].getCinvoice_bid());
      }
    }
    if (discountVOs != null && discountVOs.length > 0) {
      for (int i = 0; i < discountVOs.length; i++) {
        v1.addElement(discountVOs[i].getCinvoiceid());
        v2.addElement(discountVOs[i].getCinvoice_bid());
      }
    }
    if (specialVOs != null && specialVOs.length > 0) {
      for (int i = 0; i < specialVOs.length; i++) {
        v1.addElement(specialVOs[i].getCinvoiceid());
        v2.addElement(specialVOs[i].getCinvoice_bid());
      }
    }

    // 发票表头主键唯一性集合
    if (v1 != null && v1.size() > 0) {

      // 发票表头主键唯一性集合
      v.addElement(v1.elementAt(0));
      for (int i = 1; i < v1.size(); i++) {
        String s1 = (String) v1.elementAt(i);
        s1 = s1.trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
    }

    // 发票表体主键唯一性集合
    if (v2 != null && v2.size() > 0) {

      // 发票表体主键唯一性集合
      v.addElement(v2.elementAt(0));
      for (int i = 1; i < v2.size(); i++) {
        String s1 = (String) v2.elementAt(i);
        s1 = s1.trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
    }

    return v;
  }

  /**
   * 功能描述:获得单位重量，单位体积 作者：熊海情 修改：晁志平 For V30
   */
  public Vector getIUnitWeightAndVolume(IinvoiceVO vo[])
      throws BusinessException {
    FormulaParse f = new FormulaParse();

    // 获得单位重量
    String sExpress1 = "getColValue(bd_invbasdoc,unitweight,pk_invbasdoc,cBaseid)";
    // 获得单位体积
    String sExpress2 = "getColValue(bd_invbasdoc,unitvolume,pk_invbasdoc,cBaseid)";

    f.setExpressArray(new String[] {
        sExpress1, sExpress2
    });

    VarryVO varry[] = f.getVarryArray();

    String sParam[] = new String[vo.length];
    for (int i = 0; i < vo.length; i++)
      sParam[i] = vo[i].getCbaseid();

    f.addVariable(varry[0].getVarry()[0], sParam);
    f.addVariable(varry[1].getVarry()[0], sParam);

    String sUnitWeight[] = f.getValueSArray()[0];
    String sUnitVolume[] = f.getValueSArray()[1];

    // 返回单位重量，单位体积
    Vector v = new Vector();
    for (int i = 0; i < vo.length; i++) {
      Vector vv = new Vector();
      vv.addElement(sUnitWeight[i]);
      vv.addElement(sUnitVolume[i]);
      v.addElement(vv);
    }

    return v;
  }

  /**
   * 功能描述:获得销售发票的存货基础ID 2004-03-31CzpAdd:查询存货管理档案对应的主供应商 作者：熊海情 修改：晁志平 For V30
   */
  public SaledataVO[] getRefSaleInvoice(SaledataVO VOs[])
      throws BusinessException {
    FormulaParse f = new FormulaParse();
    // 获得存货基础ID
    String sExpress1 = "getColValue(bd_invmandoc,pk_invbasdoc,pk_invmandoc,cMangid)";
    // 获得主供应商ID
    String sExpress2 = "getColValue(bd_invmandoc,pk_cumandoc,pk_invmandoc,cMangid)";
    f.setExpressArray(new String[] {
        sExpress1, sExpress2
    });
    VarryVO varry[] = f.getVarryArray();
    String sParam[] = new String[VOs.length];
    for (int i = 0; i < sParam.length; i++)
      sParam[i] = VOs[i].getCmangid();
    f.addVariable(varry[0].getVarry()[0], sParam);
    f.addVariable(varry[1].getVarry()[0], sParam);
    String sBaseid[] = f.getValueSArray()[0];
    String sVendormangid[] = f.getValueSArray()[1];
    // 返回
    for (int i = 0; i < VOs.length; i++) {
      VOs[i].setCbaseid(sBaseid[i]);
      VOs[i].setCvendormangid(sVendormangid[i]);
    }
    return VOs;
  }

  /**
   * 功能描述:替换串 作者：熊海情 修改：晁志平 For V30
   */
  private String getReplacedSQL(String sSource, String sOld, String sReplace) {
    if (sReplace == null || sReplace.trim().length() == 0)
      return sSource;
    int nStart = sSource.indexOf(sOld);
    if (nStart < 0)
      return sSource;
    int nMiddle = sSource.indexOf("'", nStart + 1);
    if (nMiddle < 0)
      return sSource;
    int nEnd = sSource.indexOf("'", nMiddle + 1);
    String s1 = sSource.substring(0, nStart);
    String s2 = sSource.substring(nEnd + 1);
    String s = s1 + sReplace + s2;
    return s;
  }

  /**
   * 功能描述:获得结算单号 作者：熊海情 修改：晁志平 For V30
   */
  private String getSettleBillCode(SettlebillHeaderVO head)
      throws BusinessException {
    String vSettleCode = null;
    // 获取结算单号
    try {
      SettlebillVO vo = new SettlebillVO(1);
      vo.setParentVO(head);
      vo.setChildrenVO(new SettlebillItemVO[] {
        new SettlebillItemVO()
      });
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      do {
        vSettleCode = billCode.getSysBillNO(vo);
      }
      while (isSettlebillCodeDuplicate(head.getPk_corp(), vSettleCode));
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vSettleCode;
  }

  /**
   * 功能描述:获得需要加锁的主键集合 输入参数:入库单VO,发票VO,费用发票VO,折扣VO,一般发票VO(无数量或数量为0)，订单VO，材料出库单VO
   * 作者：熊海情 修改：晁志平 For V30
   */
  private String[] getSettleLockKeys(StockVO stockVOs[],
      IinvoiceVO invoiceVOs[], FeeinvoiceVO feeVOs[],
      FeeinvoiceVO discountVOs[], FeeinvoiceVO specialVOs[],
      OorderVO orderVOs[], MaterialVO materialVOs[]) {
    Vector v = new Vector();
    // 入库单主键唯一性集合
    if (stockVOs != null && stockVOs.length > 0) {
      // 入库单表头主键唯一性集合
      v.addElement(stockVOs[0].getCgeneralhid().trim());
      for (int i = 1; i < stockVOs.length; i++) {
        String s1 = stockVOs[i].getCgeneralhid().trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
      // 入库单表体主键唯一性集合
      v.addElement(stockVOs[0].getCgeneralbid().trim());
      for (int i = 1; i < stockVOs.length; i++) {
        String s1 = stockVOs[i].getCgeneralbid().trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
      // 入库单结算子表主键唯一性集合
      if (stockVOs[0].getCgeneralbb3() != null)
        v.addElement(stockVOs[0].getCgeneralbb3().trim());
      for (int i = 1; i < stockVOs.length; i++) {
        String s1 = stockVOs[i].getCgeneralbb3();
        if (s1 == null)
          continue;
        else
          s1 = s1.trim();// -------------------------mmmm
        if (!v.contains(s1))
          v.addElement(s1);
      }
    }
    // }
    // 发票头主键及发票体主键唯一性集合
    v = getInvoiceLockKeys(invoiceVOs, feeVOs, discountVOs, specialVOs, v);
    // 订单主键唯一性集合
    if (orderVOs != null && orderVOs.length > 0) {
      // 订单表头主键唯一性集合
      v.addElement(orderVOs[0].getCorderid().trim());
      for (int i = 1; i < orderVOs.length; i++) {
        String s1 = orderVOs[i].getCorderid().trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
      // 订单表体主键唯一性集合
      v.addElement(orderVOs[0].getCorder_bid().trim());
      for (int i = 1; i < orderVOs.length; i++) {
        String s1 = orderVOs[i].getCorder_bid().trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
    }
    // 材料出库单主键唯一性集合
    if (materialVOs != null && materialVOs.length > 0) {
      // 材料出库单表头主键唯一性集合
      v.addElement(materialVOs[0].getCgeneralhid().trim());
      for (int i = 1; i < materialVOs.length; i++) {
        String s1 = materialVOs[i].getCgeneralhid().trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
      // 材料出库单表体主键唯一性集合
      v.addElement(materialVOs[0].getCgeneralbid().trim());
      for (int i = 1; i < materialVOs.length; i++) {
        String s1 = materialVOs[i].getCgeneralbid().trim();
        if (!v.contains(s1))
          v.addElement(s1);
      }
    }
    // 返回
    if (v.size() > 0) {
      String keys[] = new String[v.size()];
      v.copyInto(keys);
      return keys;
    }
    return null;
  }

  /**
   * 功能描述:批次获得入库单体信息 作者：熊海情 修改：晁志平 For V30
   */
  private GeneralHItemVO[] getStockBodyInfo(SettlebillItemVO[] itemVO)
      throws BusinessException {
    if (itemVO == null || itemVO.length == 0)
      return null;
    // 从结算单获得入库单体主键
    GeneralHItemVO bodyVO[] = null;
    Vector v = new Vector();
    for (int i = 0; i < itemVO.length; i++) {
      String s = itemVO[i].getCstockrow();
      if (s != null && s.trim().length() > 0)
        v.addElement(s);
    }
    if (v.size() == 0)
      return null;
    String bodyKey[] = new String[v.size()];
    v.copyInto(bodyKey);
    try {
      nc.bs.ps.estimate.EstimateDMO dmo = new nc.bs.ps.estimate.EstimateDMO();
      // 查询存货表体VO所需的数据
      bodyVO = dmo.queryStockBodyForIA(bodyKey);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return bodyVO;
  }

  /**
   * 功能描述:批次获得入库单头信息 作者：熊海情 修改：晁志平 For V30
   */
  private GeneralHHeaderVO[] getStockHeadInfo(SettlebillItemVO[] itemVO)
      throws BusinessException {
    if (itemVO == null || itemVO.length == 0)
      return null;
    // 从结算单获得入库单头主键
    GeneralHHeaderVO headVO[] = null;
    Vector v = new Vector();
    for (int i = 0; i < itemVO.length; i++) {
      String s = itemVO[i].getCstockid();
      if (s != null && s.trim().length() > 0)
        v.addElement(s);
    }
    if (v.size() == 0)
      return null;
    String headKey[] = new String[v.size()];
    v.copyInto(headKey);
    try {
      nc.bs.ps.estimate.EstimateDMO dmo = new nc.bs.ps.estimate.EstimateDMO();
      // 查询存货表头VO所需的数据
      headVO = dmo.queryStockHeadForIA(headKey);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return headVO;
  }

  /**
   * 功能描述:获得单位重量，单位体积 输入参数:入库单VO[] 返回值:Vector 作者：熊海情 修改：晁志平 For V30
   */
  public Vector getSUnitWeightAndVolume(StockVO vo[]) throws BusinessException {
    FormulaParse f = new FormulaParse();
    // 获得单位重量
    String sExpress1 = "getColValue(bd_invbasdoc,unitweight,pk_invbasdoc,cBaseid)";
    // 获得单位体积
    String sExpress2 = "getColValue(bd_invbasdoc,unitvolume,pk_invbasdoc,cBaseid)";
    f.setExpressArray(new String[] {
        sExpress1, sExpress2
    });
    VarryVO varry[] = f.getVarryArray();
    String sParam[] = new String[vo.length];
    for (int i = 0; i < vo.length; i++)
      sParam[i] = vo[i].getCbaseid();

    f.addVariable(varry[0].getVarry()[0], sParam);
    f.addVariable(varry[1].getVarry()[0], sParam);

    String sUnitWeight[] = f.getValueSArray()[0];
    String sUnitVolume[] = f.getValueSArray()[1];
    // 返回单位重量，单位体积
    Vector v = new Vector();
    for (int i = 0; i < vo.length; i++) {
      Vector vv = new Vector();
      vv.addElement(sUnitWeight[i]);
      vv.addElement(sUnitVolume[i]);
      v.addElement(vv);
    }
    return v;
  }

  /**
   * 功能描述:获得供应商的基础ID 作者：熊海情 修改：晁志平 For V30
   */
  private String[] getVendorBaseKey(String cVendorID[]) {
    FormulaParse f = new FormulaParse();
    // 获得供应商的基础ID
    String sExpress = "getColValue(bd_cumandoc,pk_cubasdoc,pk_cumandoc,cVendorID)";
    f.setExpress(sExpress);
    VarryVO varry = f.getVarry();
    Hashtable table = new Hashtable();
    String sParam[] = new String[cVendorID.length];
    for (int i = 0; i < sParam.length; i++)
      sParam[i] = StringUtil.toString(cVendorID[i]);
    table.put(varry.getVarry()[0], sParam);
    f.setDataS(table);
    String sVendorBaseID[] = f.getValueS();
    return sVendorBaseID;
  }

  /**
   * 功能描述:供应商名称和存货名称（效率优化，提供批次查询功能） 输入参数:供应商ID，存货基础ID 修改日期：2003/02/11 xhq 作者：熊海情
   * 修改：晁志平 For V30
   */
  public ArrayList getVendorNameAndInvByBaseIDBatch(String cVendorID[],
      String cBaseID[], String cStoreorganization[]) throws BusinessException {
    for (int i = 0; i < cVendorID.length; i++)
      cVendorID[i] = StringUtil.toString(cVendorID[i]);
    for (int i = 0; i < cBaseID.length; i++)
      cBaseID[i] = StringUtil.toString(cBaseID[i]);
    for (int i = 0; i < cStoreorganization.length; i++)
      cStoreorganization[i] = StringUtil.toString(cStoreorganization[i]);

    FormulaParse f = new FormulaParse();
    // 获得供应商基础ID
    String sExpress = "getColValue(bd_cumandoc,pk_cubasdoc,pk_cumandoc,cVendorID)";
    f.setExpress(sExpress);
    VarryVO varry = f.getVarry();
    Hashtable table = new Hashtable();
    table.put(varry.getVarry()[0], cVendorID);
    f.setDataS(table);
    String sVendorBaseID[] = f.getValueS();
    // 获得供应商名称
    sExpress = "getColValue(bd_cubasdoc,custshortname,pk_cubasdoc,cBaseID)";
    f.setExpress(sExpress);
    varry = f.getVarry();
    table.put(varry.getVarry()[0], sVendorBaseID);
    f.setDataS(table);
    String sVendorName[] = f.getValueS();
    // 获得存货名称
    sExpress = "getColValue(bd_invbasdoc,invname,pk_invbasdoc,cInvID)";
    f.setExpress(sExpress);
    varry = f.getVarry();
    table.put(varry.getVarry()[0], cBaseID);
    f.setDataS(table);
    String sInvName[] = f.getValueS();
    // 获得库存组织名称
    sExpress = "getColValue(bd_calbody,bodyname,pk_calbody,pk_calbody)";
    f.setExpress(sExpress);
    varry = f.getVarry();
    table.put(varry.getVarry()[0], cStoreorganization);
    f.setDataS(table);
    String sStoreorganizationName[] = f.getValueS();
    ArrayList list = new ArrayList();
    list.add(sVendorName);
    list.add(sInvName);
    list.add(sStoreorganizationName);
    return list;
  }

  /**
   * 功能描述:判断发票的单据号是否重复 输入参数:单位编码，单据号，表头主键（修改时） 作者：熊海情 修改：晁志平 For V30
   */
  public boolean isCodeDuplicateForSettle(String unitCode, String billCode,
      String key) throws BusinessException {
    boolean b = false;
    try {
      SettleDMO dmo = new SettleDMO();
      b = dmo.isCodeDuplicate(unitCode, billCode, key);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return b;
  }

  /**
   * 功能描述:结算单是否来自VMI结算单 输入参数:SettlebillVO settleVO 结算单VO 返回值：如果结算单表体存在VMI主键则返回
   * true 作者：熊海情 修改：晁志平 For V30
   */
  private boolean isFromVMI(SettlebillVO settleVO) throws BusinessException {
    //
    if (settleVO == null || settleVO.getChildrenVO() == null
        || settleVO.getChildrenVO().length <= 0) {
      return false;
    }
    boolean bIsFromVMI = false;
    SettlebillItemVO[] bodyVOs = (SettlebillItemVO[]) settleVO.getChildrenVO();
    int iLen = bodyVOs.length;
    for (int i = 0; i < iLen; i++) {
      if (bodyVOs[i].getCvmiid() != null
          && bodyVOs[i].getCvmiid().trim().length() > 0) {
        bIsFromVMI = true;
        break;
      }
    }
    return bIsFromVMI;
  }

  /**
   * 功能描述:判断结算单的单据号是否重复 输入参数:单位编码，单据号 作者：熊海情 修改：晁志平 For V30
   */
  public boolean isSettlebillCodeDuplicate(String unitCode, String billCode)
      throws BusinessException {
    boolean b = false;
    try {
      SettleDMO dmo = new SettleDMO();
      b = dmo.isSettlebillCodeDuplicate(unitCode, billCode);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return b;
  }

  /**
   * 功能描述:并发处理时间戳(作废结算单) 日期:2002/04/10 作者：熊海情 修改：晁志平 For V30 手工结算也调用此方法
   */
  private String isTimeStampChangedForDepose(StockVO stockVOs[],
      IinvoiceVO iinvoiceVOs[], FeeinvoiceVO feeVOs[],
      FeeinvoiceVO discountVOs[], FeeinvoiceVO specialVOs[],
      SettlebillVO settlebillVOs[]) throws BusinessException {
    String sMessage = "";
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    try {
      nc.bs.pu.pub.PubDMO pubDMO = new nc.bs.pu.pub.PubDMO();
      String sHeadKey[] = null;
      String sBodyKey[] = null;
      String sBody3Key[] = null;
      // 入库单
      if (stockVOs != null && stockVOs.length > 0) {
        int iLen = stockVOs.length;
        sHeadKey = new String[iLen];
        sBodyKey = new String[iLen];
        sBody3Key = new String[iLen];
        for (int i = 0; i < iLen; i++) {
          sHeadKey[i] = stockVOs[i].getCgeneralhid();
          sBodyKey[i] = stockVOs[i].getCgeneralbid();
          sBody3Key[i] = stockVOs[i].getCgeneralbb3();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray("45", sHeadKey,
            sBodyKey, sBody3Key);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          String ts3[] = (String[]) ts[2];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = stockVOs[i].getTs1() == null ? "" : stockVOs[i]
                  .getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000014")/*
                                                                   * @res
                                                                   * "入库单表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000014")/*
                                                   * @res "入库单表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = stockVOs[i].getTs2() == null ? "" : stockVOs[i]
                  .getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000015")/*
                                                                   * @res
                                                                   * "入库单表体发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000015")/*
                                                   * @res "入库单表体发生并发操作！\n"
                                                   */;
          }
          // 判断子子表时间戳是否改变
          if (ts3 != null && ts3.length > 0 && ts3.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts3[i] == null ? "" : ts3[i].trim();
              String temp2 = stockVOs[i].getTs3() == null ? "" : stockVOs[i]
                  .getTs3().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000016")/*
                                                                   * @res
                                                                   * "入库单子子表发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000016")/*
                                                   * @res "入库单子子表发生并发操作！\n"
                                                   */;
          }
        }
      }
      timer.addExecutePhase("入库单");
      // 发票
      if (iinvoiceVOs != null && iinvoiceVOs.length > 0) {
        int iLenInv = iinvoiceVOs.length;
        sHeadKey = new String[iLenInv];
        sBodyKey = new String[iLenInv];
        for (int i = 0; i < iLenInv; i++) {
          sHeadKey[i] = iinvoiceVOs[i].getCinvoiceid();
          sBodyKey[i] = iinvoiceVOs[i].getCinvoice_bid();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray(ScmConst.PO_Invoice,
            sHeadKey, sBodyKey, null);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLenInv) {
            for (int i = 0; i < iLenInv; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = iinvoiceVOs[i].getTs1() == null ? ""
                  : iinvoiceVOs[i].getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000017")/*
                                                                   * @res
                                                                   * "发票表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000017")/*
                                                   * @res "发票表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLenInv) {
            for (int i = 0; i < iLenInv; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = iinvoiceVOs[i].getTs2() == null ? ""
                  : iinvoiceVOs[i].getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000018")/*
                                                                   * @res
                                                                   * "发票表体发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000018")/*
                                                   * @res "发票表体发生并发操作！\n"
                                                   */;
          }
        }
      }
      timer.addExecutePhase("发票");
      // 费用发票
      if (feeVOs != null && feeVOs.length > 0) {
        int iLenFee = feeVOs.length;
        sHeadKey = new String[iLenFee];
        sBodyKey = new String[iLenFee];
        for (int i = 0; i < iLenFee; i++) {
          sHeadKey[i] = feeVOs[i].getCinvoiceid();
          sBodyKey[i] = feeVOs[i].getCinvoice_bid();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray(ScmConst.PO_Invoice,
            sHeadKey, sBodyKey, null);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLenFee) {
            for (int i = 0; i < iLenFee; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = feeVOs[i].getTs1() == null ? "" : feeVOs[i]
                  .getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000019")/*
                                                                   * @res
                                                                   * "费用发票表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000019")/*
                                                   * @res "费用发票表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLenFee) {
            for (int i = 0; i < iLenFee; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = feeVOs[i].getTs2() == null ? "" : feeVOs[i]
                  .getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000020")/*
                                                                   * @res
                                                                   * "费用发票表体发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000020")/*
                                                   * @res "费用发票表体发生并发操作！\n"
                                                   */;
          }
        }
      }
      timer.addExecutePhase("费用发票");
      // 折扣
      if (discountVOs != null && discountVOs.length > 0) {
        int iLenDis = discountVOs.length;
        sHeadKey = new String[iLenDis];
        sBodyKey = new String[iLenDis];
        for (int i = 0; i < iLenDis; i++) {
          sHeadKey[i] = discountVOs[i].getCinvoiceid();
          sBodyKey[i] = discountVOs[i].getCinvoice_bid();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray(ScmConst.PO_Invoice,
            sHeadKey, sBodyKey, null);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLenDis) {
            for (int i = 0; i < iLenDis; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = discountVOs[i].getTs1() == null ? ""
                  : discountVOs[i].getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000021")/*
                                                                   * @res
                                                                   * "折扣发票表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000021")/*
                                                   * @res "折扣发票表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLenDis) {
            for (int i = 0; i < iLenDis; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = discountVOs[i].getTs2() == null ? ""
                  : discountVOs[i].getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000022")/*
                                                                   * @res
                                                                   * "折扣发票表体发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000022")/*
                                                   * @res "折扣发票表体发生并发操作！\n"
                                                   */;
          }
        }
      }
      timer.addExecutePhase("折扣");
      // 一般发票（无数量）
      if (specialVOs != null && specialVOs.length > 0) {
        int iLenSpe = specialVOs.length;
        sHeadKey = new String[iLenSpe];
        sBodyKey = new String[iLenSpe];
        for (int i = 0; i < iLenSpe; i++) {
          sHeadKey[i] = specialVOs[i].getCinvoiceid();
          sBodyKey[i] = specialVOs[i].getCinvoice_bid();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray(ScmConst.PO_Invoice,
            sHeadKey, sBodyKey, null);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLenSpe) {
            for (int i = 0; i < iLenSpe; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = specialVOs[i].getTs1() == null ? ""
                  : specialVOs[i].getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000023")/*
                                                                   * @res
                                                                   * "一般发票（无数量）表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000023")/*
                                                   * @res "一般发票（无数量）表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLenSpe) {
            for (int i = 0; i < iLenSpe; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = specialVOs[i].getTs2() == null ? ""
                  : specialVOs[i].getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000024")/*
                                                                   * @res
                                                                   * "一般发票（无数量）表体发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000024")/*
                                                   * @res "一般发票（无数量）表体发生并发操作！\n"
                                                   */;
          }
        }
      }
      timer.addExecutePhase("一般发票（无数量）");
      // 结算单头
      if (settlebillVOs != null && settlebillVOs.length > 0) {
        int iLenSett = settlebillVOs.length;
        sHeadKey = new String[iLenSett];
        for (int i = 0; i < iLenSett; i++) {
          sHeadKey[i] = settlebillVOs[i].getHeadVO().getCsettlebillid();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray(ScmConst.PO_SettleBill,
            sHeadKey, null, null);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLenSett) {
            for (int i = 0; i < iLenSett; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = settlebillVOs[i].getHeadVO().getTs() == null ? ""
                  : settlebillVOs[i].getHeadVO().getTs().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000025")/*
                                                                   * @res
                                                                   * "结算单表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000025")/*
                                                   * @res "结算单表头发生并发操作！\n"
                                                   */;
          }
        }
      }
      timer.addExecutePhase("结算单头");

      timer.showAllExecutePhase("判断时间戳是否改变(明细)");
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return sMessage;
  }

  /**
   * 功能描述:并发处理时间戳(销售结算) 日期:2002/04/10 作者：熊海情 修改：晁志平 For V30
   */
  private String isTimeStampChangedForSales(StockVO stockVOs[],
      OorderVO orderVOs[], IdTsData struIdTs) throws BusinessException {
    String sMessage = "";
    try {
      nc.bs.pu.pub.PubDMO pubDMO = new nc.bs.pu.pub.PubDMO();
      String sHeadKey[] = null;
      String sBodyKey[] = null;
      String sBBKey[] = null;
      // 入库单
      if (stockVOs != null && stockVOs.length > 0) {
        int iLen = stockVOs.length;
        sHeadKey = new String[iLen];
        sBodyKey = new String[iLen];
        sBBKey = new String[iLen];
        for (int i = 0; i < iLen; i++) {
          sHeadKey[i] = stockVOs[i].getCgeneralhid();
          sBodyKey[i] = stockVOs[i].getCgeneralbid();
          sBBKey[i] = stockVOs[i].getCgeneralbb3();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray("45", sHeadKey,
            sBodyKey, sBBKey);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          String ts3[] = (String[]) ts[2];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = stockVOs[i].getTs1() == null ? "" : stockVOs[i]
                  .getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000014")/*
                                                                   * @res
                                                                   * "入库单表头发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000014")/*
                                                   * @res "入库单表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = stockVOs[i].getTs2() == null ? "" : stockVOs[i]
                  .getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000015")/*
                                                                   * @res
                                                                   * "入库单表体发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000015")/*
                                                   * @res "入库单表体发生并发操作！\n"
                                                   */;
          }
          // 判断子子表3(结算子表)时间戳是否改变
          if (ts3 != null && ts3.length > 0 && ts3.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts3[i] == null ? "" : ts3[i].trim();
              String temp2 = stockVOs[i].getTs3() == null ? "" : stockVOs[i]
                  .getTs3().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000026")/*
                                                                   * @res
                                                                   * "入库单子子表3(结算子表)发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000026")/*
                                                   * @res
                                                   * "入库单子子表3(结算子表)发生并发操作！\n"
                                                   */;
          }
        }
      }
      // 订单
      if (orderVOs != null && orderVOs.length > 0) {
        int iLen = orderVOs.length;
        sHeadKey = new String[iLen];
        sBodyKey = new String[iLen];
        for (int i = 0; i < iLen; i++) {
          sHeadKey[i] = orderVOs[i].getCorderid();
          sBodyKey[i] = orderVOs[i].getCorder_bid();
        }
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray(ScmConst.PO_Order,
            sHeadKey, sBodyKey, null);
        if (ts != null && ts.length > 0) {
          String ts1[] = (String[]) ts[0];
          String ts2[] = (String[]) ts[1];
          // 判断表头时间戳是否改变
          if (ts1 != null && ts1.length > 0 && ts1.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts1[i] == null ? "" : ts1[i].trim();
              String temp2 = orderVOs[i].getTs1() == null ? "" : orderVOs[i]
                  .getTs1().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000027")/*
                                                                   * @res
                                                                   * "采购订单表头发生并发操作！\n"
                                                                   */;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000027")/*
                                                   * @res "采购订单表头发生并发操作！\n"
                                                   */;
          }
          // 判断表体时间戳是否改变
          if (ts2 != null && ts2.length > 0 && ts2.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              String temp1 = ts2[i] == null ? "" : ts2[i].trim();
              String temp2 = orderVOs[i].getTs2() == null ? "" : orderVOs[i]
                  .getTs2().trim();
              if (!temp1.equals(temp2)) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000028")/*
                                                                   * @res
                                                                   * "采购订单表体发生并发操作！\n"
                                                                   */;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000028")/*
                                                   * @res "采购订单表体发生并发操作！\n"
                                                   */;
          }
        }
      }
      // 采购销售数据表
      if (struIdTs != null
          && "po_saledata".equalsIgnoreCase(struIdTs.getTableName())
          && struIdTs.getIDs() != null && struIdTs.getIDs().length > 0) {
        sHeadKey = struIdTs.getIDs();
        // 并发处理
        Object ts[] = pubDMO.queryHBTsArrayByHBIDArray("2#", sHeadKey, null,
            null);
        if (ts != null && ts.length > 0) {
          String[] ts1 = (String[]) ts[0];
          String[] saTs = struIdTs.getTSs();
          // 判断表头时间戳是否改变
          int iLen = saTs.length;
          if (ts1 != null && ts1.length > 0 && ts1.length == iLen) {
            for (int i = 0; i < iLen; i++) {
              if (saTs[i] == null)
                saTs[i] = "";
              if (ts1[i] == null)
                ts1[i] = "";
              if (!saTs[i].equals(ts1[i])) {
                sMessage += nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000029")/*
                                                                   * @res
                                                                   * "销售发票发生并发操作！\n"
                                                                   */;
                break;
              }
            }
          }
          else {
            sMessage += nc.bs.ml.NCLangResOnserver.getInstance().getStrByID(
                "40040502", "UPP40040502-000029")/*
                                                   * @res "销售发票发生并发操作！\n"
                                                   */;
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return sMessage;
  }

  /**
   * 功能描述:并发处理时间戳(结算)(不包括销售结算和材料出库结算) 日期:2002/04/10 作者：熊海情 修改：晁志平 For V30
   */
  private String isTimeStampChangedForSettle(StockVO stockVOs[],
      IinvoiceVO iinvoiceVOs[], FeeinvoiceVO feeVOs[],
      FeeinvoiceVO discountVOs[], FeeinvoiceVO specialVOs[])
      throws BusinessException {

    /* 直接调用“作废结算单”的方法 */

    return isTimeStampChangedForDepose(stockVOs, iinvoiceVOs, feeVOs,
        discountVOs, specialVOs, null);
  }

  /**
   * 功能描述:入库单，发票自动结算 参数：listPara,ArrayList |-公司主键 |-查询条件VO[] |-操作员 |-会计年度 |-业务日期
   * 返回值：ArrayList |-结算单VO 作者：熊海情 修改：晁志平 For V30 2004-04-08
   */
  public java.util.ArrayList onAutoBalance(ArrayList listPara)
      throws BusinessException {

    nc.vo.scm.pu.Timer timeDebug = new nc.vo.scm.pu.Timer();
    timeDebug.start();

    if (listPara == null || listPara.size() < 5) {
      SCMEnv.out("程序BUG：传入参数不正确，返回NULL！");
      return null;
    }
    // 读取参数
    java.util.ArrayList listRet = new java.util.ArrayList();
    String m_sUnitCode = (String) listPara.get(0);
    ConditionVO[] conditionVO = (ConditionVO[]) listPara.get(1);
    String cOperator = (String)listPara.get(2);

    // 是否红蓝对冲参数获取
    boolean m_bStockRB = true;
    boolean m_bInvoiceRB = true;
    try {
      ISysInitQry srcSysInit = (ISysInitQry) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ISysInitQry.class.getName());
      nc.vo.pub.para.SysInitVO initVO[] = srcSysInit.querySysInit(m_sUnitCode,
          "PO36");
      if (initVO == null || initVO.length == 0) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000030")/*
                                                           * @res
                                                           * "未取得采购参数：是否红蓝对冲，请检查采购参数设置是否正确!"
                                                           */);
      }
      if (initVO[0].getValue().equals("否"))
        m_bStockRB = false;
      if (initVO[1].getValue().equals("否"))
        m_bInvoiceRB = false;
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    timeDebug.addExecutePhase("是否红蓝对冲参数获取");

    // 查询单据及合法性校验
    IinvoiceVO invoiceVOs[] = null;
    StockVO stockVOs[] = null;

    try {
      // 查询入库单
      stockVOs = queryStock(m_sUnitCode, conditionVO);
      boolean bStockNull = (stockVOs == null || stockVOs.length == 0);
      // 入库单、发票均不对冲，入库单为空
      if (!m_bStockRB && !m_bInvoiceRB && bStockNull) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000031")/*
                                                           * @res
                                                           * "入库单、发票均不对冲，但没有符合条件的入库单！[参见采购参数：PO31、PO32]"
                                                           */);
      }
      timeDebug.addExecutePhase("查询入库单");

      // 查询发票(不包括费用发票和折扣)
      ArrayList listPara1 = new ArrayList();
      listPara1.add(m_sUnitCode);
      listPara1.add(conditionVO);
      listPara1.add(new UFBoolean(false));
      invoiceVOs = queryAllInvoice(listPara1);
      timeDebug.addExecutePhase("查询发票(包括费用发票和折扣)");

      boolean bInvoiceNull = (invoiceVOs == null || invoiceVOs.length == 0);
      // 入库单、发票均为空
      if (bStockNull && bInvoiceNull) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000032")/*
                                                           * @res
                                                           * "没有符合条件的入库单及发票！"
                                                           */);
      }
      // 入库单、发票均不对冲，发票为空
      if (!m_bStockRB && !m_bInvoiceRB && bInvoiceNull) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000033")/*
                                                           * @res
                                                           * "入库单、发票均不对冲，但没有符合条件的发票！[参见采购参数：PO31、PO32]"
                                                           */);
      }
      // 入库单不对冲、发票对冲，无发票
      if (!m_bStockRB && m_bInvoiceRB && bInvoiceNull) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000034")/*
                                                           * @res
                                                           * "入库单不对冲、发票对冲，但没有符合条件的发票！[参见采购参数：PO31、PO32]"
                                                           */);
      }
      // 入库单对冲、发票不对冲，无入库单
      if (m_bStockRB && !m_bInvoiceRB && bStockNull) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000035")/*
                                                           * @res
                                                           * "入库单对冲、发票不对冲，但没有符合条件的入库单！[参见采购参数：PO31、PO32]"
                                                           */);
      }
      
      // 自动结算
      listRet = doAutoBalance(listPara, invoiceVOs, stockVOs, m_bStockRB,
          m_bInvoiceRB);
      timeDebug.addExecutePhase("自动结算");

      timeDebug.showAllExecutePhase("自动结算时间分布-onAutoBalance()-(总)");

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return listRet;
  }

  /**
   * 功能描述:查询发票（不含费用发票和折扣发票） 参数：listPara,ArrayList |-公司主键 |-查询条件VO[] |-是否VMI查询
   * 注：受托代销类型发票不参与结算（普通及VMI结算），只参与根据销售发票结算 作者：熊海情
   * 修改：2004-04-22\晁志平\区分VMI结算调用、普通结算调用
   */
  private IinvoiceVO[] queryAllInvoice(ArrayList listPara)
      throws BusinessException {
    if (listPara == null || listPara.size() < 3) {
      SCMEnv.out("程序BUG：查询发票（不含费用发票和折扣发票）参数为NULL！");
      return null;
    }
    String sUnitCode = (String) listPara.get(0);
    ConditionVO[] conditionVOs = (ConditionVO[]) listPara.get(1);
    UFBoolean bIsVMI = (UFBoolean) listPara.get(2);
    //
    if (sUnitCode == null || bIsVMI == null) {
      SCMEnv.out("程序BUG：查询发票（不含费用发票和折扣发票）参数存在NULL！");
      return null;
    }
    SettleDMO dmo = null;
    IinvoiceVO voaIinvoice[] = null;
    try {
      dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPowerForSale(conditionVOs);
      conditionVOs = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);

      int iLen = conditionVOs == null ? 0 : conditionVOs.length;
      for (int i = 0; i < iLen; i++) {
        String sName = conditionVOs[i].getFieldCode().trim();
        String sOpera = conditionVOs[i].getOperaCode().trim();
        String sValue = conditionVOs[i].getValue();
        String sSQL = conditionVOs[i].getSQLStr();
        String sReplace = null;
        if (sName.equals("dinvoicedate") && sValue != null
            && sValue.length() > 0) {
          sReplace = "dinvoicedate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("ddate") && sValue != null && sValue.length() > 0) {
          sReplace = "dinvoicedate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("vinvoicecode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vinvoicecode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("cbaseid") && sValue != null && sValue.length() > 0) {
          sReplace = "cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B where A.pk_invbasdoc = B.pk_invbasdoc and invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);
            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and "
                  + sValue + ")";
            }
            else {
              sReplace = "cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera + " '" + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cvendorbaseid in (select A.pk_cubasdoc from bd_cubasdoc A,bd_cumandoc B where A.pk_cubasdoc = B.pk_cubasdoc and custcode "
              + sOpera
              + " '"
              + sValue
              + "' and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("cdeptid") && sValue != null && sValue.length() > 0) {
          sReplace = "cdeptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("cbiztype") && sValue != null && sValue.length() > 0) {
          sReplace = "cbiztype in (select pk_busitype from bd_busitype where busicode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("coperator") && sValue != null && sValue.length() > 0) {
          sReplace = "coperator in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        if (sName.equals("vordercode") && sValue != null && sValue.length() > 0) {
          if (sUnitCode != null)
            sReplace = "corderid in (select corderid from po_order where pk_corp = '"
                + sUnitCode
                + "' and vordercode "
                + sOpera
                + " '"
                + sValue
                + "')";
          else
            sReplace = "corderid in (select corderid from po_order where vordercode "
                + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 仓库
        else if (sName.equals("cwarehouseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cwarehouseid in (select pk_stordoc from bd_stordoc where storcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
      }
      sCondition = PubDMO.processFirst(sCondition);

      sCondition += " and abs(nmoney - naccumsettmny) >= 0.0";
      if (bIsVMI.booleanValue()) {
        sCondition += " and E.verifyrule = 'V' ";
      }
      else {
        sCondition += " and E.verifyrule not in ('V','S') ";
      } 
      if (strDataPowerSql != null)
        sCondition += " and " + strDataPowerSql;

      voaIinvoice = dmo.queryAllInvoice(sUnitCode, sCondition);

      // 按龙旗项目调整，取单据上的单价并按单据汇率转换，单价为空时按本币金额/除以数量
      BusinessCurrencyRateUtil dmoCurrArith = new BusinessCurrencyRateUtil(
          sUnitCode);
      // 是否主辅币核算
      // boolean bBlnLocalFrac = dmoCurrArith.isBlnLocalFrac();
      // 单价精度
      ISysInitQry myService = (ISysInitQry) NCLocator.getInstance().lookup(
          ISysInitQry.class.getName());
      int nPriceDecimal = myService.getParaInt(sUnitCode, "BD505");

      if (voaIinvoice != null && voaIinvoice.length > 0) {
        // 计算未结算数量，本币未结算金额，单价
        for (int i = 0; i < voaIinvoice.length; i++) {
          UFDouble d1 = voaIinvoice[i].getNinvoicenum();
          UFDouble d2 = voaIinvoice[i].getNaccumsettlenum();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            voaIinvoice[i].setNnosettlenum(new UFDouble(d));
          }
          d1 = voaIinvoice[i].getNmoney();
          d2 = voaIinvoice[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            // double d = d1.doubleValue() - d2.doubleValue();
            // voaIinvoice[i].setNnosettlemny(new UFDouble(d));
            voaIinvoice[i].setNnosettlemny(d1.sub(d2, BsPuTool
                .getCCurrDecimal(null)));
          }
          // since v502,计算本币单价
          voaIinvoice[i].setNprice(voaIinvoice[i].getNprice(dmoCurrArith,
              nPriceDecimal, sUnitCode));
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return voaIinvoice;
  }

  /**
   * 功能描述:查询费用发票、折扣发票、数量为0发票（适用于费用单独结算的UI发票查询，优化效率） 输入参数:ArrayList |-String,单位编码
   * |-ConditionVO[],查询条件VO[] |-UFBoolean,是否VMI结算
   * 返回值:ArrayList{费用发票、折扣发票、数量为0发票} 作者：熊海情 修改：2004-04-23\晁志平\区分VMI结算调用、普通结算调用
   */
  public ArrayList queryAllInvoiceForFee(ArrayList listPara)
      throws BusinessException {
    if (listPara == null || listPara.size() < 3) {
      SCMEnv.out("程序BUG：查询费用发票、折扣发票、数量为0发票参数为NULL！");
      return null;
    }
    String sUnitCode = (String) listPara.get(0);
    ConditionVO[] conditionVOs = (ConditionVO[]) listPara.get(1);
    UFBoolean bIsVMI = (UFBoolean) listPara.get(2);
    String strDataPower = (String) listPara.get(3);

    //
    if (sUnitCode == null || bIsVMI == null) {
      SCMEnv.out("程序BUG：查询费用发票、折扣发票、数量为0发票参数存在NULL！");
      return null;
    }
    ArrayList list = new ArrayList();
    SettleDMO dmo = null;
    try {
      dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";
      int iLen = conditionVOs == null ? 0 : conditionVOs.length;
      for (int i = 0; i < iLen; i++) {
        String sName = conditionVOs[i].getFieldCode().trim();
        String sOpera = conditionVOs[i].getOperaCode().trim();
        String sValue = conditionVOs[i].getValue();
        String sSQL = conditionVOs[i].getSQLStr();
        String sReplace = null;
        if (sName.equals("dinvoicedate") && sValue != null
            && sValue.length() > 0) {
          sReplace = "dinvoicedate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("ddate") && sValue != null && sValue.length() > 0) {
          sReplace = "dinvoicedate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vinvoicecode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vinvoicecode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B where A.pk_invbasdoc = B.pk_invbasdoc and invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);
            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and "
                  + sValue + ")";
            }
            else {
              sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera + " '" + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cvendorbaseid in (select A.pk_cubasdoc from bd_cubasdoc A,bd_cumandoc B where A.pk_cubasdoc = B.pk_cubasdoc and custcode "
              + sOpera
              + " '"
              + sValue
              + "' and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cdeptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbiztype") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cbiztype in (select pk_busitype from bd_busitype where busicode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("coperator") && sValue != null
            && sValue.length() > 0) {
          sReplace = "coperator in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vordercode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "corderid in (select corderid from po_order where vordercode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票体自定义项
        else if (sName.indexOf("po_invoice_b.vdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票头自定义项
        else if (sName.indexOf("po_invoice.vdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "A." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票体备注
        else if (sName.indexOf("po_invoice_b.vmemo") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera;
          if ("like".equalsIgnoreCase(sOpera)) {
            sReplace += " '%" + sValue + "%'";
          }
          else {
            sReplace += " '" + sValue + "'";
          }
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 合同号
        else if (sName.equals("vcontractcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "corderid in (select corderid from po_order_b A, ct_manage B where pk_ct_manage = ccontractid and ct_code "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 仓库
        else if (sName.equals("cwarehouseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cwarehouseid in (select pk_stordoc from bd_stordoc where storcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
      }
      sCondition = PubDMO.processFirst(sCondition);

      sCondition += " and abs(nmoney - naccumsettmny) > 0.0";
      if (bIsVMI.booleanValue()) {
        sCondition += " and E.verifyrule = 'V' ";
      }
      else {
        sCondition += " and E.verifyrule not in ('V','S') ";
      }

      if (strDataPower != null)
        sCondition += " and " + strDataPower;

      // 查询费用发票、折扣发票和数量为0的发票
      FeeinvoiceVO discountVOs[] = dmo.queryDiscount(sUnitCode, sCondition);
      //
      FeeinvoiceVO feeVOs[] = dmo.queryFee(sUnitCode, sCondition);
      //
      FeeinvoiceVO specialVOs[] = dmo.queryInvoiceNoNum(sUnitCode, sCondition);

      HashMap mapExistId = null; // 用于实现：优先折扣处理(解决问题：存货管理档案中定义了同时拥有劳务折扣)

      // 计算折扣发票的未结算金额,本次结算金额
      if (discountVOs != null && discountVOs.length > 0) {
        mapExistId = new HashMap();
        int mLen = discountVOs.length;
        for (int i = 0; i < mLen; i++) {
          mapExistId.put(discountVOs[i].getCinvoice_bid(), "");
          discountVOs[i].setVfactorname("折扣");
          UFDouble d1 = discountVOs[i].getNmny();
          UFDouble d2 = discountVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            discountVOs[i].setNnosettlemny(new UFDouble(d));
            discountVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }

      // 如果在折扣中出现过，则同时定义了劳务折扣属性的存货行不再出现在劳务
      if (mapExistId != null && mapExistId.size() > 0) {
        if (feeVOs != null && feeVOs.length > 0) {
          Vector vTmp = new Vector();
          int jLen = feeVOs.length;
          for (int i = 0; i < jLen; i++) {
            if (mapExistId.containsKey(feeVOs[i].getCinvoice_bid())) {
              continue;
            }
            vTmp.addElement(feeVOs[i]);
          }
          if (vTmp.size() > 0) {
            feeVOs = new FeeinvoiceVO[vTmp.size()];
            vTmp.copyInto(feeVOs);
          }
          else {
            feeVOs = null;
          }
        }
      }

      // 计算费用发票的未结算金额,本次结算金额
      if (feeVOs != null && feeVOs.length > 0) {
        for (int i = 0; i < feeVOs.length; i++) {
          UFDouble d1 = feeVOs[i].getNmny();
          UFDouble d2 = feeVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            feeVOs[i].setNnosettlemny(new UFDouble(d));
            feeVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }
      // 计算数量为0发票的未结算金额,本次结算金额
      if (specialVOs != null && specialVOs.length > 0) {
        for (int i = 0; i < specialVOs.length; i++) {
          UFDouble d1 = specialVOs[i].getNmny();
          UFDouble d2 = specialVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            specialVOs[i].setNnosettlemny(new UFDouble(d));
            specialVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }
      list.add(feeVOs);
      list.add(discountVOs);
      list.add(specialVOs);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return list;
  }

  /**
   * 功能描述:查询发票（含费用发票和折扣发票）（适用于手工结算和异存货结算的UI发票查询，优化效率） 输入参数:ArrayList
   * |-String,单位编码 |-ConditionVO[],查询条件VO[] |-UFBoolean,是否VMI结算
   * 返回值:ArrayList{一般发票、费用发票、折扣发票} 作者：熊海情 修改：2004-04-23\晁志平\区分VMI结算调用、普通结算调用
   */
  public ArrayList queryAllInvoiceForManual(ArrayList listPara)
      throws BusinessException {
    if (listPara == null || listPara.size() < 3) {
      SCMEnv.out("程序BUG：查询发票（含费用发票和折扣发票）参数为NULL！");
      return null;
    }
    String sUnitCode = (String) listPara.get(0);
    ConditionVO[] conditionVOs = (ConditionVO[]) listPara.get(1);
    UFBoolean bIsVMI = (UFBoolean) listPara.get(2);
    String strDataPower = (String) listPara.get(3);
    //
    if (sUnitCode == null || bIsVMI == null) {
      SCMEnv.out("程序BUG：查询发票（含费用发票和折扣发票）参数存在NULL！");
      return null;
    }
    ArrayList list = new ArrayList();
    SettleDMO dmo = null;
    try {
      dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";
      int iLen = conditionVOs == null ? 0 : conditionVOs.length;
      for (int i = 0; i < iLen; i++) {
        String sName = conditionVOs[i].getFieldCode().trim();
        String sOpera = conditionVOs[i].getOperaCode().trim();
        String sValue = conditionVOs[i].getValue();
        String sSQL = conditionVOs[i].getSQLStr();
        String sReplace = null;

        if (sName.equals("dinvoicedate") && sValue != null
            && sValue.length() > 0) {
          sReplace = "dinvoicedate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("ddate") && sValue != null && sValue.length() > 0) {
          sReplace = "dinvoicedate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vinvoicecode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vinvoicecode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B where A.pk_invbasdoc = B.pk_invbasdoc and invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);

            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and "
                  + sValue + ")";
            }
            else {
              sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera + " '" + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cvendorbaseid in (select A.pk_cubasdoc from bd_cubasdoc A,bd_cumandoc B where A.pk_cubasdoc = B.pk_cubasdoc and custcode "
              + sOpera
              + " '"
              + sValue
              + "' and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cdeptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbiztype") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cbiztype in (select pk_busitype from bd_busitype where busicode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("coperator") && sValue != null
            && sValue.length() > 0) {
          sReplace = "coperator in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vordercode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "corderid in (select corderid from po_order where vordercode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票体自定义项
        else if (sName.indexOf("po_invoice_b.vdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票头自定义项
        else if (sName.indexOf("po_invoice.vdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "A." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 合同号
        else if (sName.equals("vcontractcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "corderid in (select corderid from po_order_b A, ct_manage B where pk_ct_manage = ccontractid and ct_code "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票体备注
        else if (sName.indexOf("po_invoice_b.vmemo") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera;
          if ("like".equalsIgnoreCase(sOpera)) {
            sReplace += " '%" + sValue + "%'";
          }
          else {
            sReplace += " '" + sValue + "'";
          }
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 仓库
        else if (sName.equals("cwarehouseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cwarehouseid in (select pk_stordoc from bd_stordoc where storcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        /* 
         * 支持顾问增加查询条件,注意，部分不重复字段可以不写表名，必写表名时就要按别名写，
         * po_invoice A ；po_invoice_b B
         */
        else{
            sCondition += sSQL;
        }
      }

      sCondition = PubDMO.processFirst(sCondition);

      sCondition += " and abs(nmoney - isnull(naccumsettmny,0)) > 0.0";

      if (bIsVMI.booleanValue()) {
        sCondition += " and E.verifyrule = 'V' ";
      }
      else {
        sCondition += " and E.verifyrule not in ('V','S') ";
      }

      if (strDataPower != null)
        sCondition += " and " + strDataPower;

      ArrayList listPara1 = new ArrayList();
      listPara1.add(sUnitCode);
      listPara1.add(sCondition + " and abs(isnull(ninvoicenum,0)) > 0 ");
      listPara1.add(new UFBoolean(false));
      listPara1.add(new UFBoolean(true));
      listPara1.add(new UFBoolean(true));// 是否按存货编码排序
      IinvoiceVO VOs[] = dmo.queryInvoice(listPara1); // 普通发票
      FeeinvoiceVO discountVOs[] = dmo.queryDiscount(sUnitCode, sCondition); // 折扣发票
      FeeinvoiceVO feeVOs[] = dmo.queryFee(sUnitCode, sCondition); // 费用发票

      // 按龙旗项目调整，取单据上的单价并按单据汇率转换，单价为空时按本币金额/除以数量
      BusinessCurrencyRateUtil dmoCurrArith = new BusinessCurrencyRateUtil(
          sUnitCode);
      // 是否主辅币核算
      // boolean bBlnLocalFrac = dmoCurrArith.isBlnLocalFrac();
      // 单价精度
      ISysInitQry myService = (ISysInitQry) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ISysInitQry.class.getName());
      int nPriceDecimal = myService.getParaInt(sUnitCode, "BD505");
      //
      if (VOs != null && VOs.length > 0) {
        // 计算普通发票未结算数量，本币未结算金额，单价
        for (int i = 0; i < VOs.length; i++) {
          UFDouble d1 = VOs[i].getNinvoicenum();
          UFDouble d2 = VOs[i].getNaccumsettlenum();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            VOs[i].setNnosettlenum(new UFDouble(d));
          }
          d1 = VOs[i].getNmoney();
          d2 = VOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            // double d = d1.doubleValue() - d2.doubleValue();
            // VOs[i].setNnosettlemny(new UFDouble(d));
            VOs[i].setNnosettlemny(d1.sub(d2, BsPuTool.getCCurrDecimal(null)));
          }
          // since v502,计算本币单价
          VOs[i].setNprice(VOs[i].getNprice(dmoCurrArith, nPriceDecimal,
              sUnitCode));
        }
      }

      HashMap mapExistId = null; // 用于实现：优先折扣处理(解决问题：存货管理档案中定义了同时拥有劳务折扣)
      if (discountVOs != null && discountVOs.length > 0) {
        mapExistId = new HashMap();
        int mLen = discountVOs.length;
        // 计算折扣发票的未结算金额,本次结算金额
        for (int i = 0; i < mLen; i++) {
          mapExistId.put(discountVOs[i].getCinvoice_bid(), "");
          discountVOs[i].setVfactorname("折扣");
          UFDouble d1 = discountVOs[i].getNmny();
          UFDouble d2 = discountVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            discountVOs[i].setNnosettlemny(new UFDouble(d));
            discountVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }

      // 如果在折扣中出现过，则同时定义了劳务折扣属性的存货行不再出现在劳务
      if (mapExistId != null && mapExistId.size() > 0) {
        if (feeVOs != null && feeVOs.length > 0) {
          Vector vTmp = new Vector();
          int jLen = feeVOs.length;
          for (int i = 0; i < jLen; i++) {
            if (mapExistId.containsKey(feeVOs[i].getCinvoice_bid())) {
              continue;
            }
            vTmp.addElement(feeVOs[i]);
          }
          if (vTmp.size() > 0) {
            feeVOs = new FeeinvoiceVO[vTmp.size()];
            vTmp.copyInto(feeVOs);
          }
          else {
            feeVOs = null;
          }
        }
      }
      // 计算费用发票的未结算金额,本次结算金额
      if (feeVOs != null && feeVOs.length > 0) {
        for (int i = 0; i < feeVOs.length; i++) {
          UFDouble d1 = feeVOs[i].getNmny();
          UFDouble d2 = feeVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            feeVOs[i].setNnosettlemny(new UFDouble(d));
            feeVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }

      list.add(VOs);
      list.add(feeVOs);
      list.add(discountVOs);

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return list;
  }

  /**
   * 功能描述:成本要素序号和名称 返回值:[[序号]，[名称]] 作者：熊海情 修改：晁志平 For V30
   */
  public Vector queryCostfactorNO(String unitCode, String cId[])
      throws BusinessException {
    Vector v = null;
    try {
      SettleDMO dmo = new SettleDMO();
      v = dmo.queryCostfactorNO(unitCode, cId);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return v;
  }

  /**
   * 功能描述:查询入库单、普通发票、费用发票细节(包括折扣发票、数量为0发票)，服务于结算单作废（效率优化，提供批次查询处理）
   * 输入参数:单位编码,入库单体主键、普通发票体主键、费用发票体主键
   * 返回值:[入库单VO、普通发票VO、[费用发票VO、折扣发票VO、数量为0发票VO]] 异常处理:无 修改日期：2003/12/03 xhq
   */
  public ArrayList queryDetailBatchForDispose(String sUnitCode,
      String stockBodyKey[], String invoiceBodyKey[], String feeBodyKey[])
      throws BusinessException {
    ArrayList list = new ArrayList();
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    try {
      StockVO stockVOs[] = queryStockDetailBatch(sUnitCode, stockBodyKey);
      timer.addExecutePhase("查询入库单");
      IinvoiceVO iinvoiceVOs[] = queryInvoiceDetailBatch(sUnitCode,
          invoiceBodyKey);
      timer.addExecutePhase("查询发票（普通）");
      ArrayList list0 = queryFeeDetailBatch(sUnitCode, feeBodyKey);
      timer.addExecutePhase("查询发票（费用）");

      list.add(stockVOs);
      list.add(iinvoiceVOs);
      list.add(list0);

      timer.showAllExecutePhase("查询入库单、发票、费用发票(明细)时间分布");

    }
    catch (Exception e) {
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return list;
  }

  /**
   * 功能描述:查询已结入库单-服务于费用单独结算 输入参数:单位编码、查询条件VO[] 返回值:入库单VO[]
   * 修改：2004-04-22\晁志平\业务类型非VMI、非受托代销
   */
  public StockVO[] queryEndStock(String sUnitCode, ConditionVO conditionVO[])
      throws BusinessException {
    StockVO vo[] = null;
    int k = 0;
    String stockBillType = null;// zhf add for v55 库存单据类型
    try {
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPower(conditionVO);
      conditionVO = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);
      
      int iLen = conditionVO == null ? 0 : conditionVO.length;
      for (int i = 0; i < iLen; i++) {

        // 该conditionvo中已含有 费用结算类型 条件 如何实现跟结算类型的不同进行查询 分析：

        String sName = conditionVO[i].getFieldCode().trim();
        String sOpera = conditionVO[i].getOperaCode().trim();
        String sValue = conditionVO[i].getValue();
        String sSQL = conditionVO[i].getSQLStr();

        String sReplace = null;

        if (sName.equals("dbilldate") && sValue != null && sValue.length() > 0) {
          sReplace = "dbilldate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vbillcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.vbillcode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc where invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);

            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and " + sValue + ")";
            }
            else {
              sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera
                  + " '"
                  + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cproviderid in (select pk_cumandoc from bd_cumandoc A, bd_cubasdoc B where custcode "
              + sOpera
              + " '"
              + sValue
              + "'and A.pk_cubasdoc = B.pk_cubasdoc and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单体自定义项
        else if (sName.indexOf("ic_general_b.vuserdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring((sName.indexOf(".") + 1)) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单头自定义项
        else if (sName.indexOf("vuserdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "A." + sName + " " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 表体行备注
        else if (sName.equalsIgnoreCase("ic_general_b.vnotebody")) {
          sReplace = "B." + sName.substring((sName.indexOf(".") + 1)) + " "
              + sOpera;
          if ("like".equalsIgnoreCase(sOpera)) {
            sReplace += " '%" + sValue + "%'";
          }
          else {
            sReplace += " '" + sValue + "'";
          }
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 合同号
        else if (sName.equals("vcontractcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cfirstbillhid in (select corderid from po_order_b A, ct_manage B where ccontractid = pk_ct_manage and ct_code "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 已结发票号:与指定发票号结算过的入库单行ID
        else if (sName.indexOf("vinvoicecode") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cgeneralbid in (select cstockrow from po_settlebill_b where cinvoiceid in (select cinvoiceid from po_invoice where vinvoicecode "
              + sOpera + " '" + sValue + "' and dr = 0))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 收货公司
        else if (sName.equals("pk_stockcorp") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.pk_corp in (select pk_corp from bd_corp where unitcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 仓库
        else if (sName.equals("cwarehouseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cwarehouseid in (select pk_stordoc from bd_stordoc where storcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 制单人
        else if (sName.equals("coperatorid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.coperatorid in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 订单号
        else if (sName.equals("vordercode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cfirstbillhid in (select corderid from po_order where vordercode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 是否已费用结算
        else if (sName.equals("bFeeSettled") && sValue != null
            && sValue.length() > 0) {
          k = Integer.parseInt(sValue);
        }
        // 费用结算类型
        else if (sName.equals("cFeeSettleType") && sValue != null
            && sValue.length() > 0) {
          String s = null;
          if (sValue.equals(ScmConst.m_purchaseIn)) {
            sCondition += " and (A.cbilltypecode = '" + ScmConst.m_purchaseIn
                + "' or A.cbilltypecode = '" + ScmConst.m_consignMachiningIn
                + "' or upper(A.cbilltypecode) = '" + ScmConst.m_purchaseInit
                + "') ";
          }
          else {
            sCondition += " and (A.cbilltypecode = '" + sValue.trim() + "')";
          }
          stockBillType = sValue.trim();
        }

      }
      sCondition = PubDMO.processFirst(sCondition);

      /** 查询已结入库单 */

      // 过滤赠品
      sCondition += " and coalesce(B.flargess,'N') = 'N' ";
      // 仓库“是否计算存货成本”属性过滤
      sCondition += " and coalesce(S.iscalculatedinvcost,'N') = 'Y' ";

      if (strDataPowerSql != null){
        //加上from 表别名
        strDataPowerSql=strDataPowerSql.replace("cinvbasid", "b.cinvbasid");
        sCondition += " and " + strDataPowerSql;
      }

      if (k == 1) {
        sCondition += " and isnull(B.nfeesettletimes,0) > 0 ";// 已费用结算过
      }
      else if (k == 2) {
        sCondition += " and isnull(B.nfeesettletimes,0) = 0 ";
      }

      // -----------zhf modify for v55----------------------------------
      if (stockBillType.equalsIgnoreCase(ScmConst.m_purchaseIn)) {
        // 过滤VMI、受托代销, 存货不处理类等业务类型入斓バ
        sCondition += " and E.verifyrule not in ('V','S','N') ";
        //
        vo = dmo.queryEndStock(sUnitCode, sCondition);
      }
      else if (stockBillType.equalsIgnoreCase(ScmConst.m_otherIn)) {
        vo = dmo.queryEndOtherStock(sUnitCode, sCondition);
      }
      else
        vo = dmo.queryEndTransStock(sUnitCode, sCondition);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  /**
   * 功能描述:查询费用发票细节(包括折扣发票、数量为0发票)，服务于结算单作废（效率优化，提供批次查询处理） 输入参数:单位编码,发票体主键
   * 返回值:费用发票VO 作者：熊海情 修改：晁志平 For V30
   */
  public ArrayList queryFeeDetailBatch(String sUnitCode, String bodyKey[])
      throws BusinessException {

    ArrayList list = new ArrayList();
    try {
      SettleDMO dmo = new SettleDMO();
      if (bodyKey == null || bodyKey.length == 0)
        return list;
      // 发票条件
      String sCondition = " and B.cinvoice_bid in ";
      // 临时表
      String strSetId = null;
      nc.bs.scm.pub.TempTableDMO dmoTempTbl = new nc.bs.scm.pub.TempTableDMO();
      strSetId = dmoTempTbl.insertTempTable(bodyKey,
          nc.vo.scm.pub.TempTableVO.TEMPTABLE_PU61,
          nc.vo.scm.pub.TempTableVO.TEMPPKFIELD_PU);
      if (strSetId == null || strSetId.trim().equals("()")) {
        strSetId = " ('ErrorPk') ";
      }
      sCondition += strSetId;
      /*
       * String sTemp[] = nc.bs.pu.pub.PubDMO.getInSetsByIds(bodyKey); for (int
       * i = 0; i < sTemp.length - 1; i++) { sCondition += " B.cinvoice_bid in " +
       * sTemp[i] + " or "; } sCondition += " B.cinvoice_bid in " +
       * sTemp[sTemp.length - 1] + ")";
       */
      // 查询发票
      FeeinvoiceVO feeVOs[] = dmo.queryFee(sUnitCode, sCondition);
      FeeinvoiceVO discountVOs[] = dmo.queryDiscount(sUnitCode, sCondition);
      FeeinvoiceVO specialVOs[] = dmo.queryInvoiceNoNum(sUnitCode, sCondition);

      HashMap mapExistId = null; // 用于实现：优先折扣处理(解决问题：存货管理档案中定

      // 计算折扣发票的未结算金额,本次结算金额
      if (discountVOs != null && discountVOs.length > 0) {
        mapExistId = new HashMap();
        int mLen = discountVOs.length;
        for (int i = 0; i < mLen; i++) {
          mapExistId.put(discountVOs[i].getCinvoice_bid(), "");
          discountVOs[i].setVfactorname("折扣");
          UFDouble d1 = discountVOs[i].getNmny();
          UFDouble d2 = discountVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            discountVOs[i].setNnosettlemny(new UFDouble(d));
            discountVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }

      // 如果在折扣中出现过，则同时定义了劳务折扣属性的存货行不再出现在劳务
      if (mapExistId != null && mapExistId.size() > 0) {
        if (feeVOs != null && feeVOs.length > 0) {
          Vector vTmp = new Vector();
          int jLen = feeVOs.length;
          for (int i = 0; i < jLen; i++) {
            if (mapExistId.containsKey(feeVOs[i].getCinvoice_bid())) {
              continue;
            }
            vTmp.addElement(feeVOs[i]);
          }
          if (vTmp.size() > 0) {
            feeVOs = new FeeinvoiceVO[vTmp.size()];
            vTmp.copyInto(feeVOs);
          }
          else {
            feeVOs = null;
          }
        }
      }

      // 计算费用发票的未结算金额,本次结算金额
      if (feeVOs != null && feeVOs.length > 0) {
        for (int i = 0; i < feeVOs.length; i++) {
          UFDouble d1 = feeVOs[i].getNmny();
          UFDouble d2 = feeVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            feeVOs[i].setNnosettlemny(new UFDouble(d));
            feeVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }
      // 计算一般发票的未结算金额,本次结算金额
      if (specialVOs != null && specialVOs.length > 0) {
        for (int i = 0; i < specialVOs.length; i++) {
          specialVOs[i].setVfactorname("一般发票");
          UFDouble d1 = specialVOs[i].getNmny();
          UFDouble d2 = specialVOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            specialVOs[i].setNnosettlemny(new UFDouble(d));
            specialVOs[i].setNsettlemny(new UFDouble(d));
          }
        }
      }
      list.add(feeVOs);
      list.add(discountVOs);
      list.add(specialVOs);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return list;
  }

  /**
   * 功能描述:查询发票细节（不含费用发票和折扣发票），服务于结算单作废(优化效率，提供批次查询处理) 输入参数:单位编码 返回值:发票VO
   * 修改日期：2003/02/10 xhq
   */
  public IinvoiceVO[] queryInvoiceDetailBatch(String sUnitCode,
      String bodyKey[]) throws BusinessException {

    IinvoiceVO vo[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      if (bodyKey == null || bodyKey.length == 0)
        return null;

      String sCondition = " and B.cinvoice_bid in ";
      // 临时表
      String strSetId = null;
      nc.bs.scm.pub.TempTableDMO dmoTempTbl = new nc.bs.scm.pub.TempTableDMO();
      strSetId = dmoTempTbl.insertTempTable(bodyKey,
          nc.vo.scm.pub.TempTableVO.TEMPTABLE_PU62,
          nc.vo.scm.pub.TempTableVO.TEMPPKFIELD_PU);
      if (strSetId == null || strSetId.trim().equals("()")) {
        strSetId = " ('ErrorPk') ";
      }
      sCondition += strSetId;
      /*
       * String sTemp[] = nc.bs.pu.pub.PubDMO.getInSetsByIds(bodyKey); for (int
       * i = 0; i < sTemp.length - 1; i++) sCondition += " B.cinvoice_bid in " +
       * sTemp[i] + " or "; sCondition += " B.cinvoice_bid in " +
       * sTemp[sTemp.length - 1] + ")";
       */
      vo = dmo.queryInvoiceDetail(sUnitCode, sCondition, new UFBoolean(true));

      if (vo != null && vo.length > 0) {
        if (vo.length != bodyKey.length)
          throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
              .getStrByID("40040502", "UPP40040502-000036")/* @res "发票不全！" */);
        // 计算未结算数量，本币未结算金额，辅币未结算金额
        for (int i = 0; i < vo.length; i++) {
          UFDouble d1 = vo[i].getNinvoicenum();
          UFDouble d2 = vo[i].getNaccumsettlenum();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlenum(new UFDouble(d));
          }
          d1 = vo[i].getNmoney();
          d2 = vo[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            // double d = d1.doubleValue() - d2.doubleValue();
            // vo[i].setNnosettlemny(new UFDouble(d));
            vo[i].setNnosettlemny(d1.sub(d2, BsPuTool.getCCurrDecimal(null)));
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  /**
   * 功能描述:查询订单细节，服务于根据销售结算 输入参数:单位编码 返回值:订单VO 作者：熊海情 修改：晁志平 For V30
   */
  private OorderVO[] queryOrderDetail(String sUnitCode, String headKey,
      String bodyKey) throws BusinessException {
    OorderVO vo[] = null;
    try {
      // 查询订单
      SettleDMO dmo = new SettleDMO();
      String sCondition = " and A.corderid = '" + headKey
          + "' and B.corder_bid = '" + bodyKey + "'";
      vo = dmo.queryOrderDetail(sUnitCode, sCondition);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  /**
   * 功能描述:查询订单细节，服务于根据销售结算 输入参数: 返回值: 异常处理: 日期:2003/03/11
   */
  public ArrayList queryOrderDetailBatch(String sUnitCode, StockVO stockVOs[])
      throws BusinessException {
    ArrayList list = new ArrayList();

    if (sUnitCode == null || sUnitCode.trim().length() == 0)
      return list;
    if (stockVOs == null || stockVOs.length == 0)
      return list;

    for (int i = 0; i < stockVOs.length; i++) {
      OorderVO orderVOs[] = null;
      String sType = stockVOs[i].getCsourcebilltype();
      if (sType == null || sType.length() == 0) {
        list.add(orderVOs);
        continue;
      }
      // 直接查询订单
      orderVOs = queryOrderDetail(sUnitCode, stockVOs[i].getCfirstbillhid(),
          stockVOs[i].getCfirstbillbid());

      list.add(orderVOs);
    }

    return list;
  }

  /**
   * 功能描述:查询销售发票 输入参数:单位编码、查询条件VO[] 返回值:销售发票VO[] 作者：熊海情 修改：晁志平 For V30
   */
  public SaledataVO[] querySaleinvoice(String sUnitCode,
      ConditionVO conditionVO[]) throws BusinessException {

    SaledataVO rsltVOs[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPowerForSale(conditionVO);
      conditionVO = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);

      //
      int iLen0 = conditionVO == null ? 0 : conditionVO.length;
      for (int i = 0; i < iLen0; i++) {
        String sName = conditionVO[i].getFieldCode().trim();
        String sOpera = conditionVO[i].getOperaCode().trim();
        String sValue = conditionVO[i].getValue();
        String sSQL = conditionVO[i].getSQLStr();
        String sReplace = null;
        if (sName.equals("dsaledate") && sValue != null && sValue.length() > 0) {
          sReplace = "dsaledate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cdeptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cmangid in (select pk_invmandoc from bd_invbasdoc A,bd_invmandoc B where A.pk_invbasdoc = B.pk_invbasdoc and invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);
            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "cmangid in (select pk_invmandoc from bd_invbasdoc A, bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and "
                  + sValue + ")";
            }
            else {
              sReplace = "cmangid in (select pk_invmandoc from bd_invbasdoc A, bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera + " '" + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cvendormangid in (select pk_cumandoc from bd_cumandoc A, bd_cubasdoc B where custcode "
              + sOpera + " '" + sValue
              // + "'and A.pk_cubasdoc = B.pk_cubasdoc and
              // (custflag = '1' or custflag = '3'))";
              + "'and A.pk_cubasdoc = B.pk_cubasdoc )";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
      }
      //
      sCondition = PubDMO.processFirst(sCondition);
      sCondition += " and po_saledata.pk_corp = '" + sUnitCode + "' ";

      if (strDataPowerSql != null)
        sCondition += " and " + strDataPowerSql;

      // 查询销售发票
      rsltVOs = dmo.querySaleinvoice(sCondition);
      //
      if (rsltVOs == null || rsltVOs.length == 0)
        return null;
      // 处理未结算的销售数量及单价
      int iLen = rsltVOs.length;
      UFDouble ufdNum = null, ufdMny = null, ufdNumAcc = null;
      for (int i = 0; i < iLen; i++) {
        ufdNum = rsltVOs[i].getNsalenum();
        if (ufdNum == null)
          ufdNum = new UFDouble(0.0);
        ufdMny = rsltVOs[i].getNsalemny();
        if (ufdMny == null)
          ufdMny = new UFDouble(0.0);
        ufdNumAcc = rsltVOs[i].getNaccumnum();
        if (ufdNumAcc == null)
          ufdNumAcc = new UFDouble(0.0);
        rsltVOs[i].setNsalenum(ufdNum.sub(ufdNumAcc));
        if (ufdNum.doubleValue() != 0) {
          rsltVOs[i].setNsaleprice(ufdMny.div(ufdNum));
          rsltVOs[i].setNsalemny(ufdMny.div(ufdNum).multiply(
              rsltVOs[i].getNsalenum()));
        }
      }
      rsltVOs = getRefSaleInvoice(rsltVOs);
      //
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return rsltVOs;
  }

  /**
   * 
   * 父类方法重写
   * 
   * @see nc.itf.ps.settle.ISettle#querySaleinvoice(java.lang.String)
   */
  public SaledataVO[] querySaleinvoice(String sCondition) throws BusinessException {

    SaledataVO rsltVOs[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 查询销售发票
      rsltVOs = dmo.querySaleinvoice(sCondition);
      //
      if (rsltVOs == null || rsltVOs.length == 0)
        return null;
      // 处理未结算的销售数量及单价
      int iLen = rsltVOs.length;
      UFDouble ufdNum = null, ufdMny = null, ufdNumAcc = null;
      for (int i = 0; i < iLen; i++) {
        ufdNum = rsltVOs[i].getNsalenum();
        if (ufdNum == null)
          ufdNum = new UFDouble(0.0);
        ufdMny = rsltVOs[i].getNsalemny();
        if (ufdMny == null)
          ufdMny = new UFDouble(0.0);
        ufdNumAcc = rsltVOs[i].getNaccumnum();
        if (ufdNumAcc == null)
          ufdNumAcc = new UFDouble(0.0);
        rsltVOs[i].setNsalenum(ufdNum.sub(ufdNumAcc));
        if (ufdNum.doubleValue() != 0) {
          rsltVOs[i].setNsaleprice(ufdMny.div(ufdNum));
          rsltVOs[i].setNsalemny(ufdMny.div(ufdNum).multiply(
              rsltVOs[i].getNsalenum()));
        }
      }
      rsltVOs = getRefSaleInvoice(rsltVOs);
      //
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return rsltVOs;
  }
  
  /**
   * 功能描述:查询结算单（包含两部分：与入库单关联＋与VMI汇总关联） 作者：熊海情 修改：晁志平 For V30
   */
  public SettlebillVO[] querySettlebill(String unitCode,
      ConditionVO conditionVO[]) throws BusinessException {

    SettlebillVO[] settleVOs = null;
    try {
      ArrayList listReturn = new ArrayList();
      ArrayList listHid = new ArrayList(); // 单据主键,保证不重复
      /* 与入库单关联部分 */
      settleVOs = querySettlebill_Stock(unitCode, conditionVO);
      if (settleVOs != null && settleVOs.length > 0) {
        int iLen = settleVOs.length;
        for (int i = 0; i < iLen; i++) {
          listReturn.add(settleVOs[i]);
          listHid.add(settleVOs[i].getHeadVO().getPrimaryKey());
        }
      }
      /* 与VMI汇总关联部分 */
      settleVOs = querySettlebill_Vmi(unitCode, conditionVO, listHid);
      if (settleVOs != null && settleVOs.length > 0) {
        int iLen = settleVOs.length;
        for (int i = 0; i < iLen; i++) {
          // if
          // (listHid.contains(settleVOs[i].getHeadVO().getPrimaryKey()))
          // continue;
          listReturn.add(settleVOs[i]);
        }
      }
      if (listReturn.size() > 0) {
        settleVOs = new SettlebillVO[listReturn.size()];
        listReturn.toArray(settleVOs);
      }
      else {
        settleVOs = null;
      }
    }
    catch (Exception e) {
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return settleVOs;
  }

  /**
   * 功能描述:查询结算单-与入库单关联 作者：熊海情 修改：晁志平 For V30
   */
  private SettlebillVO[] querySettlebill_Stock(String unitCode,
      ConditionVO conditionVO[]) throws BusinessException {
    SettlebillVO returnVO[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPowerForSettle(conditionVO);
      conditionVO = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);

      int iLen0 = conditionVO == null ? 0 : conditionVO.length;
      for (int i = 0; i < iLen0; i++) {
        String sName = conditionVO[i].getFieldCode().trim();
        String sOpera = conditionVO[i].getOperaCode().trim();
        String sValue = conditionVO[i].getValue();
        String sSQL = conditionVO[i].getSQLStr();
        String sReplace = null;

        if (sName.equals("cbaseid") && sValue != null && sValue.length() > 0) {
          sReplace = "cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B where A.pk_invbasdoc = B.pk_invbasdoc and invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);

            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and " + sValue + ")";
            }
            else {
              sReplace = "cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera
                  + " '"
                  + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("vsettlebillcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vsettlebillcode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("dsettledate") && sValue != null
            && sValue.length() > 0) {
          sReplace = "dsettledate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cproviderid in (select pk_cumandoc from bd_cumandoc A,bd_cubasdoc B where A.pk_cubasdoc = B.pk_cubasdoc and custcode "
              + sOpera
              + " '"
              + sValue
              + "' and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cdptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cemployeeid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cbizid in (select pk_psndoc from bd_psndoc where psncode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("coperator") && sValue != null
            && sValue.length() > 0) {
          sReplace = "coperator in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单号
        else if (sName.equals("vbillcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cstockid in (select cgeneralhid from ic_general_h where dr = 0 and (fbillflag = 3 or fbillflag = 4) "
              + " and vbillcode " + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票号
        else if (sName.equals("vinvoicecode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cinvoiceid in (select cinvoiceid from po_invoice where dr = 0 "
              + " and vinvoicecode " + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 打印次数
        else if (sName.equals("iprintcount") && sValue != null
            && sValue.length() > 0) {
          String s = " and (A.iprintcount" + sOpera + sValue + ")";
          sCondition += s;
        }
        // 收货公司
        else if (sName.equals("pk_stockcorp") && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.pk_arrvcorp in (select pk_corp from bd_corp where dr = 0"
              + " and unitcode " + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("csettlebillid") && sValue != null
            && sValue.length() > 0) {
          String s = " and (A.csettlebillid " + sOpera + "'" + sValue + "')";
          sCondition += s;
        }
        // VMI单号
        else if (sName.equals("vbillcode1") && sValue != null
            && sValue.length() > 0) {
          sCondition += " and 1<0 ";
        }

      }

      sCondition = PubDMO.processFirst(sCondition);

      if (strDataPowerSql != null)
        sCondition += " and " + strDataPowerSql;

      // 查询结算单表头
      SettlebillHeaderVO hVO[] = null;
      if (sCondition != null && sCondition.trim().length() > 0)
        hVO = dmo.querySettlebillHead_Stock(unitCode, sCondition);
      if (hVO == null || hVO.length == 0)
        return null;

      // 依据表头主键，查询结算单表体--效率优化：只返回第一张单据体
      Vector v = new Vector();
      int iLen = hVO.length;
      String strSqlHid = " and A.csettlebillid= '" + hVO[0].getCsettlebillid()
          + "' ";
      SettlebillItemVO bVO[] = dmo.querySettleBody(unitCode, strSqlHid);
      if (bVO != null && bVO.length > 0) {
        // 查询入库单号及发票号
        String temp1[] = dmo.queryStockCode(bVO);
        String temp2[] = dmo.queryInvoiceCode(bVO);
        // 查询供应商、部门、业务员
        String cgeneralhid[] = new String[bVO.length];
        for (int j = 0; j < bVO.length; j++)
          cgeneralhid[j] = bVO[j].getCstockid();
        ArrayList list2 = dmo.queryVendorName(cgeneralhid);
        String cVendorName[] = (String[]) list2.get(0);
        String cDeptName[] = (String[]) list2.get(1);
        String cEmployeeName[] = (String[]) list2.get(2);
        for (int j = 0; j < bVO.length; j++) {
          bVO[j].setVbillcode(temp1[j]);
          bVO[j].setVinvoicecode(temp2[j]);
          bVO[j].setCvendorname(cVendorName[j]);
          bVO[j].setCdeptname(cDeptName[j]);
          bVO[j].setCemployeename(cEmployeeName[j]);
        }
        // since v53, 支持直运销售时采购发票与订单自动结算时显示供应商等信息
        dmo.setValuesForDirect(bVO);
      }
      SettlebillVO vo = new SettlebillVO(bVO.length);
      vo.setParentVO(hVO[0]);
      vo.setChildrenVO(bVO);
      v.addElement(vo);
      for (int i = 1; i < iLen; i++) {
        vo = new SettlebillVO(0);
        vo.setParentVO(hVO[i]);
        v.addElement(vo);
      }
      if (v.size() > 0) {
        returnVO = new SettlebillVO[v.size()];
        v.copyInto(returnVO);
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return returnVO;
  }

  /**
   * 支持数据权限处理，拆分查询条件是用户录入自定义查询条件，还是UI端系统拼接的数据权限查询条件
   * 
   * @param voaCond
   * @return{0、非权限条件VO[]；1、权限条件查询串}
   */
  private ArrayList dealCondVosForPowerForVMI(ConditionVO[] voaCond) {

    // 拆分用户录入VO、数据权限VO
    ArrayList listUserInputVos = new ArrayList();
    ArrayList listPowerVos = new ArrayList();

    int iLen = voaCond.length;

    for (int i = 0; i < iLen; i++) {
      if (voaCond[i].getOperaCode().trim().equalsIgnoreCase("IS")
          && voaCond[i].getValue().trim().equalsIgnoreCase("NULL")) {
        listPowerVos.add(voaCond[i]);
        i++;
        listPowerVos.add(voaCond[i]);
      }
      else {
        listUserInputVos.add(voaCond[i]);
      }
    }

    // 组织返回VO
    ArrayList listRet = new ArrayList();

    // 用户录入
    ConditionVO[] voaCondUserInput = null;
    if (listUserInputVos.size() > 0) {
      voaCondUserInput = new ConditionVO[listUserInputVos.size()];
      listUserInputVos.toArray(voaCondUserInput);
    }
    listRet.add(voaCondUserInput);

    // 数据权限VO==>查询条件串
    ConditionVO[] voaCondPower = null;
    if (listPowerVos.size() > 0) {
      voaCondPower = new ConditionVO[listPowerVos.size()];
      listPowerVos.toArray(voaCondPower);
      String strPowerWherePart = voaCondPower[0].getWhereSQL(voaCondPower);
      // 将非标准的字段替换掉
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "custcode", "pk_cumandoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cvendorbaseid", "cvendorid");
      //      
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "storcode", "pk_stordoc");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invcode", "pk_invmandoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cbaseid", "cinventoryid");
      //      
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cinvclassid", "cinventoryid");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil
          .replaceAllString(
              strPowerWherePart,
              "select invclasscode from bd_invcl where 0=0  and pk_invcl",
              "select pk_invmandoc from bd_invbasdoc A, bd_invmandoc B, bd_invcl C where A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and C.pk_invcl");
      //     
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "bodycode", "pk_calbody");
      listRet.add(strPowerWherePart);
    }
    else {
      listRet.add(null);
    }

    return listRet;
  }

  /**
   * 功能描述:查询结算单-与VMI汇总关联 作者：熊海情 修改：晁志平 For V30
   */
  private SettlebillVO[] querySettlebill_Vmi(String unitCode,
      ConditionVO conditionVO[], ArrayList listHid) throws BusinessException {
    SettlebillVO returnVO[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPowerForVMI(conditionVO);
      conditionVO = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);

      int iLen0 = conditionVO == null ? 0 : conditionVO.length;
      for (int i = 0; i < iLen0; i++) {
        String sName = conditionVO[i].getFieldCode().trim();
        String sOpera = conditionVO[i].getOperaCode().trim();
        String sValue = conditionVO[i].getValue();
        String sSQL = conditionVO[i].getSQLStr();
        String sReplace = null;

        if (sName.equals("cbaseid") && sValue != null && sValue.length() > 0) {
          sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B where A.pk_invbasdoc = B.pk_invbasdoc and invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);

            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and "
                  + sValue + ")";
            }
            else {
              sReplace = "B.cbaseid in (select A.pk_invbasdoc from bd_invbasdoc A,bd_invmandoc B,bd_invcl C where "
                  + "A.pk_invbasdoc = B.pk_invbasdoc and A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera + " '" + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("vsettlebillcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vsettlebillcode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("dsettledate") && sValue != null
            && sValue.length() > 0) {
          sReplace = "dsettledate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "C.cvendorid in (select pk_cumandoc from bd_cumandoc A,bd_cubasdoc B where A.pk_cubasdoc = B.pk_cubasdoc and custcode "
              + sOpera
              + " '"
              + sValue
              + "' and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.cdeptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cemployeeid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.cemployeeid in (select pk_psndoc from bd_psndoc where psncode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("coperator") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.coperator in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单号
        else if (sName.equals("vbillcode") && sValue != null
            && sValue.length() > 0) {
          sCondition += " and 1<0 ";
        }
        // 发票号
        else if (sName.equals("vinvoicecode") && sValue != null
            && sValue.length() > 0) {

          sReplace = "B.cinvoiceid in (select cinvoiceid from po_invoice where dr = 0 "
              + " and vinvoicecode " + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // VMI汇总
        else if (sName.equals("vbillcode1") && sValue != null
            && sValue.length() > 0) {
          sReplace = "C.vbillcode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 打印次数
        else if (sName.equals("iprintcount") && sValue != null
            && sValue.length() > 0) {
          String s = " and (A.iprintcount" + sOpera + sValue + ")";
          sCondition += s;
        }
        else if (sName.equals("csettlebillid") && sValue != null
            && sValue.length() > 0) {
          String s = " and (A.csettlebillid " + sOpera + "'" + sValue + "')";
          sCondition += s;
        }

      }

      sCondition = PubDMO.processFirst(sCondition);

      if (strDataPowerSql != null)
        sCondition += " and " + strDataPowerSql;

      if (listHid != null && listHid.size() > 0) {
        String strSetId = null;
        try {
          nc.bs.scm.pub.TempTableDMO dmoTmpTbl = new nc.bs.scm.pub.TempTableDMO();
          strSetId = dmoTmpTbl.insertTempTable(listHid,
              nc.vo.scm.pub.TempTableVO.TEMPTABLE_PU88,
              nc.vo.scm.pub.TempTableVO.TEMPPKFIELD_PU);
          if (strSetId == null || strSetId.trim().equals("()")) {
            strSetId = " ('ErrorPk') ";
          }
        }
        catch (Exception e) {
          throw new java.sql.SQLException(nc.bs.ml.NCLangResOnserver
              .getInstance().getStrByID("SCMCOMMON", "UPPSCMCommon-000413")/*
                                                                             * @res
                                                                             * "调用临时表处理出现异常:"
                                                                             */
              + e.getMessage());
        }
        sCondition += " and A.csettlebillid not in ";
        sCondition += strSetId;
      }
      // 查询结算单表头
      SettlebillHeaderVO hVO[] = dmo.querySettlebillHead_Vmi(unitCode,
          sCondition);
      if (hVO == null || hVO.length == 0)
        return null;

      // 依据表头主键，查询结算单表体--效率优化：只返回第一张单据体
      Vector v = new Vector();
      int iLen = hVO.length;
      String strSqlHid = " and A.csettlebillid= '" + hVO[0].getCsettlebillid()
          + "' ";
      SettlebillVO vo = null;
      // 处理第一张单据(含表体)
      SettlebillItemVO bVO[] = dmo.querySettleBody(unitCode, strSqlHid);
      if (bVO != null && bVO.length > 0) {
        // 查询VMI汇总单据号及发票号
        String temp1[] = dmo.queryVMIBillCode(bVO);
        String temp2[] = dmo.queryInvoiceCode(bVO);
        // 查询供应商、部门、业务员
        // String saVMIHid[] = new String[bVO.length];
        // 配合VMI费用结算时费用行记录的是假的VMI主键处理，since v502
        ArrayList<String> listVMIHid = new ArrayList<String>();
        for (int j = 0; j < bVO.length; j++) {
          String date = null;
          try {
            date = UFDate.getValidUFDateString(bVO[j].getCvmiid().substring(0,
                10));
          }
          catch (Exception e) {
          }
          if (date != null) {
            continue;
          }
          listVMIHid.add(bVO[j].getCvmiid());
        }
        if (listVMIHid.size() > 0) {
          String saVMIHid[] = new String[listVMIHid.size()];
          listVMIHid.toArray(saVMIHid);
          // 只显示供应商的名称
          String cVendorName[] = dmo.queryVendorName_Vmi(saVMIHid);
          HashMap<String, String> mapIdVendorName = new HashMap<String, String>();
          for (int i = 0; i < cVendorName.length; i++) {
            mapIdVendorName.put(saVMIHid[i], cVendorName[i]);
          }
          String strHidValid = "";// 正确的VMI主键
          for (int j = 0; j < bVO.length; j++) {
            String date = null;
            try {
              date = UFDate.getValidUFDateString(bVO[j].getCvmiid().substring(
                  0, 10));
            }
            catch (Exception e) {
            }
            if (date == null) {
              strHidValid = bVO[j].getCvmiid();
            }
            bVO[j].setVbillcode(temp1[j]);
            bVO[j].setVinvoicecode(temp2[j]);
            // bVO[j].setCvendorname(cVendorName[j]);
            bVO[j].setCvendorname(mapIdVendorName.get(strHidValid));
          }
        }
        vo = new SettlebillVO(bVO.length);
        vo.setParentVO(hVO[0]);
        vo.setChildrenVO(bVO);
        v.addElement(vo);
      }
      // 处理第二张及以后单据(不含表体)
      for (int i = 1; i < iLen; i++) {
        vo = new SettlebillVO(0);
        vo.setParentVO(hVO[i]);
        v.addElement(vo);
      }
      if (v.size() > 0) {
        returnVO = new SettlebillVO[v.size()];
        v.copyInto(returnVO);
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return returnVO;
  }

  /**
   * 功能描述:查询结算单 作者：熊海情 修改：晁志平 For V30
   */
  public SettlebillVO querySettlebillByHeadKey(String unitCode, String headKey)
      throws BusinessException {
    SettlebillVO returnVO[] = null;
    if (headKey == null || headKey.trim().length() == 0)
      return null;
    try {
      SettleDMO dmo = new SettleDMO();
      boolean bVMI = false;
      // 查询结算单表头
      String sCondition = " and A.csettlebillid = '" + headKey + "'";
      SettlebillHeaderVO hVO[] = dmo.querySettlebillHead_Stock(unitCode,
          sCondition);
      if (hVO == null || hVO.length == 0) {
        hVO = dmo.querySettlebillHead_Vmi(unitCode, sCondition);
        bVMI = true;
      }
      if (hVO == null || hVO.length == 0)
        return null;
      // 依据表头主键，查询结算单表体
      Vector v = new Vector();
      String temp = " and A.csettlebillid= '" + hVO[0].getCsettlebillid() + "'";
      SettlebillItemVO bVO[] = dmo.querySettleBody(unitCode, temp);
      if (bVO != null && bVO.length > 0) {
        // 查询入库单号及发票号
        String temp1[] = null;
        if (!bVMI) {
          temp1 = dmo.queryStockCode(bVO);
        }
        else {
          // 查询VMI汇总单据号
          temp1 = dmo.queryVMIBillCode(bVO);
        }

        String temp2[] = dmo.queryInvoiceCode(bVO);
        // 查询供应商、部门、业务员
        String cgeneralhid[] = new String[bVO.length];
        for (int j = 0; j < bVO.length; j++) {
          if (!bVMI)
            cgeneralhid[j] = bVO[j].getCstockid();
          else
            cgeneralhid[j] = bVO[j].getCvmiid();
        }
        if (!bVMI) {
          ArrayList list2 = dmo.queryVendorName(cgeneralhid);
          String cVendorName[] = (String[]) list2.get(0);
          String cDeptName[] = (String[]) list2.get(1);
          String cEmployeeName[] = (String[]) list2.get(2);
          for (int j = 0; j < bVO.length; j++) {
            bVO[j].setVbillcode(temp1[j]);
            bVO[j].setVinvoicecode(temp2[j]);
            bVO[j].setCvendorname(cVendorName[j]);
            bVO[j].setCdeptname(cDeptName[j]);
            bVO[j].setCemployeename(cEmployeeName[j]);
          }
        }
        else {
          String cVendorName[] = dmo.queryVendorName_Vmi(cgeneralhid);
          for (int j = 0; j < bVO.length; j++) {
            bVO[j].setVbillcode(temp1[j]);
            bVO[j].setVinvoicecode(temp2[j]);
            bVO[j].setCvendorname(cVendorName[j]);
          }
        }
      }
      SettlebillVO vo = new SettlebillVO(bVO.length);
      vo.setParentVO(hVO[0]);
      vo.setChildrenVO(bVO);
      v.addElement(vo);

      for (int i = 1; i < hVO.length; i++) {
        vo = new SettlebillVO(1);
        vo.setParentVO(hVO[i]);
        v.addElement(vo);
      }
      if (v.size() > 0) {
        returnVO = new SettlebillVO[v.size()];
        v.copyInto(returnVO);
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return returnVO[0];
  }

  /**
   * 功能描述:查询结算单是否作废，专为发票作废调用 输入参数:发票VO 返回值:TRUE，结算单已经作废；FALSE，结算单未作废 作者：熊海情
   * 修改：晁志平 For V30
   */
  public boolean querySettlebillStatusSpecially(InvoiceVO invoiceVO)
      throws BusinessException {
    try {
      SettleDMO dmo = new SettleDMO();
      // 通过发票查找结算单
      InvoiceHeaderVO invoiceHeadVO = invoiceVO.getHeadVO();
      String invoiceKey = invoiceHeadVO.getCinvoiceid().trim();
      String sCondition = " and cinvoiceid = '" + invoiceKey + "'";
      SettlebillItemVO settlebillItemVOs[] = dmo.querySettleBody(invoiceHeadVO
          .getPk_corp(), sCondition);
      if (settlebillItemVOs == null || settlebillItemVOs.length == 0) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000003")/* @res "未发现符合条件的结算单！" */);
      }
      String settlebillKey = settlebillItemVOs[0].getCsettlebillid().trim();
      sCondition = " and A.csettlebillid = '" + settlebillKey + "'";
      SettlebillHeaderVO settlebillHeadVOs[] = dmo.querySettlebillHead_Stock(
          invoiceHeadVO.getPk_corp(), sCondition);
      if (settlebillHeadVOs == null || settlebillHeadVOs.length == 0) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000003")/* @res "未发现符合条件的结算单！" */);
      }
      if (settlebillHeadVOs[0].getIbillstatus().intValue() == 1)
        return true;
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return false;
  }

  /**
   * 功能描述:查询结算单体 输入参数:单位编码，头ID，头TS 作者：熊海情 修改：晁志平 For V30
   */
  public SettlebillItemVO[] querySettleBody(String unitCode, String key,
      String ts) throws BusinessException {
    SettlebillItemVO bodyVO[] = null;

    try {
      SettleDMO dmo = new SettleDMO();
      String s = " and B.csettlebillid= '" + key + "' and B.ts = '" + ts + "' ";
      bodyVO = dmo.querySettleBody(unitCode, s);
      HashMap<String, String> mapIdVendorName = new HashMap<String, String>();
      if (bodyVO != null && bodyVO.length > 0) {
        boolean bIsFromVMI = (bodyVO[0].getCvmiid() != null && bodyVO[0]
            .getCvmiid().trim().length() > 0);
        String temp1[] = null, temp2[] = null, cVendorName[] = null;
        /** 查询来源单据号{VMI汇总或入库单} */
        if (bIsFromVMI) {
          // 查询VMI汇总单据号
          temp1 = dmo.queryVMIBillCode(bodyVO);
          // 查询供应商
          // String saVMIHid[] = new String[bVO.length];
          // for (int j = 0; j < bodyVO.length; j++)
          // saVMIHid[j] = bodyVO[j].getCvmiid();
          // 配合VMI费用结算时费用行记录的是假的VMI主键处理，since v502
          ArrayList<String> listVMIHid = new ArrayList<String>();
          for (int j = 0; j < bodyVO.length; j++) {

            String date = null;
            try {
              date = UFDate.getValidUFDateString(bodyVO[j].getCvmiid()
                  .substring(0, 10));
            }
            catch (Exception e) {
            }
            if (date != null) {
              continue;
            }
            listVMIHid.add(bodyVO[j].getCvmiid());
          }
          if (listVMIHid.size() > 0) {
            String saVMIHid[] = new String[listVMIHid.size()];
            listVMIHid.toArray(saVMIHid);
            cVendorName = dmo.queryVendorName_Vmi(saVMIHid);
            for (int i = 0; i < cVendorName.length; i++) {
              mapIdVendorName.put(saVMIHid[i], cVendorName[i]);
            }
          }
          else {
            cVendorName = new String[bodyVO.length];
          }
        }
        else {
          // 查询入库单号
          temp1 = dmo.queryStockCode(bodyVO);
          // 查询供应商、部门、业务员
          String cgeneralhid[] = new String[bodyVO.length];
          for (int j = 0; j < bodyVO.length; j++)
            cgeneralhid[j] = bodyVO[j].getCstockid();
          ArrayList list2 = dmo.queryVendorName(cgeneralhid);
          cVendorName = (String[]) list2.get(0);
          for (int i = 0; i < bodyVO.length; i++) {
            mapIdVendorName.put(bodyVO[i].getCstockid(), cVendorName[i]);
          }
          // 设置部门、业务员
          String cDeptName[] = (String[]) list2.get(1);
          String cEmployeeName[] = (String[]) list2.get(2);
          for (int j = 0; j < bodyVO.length; j++) {
            bodyVO[j].setCdeptname(cDeptName[j]);
            bodyVO[j].setCemployeename(cEmployeeName[j]);
          }
        }
        // 查询发票号
        temp2 = dmo.queryInvoiceCode(bodyVO);
        // 设置单据号、发票号、供应商
        String strHidValid = null;
        for (int j = 0; j < bodyVO.length; j++) {
          String date = null;
          try {
            date = UFDate.getValidUFDateString(bodyVO[j].getCvmiid().substring(
                0, 10));
          }
          catch (Exception e) {
          }

          if (PuPubVO.getString_TrimZeroLenAsNull(bodyVO[j].getCvmiid()) == null) {
            strHidValid = bodyVO[j].getCstockid();
          }
          else if (date == null) {
            strHidValid = bodyVO[j].getCvmiid();
          }
          bodyVO[j].setVbillcode(temp1[j]);
          bodyVO[j].setVinvoicecode(temp2[j]);
          // bVO[j].setCvendorname(cVendorName[j]);
          bodyVO[j].setCvendorname(mapIdVendorName.get(strHidValid));
        }
        // since v53, 支持直运销售时采购发票与订单自动结算时显示供应商等信息
        dmo.setValuesForDirect(bodyVO);
      }
      else {
        return null;
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return bodyVO;
  }

  /**
   * 功能描述:查询一般发票细节，服务于结算单作废 输入参数:单位编码,发票体主键 返回值:费用发票VO[] 作者：熊海情 修改：晁志平 For V30
   */
  public FeeinvoiceVO[] querySpecialDetail(String sUnitCode, String bodyKey)
      throws BusinessException {

    FeeinvoiceVO vo[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      String sCondition = " and B.cinvoice_bid = '" + bodyKey + "'";
      // 查询一般发票
      vo = dmo.queryInvoiceNoNum(sUnitCode, sCondition);
      // 计算一般发票的未结算金额,本次结算金额
      if (vo != null && vo.length > 0) {
        for (int i = 0; i < vo.length; i++) {
          vo[i].setVfactorname("一般发票");
          UFDouble d1 = vo[i].getNmny();
          UFDouble d2 = vo[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlemny(new UFDouble(d));
            vo[i].setNsettlemny(new UFDouble(d));
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  /**
   * 支持数据权限处理，拆分查询条件是用户录入自定义查询条件，还是UI端系统拼接的数据权限查询条件
   * 
   * @param voaCond
   * @return{0、非权限条件VO[]；1、权限条件查询串}
   */
  private ArrayList dealCondVosForPowerForSettle(ConditionVO[] voaCond) {

    // 拆分用户录入VO、数据权限VO
    ArrayList listUserInputVos = new ArrayList();
    ArrayList listPowerVos = new ArrayList();

    int iLen = voaCond.length;

    for (int i = 0; i < iLen; i++) {
      if (voaCond[i].getOperaCode().trim().equalsIgnoreCase("IS")
          && voaCond[i].getValue().trim().equalsIgnoreCase("NULL")) {
        listPowerVos.add(voaCond[i]);
        i++;
        listPowerVos.add(voaCond[i]);
      }
      else {
        listUserInputVos.add(voaCond[i]);
      }
    }

    // 组织返回VO
    ArrayList listRet = new ArrayList();

    // 用户录入
    ConditionVO[] voaCondUserInput = null;
    if (listUserInputVos.size() > 0) {
      voaCondUserInput = new ConditionVO[listUserInputVos.size()];
      listUserInputVos.toArray(voaCondUserInput);
    }
    listRet.add(voaCondUserInput);

    // 数据权限VO==>查询条件串
    ConditionVO[] voaCondPower = null;
    if (listPowerVos.size() > 0) {
      voaCondPower = new ConditionVO[listPowerVos.size()];
      listPowerVos.toArray(voaCondPower);
      String strPowerWherePart = voaCondPower[0].getWhereSQL(voaCondPower);
      // 将非标准的字段替换掉
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "custcode", "pk_cumandoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cvendorbaseid", "cproviderid");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invcode", "b.pk_invbasdoc");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cinvclassid", "cbaseid");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invclasscode", "pk_invbasdoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil
          .replaceAllString(
              strPowerWherePart,
              "bd_invcl where 0=0  and pk_invcl",
              "bd_invcl, bd_invbasdoc where bd_invcl.pk_invcl = bd_invbasdoc.pk_invcl and bd_invcl.pk_invcl");
      //     
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "deptcode", "pk_deptdoc");
      // strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
      // strPowerWherePart, "cdeptid", "cdptid");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "psncode", "pk_psndoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cemployeeid", "cbizid");
      //
      listRet.add(strPowerWherePart);
    }
    else {
      listRet.add(null);
    }

    return listRet;
  }

  /**
   * 支持数据权限处理，拆分查询条件是用户录入自定义查询条件，还是UI端系统拼接的数据权限查询条件
   * 
   * @param voaCond
   * @return{0、非权限条件VO[]；1、权限条件查询串}
   */
  private ArrayList dealCondVosForPower(ConditionVO[] voaCond) {

    // 拆分用户录入VO、数据权限VO
    ArrayList listUserInputVos = new ArrayList();
    ArrayList listPowerVos = new ArrayList();

    int iLen = voaCond.length;

    for (int i = 0; i < iLen; i++) {
      if (voaCond[i].getOperaCode().trim().equalsIgnoreCase("IS")
          && voaCond[i].getValue().trim().equalsIgnoreCase("NULL")) {
        listPowerVos.add(voaCond[i]);
        i++;
        listPowerVos.add(voaCond[i]);
      }
      else {
        listUserInputVos.add(voaCond[i]);
      }
    }

    // 组织返回VO
    ArrayList listRet = new ArrayList();

    // 用户录入
    ConditionVO[] voaCondUserInput = null;
    if (listUserInputVos.size() > 0) {
      voaCondUserInput = new ConditionVO[listUserInputVos.size()];
      listUserInputVos.toArray(voaCondUserInput);
    }
    listRet.add(voaCondUserInput);

    // 数据权限VO==>查询条件串
    ConditionVO[] voaCondPower = null;
    if (listPowerVos.size() > 0) {
      voaCondPower = new ConditionVO[listPowerVos.size()];
      listPowerVos.toArray(voaCondPower);
      String strPowerWherePart = voaCondPower[0].getWhereSQL(voaCondPower);
      // 将非标准的字段替换掉
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "custcode", "pk_cumandoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cvendorbaseid", "cproviderid");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invcode", "b.pk_invbasdoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cbaseid", "cinvbasid");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cinvclassid", "cinvbasid");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invclasscode", "pk_invbasdoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil
          .replaceAllString(
              strPowerWherePart,
              "bd_invcl where 0=0  and pk_invcl",
              "bd_invcl, bd_invbasdoc where bd_invcl.pk_invcl = bd_invbasdoc.pk_invcl and bd_invcl.pk_invcl");
      //     
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "deptcode", "pk_deptdoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cdeptid", "cdptid");

      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "psncode", "pk_psndoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cemployeeid", "cbizid");
      //
      listRet.add(strPowerWherePart);
    }
    else {
      listRet.add(null);
    }

    return listRet;
  }

  /**
   * 支持数据权限处理，拆分查询条件是用户录入自定义查询条件，还是UI端系统拼接的数据权限查询条件
   * 
   * @param voaCond
   * @return{0、非权限条件VO[]；1、权限条件查询串}
   */
  private ArrayList dealCondVosForPowerForSale(ConditionVO[] voaCond) {

    // 拆分用户录入VO、数据权限VO
    ArrayList listUserInputVos = new ArrayList();
    ArrayList listPowerVos = new ArrayList();

    int iLen = voaCond.length;

    for (int i = 0; i < iLen; i++) {
      if (voaCond[i].getOperaCode().trim().equalsIgnoreCase("IS")
          && voaCond[i].getValue().trim().equalsIgnoreCase("NULL")) {
        listPowerVos.add(voaCond[i]);
        i++;
        listPowerVos.add(voaCond[i]);
      }
      else {
        listUserInputVos.add(voaCond[i]);
      }
    }

    // 组织返回VO
    ArrayList listRet = new ArrayList();

    // 用户录入
    ConditionVO[] voaCondUserInput = null;
    if (listUserInputVos.size() > 0) {
      voaCondUserInput = new ConditionVO[listUserInputVos.size()];
      listUserInputVos.toArray(voaCondUserInput);
    }
    listRet.add(voaCondUserInput);

    // 数据权限VO==>查询条件串
    ConditionVO[] voaCondPower = null;
    if (listPowerVos.size() > 0) {
      voaCondPower = new ConditionVO[listPowerVos.size()];
      listPowerVos.toArray(voaCondPower);
      String strPowerWherePart = voaCondPower[0].getWhereSQL(voaCondPower);
      // 将非标准的字段替换掉
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "custcode", "b.pk_cubasdoc");
      // strPowerWherePart =
      // nc.vo.jcom.lang.StringUtil.replaceAllString(strPowerWherePart,
      // "cvendorbaseid", "cproviderid");
      //
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invcode", "b.pk_invbasdoc");
      // strPowerWherePart =
      // nc.vo.jcom.lang.StringUtil.replaceAllString(strPowerWherePart,
      // "cbaseid", "cinvbasid");
      //      
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "cinvclassid", "cbaseid");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "invclasscode", "pk_invbasdoc");
      strPowerWherePart = nc.vo.jcom.lang.StringUtil
          .replaceAllString(
              strPowerWherePart,
              "bd_invcl where 0=0  and pk_invcl",
              "bd_invcl, bd_invbasdoc where bd_invcl.pk_invcl = bd_invbasdoc.pk_invcl and bd_invcl.pk_invcl");
      //     
      strPowerWherePart = nc.vo.jcom.lang.StringUtil.replaceAllString(
          strPowerWherePart, "deptcode", "pk_deptdoc");
      //
      listRet.add(strPowerWherePart);
    }
    else {
      listRet.add(null);
    }

    return listRet;
  }

  /**
   * 功能描述:查询入库单 输入参数:单位编码、查询条件VO[] 返回值:入库单VO[] 作者：熊海情 修改：晁志平 For V30
   */
  public StockVO[] queryStock(String sUnitCode, ConditionVO conditionVOs[])
      throws BusinessException {

    StockVO vo[] = null;
    try {
      Timer timer =new Timer();
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPower(conditionVOs);
      conditionVOs = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);

      int iLen = conditionVOs == null ? 0 : conditionVOs.length;
      for (int i = 0; i < iLen; i++) {
        String sName = conditionVOs[i].getFieldCode().trim();
        String sOpera = conditionVOs[i].getOperaCode().trim();
        String sValue = conditionVOs[i].getValue();
        String sSQL = conditionVOs[i].getSQLStr();
        String sReplace = null;

        if (sName.equals("dbilldate") && sValue != null && sValue.length() > 0) {
          sReplace = "dbilldate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("ddate") && sValue != null && sValue.length() > 0) {
          sReplace = "dbilldate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vbillcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vbillcode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc where invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);

            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and " + sValue + ")";
            }
            else {
              sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera
                  + " '"
                  + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cproviderid in (select pk_cumandoc from bd_cumandoc A, bd_cubasdoc B where custcode "
              + sOpera
              + " '"
              + sValue
              + "'and A.pk_cubasdoc = B.pk_cubasdoc and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cdptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbiztype") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cbiztype in (select pk_busitype from bd_busitype where busicode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vordercode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cfirstbillhid in (select corderid from po_order where vordercode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单体自定义项
        else if (sName.indexOf("ic_general_b.vuserdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring((sName.indexOf(".") + 1)) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单头自定义项
        else if (sName.indexOf("vuserdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "A." + sName + " " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equalsIgnoreCase("ic_general_b.vnotebody")) {
          sReplace = "B." + sName.substring((sName.indexOf(".") + 1)) + " "
              + sOpera;
          if ("like".equalsIgnoreCase(sOpera)) {
            sReplace += " '%" + sValue + "%'";
          }
          else {
            sReplace += " '" + sValue + "'";
          }
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 合同号
        else if (sName.equals("vcontractcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cfirstbillhid in (select corderid from po_order_b A, ct_manage B where ccontractid = pk_ct_manage and ct_code "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票号:入库单行ID生成了指定发票号的发票
        else if (sName.indexOf("vinvoicecode") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cgeneralbid in (select B.cupsourcebillrowid from po_invoice A, po_invoice_b B where A.cinvoiceid = B.cinvoiceid and vinvoicecode "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 仓库
        else if (sName.equals("cwarehouseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cwarehouseid in (select pk_stordoc from bd_stordoc where storcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 制单人
        else if (sName.equals("coperatorid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.coperatorid in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 收货公司
        else if (sName.equals("pk_stockcorp") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.pk_corp in (select pk_corp from bd_corp where unitcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        /*
         * 支持顾问增加查询条件,注意，部分不重复字段可以不写表名，必写表名时就要按别名写，
         * ic_general_h A,ic_general_b B,ic_general_bb3 C
        */
        else{
            sCondition += sSQL;
        }
      }
      
      sCondition = PubDMO.processFirst(sCondition);

      timer.addExecutePhase("入库单查询条件处理!");
      // 查询入库单
      sCondition += " and upper(isok) = 'N'";
      // 过滤赠品
      sCondition += " and coalesce(flargess,'N') = 'N' ";
      // 过滤仓库“是否计算存货成本”为否
      sCondition += " and (coalesce(S.iscalculatedinvcost,'N') = 'Y' or A.cwarehouseid is null) ";
      // 过滤VMI、受托代销, 存货不处理类等业务类型入斓バ
      sCondition += " and BT.verifyrule not in ('V','S','N') ";
      //

      if (strDataPowerSql != null)
        sCondition += " and " + strDataPowerSql;

      // 精度处理
      int iDigitLocalCurrType = 2;
      try {
        iDigitLocalCurrType = BsPuTool.getCCurrDecimal(sUnitCode);
      }
      catch (Exception e) {
        throw new SQLException(e.getMessage());
      }
      
      vo = dmo.queryStock(sUnitCode, sCondition, iDigitLocalCurrType, false);
      timer.addExecutePhase("入库单查询");
      if (vo != null && vo.length > 0) {
        // v5支持集中采购调整
        // 查询入库单调整，收货公司与当前登录公司不一致，则返回前增加处理:
        vo = dmo.preDealStockVO(sUnitCode, vo);
        if (vo == null || vo.length == 0)
          return null;

        Vector vTemp = new Vector();
        for (int i = 0; i < vo.length; i++)
          vTemp.addElement(vo[i].getCprovidermangid());
        String sVendorMangID[] = new String[vTemp.size()];
        vTemp.copyInto(sVendorMangID);
        String sVendorBaseID[] = getVendorBaseKey(sVendorMangID);

        // 计算未结算数量，本币未结算金额
        for (int i = 0; i < vo.length; i++) {
          vo[i].setCproviderbaseid(sVendorBaseID[i]);
          UFDouble d1 = vo[i].getNinnum();
          UFDouble d2 = vo[i].getNaccumsettlenum();

          if (d2 != null && Math.abs(d2.doubleValue()) > 0)
            vo[i].setBsettled(new UFBoolean(true));
          else
            vo[i].setBsettled(new UFBoolean(false));

          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlenum(new UFDouble(d));
          }
          d1 = vo[i].getNmoney();
          d2 = vo[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlemny(new UFDouble(d).add(new UFDouble(0.0),
                BsPuTool.getCCurrDecimal(null)));
          }
        }
      }
      timer.addExecutePhase("入库单查询后处理!");
      timer.showAllExecutePhase("入库单后台查询");
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  /**
   * 此处插入方法说明。 * 功能描述:查询入库单细节，服务于结算单作废（优化效率，提供批次查询） 输入参数:单位编码 返回值:入库单VO 异常处理:无
   * 修改日期：2003/02/10 xhq
   */
  public StockVO[] queryStockDetailBatch(String sUnitCode, String bodyKey[])
      throws BusinessException {

    StockVO VOs[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 查询入库单
      if (bodyKey == null || bodyKey.length == 0)
        return null;

      String sCondition = " and B.cgeneralbid in ";
      // 临时表
      String strSetId = null;
      nc.bs.scm.pub.TempTableDMO dmoTempTbl = new nc.bs.scm.pub.TempTableDMO();
      strSetId = dmoTempTbl.insertTempTable(bodyKey,
          nc.vo.scm.pub.TempTableVO.TEMPTABLE_PU52,
          nc.vo.scm.pub.TempTableVO.TEMPPKFIELD_PU);
      if (strSetId == null || strSetId.trim().equals("()")) {
        strSetId = " ('ErrorPk') ";
      }
      sCondition += strSetId;
      /*
       * String sTemp[] = nc.bs.pu.pub.PubDMO.getInSetsByIds(bodyKey); for (int
       * i = 0; i < sTemp.length - 1; i++) sCondition += " B.cgeneralbid in " +
       * sTemp[i] + " or "; sCondition += " B.cgeneralbid in " +
       * sTemp[sTemp.length - 1] + ")";
       */
      // 获取金额精度
      int nMoneyDecimal = 2;
      ISysInitQry myService = (ISysInitQry) NCLocator.getInstance().lookup(
          ISysInitQry.class.getName());
      int nPriceDecimal = 2;
      try {
        //
        nPriceDecimal = myService.getParaInt(sUnitCode, "BD505");
        //
        nMoneyDecimal = BsPuTool.getCCurrDecimal(sUnitCode);
      }
      catch (Exception e) {
        PubDMO.throwBusinessException(e);
      }
      VOs = dmo.queryStockDetail(sCondition, nPriceDecimal, nMoneyDecimal);

      if (VOs != null && VOs.length > 0) {
        if (VOs.length != bodyKey.length)
          throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
              .getStrByID("40040502", "UPP40040502-000037")/* @res "入库单不全！" */);
        // 计算未结算数量，本币未结算金额
        for (int i = 0; i < VOs.length; i++) {
          UFDouble d1 = VOs[i].getNinnum();
          UFDouble d2 = VOs[i].getNaccumsettlenum();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            VOs[i].setNnosettlenum(new UFDouble(d));
          }
          d1 = VOs[i].getNmoney();
          d2 = VOs[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            VOs[i].setNnosettlemny(new UFDouble(d).add(new UFDouble(0.0),
                BsPuTool.getCCurrDecimal(null)));
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return VOs;
  }

  /**
   * 功能描述:根据销售发票查询入库单 输入参数:单位编码 返回值:入库单VO
   */
  private StockVO[] queryStockInSales(String sUnitCode, String sInvID,
      String sVendorID, String sStoreorganization) throws BusinessException {
    StockVO vo[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";
      if (sInvID != null && sInvID.length() > 0)
        sCondition = " and B.cinventoryid = '" + sInvID + "'";
      if (sVendorID != null && sVendorID.length() > 0)
        sCondition += " and cproviderid = '" + sVendorID + "'";
      if (sStoreorganization != null && sStoreorganization.trim().length() > 0)
        sCondition += " and pk_calbody = '" + sStoreorganization + "'";
      sCondition += " and upper(isok) = 'N'";
      // 过滤赠品
      sCondition += "and coalesce(flargess,'N') = 'N' ";
      sCondition += "order by dbilldate ";

      // 查询入库单
      vo = dmo.queryStockInSales(sUnitCode, sCondition);
      if (vo != null && vo.length > 0) {

        Vector vTemp = new Vector();
        for (int i = 0; i < vo.length; i++)
          vTemp.addElement(vo[i].getCprovidermangid());
        String sVendorMangID[] = new String[vTemp.size()];
        vTemp.copyInto(sVendorMangID);
        String sVendorBaseID[] = getVendorBaseKey(sVendorMangID);

        // 计算未结算数量，本币未结算金额
        for (int i = 0; i < vo.length; i++) {
          vo[i].setCproviderbaseid(sVendorBaseID[i]);
          UFDouble d1 = vo[i].getNinnum();
          UFDouble d2 = vo[i].getNaccumsettlenum();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlenum(new UFDouble(d));
          }
          d1 = vo[i].getNmoney();
          d2 = vo[i].getNaccumsettlemny();
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlemny(new UFDouble(d).add(new UFDouble(0.0),
                BsPuTool.getCCurrDecimal(null)));
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  /**
   * 功能描述:根据销售发票批次查询入库单 日期:2003/03/11 作者：熊海情 修改：晁志平 For V30
   */
  public ArrayList queryStockInSalesBatch(String sUnitCode, String sInvID[],
      String sVendorID[], String sStoreorganization[]) throws BusinessException {
    ArrayList list = new ArrayList();
    if (sUnitCode == null || sUnitCode.trim().length() == 0)
      return list;
    if (sInvID == null || sInvID.length == 0)
      return list;
    if (sVendorID == null || sVendorID.length == 0)
      return list;
    if (sStoreorganization == null || sStoreorganization.length == 0)
      return list;
    for (int i = 0; i < sInvID.length; i++) {
      StockVO stockVOs[] = queryStockInSales(sUnitCode, sInvID[i],
          sVendorID[i], sStoreorganization[i]);
      list.add(stockVOs);
    }
    return list;
  }

  /**
   * 功能描述:反结算时回写库存VMI汇总 输入参数:结算单VO 作者：熊海情 修改：晁志平 For V30
   */
  private void rewriteVMIAntiSettle(SettlebillVO vo) throws BusinessException {
    if (vo == null || vo.getChildrenVO() == null
        || vo.getChildrenVO().length <= 0) {
      SCMEnv.out("传入参数为空，直接返回！");
      return;
    }
    SettlebillItemVO[] bodyVos = (SettlebillItemVO[]) vo.getChildrenVO();
    int iChildLen = bodyVos.length;
    ArrayList listBody = new ArrayList();
    try {
      for (int i = 0; i < iChildLen; i++) {
        /* 非VMI汇总不回写 */
        if (bodyVos[i] == null || bodyVos[i].getCvmiid() == null)
          continue;

        /* Filter cost or discount rows xhq 2006-11-29 */
        if (bodyVos[i].getCvmiid() == null
            || bodyVos[i].getCvmiid().trim().length() == 0)
          continue;

        if (bodyVos[i].getCinvoice_bid() != null
            && bodyVos[i].getCinvoice_bid().trim().length() > 0) {
          if (bodyVos[i].getNsettlenum() == null
          // since v55
              || Math.abs(bodyVos[i].getNsettlenum().doubleValue()) == 0.0) {
            continue;
          }
        }

        listBody.add(bodyVos[i]);
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    if (listBody.size() <= 0) {
      SCMEnv.out("传入结算单行来自于VMI费用单独结算或者不是来自于VMI汇总，未回写库存系统返回！");
      return;
    }
    SettlebillItemVO[] rewriteBodyVos = new SettlebillItemVO[listBody.size()];
    listBody.toArray(rewriteBodyVos);
    nc.bs.ps.vmi.VMIImpl srcVMI = null;
    try {
      srcVMI = new nc.bs.ps.vmi.VMIImpl();
      srcVMI.rewriteVMIAntiSettle(rewriteBodyVos);
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
  }

  /*
   * 2005-10-31 xhq
   */
  private String[] getInvoiceIDs(String cgeneralbid, SettlebillItemVO body[]) {
    String s[] = new String[2];
    for (int i = 0; i < body.length; i++) {
      if (body[i].getCstockrow() != null
          && body[i].getCstockrow().equals(cgeneralbid)) {
        s[0] = body[i].getCinvoiceid();
        s[1] = body[i].getCinvoice_bid();
        break;
      }
    }

    return s;
  }

  /**
   * 功能描述:无发票结算向应付传送数据 日期:2002/05/27 作者：熊海情 修改：晁志平 For V30
   */
  private void saveBillForARAPNone_Del(GeneralBillVO billVOs[],
      SettlebillItemVO body[], String currType, String cOperator)
      throws BusinessException {

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    try {
      nc.bs.ps.estimate.EstimateDMO dmo = new nc.bs.ps.estimate.EstimateDMO();

      timer.addExecutePhase("根据采购入库单(暂估)的来源为订单，查询订单的币种、汇率（折本、折辅）、扣税类别、税率");

      // 2006-09-12 xhq 支持应付单单据类型配置
      IPFMetaModel myService = (IPFMetaModel) nc.bs.framework.common.NCLocator
          .getInstance().lookup(IPFMetaModel.class.getName());
      Hashtable tBillType = new Hashtable();// 应付单据类型
      for (int i = 0; i < billVOs.length; i++) {
        GeneralBillHeaderVO aheadVO = (GeneralBillHeaderVO) billVOs[i]
            .getParentVO();
        String key = "25" + aheadVO.getCbiztypeid() + "APPROVE";
        if (tBillType.get(key) == null) {
          MessagedriveVO driveVO[] = myService.queryAllMsgdrvVOs(null, "25",
              aheadVO.getCbiztypeid(), "APPROVE");
          if (driveVO != null && driveVO.length > 0
              && driveVO[0].getPk_billtype() != null)
            tBillType.put(key, driveVO[0].getPk_billtype());
        }
      }

      Hashtable tBillTemplet = new Hashtable();// 应付单据模板
      for (int i = 0; i < billVOs.length; i++) {
        GeneralBillHeaderVO aheadVO = (GeneralBillHeaderVO) billVOs[i]
            .getParentVO();
        String key = "25" + aheadVO.getCbiztypeid() + "APPROVE";
        if (tBillType.get(key) == null)
          tBillType.put(key, "D1");

        String key1 = aheadVO.getPk_corp() + tBillType.get(key);
        if (tBillTemplet.get(key1) == null) {
          String ss[] = dmo.getDJDataForARAP(aheadVO.getPk_corp(), tBillType
              .get(key).toString());
          if (ss != null)
            tBillTemplet.put(key1, ss);
        }
      }

      // VO转换
      PfParameterVO voPf = new PfParameterVO();
      voPf.m_coId = BsPuTool.getLoginCorp(null);
      voPf.m_currentDate = BsPuTool.getLoginDate() + "";
      //
      DJZBVO arapVO[] = (DJZBVO[]) PfUtilTools.runChangeDataAry("45", "D1",
          billVOs, voPf);
      if (arapVO == null || arapVO.length == 0)
        return;

      // 根据采购入库单生成应付单
      Vector v1 = new Vector();
      Vector v2 = new Vector();
      Vector v3 = new Vector();
      Vector vPkInvMang = new Vector();
      for (int i = 0; i < billVOs.length; i++) {
        GeneralBillHeaderVO aheadVO = (GeneralBillHeaderVO) billVOs[i]
            .getParentVO();
        GeneralBillItemVO abodyVO[] = (GeneralBillItemVO[]) billVOs[i]
            .getChildrenVO();
        // 后续处理:应付单头
        DJZBHeaderVO headVO = (DJZBHeaderVO) arapVO[i].getParentVO();
        UFDouble nJSHJ = null; // 价税合计
        headVO.setVouchid(aheadVO.getCgeneralhid());

        String key = "25" + aheadVO.getCbiztypeid() + "APPROVE";
        String cBillType = tBillType.get(key).toString();
        String ss[] = null;
        key = aheadVO.getPk_corp() + tBillType.get(key);
        if (tBillTemplet.get(key) != null)
          ss = (String[]) tBillTemplet.get(key);
        if (ss != null && ss.length > 0)
          headVO.setYwbm(ss[0]);

        headVO.setLrr(aheadVO.getCoperatorid());

        // since v502: djrq,djkjnd,djkjqj 均由下游收付处理，本例为 CHG45TOD1 负责处理
        // headVO.setDjrq(aheadVO.getDbilldate());
        // headVO.setDjkjnd(Integer.toString(aheadVO.getDbilldate()
        // .getYear()));
        //
        // String sTemp = Integer.toString(aheadVO.getDbilldate()
        // .getMonth());
        // if (sTemp.length() < 2)
        // sTemp = "0" + sTemp;
        // headVO.setDjkjqj(sTemp);

        // 头非空
        headVO.setPrepay(new UFBoolean(false));
        headVO.setDjlxbm(cBillType);
        headVO.setQcbz(new UFBoolean(false));
        headVO.setLybz(new Integer(4));
        headVO.setDjzt(new Integer(1));
        headVO.setDjdl("yf");
        headVO.setPzglh(new Integer(1));
        headVO.setWldx(new Integer(1));
        headVO.setZdr(cOperator);
        headVO.setEnduser(cOperator);
        //
        v1.addElement(headVO);

        // 后续处理:应付单体
        DJZBItemVO bodyVO = ((DJZBItemVO[]) arapVO[i].getChildrenVO())[0];
        bodyVO.setDwbm(aheadVO.getPk_corp());
        bodyVO.setFb_oid(abodyVO[0].getCgeneralbid());

        // since v55, 收付不再支持管理档案ID的维护
        // v3.addElement(bodyVO.getKsbm_cl());
        v3.addElement(aheadVO.getCproviderid());
        //
        vPkInvMang.addElement(bodyVO.getChbm_cl());

        if (abodyVO[0].getNprice() == null
            || abodyVO[0].getNprice().doubleValue() == 0.0)
          continue;
        if (abodyVO[0].getNmny() == null
            || abodyVO[0].getNmny().doubleValue() == 0.0)
          continue;

        bodyVO.setFbye(new UFDouble(0)); // 辅币余额
        bodyVO.setDffbje(new UFDouble(0)); // 贷方辅币余额

        String sInvoiceIDs[] = getInvoiceIDs(abodyVO[0].getCgeneralbid(), body);
        bodyVO.setJsfsbm(ScmConst.PO_Invoice); // 上层单据类型
        bodyVO.setDdlx(sInvoiceIDs[0]); // 上层单据ID
        bodyVO.setDdhh(sInvoiceIDs[1]); // 上层单据行ID(暂传“上层单据ID”)
        bodyVO.setWldx(new Integer(1));
        // 币种
        bodyVO.setBzbm(currType);
        bodyVO.setBbhl(new UFDouble(1));

        // 扣税类别
        int nType = 2;
        bodyVO.setKslb(new Integer(nType));
        // 税率
        bodyVO.setSl(new UFDouble(0));

        // 体非空项
        bodyVO.setOld_sys_flag(new UFBoolean(false));
        bodyVO.setFx(new Integer(-1));
        bodyVO.setJffbje(new UFDouble(0));
        bodyVO.setJfbbje(new UFDouble(0));
        bodyVO.setJfybje(new UFDouble(0));

        bodyVO.setJfybsj(new UFDouble(0));
        bodyVO.setJfybwsje(new UFDouble(0));

        bodyVO.setWbfybje(new UFDouble(0));
        bodyVO.setWbffbje(new UFDouble(0));
        bodyVO.setWbfbbje(new UFDouble(0));

        bodyVO.setYwybm(aheadVO.getCbizid());// 业务员
        // 税额
        UFDouble d1 = abodyVO[0].getNmny();
        UFDouble d2 = bodyVO.getSl();
        // 价税合计
        if (nType == 0) {
          // 应税内含
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() * d2.doubleValue() * 0.01
                / (1.0 - d2.doubleValue() * 0.01);
            bodyVO.setDfbbsj(new UFDouble(d));
            bodyVO.setDfybsj(new UFDouble(d));
            d += d1.doubleValue();
            nJSHJ = new UFDouble(d);
          }
          if (bodyVO.getDj() != null && d2 != null) {
            double d = bodyVO.getDj().doubleValue()
                / (1.0 - d2.doubleValue() * 0.01);
            bodyVO.setHsdj(new UFDouble(d));
          }
        }
        else if (nType == 1) {
          // 应税外加
          if (d1 != null && d2 != null) {
            double d = d1.doubleValue() * d2.doubleValue() * 0.01;
            bodyVO.setDfbbsj(new UFDouble(d));
            bodyVO.setDfybsj(new UFDouble(d));
            d += d1.doubleValue();
            nJSHJ = new UFDouble(d);
          }
          if (bodyVO.getDj() != null && d2 != null) {
            double d = bodyVO.getDj().doubleValue()
                * (1.0 + d2.doubleValue() * 0.01);
            bodyVO.setHsdj(new UFDouble(d));
          }
        }
        else {
          // 不计税
          bodyVO.setDfbbsj(new UFDouble(0));
          bodyVO.setDfybsj(new UFDouble(0));
          nJSHJ = d1;
          bodyVO.setHsdj(bodyVO.getDj());
        }
        // 无税金额(价税合计-税额)
        d2 = nJSHJ;
        d1 = bodyVO.getDfbbsj();
        if (d1 != null && d2 != null) {
          double d = d2.doubleValue() - d1.doubleValue();
          bodyVO.setDfbbwsje(new UFDouble(d));
          bodyVO.setDfybwsje(new UFDouble(d));
        }
        //
        bodyVO.setDfbbje(nJSHJ);
        bodyVO.setDfybje(nJSHJ);
        bodyVO.setYbye(nJSHJ);
        bodyVO.setBbye(nJSHJ);
        v2.addElement(bodyVO);
      }

      timer.addExecutePhase("VO 对照");

      // 对应付单进行处理: 相同表头的单据组合成一张单据
      DJZBHeaderVO headVOs[] = new DJZBHeaderVO[v1.size()];
      v1.copyInto(headVOs);
      DJZBItemVO bodyVOs[] = new DJZBItemVO[v2.size()];
      v2.copyInto(bodyVOs);
      // 为应付获得供应商基础ID
      if (v3.size() > 0) {
        String pk_cumandoc[] = new String[v3.size()];
        v3.copyInto(pk_cumandoc);
        SettleDMO settleDMO = new SettleDMO();
        String pk_cubasdoc[] = settleDMO.queryVendorBaseIDForARAP(pk_cumandoc);
        if (pk_cubasdoc != null && pk_cubasdoc.length > 0) {
          for (int i = 0; i < bodyVOs.length; i++) {
            bodyVOs[i].setHbbm(pk_cubasdoc[i]);
          }
        }
      }
      timer.addExecutePhase("为应付获得供应商基础ID");

      // 为应付获得存货基础ID
      if (vPkInvMang.size() > 0) {
        String[] pk_invmandocs = new String[vPkInvMang.size()];
        vPkInvMang.copyInto(pk_invmandocs);
        SettleDMO dmoQueryPkInvBase = new SettleDMO();
        String[] pk_invbasdocs = dmoQueryPkInvBase.getInvBaseID(pk_invmandocs);
        if (pk_invbasdocs != null && pk_invbasdocs.length > 0) {
          for (int i = 0; i < bodyVOs.length; i++) {
            bodyVOs[i].setCinventoryid(pk_invbasdocs[i]);
          }
        }
      }
      timer.addExecutePhase("为应付获得存货基础ID");

      // 组合VO[]
      v1 = new Vector();
      Vector vTemp = new Vector();
      v1.addElement(headVOs[0]);
      vTemp.addElement(headVOs[0].getVouchid().trim());
      for (int i = 1; i < headVOs.length; i++) {
        String s1 = headVOs[i].getVouchid().trim();
        if (!vTemp.contains(s1)) {
          vTemp.addElement(s1);
          v1.addElement(headVOs[i]);
        }
      }
      headVOs = new DJZBHeaderVO[v1.size()];
      v1.copyInto(headVOs);
      v1 = new Vector();
      for (int i = 0; i < headVOs.length; i++) {
        DJZBVO VO = new DJZBVO();
        String s1 = headVOs[i].getVouchid().trim();
        v2 = new Vector();
        for (int j = 0; j < bodyVOs.length; j++) {
          String s2 = bodyVOs[j].getVouchid().trim();
          if (s1.equals(s2))
            v2.addElement(bodyVOs[j]);
        }
        if (v2.size() > 0) {
          DJZBItemVO tempVOs[] = new DJZBItemVO[v2.size()];
          v2.copyInto(tempVOs);
          VO.setParentVO(headVOs[i]);
          VO.setChildrenVO(tempVOs);
          v1.addElement(VO);
        }
      }
      DJZBVO VOs[] = new DJZBVO[v1.size()];
      v1.copyInto(VOs);
      timer.addExecutePhase("组合VO[]");

      // 调用应付的VO转换工具
      if (VOs != null && VOs.length > 0) {
        VoTools tools = new VoTools();
        for (int i = 0; i < VOs.length; i++) {
          VOs[i] = (DJZBVO) tools.getSumCG((DJZBVO) VOs[i]);
        }
      }
      timer.addExecutePhase("调用应付的VO转换工具");

      // 调用应付提供接口传送单据
      ArapHelper.saveArapBillForSettle(VOs);

      timer.addExecutePhase("调用应付提供接口传送单据");

      timer.showAllExecutePhase("无发票结算向应付传送数据时间分布--明细");

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return;
  }

  /**
   * 功能描述:向存货核算系统传送数据(成批单据传送) 需要查询入库单的保存，适用于以下情况 
   * <p>1)、无发票结算 
   * <p>2)、根据销售结算
   * <p>3)、采购发票保存自动结算(采购发票基于采购入库单、委外入库单、期初暂估入库单)
   * <p>4)、采购入库单签字自动结算(要求入库单和发票基于{直接上层}同一订单)、走原来的保存方法 
   * <p>作者：熊海情 
   * <p>修改：晁志平 For V30 
   * <p>@since v55,重构，增加参数：paraListDigits 精度列表{0单价、1金额、2数量、3辅数量}
   */
  private void saveBillFromOutter0(String sEstMode, String sDiffMode,
      SettlebillVO settlebillVO, String cOperator, UFDate dCurrDate,
      GeneralHItemVO generalHItemVO[], String strIntoCost,
      ArrayList paraListDigits) throws BusinessException {

    Timer timer = new Timer();
    timer.start();
    // 单价精度参数
    int iPriceDecimal = ((Integer) paraListDigits.get(0)).intValue();
    // 金额精度
    int iMnyDigit = ((Integer) paraListDigits.get(1)).intValue();
    // 数量精度
    int iNumDigit = ((Integer) paraListDigits.get(2)).intValue();
    // 辅数量精度
    int iAssNumDecimal = ((Integer) paraListDigits.get(3)).intValue();
    try {
      // 提高效率，批次获得入库单头/体信息
      SettlebillItemVO settleItemVos[] = settlebillVO.getBodyVO();
      GeneralHHeaderVO stockHeadVO[] = getStockHeadInfo(settleItemVos);
      timer.addExecutePhase("批次获得入库单头信息");
      GeneralHItemVO stockBodyVO[] = getStockBodyInfo(settleItemVos);
      timer.addExecutePhase("批次获得入库单体信息");
      if (stockHeadVO == null || stockHeadVO.length == 0) {
        return;
      }
      if (stockBodyVO == null || stockBodyVO.length == 0) {
        return;
      }
      // 入库单表头哈希表
      HashMap<String, GeneralHHeaderVO> mapEstStockHeaderVos = new HashMap<String, GeneralHHeaderVO>();
      for (GeneralHHeaderVO curHeaderVo : stockHeadVO) {
        mapEstStockHeaderVos.put(curHeaderVo.getPrimaryKey(), curHeaderVo);
      }
      // 入库单表体哈希表,入库单VO(VO对照备用)
      HashMap<String, GeneralHItemVO> mapEstStockBodyVos = new HashMap<String, GeneralHItemVO>();
      GeneralBillVO[] icVos = new GeneralBillVO[stockBodyVO.length];
      for (int i = 0; i < stockBodyVO.length; i++) {
        // 表体哈希表
        mapEstStockBodyVos.put(stockBodyVO[i].getPrimaryKey(), stockBodyVO[i]);
        // 入库单VO
        icVos[i] = switchVOFromGeneral2IC(mapEstStockHeaderVos
            .get(stockBodyVO[i].getCgeneralhid()), stockBodyVO[i]);
      }
      // since v502 , 效率优化， 单个执行VO对照调整为批量对照
      BillVO[] billVOs0 = (BillVO[]) PfUtilTools.runChangeDataAry("45", "I2",
          icVos);
      BillItemVO item = null;
      HashMap<String, BillVO> mapBillVo = new HashMap<String, BillVO>();
      for (int i = 0; i < icVos.length; i++) {
        if (billVOs0[i] == null
            || billVOs0[i].getChildrenVO() == null
            || billVOs0[i].getChildrenVO().length == 0
            || billVOs0[i].getChildrenVO()[0] == null
            || billVOs0[i].getChildrenVO()[0].getAttributeValue("cicitemid") == null) {
          throw new BusinessException(
              "Chg45toI2 Exception : cicitemid is null!");
        }
        item = (BillItemVO) billVOs0[i].getChildrenVO()[0];
        mapBillVo.put(item.getCicitemid(), billVOs0[i]);
      }
      timer
          .addExecutePhase("VO转换:PfUtilTools.runChangeDataAry(“45”, “I2”, icVOs)");
      //
      String strLoginCorpId = settleItemVos[0].getPk_corp();

      // 获得辅数量
      int iLenVOs = settleItemVos.length;
      // 哈希MAP：｛入库单行ID＝换算率｝
      HashMap mapStockHsl = new HashMap();
      int iLen = stockBodyVO.length;
      for (int i = 0; i < iLen; i++) {
        if (stockBodyVO[i].getCgeneralbid() == null
            || stockBodyVO[i].getHsl() == null) {
          continue;
        }
        mapStockHsl.put(stockBodyVO[i].getCgeneralbid(), stockBodyVO[i]
            .getHsl());
      }
      String strBid = null;
      UFDouble[] uaAssistNum = new UFDouble[iLenVOs];
      String[] saAssistId = new String[iLenVOs];
      UFDouble uNum = null, uHsl = null;
      for (int i = 0; i < iLenVOs; i++) {
        uaAssistNum[i] = new UFDouble(0.0);
        strBid = settleItemVos[i].getCstockrow();
        if (strBid == null) {
          continue;
        }
        uHsl = (UFDouble) mapStockHsl.get(strBid);
        if (uHsl == null || uHsl.doubleValue() == 0.0) {
          continue;
        }
        uNum = settleItemVos[i].getNsettlenum();
        if (uNum == null) {
          continue;
        }
        uaAssistNum[i] = uNum.div(uHsl, iAssNumDecimal);
      }
      timer.addExecutePhase("获得辅数量");

      Vector v0 = new Vector();
      BillVO[] billVOs = null;
      BillVO billVO0 = null;
      GeneralHHeaderVO stockHeaderVo = null;
      GeneralHItemVO stockItemVo = null;
      Vector vTemp = new Vector();
      for (int i = 0; i < settleItemVos.length; i++) {
        String stockID = settleItemVos[i].getCstockid();
        String stockRow = settleItemVos[i].getCstockrow();
        if (stockID != null && stockID.length() > 0 && stockRow != null
            && stockRow.length() > 0) {
          billVO0 = mapBillVo.get(stockRow);
          stockHeaderVo = mapEstStockHeaderVos.get(stockID);
          stockItemVo = mapEstStockBodyVos.get(stockRow);
          vTemp.add(stockItemVo.getCgeneralbid());
          if (generalHItemVO == null || generalHItemVO.length == 0) {
            billVOs = transferIAData(billVO0, stockHeaderVo, stockItemVo,
                sEstMode, sDiffMode, settleItemVos[i], cOperator, dCurrDate,
                null, uaAssistNum[i], stockHeaderVo.getCstoreorganization(),
                paraListDigits, iMnyDigit, iNumDigit, strIntoCost);
          }
          else {
            billVOs = transferIAData(billVO0, stockHeaderVo, stockItemVo,
                sEstMode, sDiffMode, settleItemVos[i], cOperator, dCurrDate,
                generalHItemVO, uaAssistNum[i], stockHeaderVo
                    .getCstoreorganization(), paraListDigits, iMnyDigit,
                iNumDigit, strIntoCost);
          }
          if (billVOs == null || billVOs.length == 0) {
            continue;
          }
          for (int j = 0; j < billVOs.length; j++) {
            v0.addElement(billVOs[j]);
          }
        }
      }
      timer.addExecutePhase("VO转换后续处理<按结算单行循环>");

      if (v0 == null || v0.size() == 0) {
        return;
      }
      billVOs = new BillVO[v0.size()];
      v0.copyInto(billVOs);

      // 跨公司转换
      billVOs = new SettleDMO().postDealBillVO(settlebillVO.getHeadVO()
          .getPk_corp(), stockBodyVO, billVOs);

      // 针对暂估的尾差处理
      Hashtable tZG = new Hashtable();
      // Vector vTemp = new Vector();
      // if (generalHItemVO != null && generalHItemVO.length > 0) {
      // for (int i = 0; i < generalHItemVO.length; i++) {
      // if (generalHItemVO[i].getBzgflag() != null
      // && generalHItemVO[i].getBzgflag().booleanValue()
      // && !vTemp.contains(generalHItemVO[i].getCgeneralbid())) {
      // vTemp.addElement(generalHItemVO[i].getCgeneralbid());
      // }
      // }
      // }
      if (vTemp.size() > 0) {
        String cgeneralbid[] = new String[vTemp.size()];
        vTemp.copyInto(cgeneralbid);
        tZG = new SettleDMO().queryStockZGInfo(cgeneralbid);
      }
      if (tZG.size() > 0) {
        if (sEstMode.equals("单到回冲")) {
          billVOs = crackBillDDHC(tZG, billVOs);
        }
        else {
          billVOs = crackBillDDBC(tZG, billVOs);
        }
      }
      if (billVOs == null || billVOs.length == 0) {
        return;
      }

      // 对存货核算单进行处理: 相同表头的单据组合成一张单据
      // (1) 存货核算单据来源单据头ID和暂估标志和单据类型唯一性组合
      Vector v = new Vector();
      for (int i = 0; i < billVOs.length - 1; i++) {
        String s1 = ((IBillHeaderVO) billVOs[i].getParentVO()).getCbillid()
            .trim();
        String ss1 = ((IBillHeaderVO) billVOs[i].getParentVO())
            .getBestimateflag().toString().toUpperCase().trim();
        String sss1 = ((IBillHeaderVO) billVOs[i].getParentVO())
            .getCbilltypecode().trim();
        boolean b = false;
        for (int j = i + 1; j < billVOs.length; j++) {
          String s2 = ((IBillHeaderVO) billVOs[j].getParentVO()).getCbillid()
              .trim();
          String ss2 = ((IBillHeaderVO) billVOs[j].getParentVO())
              .getBestimateflag().toString().toUpperCase().trim();
          String sss2 = ((IBillHeaderVO) billVOs[j].getParentVO())
              .getCbilltypecode().trim();
          if (s1.equals(s2) && ss1.equals(ss2) && sss1.equals(sss2)) {
            b = true;
            break;
          }
        }
        if (!b) {
          v.addElement(billVOs[i]);
        }
      }
      v.addElement(billVOs[billVOs.length - 1]);
      timer.addExecutePhase("(1) 存货核算单据来源单据头ID和暂估标志和单据类型唯一性组合");

      // (3) 所有存货核算单据体的来源单据头ID相同, 而且暂估标志和单据类型相同时,归为同一张存货核算单据
      Vector vv = new Vector();
      for (int i = 0; i < v.size(); i++) {
        BillVO tempVO = (BillVO) v.elementAt(i);
        String s1 = ((IBillHeaderVO) tempVO.getParentVO()).getCbillid().trim();
        String ss1 = ((IBillHeaderVO) tempVO.getParentVO()).getBestimateflag()
            .toString().toUpperCase().trim();
        String sss1 = ((IBillHeaderVO) tempVO.getParentVO()).getCbilltypecode()
            .trim();
        vTemp = new Vector();
        for (int j = 0; j < billVOs.length; j++) {
          String s2 = ((IBillHeaderVO) billVOs[j].getParentVO()).getCbillid()
              .trim();
          String ss2 = ((IBillHeaderVO) billVOs[j].getParentVO())
              .getBestimateflag().toString().toUpperCase().trim();
          String sss2 = ((IBillHeaderVO) billVOs[j].getParentVO())
              .getCbilltypecode().trim();
          if (s1.equals(s2) && ss1.equals(ss2) && sss1.equals(sss2)) {
            IBillItemVO tempItemVO[] = (IBillItemVO[]) billVOs[j]
                .getChildrenVO();
            for (int k = 0; k < tempItemVO.length; k++) {
              vTemp.addElement(tempItemVO[k]);
            }
          }
        }
        IBillItemVO tempItemVOs[] = new IBillItemVO[vTemp.size()];
        vTemp.copyInto(tempItemVOs);
        // 重新设置表体行号
        for (int j = 0; j < tempItemVOs.length; j++) {
          tempItemVOs[j].setIrownumber(new Integer(j));
          if (tempItemVOs[j].getCsourcebilltypecode().equals("27")) {
            tempItemVOs[j].setVsourcebillcode(settlebillVO.getHeadVO()
                .getVsettlebillcode());
          }
        }
        tempVO.setChildrenVO(tempItemVOs);
        vv.addElement(tempVO);
      }
      timer
          .addExecutePhase("(3) 所有存货核算单据体的来源单据头ID相同, 而且暂估标志和单据类型相同时,归为同一张存货核算单据");

      // (4) 整理需向存货传送的单据
      billVOs = null;
      billVOs = new BillVO[vv.size()];
      vv.copyInto(billVOs);
      timer.addExecutePhase("(4) 整理需向存货传送的单据");
      // 传送数据
      if (billVOs == null || billVOs.length == 0) {
        return;
      }
      String s1 = ((IBillHeaderVO) billVOs[0].getParentVO())
          .getCsourcemodulename();
      String s2 = ((IBillItemVO[]) billVOs[0].getChildrenVO())[0]
          .getCsourcebilltypecode();
      //
      String sTime = (new UFDateTime(new Date())).toString();
      for (int i = 0; i < billVOs.length; i++) {
        ((IBillHeaderVO) billVOs[i].getParentVO()).setVbillcode(null);
        ((IBillHeaderVO) billVOs[i].getParentVO()).setTmaketime(sTime);
        ((IBillHeaderVO) billVOs[i].getParentVO()).setTlastmaketime(sTime);
        ((IBillHeaderVO) billVOs[i].getParentVO())
            .setClastoperatorid(cOperator);
        IBillItemVO bodyVO[] = (IBillItemVO[]) billVOs[i].getChildrenVO();
        if (bodyVO != null && bodyVO.length > 0) {
          for (int j = 0; j < bodyVO.length; j++) {
            bodyVO[j].setVbillcode(null);
          }
        }
      }
      // 保存前处理
      dealBeforeCallIaSave(billVOs);
      timer.addExecutePhase("保存前处理");

      // 调用IA保存
      IIAToPU myService = (IIAToPU) NCLocator.getInstance().lookup(
          IIAToPU.class.getName());
      myService.settlePU(billVOs, PuUtils.getClintLink(strLoginCorpId,
          cOperator, dCurrDate));
      timer.addExecutePhase("传送数据<存货核算接口>");
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    timer
        .showAllExecutePhase("向存货核算系统传送数据(成批单据传送)[SettleBO.saveBillFromOutter0()]");
  }

  /**
   * 调用存货核算保存前处理。
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * <p>
   * 
   * @author czp
   * @time 2007-9-25 下午03:12:07
   */
  public static void dealBeforeCallIaSave(BillVO[] billVOs)
      throws BusinessException {
    if (billVOs == null || billVOs.length == 0) {
      return;
    }
    int iVosLen = billVOs.length;
    BillItemVO[] items = null;
    int iPriceDigit = 2;
    int iAssNumDigit = 2;
    int iChgRateDigit = 2;
    String strLoginCorp = BsPuTool.getLoginCorp(null);
    ISysInitQry srvQry = null;
    try {
      srvQry = (ISysInitQry) NCLocator.getInstance().lookup(
          ISysInitQry.class.getName());
      iPriceDigit = srvQry.getParaInt(strLoginCorp, "BD505");
      iAssNumDigit = srvQry.getParaInt(strLoginCorp, "BD502");
      iChgRateDigit = srvQry.getParaInt(strLoginCorp, "BD503");
    }
    catch (Exception e) {
      iPriceDigit = 2;
    }
    for (int i = 0; i < iVosLen; i++) {
      items = (BillItemVO[]) billVOs[i].getChildrenVO();
      if (items == null || items.length == 0) {
        continue;
      }
      for (BillItemVO item : items) {
        if (item == null) {
          continue;
        }
        // 如果辅计量ID为空，则将辅数量、换算率也设置为空
        if (PuPubVO.getString_TrimZeroLenAsNull(item.getCastunitid()) == null) {
          item.setNassistnum(null);
          item.setNchangerate(null);
        }
        // 如果有辅计量信息则处理辅数量、换算率精度
        else {
          // 精度补充处理
          item.setNassistnum(PuPubVO.getUFDouble_NullAsZero(
              item.getNassistnum()).add(new UFDouble(0.0), iAssNumDigit));
          item.setNchangerate(PuPubVO.getUFDouble_NullAsZero(
              item.getNchangerate()).add(new UFDouble(0.0), iChgRateDigit));

          // 针对错误数据的补救 处理
          if (item.getNchangerate().doubleValue() == 0.0
              && item.getNassistnum() != null
              && item.getNassistnum().doubleValue() != 0.0) {
            item.setNchangerate(PuPubVO.getUFDouble_NullAsZero(
                item.getNnumber()).div(
                PuPubVO.getUFDouble_NullAsZero(item.getNassistnum()),
                iChgRateDigit));
          }
        }
        // FENGPING ，传存货前采购反算单价。解决问题：发票有合理损耗时，存货核算单据的数量*单价<>金额。
        if (item.getNmoney() != null && item.getNnumber() != null
            && item.getNnumber().doubleValue() != 0.0) {
          if (item.getPk_corp() != strLoginCorp) {
            iPriceDigit = srvQry.getParaInt(item.getPk_corp(), "BD505");
          }
          item.setNprice(item.getNmoney().div(item.getNnumber(), iPriceDigit));
        }
      }
    }
  }

  /*
   * 实现倒挤，避免结算时, 累计单到回冲金额 不等于 暂估金额 <p>参数说明：tStock ={key = 入库单行ID, value[] =
   * [暂估数量,暂估金额]} 2006-08-17 xhq
   * 
   * @since v55,2008-07-05, 加注&重构
   */
  private BillVO[] crackBillDDHC(Hashtable tBB3NumPmny, BillVO[] billVos)
      throws BusinessException {
    if (billVos == null || billVos.length == 0) {
      return billVos;
    }
    // 按存货单据获取入库单行ID
    Vector vecStockRow = new Vector();
    for (int i = 0; i < billVos.length; i++) {
      IBillHeaderVO headVO = (IBillHeaderVO) billVos[i].getParentVO();
      if (headVO.getBRedBill() == null || !headVO.getBRedBill().booleanValue()) {
        continue;
      }
      IBillItemVO bodyVO[] = (IBillItemVO[]) billVos[i].getChildrenVO();
      for (int j = 0; j < bodyVO.length; j++) {
        if (!vecStockRow.contains(bodyVO[j].getCbill_bid())) {
          vecStockRow.addElement(bodyVO[j].getCbill_bid());
        }
      }
    }
    // 获取结算数量和暂估金额
    String[] saStockRow = new String[vecStockRow.size()];
    vecStockRow.copyInto(saStockRow);
    String strWherePart = null;
    try {
      TempTableDMO dmoTmpTbl = new TempTableDMO();
      strWherePart = dmoTmpTbl.insertTempTable(saStockRow,
          TempTableVO.TEMPTABLE_PU_V502_001, TempTableVO.TEMPPKFIELD_PU);
      if (strWherePart == null || strWherePart.trim().equals("()")) {
        strWherePart = " ('ErrorPk') ";
      }
    }
    catch (Exception e) {
      throw new BusinessException(NCLangResOnserver.getInstance().getStrByID(
          "40040502", "UPP40040502-000046")
          /* @res"调用临时表处理出现异常" */+ e.getMessage());
    }
    strWherePart = " dr = 0 and cstockrow in " + strWherePart;

    // 查询结算单：结算数量(回冲数量)、回冲暂估金额
    Hashtable tableSettleNumGaugMny = new Hashtable();
    try {
      tableSettleNumGaugMny = new PubDMO().queryHtResultFromAnyTable(
          "po_settlebill_b", "cstockrow", new String[] {
              "nsettlenum", "ngaugemny"
          }, strWherePart);
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    // 哈希表：key = 入库单行ID,value[] = [已回冲数量之和,已回冲金额之和]
    Hashtable tableAccNumAccMny = new Hashtable();
    //
    Object objNumMny = null;
    //
    Vector vecNumMny = null;
    //
    Object[] oaNumMny = null;
    //
    double dAccWashNum = 0, dAccWashMny = 0, dIcNum = 0, dBB3GaugMny = 0, dWasMnyThis;
    // 
    IBillItemVO[] bodyVOs = null;
    // 逐个存货单据处理(只处理表头有红冲标识的存货单据)
    for (int i = 0; i < billVos.length; i++) {
      IBillHeaderVO headVO = (IBillHeaderVO) billVos[i].getParentVO();
      if (headVO.getBRedBill() == null || !headVO.getBRedBill().booleanValue()) {
        continue;
      }
      bodyVOs = (IBillItemVO[]) billVos[i].getChildrenVO();
      // 逐个存货单据行处理
      for (int j = 0; j < bodyVOs.length; j++) {
        objNumMny = tableSettleNumGaugMny.get(bodyVOs[j].getCbill_bid());
        // 计算同入库单行的多次结算的累计回冲数量,累计回冲金额
        if (objNumMny != null) {
          vecNumMny = (Vector) objNumMny;
          if (vecNumMny != null && vecNumMny.size() > 0) {
            // 同入库单行的多次结算
            for (int k = 0; k < vecNumMny.size(); k++) {
              oaNumMny = (Object[]) vecNumMny.elementAt(k);
              dAccWashNum = (new UFDouble(oaNumMny[0].toString()))
                  .doubleValue();
              dAccWashMny = (new UFDouble(oaNumMny[1].toString()))
                  .doubleValue();

              objNumMny = tableAccNumAccMny.get(bodyVOs[j].getCbill_bid());
              if (objNumMny != null) {
                oaNumMny = (Object[]) objNumMny;
                dAccWashNum += (new UFDouble(oaNumMny[0].toString()))
                    .doubleValue();
                dAccWashMny += (new UFDouble(oaNumMny[1].toString()))
                    .doubleValue();
              }
              tableAccNumAccMny.put(bodyVOs[j].getCbill_bid(), new UFDouble[] {
                  new UFDouble(dAccWashNum), new UFDouble(dAccWashMny)
              });
            }
          }
        }
        // 同入库单行的多次结算的累计回冲数量,累计回冲金额
        objNumMny = tableAccNumAccMny.get(bodyVOs[j].getCbill_bid());
        if (objNumMny != null) {
          oaNumMny = (Object[]) objNumMny;
          dAccWashNum = (new UFDouble(oaNumMny[0].toString())).doubleValue();// 累计回冲数量(已包含本次回冲数量)
          dAccWashMny = (new UFDouble(oaNumMny[1].toString())).doubleValue();// 累计回冲金额(已包含本次回冲金额)
        }
        // 入库单子子表3记录的暂估数量(入库单行上的实收数量)、暂估金额
        objNumMny = tBB3NumPmny.get(bodyVOs[j].getCbill_bid());
        if (objNumMny != null) {
          oaNumMny = (Object[]) objNumMny;
          dIcNum = (new UFDouble(oaNumMny[0].toString())).doubleValue();// 暂估数量
          dBB3GaugMny = (new UFDouble(oaNumMny[1].toString())).doubleValue();// 暂估金额
        }
        // 如果累计回冲数量=暂估数量,倒挤本次回冲金额,本次回冲金额=暂估金额-累计回冲金额(不含本次回冲金额)
        if (Math.abs(dAccWashNum - dIcNum) == 0.0) {
          // dWasMnyThis = dBB3GaugMny - (dAccWashMny +
          // bodyVOs[j].getNmoney().doubleValue());
          // bodyVOs[j].setNmoney(new UFDouble(dWasMnyThis * -1));
          // since v55, 修正潜在错误
          dWasMnyThis = dBB3GaugMny
              - (dAccWashMny - bodyVOs[j].getNmoney().doubleValue());
          bodyVOs[j].setNmoney(new UFDouble(dWasMnyThis));
        }
      }
    }
    //
    return billVos;
  }

  /*
   * 实现倒挤，避免结算时, 累计单到补差金额 不等于 累计结算金额 - 累计暂估金额 <p>参数说明：tStock ={key = 入库单行ID,
   * value[] = [暂估数量,暂估金额]} 2006-08-17 xhq
   * 
   * @since v55,2008-07-05, czp, 加注&重构
   */
  private BillVO[] crackBillDDBC(Hashtable tBB3NumPmny, BillVO[] billVos)
      throws BusinessException {
    if (billVos == null || billVos.length == 0) {
      return billVos;
    }
    // 按存货单据获取入库单行ID
    Vector v = new Vector();
    for (int i = 0; i < billVos.length; i++) {
      IBillItemVO bodyVO[] = (IBillItemVO[]) billVos[i].getChildrenVO();
      for (int j = 0; j < bodyVO.length; j++) {
        if (!v.contains(bodyVO[j].getCbill_bid()))
          v.addElement(bodyVO[j].getCbill_bid());
      }
    }
    // 获取结算数量和补差金额
    String sTemp[] = new String[v.size()];
    v.copyInto(sTemp);
    String ss = null;
    try {
      TempTableDMO dmoTmpTbl = new TempTableDMO();
      ss = dmoTmpTbl.insertTempTable(sTemp, TempTableVO.TEMPTABLE_PU_V502_001,
          TempTableVO.TEMPPKFIELD_PU);
      if (ss == null || ss.trim().equals("()")) {
        ss = " ('ErrorPk') ";
      }
    }
    catch (Exception e) {
      throw new BusinessException(NCLangResOnserver.getInstance().getStrByID(
          "40040502", "UPP40040502-000046")
          /* @res"调用临时表处理出现异常" */+ e.getMessage());
    }
    ss = " dr = 0 and cstockrow in " + ss;
    //
    Hashtable hSettle = new Hashtable();
    try {
      hSettle = new PubDMO().queryHtResultFromAnyTable("po_settlebill_b",
          "cstockrow", new String[] {
              "nsettlenum", "nmoney", "ngaugemny"
          }, ss);
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }

    // key = 入库单行ID,value[] = [已补差数量之和,已补差金额之和, 已结算金额之和]
    Hashtable tableAccNumAccMny = new Hashtable();
    Object objNumMny = null;
    Object[] oaNumMny = null;
    double dAccSettleNum = 0, dAccSettleMny = 0, dAccGaugMny = 0, dIcNum = 0, dBB3GaugMny = 0, dAccDiffMnyNoThis = 0, dDiffMnyThis = 0;

    // 计算本次结算的累计补差数量,累计补差金额, 累计结算金额
    for (int i = 0; i < billVos.length; i++) {
      IBillHeaderVO headVO = (IBillHeaderVO) billVos[i].getParentVO();
      IBillItemVO bodyVO[] = (IBillItemVO[]) billVos[i].getChildrenVO();

      for (int j = 0; j < bodyVO.length; j++) {
        objNumMny = hSettle.get(bodyVO[j].getCbill_bid());
        if (objNumMny != null) {
          v = (Vector) objNumMny;
          if (v != null && v.size() > 0) {
            for (int k = 0; k < v.size(); k++) {
              oaNumMny = (Object[]) v.elementAt(k);
              dAccSettleNum = (new UFDouble(oaNumMny[0].toString()))
                  .doubleValue();
              dAccSettleMny = (new UFDouble(oaNumMny[1].toString()))
                  .doubleValue();
              if (oaNumMny[2] != null) {
                dAccGaugMny = (new UFDouble(oaNumMny[2].toString()))
                    .doubleValue();
              }
              objNumMny = tableAccNumAccMny.get(bodyVO[j].getCbill_bid());
              if (objNumMny != null) {
                oaNumMny = (Object[]) objNumMny;
                dAccSettleNum += (new UFDouble(oaNumMny[0].toString()))
                    .doubleValue();
                dAccSettleMny += (new UFDouble(oaNumMny[1].toString()))
                    .doubleValue();
                if (oaNumMny[2] != null) {
                  dAccGaugMny += (new UFDouble(oaNumMny[2].toString()))
                      .doubleValue();
                }
              }
              tableAccNumAccMny.put(bodyVO[j].getCbill_bid(), new UFDouble[] {
                  new UFDouble(dAccSettleNum), new UFDouble(dAccSettleMny),
                  new UFDouble(dAccGaugMny)
              });
            }
          }
        }
        objNumMny = tableAccNumAccMny.get(bodyVO[j].getCbill_bid());
        if (objNumMny != null) {
          oaNumMny = (Object[]) objNumMny;
          // 累计补差数量(已包含本次补差数量)
          dAccSettleNum = (new UFDouble(oaNumMny[0].toString())).doubleValue();
          // 累计结算金额(已包含本次结算金额)
          dAccSettleMny = (new UFDouble(oaNumMny[1].toString())).doubleValue();
          // 累计暂估金额(已包含本次暂估金额)
          dAccGaugMny = (new UFDouble(oaNumMny[2].toString())).doubleValue();
        }

        objNumMny = tBB3NumPmny.get(bodyVO[j].getCbill_bid());
        if (objNumMny != null) {
          oaNumMny = (Object[]) objNumMny;
          dIcNum = (new UFDouble(oaNumMny[0].toString())).doubleValue();// 暂估数量
          dBB3GaugMny = (new UFDouble(oaNumMny[1].toString())).doubleValue();// 暂估金额
        }
        // 如果累计补差数量=暂估数量,本次补差金额=累计结算金额-暂估金额-累计补差金额(不含本次)
        if (Math.abs(dAccSettleNum - dIcNum) == 0.0) {
          // 累计补差金额(不含本次)
          dAccDiffMnyNoThis = dAccSettleMny - dBB3GaugMny
              - bodyVO[j].getNmoney().doubleValue();
          // 倒挤本次补差金额
          dDiffMnyThis = dAccSettleMny - dBB3GaugMny - dAccDiffMnyNoThis;
          // 设置
          bodyVO[j].setNmoney(new UFDouble(dDiffMnyThis));
        }
      }
    }
    //
    return billVos;
  }

  /*
   * 根据入库单子表主键，返回暂估相关信息 <p>返回结构：HashMap{String, 入库单子表主键 <p> ArrayList{ <p>
   * 入库单行主键cgeneralbid, <p> 暂估费用主键cfeeid, <p> 暂估费用金额nfeemny, <p>
   * 成本要素主键ccostfactorid, <p> 暂估的费用存货在成本要素中定义的序号N(即结算单成本要素索引nfactorN) <p>
   * 公司主键pk_corp, <p> 成本要素名称vfactorname, <p> 分摊方式fapportionmode, <p>
   * 是否进行成本计算bisentercost, <p> } <p> }
   * 
   * @since v55
   */
  private HashMap<String, ArrayList<Object>> getEstFeeInfos(String[] saBid,
      String strLoginCorp) throws BusinessException {

    // 此结构内容见方法说明
    HashMap<String, ArrayList<Object>> mapEstFeeInfos = new HashMap<String, ArrayList<Object>>();
    //

    if (saBid == null || saBid.length == 0) {
      return null;
    }
    PubImpl queryTool = new PubImpl();
    // 查询cfeeid, nfeemny
    Object[][] oa2Ret = queryTool.queryArrayValue("ic_general_bb3",
        "cgeneralbid", new String[] {
            "cgeneralbid", "cfeeid", "nfeemny"
        }, saBid, "dr=0");
    if (oa2Ret == null || oa2Ret.length == 0) {
      return null;
    }
    // 费用存货主键
    ArrayList<String> listFeeMangId = new ArrayList<String>();
    // {入库单行主键、暂估费用存货主键、暂估费用金额}
    ArrayList listFeeInfos = null;
    String strBid = null;
    String strFeeMangId = null;
    for (int i = 0; i < oa2Ret.length; i++) {
      if (oa2Ret[i] == null) {
        continue;
      }
      listFeeInfos = new ArrayList();
      strBid = (String) oa2Ret[i][0];
      strFeeMangId = (String) oa2Ret[i][1];
      // 没有费用暂估，忽略
      if (PuPubVO.getString_TrimZeroLenAsNull(strFeeMangId) == null) {
        continue;
      }
      // {入库单行主键、暂估费用存货主键、暂估费用金额、？(后续处理：成本要素相关信息)}
      listFeeInfos.add(strBid);
      listFeeInfos.add(strFeeMangId);
      listFeeInfos.add(PuPubVO.getUFDouble_NullAsZero(oa2Ret[i][2]));
      mapEstFeeInfos.put(strBid, listFeeInfos);

      // 只记录不重复的费用存货ID
      if (!listFeeMangId.contains(strFeeMangId)) {
        listFeeMangId.add(strFeeMangId);
      }
    }

    // 为处理暂估的费用存货在成本要素中定义的序号N(即结算单成本要素索引nfactorN)准备数据

    // {成本要素主键=序号}
    HashMap<String, Integer> mapCfactorIdAndNo = null;
    try {
      strLoginCorp = BsPuTool.getLoginCorp(strLoginCorp);
      mapCfactorIdAndNo = new SettleDMO().queryCfactorIdAndNoHash(strLoginCorp);
    }
    catch (NamingException e) {
      throw new BusinessException(e.getMessage());
    }
    catch (SystemException e) {
      throw new BusinessException(e.getMessage());
    }
    // 未定义成本要素，直接返回空
    if (mapCfactorIdAndNo == null || mapCfactorIdAndNo.size() == 0) {
      return null;
    }
    // {费用存货=成本要素主键+表头其它信息}
    HashMap<String, CostfactorHeaderVO> mapCostFactorHeader = new HashMap<String, CostfactorHeaderVO>();
    oa2Ret = queryTool.queryArrayValue("po_costfactor_b b, po_costfactor h",
        "b.cmangid", new String[] {
            "b.cmangid", "b.ccostfactorid", "h.pk_corp", "h.vfactorname",
            "h.fapportionmode", "h.bisentercost"
        }, listFeeMangId.toArray(new String[listFeeMangId.size()]),
        "b.ccostfactorid = h.ccostfactorid and b.dr=0 and h.dr = 0 and b.pk_corp = '"
            + strLoginCorp + "'");
    if (oa2Ret == null || oa2Ret.length == 0) {
      return null;
    }
    String strFactorId = null;
    CostfactorHeaderVO header = null;
    for (int i = 0; i < oa2Ret.length; i++) {
      if (oa2Ret[i] == null) {
        continue;
      }
      strFeeMangId = (String) oa2Ret[i][0];
      //
      header = new CostfactorHeaderVO();
      header.setCcostfactorid((String) oa2Ret[i][1]);
      header.setPk_corp((String) oa2Ret[i][2]);
      header.setVfactorname((String) oa2Ret[i][3]);
      header.setFapportionmode(PuPubVO.getInteger_NullAs(oa2Ret[i][4],
          new Integer(1)));
      header.setBisentercost(PuPubVO.getUFBoolean_NullAs(oa2Ret[i][5],
          UFBoolean.FALSE));
      //
      mapCostFactorHeader.put(strFeeMangId, header);
    }
    // 处理暂估的费用存货在成本要素中定义的序号N(即结算单成本要素索引nfactorN)
    for (int i = 0; i < saBid.length; i++) {
      if (!mapEstFeeInfos.containsKey(saBid[i])) {
        continue;
      }
      // {入库单行主键、暂估费用存货主键、暂估费用金额、？(成本要素相关)}
      listFeeInfos = mapEstFeeInfos.get(saBid[i]);
      //
      if (listFeeInfos == null || listFeeInfos.size() == 0) {
        continue;
      }
      //
      strFeeMangId = (String) listFeeInfos.get(1);
      // 加入成本要素相关信息：listFeeInfos = {入库单行主键、暂估费用存货主键、暂估费用金额、成本要素相关...}
      header = mapCostFactorHeader.get(strFeeMangId);
      //
      listFeeInfos.add(header.getCcostfactorid());
      listFeeInfos.add(mapCfactorIdAndNo.get(header.getCcostfactorid()));
      listFeeInfos.add(header.getPk_corp());
      listFeeInfos.add(header.getVfactorname());
      listFeeInfos.add(header.getFapportionmode());
      listFeeInfos.add(header.getBisentercost());
    }
    return mapEstFeeInfos;
  }

  /*
   * since v55,处理StockVO，
   * 记录暂估费用ID：cfeeid,暂估费用金额：nfeemny,暂估的费用存货在成本要素中定义的序号N(即结算单成本要素索引nfactorN)
   */
  private void dealStockVosUseEstFeeInfos(StockVO[] stocks, String strLoginCorp)
      throws BusinessException {
    if (stocks == null || stocks.length == 0) {
      return;
    }
    ArrayList<String> listBid = new ArrayList<String>();
    String strBid = null;
    for (int i = 0; i < stocks.length; i++) {
      strBid = PuPubVO.getString_TrimZeroLenAsNull(stocks[i].getCgeneralbid());
      if (strBid == null) {
        continue;
      }
      listBid.add(strBid);
    }
    /*
     * 结构：HashMap{String, 入库单子表主键 <p> ArrayList{ <p> 入库单行主键cgeneralbid, <p>
     * 暂估费用主键cfeeid, <p> 暂估费用金额nfeemny, <p> 成本要素主键ccostfactorid, <p>
     * 暂估的费用存货在成本要素中定义的序号N(即结算单成本要素索引nfactorN) <p> 公司主键pk_corp, <p>
     * 成本要素名称vfactorname, <p> 分摊方式fapportionmode, <p> 是否进行成本计算bisentercost, <p> }
     * <p> }
     */
    HashMap<String, ArrayList<Object>> mapEstFeeInfos = null;

    // 按入库单行ID获取成本要素信息
    mapEstFeeInfos = getEstFeeInfos(
        listBid.toArray(new String[listBid.size()]), strLoginCorp);
    if (mapEstFeeInfos == null || mapEstFeeInfos.size() == 0) {
      return;
    }
    //
    for (int i = 0; i < stocks.length; i++) {
      strBid = PuPubVO.getString_TrimZeroLenAsNull(stocks[i].getCgeneralbid());
      if (strBid == null || !mapEstFeeInfos.containsKey(strBid)) {
        continue;
      }
      // {入库单行主键、暂估费用存货主键、暂估费用金额、成本要素相关信息...}
      ArrayList listFeeInfos = mapEstFeeInfos.get(strBid);
      if (listFeeInfos == null || listFeeInfos.size() == 0) {
        continue;
      }
      int index = 0;
      stocks[i].setCfeeid((String) listFeeInfos.get(++index));
      stocks[i].setNfeemny((UFDouble) listFeeInfos.get(++index));
      stocks[i].setCcostfactorid((String) listFeeInfos.get(++index));
      stocks[i].setIfactorno((Integer) listFeeInfos.get(++index));
      stocks[i].setPk_corp((String) listFeeInfos.get(++index));
      stocks[i].setVfactorname((String) listFeeInfos.get(++index));
      stocks[i].setFapportionmode((Integer) listFeeInfos.get(++index));
      stocks[i].setBisentercost((UFBoolean) listFeeInfos.get(++index));
    }
  }

  /*
   * 哈希表{存货ID=ArrayList{单位体积、单位重量}} since v55
   */
  private HashMap<String, ArrayList<UFDouble>> getUnitWeightAndVolumeMap(
      IinvoiceVO[] iinvoiceVOs) throws BusinessException {
    if (iinvoiceVOs == null || iinvoiceVOs.length == 0) {
      return null;
    }
    HashMap<String, ArrayList<UFDouble>> mapUnitWeightAndVolume = null;
    ArrayList<String> listBaseId = new ArrayList<String>();
    for (IinvoiceVO vo : iinvoiceVOs) {
      if (!listBaseId.contains(vo.getCbaseid())) {
        listBaseId.add(vo.getCbaseid());
      }
    }
    if (listBaseId.size() == 0) {
      return null;
    }
    Object[][] oa2Ret = new PubImpl().queryArrayValue("bd_invbasdoc",
        "pk_invbasdoc", new String[] {
            "pk_invbasdoc", "unitvolume", "unitweight"
        }, listBaseId.toArray(new String[listBaseId.size()]), "dr=0");
    //
    ArrayList<UFDouble> listUnitWorV = null;
    if (oa2Ret != null || oa2Ret.length > 0) {
      mapUnitWeightAndVolume = new HashMap<String, ArrayList<UFDouble>>();
      for (int i = 0; i < oa2Ret.length; i++) {
        if (oa2Ret[i] == null) {
          continue;
        }
        listUnitWorV = new ArrayList<UFDouble>();
        listUnitWorV.add(PuPubVO.getUFDouble_NullAsZero(oa2Ret[i][1]));
        listUnitWorV.add(PuPubVO.getUFDouble_NullAsZero(oa2Ret[i][2]));
        mapUnitWeightAndVolume.put((String) oa2Ret[i][0], listUnitWorV);
      }
    }
    else {
      listUnitWorV = new ArrayList<UFDouble>();
      listUnitWorV.add(new UFDouble(0.0));
      listUnitWorV.add(new UFDouble(0.0));
      for (int i = 0; i < listBaseId.size(); i++) {
        mapUnitWeightAndVolume.put(listBaseId.get(i), listUnitWorV);
      }
    }
    //
    return mapUnitWeightAndVolume;
  }

  /**
   * 功能描述:向存货核算系统传送数据(成批单据传送) 
   * <p>参数结构：ArrayList 
   * <p>                |-String sEstMode,暂估方式 
   * <p>                |-String sDiffMode,差异转入方式 
   * <p>                |-SettlebillVO settlebillVO,结算单VO 
   * <p>                |-String cOperator,操作员
   * <p>                |-UFDate dCurrDate,当前登录日期 
   * <p>                |-GeneralHItemVO[] generalHItemVOs，入库单体VO
   * <p>                |-StockVO[] stocks，入库单体VO(结算用入库单VO，含表头信息)
   * <p>                |-IinvoiceVO[] iinvoiceVOs，普通发票VO数组  //since v55
   * <p>                |-FeeinvoiceVO[] feeVOs，费用发票VO数组     //since v55
   * 
   * <p>作者：熊海情 
   * <p>修改：晁志平 For V30
   */
  public void saveBillFromOutter1(ArrayList listPara) throws BusinessException {
    if (listPara == null || listPara.size() < 7) {
      SCMEnv.out("程序BUG：传入参数数不正确");
      SCMEnv.out(new Exception());
    }

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    String sEstMode = (String) listPara.get(0);
    String sDiffMode = (String) listPara.get(1);
    SettlebillVO settlebillVO = (SettlebillVO) listPara.get(2);
    String cOperator = (String) listPara.get(3);
    UFDate dCurrDate = (UFDate) listPara.get(4);
    GeneralHItemVO[] generalHItemVOs = (GeneralHItemVO[]) listPara.get(5);
    StockVO[] stocks = (StockVO[]) listPara.get(6);
    // since v55
    IinvoiceVO iinvoiceVOs[] = (IinvoiceVO[]) listPara.get(7);
    FeeinvoiceVO feeVOs[] = (FeeinvoiceVO[]) listPara.get(8);

    // *****
    // 入库单行的长度小于结算单体中含入库单行的长度(入库单行拆分结算),则补充入库单行的长度等于结算单体中含入库单行的长度
    SettlebillItemVO[] settleItems = settlebillVO.getBodyVO();
    String strLoginCorpId = settleItems[0].getPk_corp();
    ArrayList paraListDigits = new ArrayList();
    String strIntoCost = null;
    int iPriceDecimal = 2;
    int iAssNumDecimal = 2;
    try {
      ISysInitQry srvQrySysInit = (ISysInitQry) NCLocator.getInstance().lookup(ISysInitQry.class.getName());
      // 单价精度参数
      iPriceDecimal = srvQrySysInit.getParaInt(strLoginCorpId, "BD505");
      // 合理损耗是否进入成本
      strIntoCost = srvQrySysInit.getParaString(strLoginCorpId, "PO75");
      // 辅数量精度
      iAssNumDecimal = srvQrySysInit.getParaInt(settlebillVO.getHeadVO().getPk_corp(), "BD502");
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    // 单价精度
    paraListDigits.add(new Integer(iPriceDecimal));
    // 本位币金额精度
    paraListDigits.add(new Integer(BsPuTool.getCCurrDecimal(strLoginCorpId)));
    // 数量精度
    paraListDigits.add(BsPuTool.getDigitBD501());
    // 辅数量精度
    paraListDigits.add(new Integer(iAssNumDecimal));

    timer.addExecutePhase("读取参数");

    /*
     * 需要查询入库单的保存，适用于以下情况 
     * 1)、无发票结算 
     * 2)、根据销售结算
     * 3)、采购发票保存自动结算(采购发票基于采购入库单、委外入库单、期初暂估入库单)
     * 4)、采购入库单签字自动结算(要求入库单和发票基于{直接上层}同一订单)、走原来的保存方法
     */
    if (stocks == null) {
      saveBillFromOutter0(sEstMode, sDiffMode, settlebillVO, cOperator,dCurrDate, generalHItemVOs, strIntoCost, paraListDigits);
      return;
    }

    /*
     * 不需要查询入库单的保存，适用于以下情况{V30优化} 
     * 1)、自动结算 
     * 2)、手工结算 
     * 3)、异存货结算
     * 4)、采购发票保存自动结算(采购发票基于采购订单，非直运类，可匹配采购入库单、委外入库单、期初暂估入库单)
     */
    /* since v55,支持运费暂估处理 */
    HashMap<String, ArrayList<UFDouble>> mapUnitWeightAndVolume = null;
    mapUnitWeightAndVolume = getUnitWeightAndVolumeMap(iinvoiceVOs);
    //
    int iLenVOs = settleItems.length;
    HashMap<String, StockVO> hashStockVo = new HashMap<String, StockVO>();
    for (int i = 0; i < stocks.length; i++) {
      hashStockVo.put(stocks[i].getCgeneralbid(), stocks[i]);
    }
    if (settleItems != null && stocks.length < settleItems.length) {
      Vector v = new Vector();
      for (int i = 0; i < settleItems.length; i++) {
        String key = settleItems[i].getCstockrow();
        if (key != null && hashStockVo.containsKey(key))
          v.addElement(hashStockVo.get(key));
      }
      stocks = new StockVO[v.size()];
      v.copyInto(stocks);
    }

    // IIAToPUBill myService = null;
    try {
      /** 获得辅数量 */
      // 哈希MAP：｛存货管理档案ID＝换算率｝
      HashMap mapStockHsl = new HashMap();
      int iLen = stocks.length;
      for (int i = 0; i < iLen; i++) {
        if (stocks[i].getCgeneralbid() == null || stocks[i].getHsl() == null)
          continue;
        mapStockHsl.put(stocks[i].getCgeneralbid(), stocks[i].getHsl());
      }
      String strBid = null;
      UFDouble[] uaAssistNum = new UFDouble[iLenVOs];
      UFDouble uNum = null, uHsl = null;

      for (int i = 0; i < iLenVOs; i++) {
        uaAssistNum[i] = new UFDouble(0.0);
        strBid = settleItems[i].getCstockrow();
        if (strBid == null)
          continue;
        uHsl = (UFDouble) mapStockHsl.get(strBid);
        if (uHsl == null || uHsl.doubleValue() == 0.0)
          continue;
        uNum = settleItems[i].getNsettlenum();
        if (uNum == null)
          continue;
        uaAssistNum[i] = uNum.div(uHsl, iAssNumDecimal);
      }
      timer.addExecutePhase("获得辅数量");

      // since v502 效率优化，支持VO转换的批量处理
      int iLenStockVOs = stocks.length;

      // icVOs的每张单据表体长度为1
      GeneralBillVO[] icVOs = new GeneralBillVO[iLenStockVOs];
      for (int i = 0; i < iLenStockVOs; i++) {
        icVOs[i] = switchVOFromStock2IC(stocks[i]);
      }
      timer.addExecutePhase("StockVO向IC的VO转换<缓存处理>:switchVOFromStock2IC()");

      // billVOs0的每张单据表体长度为1
      BillVO[] billVOs0 = (BillVO[]) PfUtilTools.runChangeDataAry("45", "I2",
          icVOs);
      //
      BillItemVO item = null;
      HashMap<String, BillVO> mapBillVo = new HashMap<String, BillVO>();
      for (int i = 0; i < iLenStockVOs; i++) {
        if (billVOs0[i] == null
            || billVOs0[i].getChildrenVO() == null
            || billVOs0[i].getChildrenVO().length == 0
            || billVOs0[i].getChildrenVO()[0] == null
            || billVOs0[i].getChildrenVO()[0].getAttributeValue("cicitemid") == null) {
          throw new BusinessException(NCLangResOnserver.getInstance().getStrByID("40040502", 
              "UPP40040502-000240",null,new String[]{"45","I2","I2","cicitemid"}));
              /*"从类型{0}到类型{1}的VO对照转换存在问题，转换后的单据{2}中{3}为空！"*/
        }
        item = (BillItemVO) billVOs0[i].getChildrenVO()[0];
        mapBillVo.put(item.getCicitemid(), billVOs0[i]);
      }
      timer
          .addExecutePhase("VO转换:PfUtilTools.runChangeDataAry(“45”, “I2”, icVOs)");

      Vector vecBillVosAll = new Vector();
      //
      if (generalHItemVOs == null || generalHItemVOs.length == 0) {
        generalHItemVOs = null;
      }

      BillVO[] billVos = null;
      BillVO billVo = null;// 存货单据与采购的StockVO一一对应
      StockVO stockVo = null;

      // VO转换后续处理
      for (int i = 0; i < iLenVOs; i++) {
        String stockID = settleItems[i].getCstockid();
        String stockRow = settleItems[i].getCstockrow();
        if (stockID != null && stockID.length() > 0 && stockRow != null && stockRow.length() > 0) {
          stockVo = hashStockVo.get(stockRow);
          // billVo的表体长度为1
          billVo = mapBillVo.get(stockRow);
          if (billVo == null) {
            throw new BusinessException("Chg45toI2 Exception : mapBillVo cannot get BillVO using the key “stockRow”!");
          }
          // 后续处理
          billVos = transferIAData1(billVo, stockVo, sEstMode, sDiffMode,
              settleItems[i], cOperator, dCurrDate, generalHItemVOs,
              uaAssistNum[i], stockVo.getCstoreorganization(), paraListDigits,
              strIntoCost,
              // since v55
              settlebillVO, mapUnitWeightAndVolume);
          //
          if (billVos == null || billVos.length == 0) {
            continue;
          }
          for (int j = 0; j < billVos.length; j++) {
            vecBillVosAll.addElement(billVos[j]);
          }
        }
      }
      timer.addExecutePhase("VO转换后续处理：transferIAData1()");

      if (vecBillVosAll == null || vecBillVosAll.size() == 0) {
        return;
      }
      billVos = new BillVO[vecBillVosAll.size()];
      vecBillVosAll.copyInto(billVos);

      // 跨公司转换
      billVos = new SettleDMO().postDealBillVOSP(settlebillVO.getHeadVO()
          .getPk_corp(), stocks, billVos);
      timer.addExecutePhase("跨公司转换");

      // 针对暂估的尾差处理
      dealBillVosForCrack(generalHItemVOs, billVos, sEstMode);
      timer.addExecutePhase("crackBillDDBC()处理");

      // 分单：来源单据头ID、暂估标志、单据类型、暂估费用调整标志(since v55)
      billVos = (BillVO[]) SplitBillVOs.getSplitVOs(BillVO.class.getName(),
          IBillHeaderVO.class.getName(), IBillItemVO.class.getName(), billVos,
          new String[] {
              "cbillid", "bestimateflag", "cbilltypecode", "bestfeebill"
          }, null);
      timer.addExecutePhase("分单：来源单据头ID、暂估标志、单据类型、暂估费用调整标志");

      // 设置时间戳等必要信息
      String sTime = (new UFDateTime(new Date())).toString();
      IBillItemVO[] bodyVOs = null;
      for (int i = 0; i < billVos.length; i++) {
        ((IBillHeaderVO) billVos[i].getParentVO()).setVbillcode(null);
        ((IBillHeaderVO) billVos[i].getParentVO()).setTmaketime(sTime);
        ((IBillHeaderVO) billVos[i].getParentVO()).setTlastmaketime(sTime);
        ((IBillHeaderVO) billVos[i].getParentVO())
            .setClastoperatorid(cOperator);
        bodyVOs = (IBillItemVO[]) billVos[i].getChildrenVO();
        if (bodyVOs != null && bodyVOs.length > 0) {
          for (int j = 0; j < bodyVOs.length; j++) {
            bodyVOs[j].setIrownumber(new Integer(j));
            if (bodyVOs[j].getCsourcebilltypecode().equals("27")) {
              bodyVOs[j].setVsourcebillcode(settlebillVO.getHeadVO().getVsettlebillcode());
            }
            bodyVOs[j].setVbillcode(null);
          }
        }
      }
      // 保存前处理
      dealBeforeCallIaSave(billVos);
      timer.addExecutePhase("dealBeforeCallIaSave()");

      // 拆分成两类：按暂估费用调整标志(since v55),分别调用存货核算不同接口方法
      BillVO[][] voa2Bill = getTwoTypeBillVos(billVos);
      timer.addExecutePhase("拆分成两类：按暂估费用调整标志");

      // 调用IA保存
      IIAToPU myService = (IIAToPU) NCLocator.getInstance().lookup(IIAToPU.class.getName());
      ClientLink client = PuUtils.getClintLink(strLoginCorpId, cOperator,dCurrDate);
      // 调用货物接口
      myService.settlePU(voa2Bill[0], client);
      // 调用费用接口
      if (voa2Bill.length > 1) {
        myService.settlePUFeiYong(voa2Bill[1], client);
      }
      //
      timer.addExecutePhase("调用IA保存<存货核算接口>");

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      PubDMO.throwBusinessException(e);
    }
    timer.showAllExecutePhase("SettleImpl.saveBillFromOutter1()-总时间");
  }

  /*
   * 将要保存的存货核算VO数组拆分成两类： 按暂估费用调整标志(since v55) 1)、货物类；2)、费用类 分别调用存货核算不同接口方法
   */
  private BillVO[][] getTwoTypeBillVos(BillVO[] billVos) {
    ArrayList<BillVO> listInv = new ArrayList<BillVO>();
    ArrayList<BillVO> listFee = new ArrayList<BillVO>();
    IBillHeaderVO header = null;
    for (BillVO bill : billVos) {
      // 如果没特殊处理过，则认为是货物单据
      if (!(bill.getParentVO() instanceof IBillHeaderVO)) {
        listInv.add(bill);
        continue;
      }
      header = (IBillHeaderVO) bill.getParentVO();
      if (header.getBEstFeeBill().booleanValue()) {
        listFee.add(bill);
        continue;
      }
      listInv.add(bill);
    }
    //
    BillVO[][] voa2Bill = new BillVO[2][];
    voa2Bill[0] = listInv.toArray(new BillVO[listInv.size()]);
    voa2Bill[1] = listFee.toArray(new BillVO[listFee.size()]);
    //
    return voa2Bill;
  }

  /*
   * 针对暂估的尾差处理
   */
  private void dealBillVosForCrack(GeneralHItemVO[] generalHItemVOs,
      BillVO[] billVOs, String sEstMode) throws BusinessException {
    Hashtable tZG = new Hashtable();
    Vector vTemp = new Vector();
    if (generalHItemVOs != null && generalHItemVOs.length > 0) {
      for (int i = 0; i < generalHItemVOs.length; i++) {
        if (generalHItemVOs[i].getBzgflag() != null
            && generalHItemVOs[i].getBzgflag().booleanValue()
            && !vTemp.contains(generalHItemVOs[i].getCgeneralbid())) {
          vTemp.addElement(generalHItemVOs[i].getCgeneralbid());
        }
      }
    }
    if (vTemp.size() > 0) {
      String cgeneralbid[] = new String[vTemp.size()];
      vTemp.copyInto(cgeneralbid);
      try {
        tZG = new SettleDMO().queryStockZGInfo(cgeneralbid);
      }
      catch (Exception e) {
        PubDMO.throwBusinessException(e);
      }
    }
    if (tZG.size() > 0) {
      if (sEstMode.equals("单到回冲"))
        billVOs = crackBillDDHC(tZG, billVOs);
      else
        billVOs = crackBillDDBC(tZG, billVOs);
    }
    if (billVOs == null || billVOs.length == 0) {
      return;
    }
  }

  /**
   * 功能描述:直运业务类型结算时向存货核算系统传送数据 作者：熊海情
   * <p>
   * 修改：晁志平 For V30 直运销售采购不向存货核算传辅信息,原因：
   * <p>
   * 1)、直运销售采购由于发票上不记录辅计量
   * <p>
   * 2)、存货在发票维护可修改为与订单不一致
   * <p>
   * 3)、修改存货后的发票仍然回写订单
   * <p>
   * 4)、结算时向存货核算传递的存货是发票的存货
   * 
   * @since v502,支持单价精度处理，by czp
   */
  private void saveBillFromOutterForDirect(IinvoiceVO invoiceVO[],
      String sStoreOrgID[], UFDate currDate, SettlebillVO settlebillVO,
      String cOperator, String strLoginCorpId) throws BusinessException {

    // IIAToPUBill myService = null;
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    // 单价精度
    int iPriceDigit = 2;
    // 换算率精度
    int iChgRateDigit = 2;
    // 辅数量精度
    int iAssNumDigit = 2;
    try {
      ISysInitQry myServiceTemp = (ISysInitQry) NCLocator.getInstance().lookup(
          ISysInitQry.class.getName());
      // 单价精度参数
      iPriceDigit = myServiceTemp.getParaInt(strLoginCorpId, "BD505");
      // 换算率精度
      iChgRateDigit = myServiceTemp.getParaInt(strLoginCorpId, "BD503");
      // 辅数量精度
      iAssNumDigit = myServiceTemp.getParaInt(strLoginCorpId, "BD502");
      //
      SettlebillItemVO VO[] = settlebillVO.getBodyVO();
      Vector v0 = new Vector();
      BillVO billVO = null;
      for (int i = 0; i < VO.length; i++) {
        String s1 = VO[i].getCinvoiceid();
        String s2 = VO[i].getCinvoice_bid();
        if (s1 != null && s1.length() > 0 && s2 != null && s2.length() > 0) {
          billVO = transferIADataForDirect(invoiceVO[i], sStoreOrgID[i],
              currDate, VO[i], cOperator, iPriceDigit, iChgRateDigit,
              iAssNumDigit);
          if (billVO == null) {
            continue;
          }
          v0.addElement(billVO);
        }
      }
      timer.addExecutePhase("VO对照操作");
      if (v0 == null || v0.size() == 0) {
        return;
      }
      BillVO billVOs[] = new BillVO[v0.size()];
      v0.copyInto(billVOs);
      // 对存货核算单进行处理: 相同表头的单据组合成一张单据
      // (1) 存货核算单据来源单据头ID唯一性组合
      Vector v = new Vector();
      Vector vTemp0 = new Vector();
      v.addElement(billVOs[0]);
      vTemp0.addElement(((IBillHeaderVO) billVOs[0].getParentVO()).getCbillid()
          .trim());
      for (int i = 1; i < billVOs.length; i++) {
        String s1 = ((IBillHeaderVO) billVOs[i].getParentVO()).getCbillid()
            .trim();
        if (!vTemp0.contains(s1)) {
          vTemp0.addElement(s1);
          v.addElement(billVOs[i]);
        }
      }
      timer.addExecutePhase("(1) 存货核算单据来源单据头ID唯一性组合");
      // (3) 所有存货核算单据体的来源单据头ID相同, 归为同一张存货核算单据
      Vector vv = new Vector();
      for (int i = 0; i < v.size(); i++) {
        BillVO tempVO = (BillVO) v.elementAt(i);
        String s1 = ((IBillHeaderVO) tempVO.getParentVO()).getCbillid().trim();
        Vector vTemp = new Vector();
        for (int j = 0; j < billVOs.length; j++) {
          String s2 = ((IBillHeaderVO) billVOs[j].getParentVO()).getCbillid()
              .trim();
          if (s1.equals(s2)) {
            IBillItemVO tempItemVO[] = (IBillItemVO[]) billVOs[j]
                .getChildrenVO();
            for (int k = 0; k < tempItemVO.length; k++)
              vTemp.addElement(tempItemVO[k]);
          }
        }
        IBillItemVO tempItemVOs[] = new IBillItemVO[vTemp.size()];
        vTemp.copyInto(tempItemVOs);
        // 重新设置表体行号
        for (int j = 0; j < tempItemVOs.length; j++) {
          tempItemVOs[j].setIrownumber(new Integer(j));
          if (tempItemVOs[j].getCsourcebilltypecode().equals("27"))
            tempItemVOs[j].setVsourcebillcode(settlebillVO.getHeadVO()
                .getVsettlebillcode());
        }
        tempVO.setChildrenVO(tempItemVOs);
        vv.addElement(tempVO);
      }
      timer.addExecutePhase("(3) 所有存货核算单据体的来源单据头ID相同, 归为同一张存货核算单据");
      // (4) 整理需向存货传送的单据
      billVOs = null;
      billVOs = new BillVO[vv.size()];
      vv.copyInto(billVOs);
      // 向存货传送数据
      if (billVOs == null || billVOs.length == 0)
        return;
      String s1 = ((IBillHeaderVO) billVOs[0].getParentVO())
          .getCsourcemodulename();
      String s2 = ((IBillItemVO[]) billVOs[0].getChildrenVO())[0]
          .getCsourcebilltypecode();
      //
      String sTime = (new UFDateTime(new Date())).toString();
      for (int i = 0; i < billVOs.length; i++) {
        ((IBillHeaderVO) billVOs[i].getParentVO()).setVbillcode(null);
        ((IBillHeaderVO) billVOs[i].getParentVO()).setTlastmaketime(sTime);
        ((IBillHeaderVO) billVOs[i].getParentVO()).setTmaketime(sTime);
        ((IBillHeaderVO) billVOs[i].getParentVO())
            .setClastoperatorid(cOperator);
        IBillItemVO bodyVO[] = (IBillItemVO[]) billVOs[i].getChildrenVO();
        if (bodyVO != null && bodyVO.length > 0) {
          for (int j = 0; j < bodyVO.length; j++)
            bodyVO[j].setVbillcode(null);
        }
      }
      // 保存前处理
      dealBeforeCallIaSave(billVOs);
      // 调用IA保存
      // myService = (IIAToPUBill)
      // NCLocator.getInstance().lookup(IIAToPUBill.class.getName());
      // myService.saveBillFromOutterArray(billVOs, s1, s2);
      IIAToPU myService = (IIAToPU) NCLocator.getInstance().lookup(
          IIAToPU.class.getName());
      myService.settlePU(billVOs, PuUtils.getClintLink(strLoginCorpId,
          cOperator, currDate));
      timer.addExecutePhase("向存货传送数据");

      timer.showAllExecutePhase("直运业务类型结算时向存货核算系统传送数据(明细)");
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
  }

  /**
   * <p>
   * 功能描述:费用单独结算时向存货核算系统传送数据
   * <p>
   * 作者：熊海情
   * <p>
   * 修改：晁志平 For V30
   * 
   * @V502效率优化, VO对照单个执行调整为批量执行，by czp , 2007-12-12
   * @修改 zhf
   * @修改说明 费用结算 支持暂估运费 支持多单据费用结算 追加形参 1>feeEstiMap 满足进行暂估费用调整的入库行和暂估费用金额
   *       2>m_bIsentercost 成本要素是否计入成本
   * @ 2008.11.28合并项目需求-200805071248590242-采购费用结算传递费用发票的供应商
   * @ V55 联调问题号:NCdp200609247测试人:tangmc,开发组长:czp
   */
  private void saveBillFromOutterForFee(String sDiffMode,
      SettlebillVO settlebillVO, HashMap<String, UFDouble> feeEstiMap,
      UFBoolean[] m_bIsentercost, String strLoginCorp, String cOperator,
      UFDate dCurrDate, String strEstiDealMode,String[] saVendorId) throws BusinessException {

    Timer timer = new Timer();
    timer.start();

    // 提高效率，批次获得入库单头/体信息
    SettlebillItemVO[] settleItemVos = settlebillVO.getBodyVO();
    GeneralHHeaderVO stockHeadVO[] = getStockHeadInfo(settleItemVos);

    SettleDMO dmo = null;
    try {
      dmo = new SettleDMO();
    }
    catch (Exception e) {
      // TODO 自动生成 catch 块
      // SCMEnv.out(e.getMessage());
      PubDMO.throwBusinessException(e);
    }

    timer.addExecutePhase("批次获得入库单头信息");
    GeneralHItemVO stockBodyVO[] = getStockBodyInfo(settleItemVos);
    timer.addExecutePhase("批次获得入库单体信息");
    if (stockHeadVO == null || stockHeadVO.length == 0) {
      return;
    }
    if (stockBodyVO == null || stockBodyVO.length == 0) {
      return;
    }
    // 入库单表头哈希表
    HashMap<String, GeneralHHeaderVO> mapEstStockHeaderVos = new HashMap<String, GeneralHHeaderVO>();
    for (GeneralHHeaderVO curHeaderVo : stockHeadVO) {
      mapEstStockHeaderVos.put(curHeaderVo.getPrimaryKey(), curHeaderVo);
    }
    // 入库单表体哈希表,入库单VO(VO对照备用)
    HashMap<String, GeneralHItemVO> mapEstStockBodyVos = new HashMap<String, GeneralHItemVO>();
    GeneralBillVO[] icVos = new GeneralBillVO[stockBodyVO.length];
    for (int i = 0; i < stockBodyVO.length; i++) {
      // 表体哈希表
      mapEstStockBodyVos.put(stockBodyVO[i].getPrimaryKey(), stockBodyVO[i]);
      // 入库单VO
      icVos[i] = switchVOFromGeneral2IC(mapEstStockHeaderVos.get(stockBodyVO[i]
          .getCgeneralhid()), stockBodyVO[i]);
    }
    // since v502 , 效率优化， 单个执行VO对照调整为批量对照
    BillVO[] billVOs0 = (BillVO[]) PfUtilTools.runChangeDataAry("45", "I2",
        icVos);
    BillItemVO item = null;
    HashMap<String, BillVO> mapBillVo = new HashMap<String, BillVO>();
    for (int i = 0; i < icVos.length; i++) {
      if (billVOs0[i] == null
          || billVOs0[i].getChildrenVO() == null
          || billVOs0[i].getChildrenVO().length == 0
          || billVOs0[i].getChildrenVO()[0] == null
          || billVOs0[i].getChildrenVO()[0].getAttributeValue("cicitemid") == null) {
        throw new BusinessException("Chg45toI2 Exception : cicitemid is null!");
      }
      item = (BillItemVO) billVOs0[i].getChildrenVO()[0];
      mapBillVo.put(item.getCicitemid(), billVOs0[i]);
    }
    timer
        .addExecutePhase("VO转换:PfUtilTools.runChangeDataAry(“45”, “I2”, icVOs)");
    //
    int iMnyDigit = getLocalCurMnyDigit(strLoginCorp);
    // since v53
    int iNumDigit = BsPuTool.getDigitBD501();
    //	
    Vector v0 = new Vector();
    BillVO billVO0 = null;

    HashMap<String, SettlebillItemVO> stockSettleMap = new HashMap<String, SettlebillItemVO>();// 入库行：结算单体
    // （货物行）
    Vector vFeeDet = new Vector();// 记录费用结算明细

    GeneralHHeaderVO estStockHeaderVo = null;
    for (int i = 0; i < settleItemVos.length; i++) {

      String stockID = settleItemVos[i].getCstockid();
      String stockRow = settleItemVos[i].getCstockrow();

      stockSettleMap.put(stockRow, settleItemVos[i]);
      // ---end

      if (stockID != null && stockID.length() > 0 && stockRow != null
          && stockRow.length() > 0) {
        billVO0 = mapBillVo.get(stockRow);
        estStockHeaderVo = mapEstStockHeaderVos.get(stockID);
        BillVO billVOs[] = transferIADataForFee(billVO0, estStockHeaderVo,
            m_bIsentercost, mapEstStockBodyVos.get(stockRow), sDiffMode,
            settleItemVos[i], cOperator, dCurrDate, estStockHeaderVo
                .getCstoreorganization(), iMnyDigit, iNumDigit, strEstiDealMode);
        if (billVOs == null || billVOs.length == 0) {
          continue;
        }
        for (int j = 0; j < billVOs.length; j++) {
          v0.addElement(billVOs[j]);
          // zhf add for v55 追加记录费用结算明细----费用结算明细表
          IBillItemVO itemVO[] = (IBillItemVO[]) billVOs[j].getChildrenVO();
          FeeDetailVO feeDetVo = null;
          for (IBillItemVO vo : itemVO) {
            feeDetVo = new FeeDetailVO();

            if (vo.getCicitemid().equals(vo.getCadjustbillitemid())) {
              feeDetVo.setVadjustbilltype(stockSettleMap.get(vo.getCicitemid())
                  .getVstockbilltype());
            }
            else {
              // feeDetVo.setCsettlebillid(vo.getCadjustbillid());
              // feeDetVo.setCsettlebill_bid(vo.getCadjustbillitemid());
              feeDetVo.setVadjustbilltype(ScmConst.PO_SettleBill);// --采购结算单
            }

            feeDetVo.setCsettlebillid(stockSettleMap.get(vo.getCicitemid())
                .getCsettlebillid());
            feeDetVo.setCsettlebill_bid(stockSettleMap.get(vo.getCicitemid())
                .getCsettlebill_bid());
            feeDetVo.setCadjustbillid(vo.getCadjustbillid());
            feeDetVo.setCadjustbillbid(vo.getCadjustbillitemid());
            vFeeDet.add(feeDetVo);
            // 如果是损益调整单，在费用结算明细表记录调整信息后按存货要求清空调整单的调整ID--zhf v55
            if ("损益".equals(sDiffMode.trim())) {
              vo.setCadjustbillid(null);
              vo.setCadjustbillitemid(null);
            }
          }

          // end
        }
      }
    }
    timer.addExecutePhase("VO对照后续处理");

    if (v0 == null || v0.size() == 0) {
      return;
    }
    BillVO billVOs[] = new BillVO[v0.size()];
    v0.copyInto(billVOs);

    // 支持费用暂估 针对暂估费用对调整金额 再一次进行调整 zhf for v55
    billVOs = adjustBillVOForFee(billVOs, stockSettleMap, feeEstiMap, iMnyDigit);
    // end
    if (billVOs == null || billVOs.length == 0)
      return;

    // 跨公司转换
    if (!stockHeadVO[0].getCbilltypecode().equalsIgnoreCase(//调拨入库单的费用结算不用处理跨公司转换
        ScmConst.m_allocationIn)) {
      billVOs = dmo.postDealBillVO(settlebillVO.getHeadVO().getPk_corp(),
          stockBodyVO, billVOs);
      if (billVOs == null || billVOs.length == 0) {
        return;
      }
    }   

    // 对存货核算单进行处理: 相同表头的单据组合成一张单据
    // (1) 存货核算单据来源单据头ID唯一性组合
    Vector v = new Vector();
    Vector vTemp0 = new Vector();
    v.addElement(billVOs[0]);
    vTemp0.addElement(((IBillHeaderVO) billVOs[0].getParentVO()).getCbillid()
        .trim());
    for (int i = 1; i < billVOs.length; i++) {
      String s1 = ((IBillHeaderVO) billVOs[i].getParentVO()).getCbillid()
          .trim();
      if (!vTemp0.contains(s1)) {
        vTemp0.addElement(s1);
        v.addElement(billVOs[i]);
      }
    }
    timer.addExecutePhase("(1) 存货核算单据来源单据头ID唯一性组合");

    // (3) 所有存货核算单据体的来源单据头ID相同, 归为同一张存货核算单据
    Vector vv = new Vector();
    for (int i = 0; i < v.size(); i++) {
      BillVO tempVO = (BillVO) v.elementAt(i);
      String s1 = ((IBillHeaderVO) tempVO.getParentVO()).getCbillid().trim();
      Vector vTemp = new Vector();
      for (int j = 0; j < billVOs.length; j++) {
        String s2 = ((IBillHeaderVO) billVOs[j].getParentVO()).getCbillid()
            .trim();
        if (s1.equals(s2)) {
          IBillItemVO tempItemVO[] = (IBillItemVO[]) billVOs[j].getChildrenVO();
          for (int k = 0; k < tempItemVO.length; k++) {
            vTemp.addElement(tempItemVO[k]);
          }
        }
      }
      IBillItemVO tempItemVOs[] = new IBillItemVO[vTemp.size()];
      vTemp.copyInto(tempItemVOs);
      // 重新设置表体行号
      for (int j = 0; j < tempItemVOs.length; j++) {
        tempItemVOs[j].setIrownumber(new Integer(j));
        if (tempItemVOs[j].getCsourcebilltypecode().equals("27"))
          tempItemVOs[j].setVsourcebillcode(settlebillVO.getHeadVO()
              .getVsettlebillcode());
      }
      tempVO.setChildrenVO(tempItemVOs);
      vv.addElement(tempVO);
    }
    timer.addExecutePhase("(3) 所有存货核算单据体的来源单据头ID相同, 归为同一张存货核算单据");

    // (4) 整理需向存货传送的单据
    billVOs = null;
    billVOs = new BillVO[vv.size()];
    vv.copyInto(billVOs);
    if (billVOs == null || billVOs.length == 0)
      return;
    String s1 = ((IBillHeaderVO) billVOs[0].getParentVO())
        .getCsourcemodulename();
    String s2 = ((IBillItemVO[]) billVOs[0].getChildrenVO())[0]
        .getCsourcebilltypecode();
    //
    String sTime = (new UFDateTime(new Date())).toString();
    for (int i = 0; i < billVOs.length; i++) {
      //合并项目(V5011)需求：支持费用结算时，向存货核算传递费用发票供应商，不传递入库单供应商
      if(saVendorId != null){
        if("I9".equalsIgnoreCase(((IBillHeaderVO) billVOs[i].getParentVO()).getCbilltypecode())){
          ((IBillHeaderVO) billVOs[i].getParentVO()).setCcustombasid(saVendorId[0]);
          ((IBillHeaderVO) billVOs[i].getParentVO()).setCcustomvendorid(saVendorId[1]);
        }
      }
      ((IBillHeaderVO) billVOs[i].getParentVO()).setVbillcode(null);
      ((IBillHeaderVO) billVOs[i].getParentVO()).setTlastmaketime(sTime);
      ((IBillHeaderVO) billVOs[i].getParentVO()).setTmaketime(sTime);
      ((IBillHeaderVO) billVOs[i].getParentVO()).setClastoperatorid(cOperator);
      IBillItemVO bodyVO[] = (IBillItemVO[]) billVOs[i].getChildrenVO();
      if (bodyVO != null && bodyVO.length > 0) {
        for (int j = 0; j < bodyVO.length; j++) {
          bodyVO[j].setVbillcode(null);
          //将期初的单子调整信息清空
          String sourceType=bodyVO[j].getCicbilltype();
          if(ScmConst.m_purchaseInit.equals(sourceType)){
            bodyVO[j].setCadjustbillid(null);
            bodyVO[j].setCadjustbillitemid(null);
            bodyVO[j].setNadjustnum(null);
          }
        }
      }
    }
    // 保存前处理
    dealBeforeCallIaSave(billVOs);
    timer.addExecutePhase("保存前处理");

    // 调用IA保存
    IIAToPU myService = (IIAToPU) NCLocator.getInstance().lookup(
        IIAToPU.class.getName());
    // myService.saveBillFromOutterArray(billVOs, s1, s2);
    myService.settlePUFeiYong(billVOs, PuUtils.getClintLink(strLoginCorp,
        cOperator, dCurrDate));
    timer.addExecutePhase("(4) 整理并向存货传送的单据");
    // 记录费用结算明细
    if (vFeeDet != null && vFeeDet.size() > 0) {// -
      FeeDetailVO[] feeDetVos = new FeeDetailVO[vFeeDet.size()];
      vFeeDet.copyInto(feeDetVos);

      try {
        // SettleDMO dmo = new SettleDMO();
        dmo.insertFeeDetail(feeDetVos, strLoginCorp);
      }
      catch (Exception e) {
        SCMEnv.out(e);
        PubDMO.throwBusinessException(e);
      }
    }

    timer.showAllExecutePhase("费用单独结算时向存货核算系统传送数据--明细");
  }

  /**
   * 对进行了费用暂估且第一次进行暂估费用结算的入库行进行暂估费用调整 同时 回写 结算单行该暂估费用已调整标志位
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * 
   * @param billVOs
   *          本次费用结算传存货单据
   * @param stockSettleMap
   *          stockrow:SettleBillitemVO
   * @param feeEstiMap
   *          满足进行暂估费用调整的入库行和暂估费用金额
   * @param iMnyDigit
   * @throws BusinessException
   *           <p>
   * @author zhanghongfang
   * @time 2008-7-29 下午06:30:52
   */
  public BillVO[] adjustBillVOForFee(BillVO[] billVOs,
      HashMap<String, SettlebillItemVO> stockSettleMap,
      HashMap<String, UFDouble> feeEstiMap, int iMnyDigit)
      throws BusinessException {
    ArrayList<String> list = new ArrayList<String>();// 暂存进行了暂估费用调整的入库行id
    ArrayList<BillVO> billList = new ArrayList<BillVO>();
    IBillItemVO[] itemVos = null;
    String icitemid = null;
    for (int i = 0; i < billVOs.length; i++) {
      itemVos = (IBillItemVO[]) billVOs[i].getChildrenVO();
      for (int j = 0; j < itemVos.length; j++) {
        icitemid = itemVos[j].getCicitemid();
        if (feeEstiMap.containsKey(icitemid)) {
          if (list.contains(icitemid))
            continue;
          UFDouble nadjustmny = itemVos[j].getNmoney().sub(
              feeEstiMap.get(icitemid), iMnyDigit);
          itemVos[j].setNmoney(nadjustmny);
          list.add(icitemid);
        }
      }
      // 如果调整金额为0不传存货核算
      if (itemVos[0].getNmoney() != null
          && Math.abs(itemVos[0].getNmoney().doubleValue()) > 0.0) {
        billList.add(billVOs[i]);
      }
    }
    // 回写结算单体 运费是否第一次费用结算 标志位

    if (list != null && list.size() > 0) {
      ArrayList<String> settleList = new ArrayList<String>();
      String s = null;
      for (int i = 0; i < list.size(); i++) {
        s = stockSettleMap.get(list.get(i)).getCsettlebill_bid();
        if (s != null)
          settleList.add(s);
      }
      if (settleList != null && settleList.size() > 0) {
        try {
          new SettleDMO().updateYfFirstSettle(settleList, true);
        }
        catch (Exception e) {
          // SCMEnv.out(e);
          PubDMO.throwBusinessException(e);
        }
      }
    }
    if (billList != null && billList.size() > 0) {
      return billList.toArray(new BillVO[0]);
    }
    else {
      return null;
    }
  }

  /**
   * 功能描述:入库单VO，结算单体VO转化为标准入库单VO 日期:2002/05/27 作者：熊海情 修改：晁志平 For V30
   */
  private GeneralBillVO[] transferARAPDataNone(StockVO VOs[],
      SettlebillItemVO settlebillVOs[], String cOperator, UFDate dCurrDate)
      throws BusinessException {
    Vector vTemp = new Vector();
    Vector vTemp0 = new Vector();
    // 查询入库单的来源及上层来源
    for (int i = 0; i < VOs.length; i++) {
      vTemp.addElement(VOs[i].getCgeneralbid());
      vTemp0.addElement(VOs[i].getCgeneralhid());
    }
    String sKeys[] = new String[vTemp.size()];
    vTemp.copyInto(sKeys);
    String sKeys0[] = new String[vTemp0.size()];
    vTemp0.copyInto(sKeys0);
    GeneralHItemVO itemVO[] = null;
    GeneralHHeaderVO headerVO[] = null;

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    try {
      nc.bs.ps.estimate.EstimateDMO dmo = new nc.bs.ps.estimate.EstimateDMO();
      itemVO = dmo.queryStockBodyForIA(sKeys);
      timer.addExecutePhase("查询入库单表体");
      headerVO = dmo.queryStockHeadForIA(sKeys0);
      timer.addExecutePhase("查询入库单表头");
    }
    catch (Exception e) {
      /* 不影响业务操作，此异常不必抛出 */
      SCMEnv.out(e);
      return null;
    }
    if (itemVO == null || itemVO.length == 0)
      return null;
    if (headerVO == null || headerVO.length == 0)
      return null;
    vTemp = new Vector();
    for (int i = 0; i < VOs.length; i++) {
      // 赠品行不传应付
      if (VOs[i].getFlargess() != null && VOs[i].getFlargess().booleanValue())
        continue;

      // 标准入库单表头
      GeneralBillHeaderVO headVO = new GeneralBillHeaderVO();
      // 传递表头备注
      headVO.setVnote(headerVO[0].getVnote());
      //
      headVO.setCgeneralhid(VOs[i].getCgeneralhid());
      headVO.setCbiztypeid(VOs[i].getCbiztype());
      headVO.setCproviderid(VOs[i].getCprovidermangid());
      headVO.setPk_corp(VOs[i].getPk_corp());
      headVO.setDbilldate(dCurrDate);
      headVO.setCoperatorid(cOperator);
      headVO.setCbilltypecode(VOs[i].getCbilltype());

      headVO.setVuserdef1(headerVO[0].getVuserdef1());
      headVO.setVuserdef2(headerVO[0].getVuserdef2());
      headVO.setVuserdef3(headerVO[0].getVuserdef3());
      headVO.setVuserdef4(headerVO[0].getVuserdef4());
      headVO.setVuserdef5(headerVO[0].getVuserdef5());
      headVO.setVuserdef6(headerVO[0].getVuserdef6());
      headVO.setVuserdef7(headerVO[0].getVuserdef7());
      headVO.setVuserdef8(headerVO[0].getVuserdef8());
      headVO.setVuserdef9(headerVO[0].getVuserdef9());
      headVO.setVuserdef10(headerVO[0].getVuserdef10());

      headVO.setAttributeValue("vuserdef11", headerVO[0].getVuserdef11());
      headVO.setAttributeValue("vuserdef12", headerVO[0].getVuserdef12());
      headVO.setAttributeValue("vuserdef13", headerVO[0].getVuserdef13());
      headVO.setAttributeValue("vuserdef14", headerVO[0].getVuserdef14());
      headVO.setAttributeValue("vuserdef15", headerVO[0].getVuserdef15());
      headVO.setAttributeValue("vuserdef16", headerVO[0].getVuserdef16());
      headVO.setAttributeValue("vuserdef17", headerVO[0].getVuserdef17());
      headVO.setAttributeValue("vuserdef18", headerVO[0].getVuserdef18());
      headVO.setAttributeValue("vuserdef19", headerVO[0].getVuserdef19());
      headVO.setAttributeValue("vuserdef20", headerVO[0].getVuserdef20());

      headVO.setAttributeValue("pk_defdoc1", headerVO[0].getPk_defdoc1());
      headVO.setAttributeValue("pk_defdoc2", headerVO[0].getPk_defdoc2());
      headVO.setAttributeValue("pk_defdoc3", headerVO[0].getPk_defdoc3());
      headVO.setAttributeValue("pk_defdoc4", headerVO[0].getPk_defdoc4());
      headVO.setAttributeValue("pk_defdoc5", headerVO[0].getPk_defdoc5());
      headVO.setAttributeValue("pk_defdoc6", headerVO[0].getPk_defdoc6());
      headVO.setAttributeValue("pk_defdoc7", headerVO[0].getPk_defdoc7());
      headVO.setAttributeValue("pk_defdoc8", headerVO[0].getPk_defdoc8());
      headVO.setAttributeValue("pk_defdoc9", headerVO[0].getPk_defdoc9());
      headVO.setAttributeValue("pk_defdoc10", headerVO[0].getPk_defdoc10());

      headVO.setAttributeValue("pk_defdoc11", headerVO[0].getPk_defdoc11());
      headVO.setAttributeValue("pk_defdoc12", headerVO[0].getPk_defdoc12());
      headVO.setAttributeValue("pk_defdoc13", headerVO[0].getPk_defdoc13());
      headVO.setAttributeValue("pk_defdoc14", headerVO[0].getPk_defdoc14());
      headVO.setAttributeValue("pk_defdoc15", headerVO[0].getPk_defdoc15());
      headVO.setAttributeValue("pk_defdoc16", headerVO[0].getPk_defdoc16());
      headVO.setAttributeValue("pk_defdoc17", headerVO[0].getPk_defdoc17());
      headVO.setAttributeValue("pk_defdoc18", headerVO[0].getPk_defdoc18());
      headVO.setAttributeValue("pk_defdoc19", headerVO[0].getPk_defdoc19());
      headVO.setAttributeValue("pk_defdoc20", headerVO[0].getPk_defdoc20());

      headVO.setCdptid(VOs[i].getCdeptid());
      headVO.setCbizid(VOs[i].getCbizid());

      // 标准入库单体
      GeneralBillItemVO bodyVO = new GeneralBillItemVO();
      bodyVO.setCgeneralhid(VOs[i].getCgeneralhid());
      bodyVO.setCgeneralbid(VOs[i].getCgeneralbid());
      bodyVO.setCinventoryid(VOs[i].getCmangid());
      bodyVO.setNinnum(settlebillVOs[i].getNsettlenum());
      bodyVO.setNprice(settlebillVOs[i].getNprice());
      bodyVO.setNmny(settlebillVOs[i].getNmoney());
      bodyVO.setCsourcetype(itemVO[i].getCsourcetype());
      bodyVO.setCsourcebillhid(itemVO[i].getCsourcebillhid());
      bodyVO.setCsourcebillbid(itemVO[i].getCsourcebillbid());
      bodyVO.setCfirsttype(itemVO[i].getCfirsttype());
      bodyVO.setCfirstbillhid(itemVO[i].getCfirstbillhid());
      bodyVO.setCfirstbillbid(itemVO[i].getCfirstbillbid());
      bodyVO.setCprojectid(itemVO[i].getCprojectid());
      bodyVO.setCprojectphaseid(itemVO[i].getCprojectphaseid());

      bodyVO.setVuserdef1(itemVO[i].getVuserdef1());
      bodyVO.setVuserdef2(itemVO[i].getVuserdef2());
      bodyVO.setVuserdef3(itemVO[i].getVuserdef3());
      bodyVO.setVuserdef4(itemVO[i].getVuserdef4());
      bodyVO.setVuserdef5(itemVO[i].getVuserdef5());
      bodyVO.setVuserdef6(itemVO[i].getVuserdef6());
      bodyVO.setVuserdef7(itemVO[i].getVuserdef7());
      bodyVO.setVuserdef8(itemVO[i].getVuserdef8());
      bodyVO.setVuserdef9(itemVO[i].getVuserdef9());
      bodyVO.setVuserdef10(itemVO[i].getVuserdef10());

      bodyVO.setAttributeValue("vuserdef11", itemVO[i].getVuserdef11());
      bodyVO.setAttributeValue("vuserdef12", itemVO[i].getVuserdef12());
      bodyVO.setAttributeValue("vuserdef13", itemVO[i].getVuserdef13());
      bodyVO.setAttributeValue("vuserdef14", itemVO[i].getVuserdef14());
      bodyVO.setAttributeValue("vuserdef15", itemVO[i].getVuserdef15());
      bodyVO.setAttributeValue("vuserdef16", itemVO[i].getVuserdef16());
      bodyVO.setAttributeValue("vuserdef17", itemVO[i].getVuserdef17());
      bodyVO.setAttributeValue("vuserdef18", itemVO[i].getVuserdef18());
      bodyVO.setAttributeValue("vuserdef19", itemVO[i].getVuserdef19());
      bodyVO.setAttributeValue("vuserdef20", itemVO[i].getVuserdef20());

      bodyVO.setAttributeValue("pk_defdoc1", itemVO[i].getPk_defdoc1());
      bodyVO.setAttributeValue("pk_defdoc2", itemVO[i].getPk_defdoc2());
      bodyVO.setAttributeValue("pk_defdoc3", itemVO[i].getPk_defdoc3());
      bodyVO.setAttributeValue("pk_defdoc4", itemVO[i].getPk_defdoc4());
      bodyVO.setAttributeValue("pk_defdoc5", itemVO[i].getPk_defdoc5());
      bodyVO.setAttributeValue("pk_defdoc6", itemVO[i].getPk_defdoc6());
      bodyVO.setAttributeValue("pk_defdoc7", itemVO[i].getPk_defdoc7());
      bodyVO.setAttributeValue("pk_defdoc8", itemVO[i].getPk_defdoc8());
      bodyVO.setAttributeValue("pk_defdoc9", itemVO[i].getPk_defdoc9());
      bodyVO.setAttributeValue("pk_defdoc10", itemVO[i].getPk_defdoc10());

      bodyVO.setAttributeValue("pk_defdoc11", itemVO[i].getPk_defdoc11());
      bodyVO.setAttributeValue("pk_defdoc12", itemVO[i].getPk_defdoc12());
      bodyVO.setAttributeValue("pk_defdoc13", itemVO[i].getPk_defdoc13());
      bodyVO.setAttributeValue("pk_defdoc14", itemVO[i].getPk_defdoc14());
      bodyVO.setAttributeValue("pk_defdoc15", itemVO[i].getPk_defdoc15());
      bodyVO.setAttributeValue("pk_defdoc16", itemVO[i].getPk_defdoc16());
      bodyVO.setAttributeValue("pk_defdoc17", itemVO[i].getPk_defdoc17());
      bodyVO.setAttributeValue("pk_defdoc18", itemVO[i].getPk_defdoc18());
      bodyVO.setAttributeValue("pk_defdoc19", itemVO[i].getPk_defdoc19());
      bodyVO.setAttributeValue("pk_defdoc20", itemVO[i].getPk_defdoc20());

      bodyVO.setDbizdate(itemVO[i].getDbizdate());
      GeneralBillVO VO = new GeneralBillVO();
      VO.setParentVO(headVO);
      VO.setChildrenVO(new GeneralBillItemVO[] {
        bodyVO
      });
      if (bodyVO.getNprice() != null
          && Math.abs(bodyVO.getNprice().doubleValue()) > 0)
        vTemp.addElement(VO);
    }
    timer.addExecutePhase("VO对照");

    timer.showAllExecutePhase("入库单VO，结算单体VO转化为标准入库单VO(明细)");

    if (vTemp.size() > 0) {
      GeneralBillVO tempVOs[] = new GeneralBillVO[vTemp.size()];
      vTemp.copyInto(tempVOs);
      return tempVOs;
    }
    return null;
  }

  /*
   * IinvoiceVO-->InvoiceVO 2007-03-21 xhq
   */
  private InvoiceVO switchVOForDirectInvSettle(IinvoiceVO invVO) {
    InvoiceHeaderVO headVO = new InvoiceHeaderVO();

    headVO.setPk_corp(invVO.getPk_corp());
    headVO.setVinvoicecode(invVO.getVinvoicecode());
    headVO.setCbiztype(invVO.getCbiztype());
    headVO.setCdeptid(invVO.getCdeptid());
    headVO.setCvendorbaseid(invVO.getCvendorbaseid());
    headVO.setCvendormangid(invVO.getCvendormangid());
    headVO.setCstoreorganization(invVO.getPk_calbody());

    headVO.setVdef1(invVO.getVhdef1());
    headVO.setVdef2(invVO.getVhdef2());
    headVO.setVdef3(invVO.getVhdef3());
    headVO.setVdef4(invVO.getVhdef4());
    headVO.setVdef5(invVO.getVhdef5());
    headVO.setVdef6(invVO.getVhdef6());
    headVO.setVdef7(invVO.getVhdef7());
    headVO.setVdef8(invVO.getVhdef8());
    headVO.setVdef9(invVO.getVhdef9());
    headVO.setVdef10(invVO.getVhdef10());

    headVO.setVdef11(invVO.getVhdef11());
    headVO.setVdef12(invVO.getVhdef12());
    headVO.setVdef13(invVO.getVhdef13());
    headVO.setVdef14(invVO.getVhdef14());
    headVO.setVdef15(invVO.getVhdef15());
    headVO.setVdef16(invVO.getVhdef16());
    headVO.setVdef17(invVO.getVhdef17());
    headVO.setVdef18(invVO.getVhdef18());
    headVO.setVdef19(invVO.getVhdef19());
    headVO.setVdef20(invVO.getVhdef20());

    headVO.setPKDefDoc1(invVO.getPk_defdoch1());
    headVO.setPKDefDoc2(invVO.getPk_defdoch2());
    headVO.setPKDefDoc3(invVO.getPk_defdoch3());
    headVO.setPKDefDoc4(invVO.getPk_defdoch4());
    headVO.setPKDefDoc5(invVO.getPk_defdoch5());
    headVO.setPKDefDoc6(invVO.getPk_defdoch6());
    headVO.setPKDefDoc7(invVO.getPk_defdoch7());
    headVO.setPKDefDoc8(invVO.getPk_defdoch8());
    headVO.setPKDefDoc9(invVO.getPk_defdoch9());
    headVO.setPKDefDoc10(invVO.getPk_defdoch10());

    headVO.setPKDefDoc11(invVO.getPk_defdoch11());
    headVO.setPKDefDoc12(invVO.getPk_defdoch12());
    headVO.setPKDefDoc13(invVO.getPk_defdoch13());
    headVO.setPKDefDoc14(invVO.getPk_defdoch14());
    headVO.setPKDefDoc15(invVO.getPk_defdoch15());
    headVO.setPKDefDoc16(invVO.getPk_defdoch16());
    headVO.setPKDefDoc17(invVO.getPk_defdoch17());
    headVO.setPKDefDoc18(invVO.getPk_defdoch18());
    headVO.setPKDefDoc19(invVO.getPk_defdoch19());
    headVO.setPKDefDoc20(invVO.getPk_defdoch20());

    InvoiceItemVO bodyVO = new InvoiceItemVO();

    // since v502
    bodyVO.setCorder_bid(invVO.getCorder_bid());
    bodyVO.setCorderid(invVO.getCorderid());
    bodyVO.setCupsourcebillid(invVO.getCupsourcebillid());
    bodyVO.setCupsourcebillrowid(invVO.getCupsourcebillrowid());
    bodyVO.setCupsourcebilltype(invVO.getCupsourcebilltype());
    //

    bodyVO.setPk_corp(invVO.getPk_corp());
    bodyVO.setCmangid(invVO.getCmangid());
    bodyVO.setCbaseid(invVO.getCbaseid());
    bodyVO.setVproducenum(invVO.getVbatchcode());
    bodyVO.setCprojectid(invVO.getCprojectid());
    bodyVO.setCprojectphaseid(invVO.getCprojectphaseid());

    bodyVO.setVfree1(invVO.getVfree1());
    bodyVO.setVfree2(invVO.getVfree2());
    bodyVO.setVfree3(invVO.getVfree3());
    bodyVO.setVfree4(invVO.getVfree4());
    bodyVO.setVfree5(invVO.getVfree5());

    bodyVO.setVdef1(invVO.getVbdef1());
    bodyVO.setVdef2(invVO.getVbdef2());
    bodyVO.setVdef3(invVO.getVbdef3());
    bodyVO.setVdef4(invVO.getVbdef4());
    bodyVO.setVdef5(invVO.getVbdef5());
    bodyVO.setVdef6(invVO.getVbdef6());
    bodyVO.setVdef7(invVO.getVbdef7());
    bodyVO.setVdef8(invVO.getVbdef8());
    bodyVO.setVdef9(invVO.getVbdef9());
    bodyVO.setVdef10(invVO.getVbdef10());

    bodyVO.setVdef11(invVO.getVbdef11());
    bodyVO.setVdef12(invVO.getVbdef12());
    bodyVO.setVdef13(invVO.getVbdef13());
    bodyVO.setVdef14(invVO.getVbdef14());
    bodyVO.setVdef15(invVO.getVbdef15());
    bodyVO.setVdef16(invVO.getVbdef16());
    bodyVO.setVdef17(invVO.getVbdef17());
    bodyVO.setVdef18(invVO.getVbdef18());
    bodyVO.setVdef19(invVO.getVbdef19());
    bodyVO.setVdef20(invVO.getVbdef20());

    bodyVO.setPKDefDoc1(invVO.getPk_defdocb1());
    bodyVO.setPKDefDoc2(invVO.getPk_defdocb2());
    bodyVO.setPKDefDoc3(invVO.getPk_defdocb3());
    bodyVO.setPKDefDoc4(invVO.getPk_defdocb4());
    bodyVO.setPKDefDoc5(invVO.getPk_defdocb5());
    bodyVO.setPKDefDoc6(invVO.getPk_defdocb6());
    bodyVO.setPKDefDoc7(invVO.getPk_defdocb7());
    bodyVO.setPKDefDoc8(invVO.getPk_defdocb8());
    bodyVO.setPKDefDoc9(invVO.getPk_defdocb9());
    bodyVO.setPKDefDoc10(invVO.getPk_defdocb10());

    bodyVO.setPKDefDoc11(invVO.getPk_defdocb11());
    bodyVO.setPKDefDoc12(invVO.getPk_defdocb12());
    bodyVO.setPKDefDoc13(invVO.getPk_defdocb13());
    bodyVO.setPKDefDoc14(invVO.getPk_defdocb14());
    bodyVO.setPKDefDoc15(invVO.getPk_defdocb15());
    bodyVO.setPKDefDoc16(invVO.getPk_defdocb16());
    bodyVO.setPKDefDoc17(invVO.getPk_defdocb17());
    bodyVO.setPKDefDoc18(invVO.getPk_defdocb18());
    bodyVO.setPKDefDoc19(invVO.getPk_defdocb19());
    bodyVO.setPKDefDoc20(invVO.getPk_defdocb20());

    // since v55
    bodyVO.setCinvoice_bid(invVO.getCinvoice_bid());
    bodyVO.setCinvoiceid(invVO.getCinvoiceid());
    //
    InvoiceVO VO = new InvoiceVO(1);
    VO.setParentVO(headVO);
    VO.setChildrenVO(new InvoiceItemVO[] {
      bodyVO
    });
    return VO;
  }

  /**
   * 功能描述:向存货核算系统传递数据。（服务于直运业务类型结算） 输入参数:发票VO,库存组织ID,辅计量ID,当前日期,结算单体VO,当前操作员
   * 作者：熊海情 修改：晁志平 For V30
   * 
   * @sinve v502, 支持单价精度处理 , by czp
   */
  private BillVO transferIADataForDirect(IinvoiceVO invoiceVO,
      String cStoreOrgID, UFDate currDate, SettlebillItemVO VO,
      String cOperator, int iPriceDigit, int iChgRateDigit, int iAssNumDigit)
      throws BusinessException {
    BillVO billVO = null;
    try {
      // VO转换
      InvoiceVO invVO = switchVOForDirectInvSettle(invoiceVO);
      billVO = (BillVO) PfUtilTools.runChangeData("25", "I2", invVO);
      if (billVO == null)
        return null;
      // 取得HASHMAP{发票行ID=[订单行ID，订单头ID]}
      HashMap<String, ArrayList<String>> mapBidOrderIds = new HashMap<String, ArrayList<String>>();
      InvoiceItemVO[] items = invVO.getBodyVO();
      ArrayList<String> listBids = null;
      if (items != null && items.length > 0) {
        for (InvoiceItemVO item : items) {
          if (item == null || item.getCinvoice_bid() == null
              || item.getCorder_bid() == null || item.getCorderid() == null) {
            continue;
          }
          listBids = new ArrayList<String>();
          listBids.add(item.getCorder_bid());
          listBids.add(item.getCorderid());
          mapBidOrderIds.put(item.getCinvoice_bid(), listBids);
        }
      }
      // 取得订单的辅计量ID及主数量、辅数量
      int iBodyLen = invVO.getBodyLen();
      String[] saBid = new String[iBodyLen];
      for (int i = 0; i < iBodyLen; i++) {
        saBid[i] = invVO.getBodyVO()[i].getCorder_bid();
      }
      PubDMO dmoPuPub = new PubDMO();
      HashMap mapBid = dmoPuPub.queryArrayValues("po_order_b", "corder_bid",
          new String[] {
              "cassistunit", "nordernum", "nassistnum"
          }, saBid, "po_order_b.dr=0");
      Object[] oaOrderInfoes = null;
      UFDouble ufdHsl = null;
      /*
       * //结算时的存货：非劳务，非折扣 if (mapBid != null){ s3 = (Object[])
       * mapBid.get("corder_bid"); if (s3 == null) { } if
       * (s3[0].toString().equals("Y") || s3[1].toString().equals("Y")) {
       * continue; }
       */

      nc.bs.ps.estimate.EstimateDMO dmo = new nc.bs.ps.estimate.EstimateDMO();

      UFDouble nSettleNum = VO.getNsettlenum();
      UFDouble nSettleMny = VO.getNmoney();

      // 后续处理:存货表头
      BillHeaderVO tempheadVO = (BillHeaderVO) billVO.getParentVO();
      IBillHeaderVO headVO = new IBillHeaderVO();
      String s[] = tempheadVO.getAttributeNames();
      for (int i = 0; i < s.length; i++) {
        headVO.setAttributeValue(s[i], tempheadVO.getAttributeValue(s[i]));
      }

      headVO.setCbilltypecode("I2");
      headVO.setCbillid(invoiceVO.getCinvoiceid());

      headVO.setDbilldate(currDate);
      headVO.setCsourcemodulename("PO");
      headVO.setFdispatchflag(new Integer(0));

      String ss = dmo.queryRSMode(invoiceVO.getCbiztype());
      if (ss != null && ss.length() > 0)
        headVO.setCdispatchid(ss);
      else
        headVO.setCdispatchid(null);

      headVO.setCstockrdcenterid(cStoreOrgID);
      headVO.setCoperatorid(cOperator);

      headVO.setBestimateflag(new UFBoolean(false));
      headVO.setCemployeeid(invoiceVO.getCoperatorid());// invoiceVO.getCoperatorid()
      // 即为发票上的业务员 Czp
      // 2004-07-21
      headVO.setVbillcode(invoiceVO.getVinvoicecode());
      headVO.setBwithdrawalflag(new UFBoolean(false));
      headVO.setBdisableflag(new UFBoolean(false));
      headVO.setBauditedflag(new UFBoolean(false));

      // 后续处理:存货表体
      BillItemVO tempbodyVO = ((BillItemVO[]) billVO.getChildrenVO())[0];
      IBillItemVO bodyVO = new IBillItemVO();
      s = tempbodyVO.getAttributeNames();
      for (int i = 0; i < s.length; i++)
        bodyVO.setAttributeValue(s[i], tempbodyVO.getAttributeValue(s[i]));

      bodyVO.setCbilltypecode("I2");
      bodyVO.setCbill_bid(invoiceVO.getCinvoice_bid());
      bodyVO.setCbillid(invoiceVO.getCinvoiceid());

      bodyVO.setCsourcebillid(VO.getCsettlebillid());
      bodyVO.setCsourcebillitemid(VO.getCsettlebill_bid());
      bodyVO.setCsourcebilltypecode(ScmConst.PO_SettleBill);

      // since v55, 支持订单ID传递到存货核算，跟踪销售订单
      if (invoiceVO.getCinvoice_bid() != null
          && mapBidOrderIds.containsKey(invoiceVO.getCinvoice_bid())) {
        bodyVO.setCfirstbilltypecode(ScmConst.PO_Order);
        bodyVO.setCfirstbillitemid(mapBidOrderIds.get(
            invoiceVO.getCinvoice_bid()).get(0));
        bodyVO.setCfirstbillid(mapBidOrderIds.get(invoiceVO.getCinvoice_bid())
            .get(1));
      }

      bodyVO.setNnumber(nSettleNum);
      bodyVO.setNmoney(nSettleMny);
      if (nSettleNum != null && nSettleMny != null
          && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
        bodyVO.setNprice(nSettleMny.div(nSettleNum, iPriceDigit));
      }
      // since v502, 设置辅计量信息， FENGPING， (理由：如果采购不设置，需要存货注释掉辅计量检查)
      if (mapBid != null && mapBid.containsKey(invoiceVO.getCorder_bid())) {
        oaOrderInfoes = (Object[]) mapBid.get(invoiceVO.getCorder_bid());
        if (oaOrderInfoes.length == 3
            && oaOrderInfoes[0] != null
            && oaOrderInfoes[1] != null
            && oaOrderInfoes[2] != null
            && PuPubVO.getUFDouble_NullAsZero(oaOrderInfoes[2]).doubleValue() != 0.0) {
          ufdHsl = PuPubVO.getUFDouble_NullAsZero(oaOrderInfoes[1]).div(
              PuPubVO.getUFDouble_NullAsZero(oaOrderInfoes[2]), iChgRateDigit);
          bodyVO.setNchangerate(ufdHsl);
          bodyVO.setNassistnum(nSettleNum.multiply(ufdHsl, iAssNumDigit));
          bodyVO.setCastunitid(oaOrderInfoes[0].toString());
        }
      }
      /*
       * czp del 2004-07-21 原因： 1)、直运销售采购由于发票上不记录辅计量 2)、存货在发票维护可修改为与订单不一致
       * 3)、修改存货后的发票仍然回写订单 4)、结算时向存货核算传递的存货是发票的存货 //设置辅计量
       * bodyVO.setCastunitid(cAssistUnit); //设置换算率
       * bodyVO.setNchangerate(invoiceVO.getHsl()); //设置辅数量 if (nSettleNum !=
       * null && invoiceVO.getHsl() != null && invoiceVO.getHsl().doubleValue() !=
       * 0.0) { bodyVO.setNassistnum(nSettleNum.multiply(invoiceVO.getHsl())); }
       */
      bodyVO.setIrownumber(new Integer(0));
      bodyVO.setVbillcode(invoiceVO.getVinvoicecode());
      bodyVO.setDbizdate(invoiceVO.getDarrivedate());

      // 组合存货的表头和表体VO
      billVO = new BillVO();
      billVO.setParentVO(headVO);

      Vector vTemp = new Vector();
      vTemp.addElement(bodyVO);
      IBillItemVO tempBodyVO[] = new IBillItemVO[1];
      vTemp.copyInto(tempBodyVO);

      billVO.setChildrenVO(tempBodyVO);

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      // reportException(e);
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    // 返回存货核算所需要的VO
    return billVO;

  }

  /**
   * 功能描述:入库单VO转换为存货结算VO。为结算时向存货核算系统传送数据服务。
   * 输入参数:入库单头VO,入库单体VO,结算单头主键,结算单体主键,当前操作员,当前日期，库存组织 返回值:存货核算单据VO,暂估标志,入库单类型
   * 作者：熊海情 修改：晁志平 For V30
   */
  private Vector convertVOForIA(BillVO billVO, GeneralHHeaderVO stockHeadVO,
      GeneralHItemVO stockBodyVO, String settleID, String settleRow,
      String cOperator, UFDate dCurrDate, String cCalbody)
      throws BusinessException {
    Vector vRslt = null;
    try {
      // // VO转换, since v502, 效率优化到循环外边进行VO对照
      // GeneralBillVO icVO = switchVOFromGeneral2IC(stockHeadVO,stockBodyVO);
      // BillVO billVO = (BillVO) PfUtilTools.runChangeData("45", "I2", icVO);

      if (billVO == null)
        return null;

      GeneralHHeaderVO headerVO = stockHeadVO;

      // 后续处理:存货表头
      BillHeaderVO tempheadVO = (BillHeaderVO) billVO.getParentVO();
      IBillHeaderVO headVO = new IBillHeaderVO();
      String s[] = tempheadVO.getAttributeNames();
      for (int i = 0; i < s.length; i++)
        headVO.setAttributeValue(s[i], tempheadVO.getAttributeValue(s[i]));

      headVO.setCbillid(headerVO.getCgeneralhid());
      headVO.setDbilldate(dCurrDate);
      headVO.setCsourcemodulename("PO");
      headVO.setFdispatchflag(new Integer(0));

      headVO.setCoperatorid(cOperator);
      headVO.setBestimateflag(new UFBoolean(false));
      headVO.setCwarehousemanagerid(headerVO.getCwhsmanagerid());
      headVO.setCemployeeid(headerVO.getCbizid());

      headVO.setVbillcode(headerVO.getVbillcode());
      headVO.setBwithdrawalflag(new UFBoolean(false));
      headVO.setBdisableflag(new UFBoolean(false));
      headVO.setBauditedflag(new UFBoolean(false));

      headVO.setCstockrdcenterid(null);

      // 查询存货核算表体VO所需的数据
      GeneralHItemVO itemVO = stockBodyVO;

      // 后续处理:存货表体
      BillItemVO tempbodyVO = ((BillItemVO[]) billVO.getChildrenVO())[0];
      IBillItemVO bodyVO = new IBillItemVO();
      s = tempbodyVO.getAttributeNames();
      for (int i = 0; i < s.length; i++)
        bodyVO.setAttributeValue(s[i], tempbodyVO.getAttributeValue(s[i]));

      bodyVO.setPk_corp(headVO.getPk_corp());
      bodyVO.setCbill_bid(itemVO.getCgeneralbid());
      bodyVO.setCbillid(itemVO.getCgeneralhid());

      // V5新增:库存入库单相关信息
      bodyVO.setCicbilltype(headerVO.getCbilltypecode());
      bodyVO.setCicbillcode(headerVO.getVbillcode());
      bodyVO.setCicbillid(itemVO.getCgeneralhid());
      bodyVO.setCicitemid(itemVO.getCgeneralbid());

      bodyVO.setCsourcebillid(settleID);
      bodyVO.setCsourcebillitemid(settleRow);
      bodyVO.setCsourcebilltypecode(ScmConst.PO_SettleBill);

      bodyVO.setCfirstbillid(itemVO.getCfirstbillhid());
      bodyVO.setCfirstbillitemid(itemVO.getCfirstbillbid());
      bodyVO.setCfirstbilltypecode(itemVO.getCfirsttype());

      bodyVO.setIrownumber(new Integer(0));
      bodyVO.setVbillcode(headVO.getVbillcode());
      bodyVO.setVsourcebillcode(headVO.getVbillcode());

      bodyVO.setDbizdate(itemVO.getDbizdate());
      bodyVO.setCvendorid(itemVO.getCvendorid());

      // 赠品标志
      bodyVO.setBlargessflag(itemVO.getFlargess());

      // 组合存货的表头和表体VO
      billVO = new BillVO();
      billVO.setParentVO(headVO);
      IBillItemVO tempBodyVO[] = new IBillItemVO[1];
      Vector v = new Vector();
      v.addElement(bodyVO);
      v.copyInto(tempBodyVO);
      billVO.setChildrenVO(tempBodyVO);

      // 返回存货核算所需要的VO及暂估标志
      vRslt = new Vector();
      vRslt.addElement(billVO);
      vRslt.addElement(itemVO.getBzgflag());
      vRslt.addElement(headerVO.getCbilltypecode());
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vRslt;
  }

  /**
   * 功能描述:入库单VO转换为存货结算VO。为结算时向存货核算系统传送数据服务(V30优化用)
   * 输入参数:入库单头VO,入库单体VO,结算单头主键,结算单体主键,当前操作员,当前日期，库存组织 返回值:存货核算单据VO,暂估标志,入库单类型
   * 作者：晁志平 日期：2004-05-10
   * 
   * @sinve v55, czp ,修改参数,
   *        <p>
   *        1)、删除参数：结算单头主键,结算单体主键，
   *        <p>
   *        2)、增加参数：voSettleItem，结算单行VO，目的是传递成本要素1-5到存货核算
   */
  private Vector convertVOForIA1(BillVO billVO, StockVO stock,
      String cOperator, UFDate dCurrDate, String cCalbody,
      SettlebillItemVO voSettleItem) throws BusinessException {
    // VO转换
    if (billVO == null) {
      return null;
    }
    Vector vRslt = null;
    String settleHid = voSettleItem.getCsettlebillid();
    String settleBid = voSettleItem.getCsettlebill_bid();
    try {
      // 后续处理:存货表头
      BillHeaderVO tempheadVO = (BillHeaderVO) billVO.getParentVO();
      IBillHeaderVO headVO = new IBillHeaderVO();
      String s[] = tempheadVO.getAttributeNames();
      for (int i = 0; i < s.length; i++) {
        headVO.setAttributeValue(s[i], tempheadVO.getAttributeValue(s[i]));
      }
      headVO.setCbillid(stock.getCgeneralhid());
      headVO.setDbilldate(dCurrDate);
      headVO.setCsourcemodulename("PO");
      headVO.setFdispatchflag(new Integer(0));

      headVO.setCoperatorid(cOperator);
      headVO.setBestimateflag(new UFBoolean(false));
      headVO.setCwarehousemanagerid(stock.getCwhsmanagerid());
      headVO.setCemployeeid(stock.getCbizid());// czp 2004-07-21

      headVO.setVbillcode(stock.getVbillcode());
      headVO.setBwithdrawalflag(new UFBoolean(false));
      headVO.setBdisableflag(new UFBoolean(false));
      headVO.setBauditedflag(new UFBoolean(false));

      headVO.setCstockrdcenterid(null);

      // 后续处理:存货表体
      BillItemVO tempbodyVO = ((BillItemVO[]) billVO.getChildrenVO())[0];
      IBillItemVO bodyVO = new IBillItemVO();
      s = tempbodyVO.getAttributeNames();
      for (int i = 0; i < s.length; i++) {
        bodyVO.setAttributeValue(s[i], tempbodyVO.getAttributeValue(s[i]));
      }

      bodyVO.setPk_corp(headVO.getPk_corp());
      bodyVO.setCbill_bid(stock.getCgeneralbid());
      bodyVO.setCbillid(stock.getCgeneralhid());

      bodyVO.setCsourcebillid(settleHid);
      bodyVO.setCsourcebillitemid(settleBid);
      bodyVO.setCsourcebilltypecode(ScmConst.PO_SettleBill);

      bodyVO.setCfirstbillid(stock.getCfirstbillhid());
      bodyVO.setCfirstbillitemid(stock.getCfirstbillbid());
      bodyVO.setCfirstbilltypecode(stock.getCfirsttype());

      bodyVO.setIrownumber(new Integer(0));
      bodyVO.setVbillcode(headVO.getVbillcode());
      bodyVO.setVsourcebillcode(headVO.getVbillcode());

      // V5新增:库存入库单相关信息
      bodyVO.setCicbilltype(stock.getCbilltype());
      bodyVO.setCicbillcode(stock.getVbillcode());
      bodyVO.setCicbillid(stock.getCgeneralhid());
      bodyVO.setCicitemid(stock.getCgeneralbid());

      bodyVO.setDbizdate(stock.getDbizdate());
      // 赠品标志
      bodyVO.setBlargessflag(stock.getFlargess());
      bodyVO.setCvendorid(stock.getCvendorid());

      // since v55,增加成本要素的传递
      bodyVO.setNfactor1(voSettleItem.getNfactor1());
      bodyVO.setNfactor2(voSettleItem.getNfactor2());
      bodyVO.setNfactor3(voSettleItem.getNfactor3());
      bodyVO.setNfactor4(voSettleItem.getNfactor4());
      bodyVO.setNfactor5(voSettleItem.getNfactor5());

      // 组合存货的表头和表体VO
      billVO = new BillVO();
      billVO.setParentVO(headVO);
      IBillItemVO tempBodyVO[] = new IBillItemVO[1];
      Vector v = new Vector();
      v.addElement(bodyVO);
      v.copyInto(tempBodyVO);
      billVO.setChildrenVO(tempBodyVO);

      // 返回存货核算所需要的VO及暂估标志
      vRslt = new Vector();
      vRslt.addElement(billVO);
      vRslt.addElement(stock.getBzgflag());
      vRslt.addElement(stock.getCbilltype());

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      PubDMO.throwBusinessException(e);
    }
    return vRslt;
  }

  /**
   * 功能描述:基于订单入库时自动结算，入库单签字调用该结算接口 （注意：结算是否成功，不影响入库单签字） 输入参数:标准入库单VO
   * 返回值:结算成功，返回TRUE，否则，返回FALSE 日期:2003/04/24 作者：熊海情 修改：晁志平 For V30
   * 增加对参与结算的发票ID、红入库单ID的加锁处理，解锁在调用者完成(N_45_SIGN)
   */
  public ArrayList doOrderToICSettle(GeneralBillVO[] VO)
      throws BusinessException {
    ArrayList listLockId = null;
    String sEstMode = null;
    String sDiffMode = null;
    SettlebillVO voBillCode = null;
    boolean bGetBillCodeSucc = false;
    boolean bLock = false;

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    try {
      // 获得系统设置的暂估方式和差异转入方式
      ISysInitQry myService1 = (ISysInitQry) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ISysInitQry.class.getName());
      Hashtable t = myService1.queryBatchParaValues(VO[0].getHeaderVO()
          .getPk_corp(), new String[] {
          "PO12", "PO13"
      });
      if (t == null || t.size() == 0)
        return null;
      sEstMode = (String) t.get("PO12");
      sDiffMode = (String) t.get("PO13");

      timer.addExecutePhase("获得系统设置的暂估方式和差异转入方式");

      // 生成结算单号
      String vSettlebillcode = "";
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      SettlebillHeaderVO head = new SettlebillHeaderVO();
      head.setPk_corp(VO[0].getHeaderVO().getPk_corp());
      voBillCode = new SettlebillVO(1);
      voBillCode.setParentVO(head);
      voBillCode.setChildrenVO(new SettlebillItemVO[] {
        new SettlebillItemVO()
      });
      do {
        vSettlebillcode = billCode.getSysBillNO(voBillCode);
      }
      while (isSettlebillCodeDuplicate(VO[0].getHeaderVO().getPk_corp(),
          vSettlebillcode));
      voBillCode.getHeadVO().setVsettlebillcode(vSettlebillcode);
      bGetBillCodeSucc = true;

      timer.addExecutePhase("生成结算单号");

      // 执行结算
      AutoSettleOrderToIC orderToIC = new AutoSettleOrderToIC(null,
          vSettlebillcode);
      Vector v = null;
      v = orderToIC.doBalance(VO, null);

      timer.addExecutePhase("执行结算");

      if (v != null && v.size() > 0) {
        StockVO stockVOs[] = (StockVO[]) v.elementAt(0);
        SettlebillVO settlebillVO = (SettlebillVO) v.elementAt(1);
        // 判断存货核算是否启用
        if (stockVOs != null && stockVOs.length > 0) {
          ICreateCorpQueryService myService0 = null;
          myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
              .getInstance().lookup(ICreateCorpQueryService.class.getName());
          boolean bIAStartUp = myService0.isEnabled(VO[0].getHeaderVO()
              .getPk_corp(), "IA");
          if (bIAStartUp) {
            // 对参与结算的发票ID、红入库单ID加锁(解锁在入库单签字脚本：N_45_SIGN中完成)
            listLockId = (ArrayList) v.elementAt(2);
            if (listLockId != null && listLockId.size() > 0) {
              String[] saLockId = new String[listLockId.size()];
              saLockId = (String[]) listLockId.toArray(saLockId);
              String strOprId = VO[0].getCurUserID();
              // LockTool.releaseLockForPks(saLockId, strOprId);
              bLock = LockTool.setLockForPks(saLockId, strOprId);
              if (!bLock) {
                listLockId = null;
                throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000038")/*
                                                                   * @res
                                                                   * "参与结算的发票或红入库单正在被占用，本次签字自动结算失败!"
                                                                   */);
              }
            }
            // 向存货核算传送数据
            ArrayList listPara = new ArrayList();
            listPara.add(sEstMode);
            listPara.add(sDiffMode);
            listPara.add(settlebillVO);
            listPara.add(VO[0].getHeaderVO().getCregister());
            listPara.add(VO[0].getHeaderVO().getDaccountdate());
            listPara.add(null);
            listPara.add(stockVOs);
            listPara.add(null);// since v55
            listPara.add(null);// since v55
            saveBillFromOutter1(listPara);
          }
        }
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            billCode = new nc.bs.pu.pub.GetSysBillCode();
            billCode.returnBillNo(voBillCode);
          }
          catch (Exception ex) {
            SCMEnv.out("结算失败,回退结算单号");
            /* 自动结算失败，不影响入库单签字操作，此处异常不抛出 */
            SCMEnv.out(ex);
          }
        }
      }

      timer.addExecutePhase("向存货核算传送数据(总)");

      timer.showAllExecutePhase("基于订单入库时自动结算，入库单签字调用该结算接口时间分布");

    }
    catch (Exception e) {
      SCMEnv.out("向存货核算传送数据失败");
      /* 自动结算失败，不影响入库单签字操作，此处异常不抛出 */
      SCMEnv.out(e);
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(voBillCode);
        }
        catch (Exception ex) {
          SCMEnv.out("结算失败,回退结算单号");
          /* 自动结算失败，不影响入库单签字操作，此处异常不抛出 */
          SCMEnv.out(ex);
        }
      }
      // 2004-12-09xhq(begin)
      // 异常照常抛出,此时发票方不能解锁,故需在此处解锁
      if (bLock && listLockId != null && listLockId.size() > 0) {
        String[] saLockId = new String[listLockId.size()];
        saLockId = (String[]) listLockId.toArray(saLockId);
        String strOprId = VO[0].getCurUserID();
        try {
          LockTool.releaseLockForPks(saLockId, strOprId);
        }
        catch (Exception ee) {
          nc.bs.pu.pub.PubDMO.throwBusinessException(ee);
        }
      }
//      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      // 2004-12-09xhq(end)
    }
    //同时返回加锁员ID by zhaoyha at 2008.10.23
    if(VO!=null && VO[0]!=null && listLockId!=null) listLockId.add(VO[0].getCurUserID());
    return listLockId;
  }

  /**
   * 功能描述:基于订单接收发票自动结算时，发票调用该结算接口（除直运业务类型外） （注意：结算是否成功，不影响发票保存） 输入参数:标准发票VO
   * 返回值:结算成功，返回TRUE，否则，返回FALSE 日期:2003/04/22 作者：熊海情 修改：晁志平 For V30
   */
  public ArrayList doOrderToInvoiceSettle(InvoiceVO VO[], ArrayList list, String strOprType)
      throws BusinessException {
    ArrayList listLockId = null;
    SettlebillVO voBillCode = null;
    boolean bGetBillCodeSucc = false;
    boolean bLock = false;
    UFBoolean bSucceed = new UFBoolean(false);

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    try {
      String accountYear = VO[0].getHeadVO().getCaccountyear(); // 会计年度
      UFDate currentDate = VO[0].getHeadVO().getDinvoicedate(); // 当前日期
      String operatorID = null; // 操作员
      if (VO[0].getHeadVO().getCauditpsn() != null)
        operatorID = VO[0].getHeadVO().getCauditpsn();
      else
        operatorID = VO[0].getHeadVO().getCoperator();
      if (list != null && list.size() > 0) {
        Object oTemp = list.get(0);
        if (oTemp != null)
          currentDate = new UFDate(oTemp.toString());
      }

      // 获得系统设置的暂估方式和差异转入方式
      String sEstMode = null;
      String sDiffMode = null;
      ISysInitQry myService1 = (ISysInitQry) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ISysInitQry.class.getName());
      Hashtable t = myService1.queryBatchParaValues(VO[0].getHeadVO()
          .getPk_corp(), new String[] {
          "PO12", "PO13"
      });
      if (t == null || t.size() == 0)
        return null;
      sEstMode = (String) t.get("PO12");
      sDiffMode = (String) t.get("PO13");

      timer.addExecutePhase("获得系统设置的暂估方式和差异转入方式");

      // 生成结算单号
      String vSettlebillcode = "";
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      SettlebillHeaderVO head = new SettlebillHeaderVO();
      head.setPk_corp(VO[0].getHeadVO().getPk_corp());
      voBillCode = new SettlebillVO(1);
      voBillCode.setParentVO(head);
      voBillCode.setChildrenVO(new SettlebillItemVO[] {
        new SettlebillItemVO()
      });
      do {
        vSettlebillcode = billCode.getSysBillNO(voBillCode);
      }
      while (isSettlebillCodeDuplicate(VO[0].getHeadVO().getPk_corp(),
          vSettlebillcode));
      voBillCode.getHeadVO().setVsettlebillcode(vSettlebillcode);
      bGetBillCodeSucc = true;

      timer.addExecutePhase("生成结算单号");

      // 执行结算
      AutoSettleOrderToInvoice orderToInvoice = new AutoSettleOrderToInvoice(
          accountYear, currentDate, operatorID, vSettlebillcode);
      Vector v = null;
      v = orderToInvoice.doBalance(VO, strOprType);

      timer.addExecutePhase("执行结算");

      if (v != null && v.size() > 0) {
        bSucceed = new UFBoolean(true);
        StockVO stockVOs[] = (StockVO[]) v.elementAt(0);
        SettlebillVO settlebillVO = (SettlebillVO) v.elementAt(1);
        // 判断存货核算是否启用
        if (stockVOs != null && stockVOs.length > 0) {
          // 除NULL
          Vector vNotNull = new Vector();
          int iLenSto = stockVOs.length;
          for (int i = 0; i < iLenSto; i++) {
            if (stockVOs[i] != null)
              vNotNull.addElement(stockVOs[i]);
          }
          if (vNotNull.size() > 0) {
            stockVOs = new StockVO[vNotNull.size()];
            vNotNull.copyInto(stockVOs);
          }
          else {
            stockVOs = null;
          }
          ICreateCorpQueryService myService0 = null;
          myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
              .getInstance().lookup(ICreateCorpQueryService.class.getName());
          boolean bIAStartUp = myService0.isEnabled(VO[0].getHeadVO()
              .getPk_corp(), "IA");
          if (bIAStartUp) {
            // 对参与结算的发票ID、红入库单ID加锁(解锁在入库单签字脚本：N_45_SIGN中完成)
            listLockId = (ArrayList) v.elementAt(2);
            if (listLockId != null && listLockId.size() > 0) {
              String[] saLockId = new String[listLockId.size()];
              saLockId = (String[]) listLockId.toArray(saLockId);
              String strOprId = VO[0].getHeadVO().getCuserid() == null ? BsPuTool.getLoginOperator() : VO[0].getHeadVO().getCuserid();
              bLock = LockTool.setLockForPks(saLockId, strOprId);
              if (!bLock) {
                listLockId = null;
                throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
                    .getStrByID("40040502", "UPP40040502-000039")/*
                                                                   * @res
                                                                   * "参与结算的入库单或红发票正在被占用，本次发票驱动的自动结算失败!"
                                                                   */);
              }
            }
            // 向存货核算传送数据
            ArrayList listPara = new ArrayList();
            listPara.add(sEstMode);
            listPara.add(sDiffMode);
            listPara.add(settlebillVO);
            listPara.add(operatorID);
            listPara.add(currentDate);
            listPara.add(null);
            listPara.add(stockVOs);
            listPara.add(null);// since v55
            listPara.add(null);// since v55
            saveBillFromOutter1(listPara);
          }
        }
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            nc.bs.pu.pub.GetSysBillCode billCode1 = new nc.bs.pu.pub.GetSysBillCode();
            billCode1.returnBillNo(voBillCode);
          }
          catch (Exception ex) {
            /* 订单接收发票自动结算失败，不影响发票操作，此处异常不抛出 */
            SCMEnv.out(ex);
          }
        }
      }

      timer.addExecutePhase("向存货核算传送数据(总)");

      timer.showAllExecutePhase("基于订单接收发票自动结算时，发票调用该结算接口（除直运业务类型外）时间分布");

    }
    catch (Exception e) {
      /* 订单接收发票自动结算失败，不影响发票操作，此处异常不抛出 */
      SCMEnv.out(e);
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(voBillCode);
        }
        catch (Exception ex) {
          /* 订单接收发票自动结算失败，不影响发票操作，此处异常不抛出 */
          SCMEnv.out(ex);
        }
      }
      // 2004-12-09xhq(begin)
      // 异常照常抛出,此时发票方不能解锁,故需在此处解锁
      if (bLock && listLockId != null && listLockId.size() > 0) {
        String[] saLockId = new String[listLockId.size()];
        saLockId = (String[]) listLockId.toArray(saLockId);
        String strOprId = VO[0].getHeadVO().getCuserid();
        try {
          LockTool.releaseLockForPks(saLockId, strOprId);
        }
        catch (Exception ee) {
          nc.bs.pu.pub.PubDMO.throwBusinessException(ee);
        }
      }
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
      // 2004-12-09xhq(end)
    }
    ArrayList list0 = new ArrayList();
    list0.add(listLockId);
    list0.add(bSucceed);
    return list0;
  }

  /*
   * 功能描述:采购结算时，依据入库单是否暂估和暂估方式不同,向存货核算系统传递数据(单张单据传送)
   * 输入参数:入库单头VO,入库单体VO,暂估方式，差异转入方式,结算单体VO,当前操作员,当前日期，入库单体[],计价方式,辅数量，库存组织,退税参数
   * 返回值:存货核算VO集合 作者：熊海情 修改：晁志平 For V30
   */
  private BillVO[] transferIAData(BillVO billVo, GeneralHHeaderVO stockHeadVO,
      GeneralHItemVO stockBodyVO, String sZGmode, String sCYZRmode,
      SettlebillItemVO settlebillitemVo, String cOperator, UFDate dCurrDate,
      GeneralHItemVO generalHItemVOs[], UFDouble nAssistNum, String cCalbody,
      ArrayList paraListDigits, int iMnyDigit, int iNumDigit, String strIntoCost)
      throws BusinessException {

    Vector vReturn = new Vector();
    String strPkCorp = null;
    try {
      strPkCorp = stockHeadVO.getPk_corp();
      // 入库单VO转换为存货核算VO,并且返回该VO及入库单暂估标志
      Vector v = convertVOForIA(billVo, stockHeadVO, stockBodyVO,
          settlebillitemVo.getCsettlebillid(), settlebillitemVo
              .getCsettlebill_bid(), cOperator, dCurrDate, cCalbody);
      UFDouble nSettleNum = settlebillitemVo.getNsettlenum();
      UFDouble nSettleMny = settlebillitemVo.getNmoney();
      UFDouble nGaugeMny = settlebillitemVo.getNgaugemny();
      UFDouble nPrice = settlebillitemVo.getNprice();
      BillVO billVO = (BillVO) v.elementAt(0);
      IBillHeaderVO headerVO = (IBillHeaderVO) billVO.getParentVO();
      IBillItemVO itemVO[] = (IBillItemVO[]) billVO.getChildrenVO();
      UFBoolean bZG = (UFBoolean) v.elementAt(1);
      String sStockTypeCode = (String) v.elementAt(2);

      // 非空，由调用者保证
      int iPriceDigit = ((Integer) paraListDigits.get(0)).intValue();

      /*
       * V502 调整， FENGPING， 2007-12-27
       * 4.8 采购结算形成的合理损耗数量不进入成本的方案调整 
       * 4.8.1 业务描述
       *   测试问题，原来需求方案的进一步完善。
       *   目前产品处理时，合理损耗如果不进入成本，在已暂估并且为单到补差时，合理损耗部分体现在损益调整单中，其他情况则体现在存货采购入库单上。如合理损耗不进成本，应统一体现在损益调整单上，用户配置模板时也不会困惑，产品也更清晰。
       * 4.8.2 解决方案 
       * 1、存货核算采购入库单去掉“合理损耗数量”、“合理损耗金额”字段。 
       * 2、采购结算时，参数“采购结算时合理损耗是否进入成本”如果为“是”，则结算后生成的存货采购入库单或者入库调整单成本金额包括合理损耗金额，和原有处理一致。
       * 3、采购结算时，参数“采购结算时合理损耗是否进入成本”如果为“否”，则结算后生成的存货采购入库单或者入库调整单成本金额不包括合理损耗金额，并且不再将合理损耗数量、合理损耗金额传递到存货采购入库单和入库调整单；合理损耗部分生成损益调整单，损益调整单上的合理损耗数量、合理损耗金额为结算合理损耗数量和金额。
       */

      BillVO gBillVOReasonWaste = null;
      if (settlebillitemVo.getNreasonalwastnum() != null
          && Math.abs(settlebillitemVo.getNreasonalwastnum().doubleValue()) >= PuPubVO.getDigitVal(iNumDigit).doubleValue()
          && "N".equalsIgnoreCase(strIntoCost)) {
        gBillVOReasonWaste = new BillVO();
        IBillHeaderVO gheaderVO = (IBillHeaderVO) headerVO.clone();
        IBillItemVO gitemVO = (IBillItemVO) itemVO[0].clone();

        gheaderVO.setCbilltypecode("IG");
        gitemVO.setCbilltypecode("IG");

        //
        gitemVO.setNnumber(null);
        gitemVO.setNprice(null);
        gitemVO.setNmoney(settlebillitemVo.getNreasonalwastmny());

        // since V502,
        // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--czp&zhongm,2007-11-12-bgn
        gitemVO.setNadjustnum(null);
        gitemVO.setCadjustbillid(null);
        gitemVO.setCadjustbillitemid(null);
        // since V502,
        // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--czp&zhongm,2007-11-12-end
        
        //按存货核算要求,如果是合理损耗的IG单,要打上True标志 
        gitemVO.setBpuwaste(UFBoolean.TRUE); 
        
        Vector vTemp = new Vector();
        vTemp.addElement(gitemVO);
        IBillItemVO tempVO[] = new IBillItemVO[1];
        vTemp.copyInto(tempVO);
        gBillVOReasonWaste.setChildrenVO(tempVO);
        gBillVOReasonWaste.setParentVO(gheaderVO);
      }
      if (gBillVOReasonWaste != null) {
        vReturn.addElement(gBillVOReasonWaste);
      }

      // 判断存货核算单据类型
      if (!bZG.booleanValue()) {
        // 入库单未暂估,单据类型为“采购入库单”
        headerVO.setBestimateflag(new UFBoolean(false));
        headerVO.setCbilltypecode("I2");
        itemVO[0].setCbilltypecode("I2");
        itemVO[0].setNnumber(nSettleNum);
        itemVO[0].setNmoney(nSettleMny);

        // 合理损耗处理
        if ("Y".equalsIgnoreCase(strIntoCost)) {
          itemVO[0].setNreasonalwastnum(settlebillitemVo.getNreasonalwastnum());
          itemVO[0].setNreasonalwastprice(settlebillitemVo.getNreasonalwastprice());
          itemVO[0].setNreasonalwastmny(settlebillitemVo.getNreasonalwastmny());
        }
        //

        if (nPrice != null) {
          itemVO[0].setNprice(nPrice);
        }
        else if (nSettleMny != null && nSettleNum != null && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
          // since v502, 支持精度处理
          itemVO[0].setNprice(nSettleMny.div(nSettleNum, iPriceDigit));
        }
        // 设置辅数量
        itemVO[0].setNassistnum(
            (itemVO[0].getCastunitid() == null || itemVO[0].getCastunitid().trim().equals("")) ? null : nAssistNum);
        vReturn.addElement(billVO);
      }
      else {
        // 入库单已暂估
        headerVO.setBestimateflag(new UFBoolean(true));
        // 如果暂估的委外入库单,不管暂估参数设置,改为"单到补差"
        if (sStockTypeCode.trim().equals("47")){
          sZGmode = "单到补差";
        }
        if (sZGmode.trim().equals("单到回冲")) {
          // 暂估方式为“单到回冲”，则传送的单据类型为“采购入库单”和“暂估回冲单”
          // 先生成“采购入库单”
          if (sStockTypeCode.trim().equals("47")) {
            headerVO.setCbilltypecode("ID");
            itemVO[0].setCbilltypecode("ID");
          }
          else {
            headerVO.setCbilltypecode("I2");
            itemVO[0].setCbilltypecode("I2");
          }
          headerVO.setBRedBill(new UFBoolean(false));
          itemVO[0].setNnumber(nSettleNum);
          itemVO[0].setNmoney(nSettleMny);

          // 合理损耗处理
          if ("Y".equalsIgnoreCase(strIntoCost)) {
            itemVO[0].setNreasonalwastnum(settlebillitemVo.getNreasonalwastnum());
            itemVO[0].setNreasonalwastprice(settlebillitemVo.getNreasonalwastprice());
            itemVO[0].setNreasonalwastmny(settlebillitemVo.getNreasonalwastmny());
          }
          //
          if (nPrice != null) {
            itemVO[0].setNprice(nPrice);
          }
          else if (nSettleMny != null && nSettleNum != null && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
            // since v502, 支持精度处理
            itemVO[0].setNprice(nSettleMny.div(nSettleNum, iPriceDigit));
          }
          // 设置辅数量
          itemVO[0].setNassistnum(
              (itemVO[0].getCastunitid() == null || itemVO[0].getCastunitid().trim().equals("")) ? null : nAssistNum);
          // 按存货核算要求修改
          ((IBillHeaderVO) billVO.getParentVO()).setBestimateflag(new UFBoolean(false));
          // 再生成“暂估回冲单”
          BillVO gbillVO = new BillVO();
          IBillHeaderVO gheaderVO = (IBillHeaderVO) headerVO.clone();
          IBillItemVO gitemVO = (IBillItemVO) itemVO[0].clone();

          // 合理损耗处理
          gitemVO.setNreasonalwastnum(null);
          gitemVO.setNreasonalwastprice(null);
          gitemVO.setNreasonalwastmny(null);
          //

          if (nSettleNum != null){
            gitemVO.setNnumber(new UFDouble(-nSettleNum.doubleValue()));
          }
          if (nGaugeMny != null){
            gitemVO.setNmoney(new UFDouble(-nGaugeMny.doubleValue()));
          }
          if (nGaugeMny != null && nSettleNum != null && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
            // since v502, 支持精度处理
            gitemVO.setNprice(nGaugeMny.div(nSettleNum, iPriceDigit));
          }
          // 设置辅数量
          gitemVO.setNassistnum(
              (gitemVO.getCastunitid() == null || gitemVO.getCastunitid().trim().equals("")) ? null : nAssistNum);
          if (gitemVO.getNassistnum() != null){
            gitemVO.setNassistnum(gitemVO.getNassistnum().multiply(-1));
          }
          gheaderVO.setBRedBill(new UFBoolean(true));
          Vector vTemp = new Vector();
          vTemp.addElement(gitemVO);
          IBillItemVO tempVO[] = new IBillItemVO[1];
          vTemp.copyInto(tempVO);
          gbillVO.setChildrenVO(tempVO);
          gbillVO.setParentVO(gheaderVO);
          // 按存货核算要求修改
          ((IBillHeaderVO) gbillVO.getParentVO()).setBestimateflag(new UFBoolean(true));
          // 先传“暂估回冲单”，再传“采购入库单”
          vReturn.addElement(gbillVO);
          vReturn.addElement(billVO);
        }
        else {
          // 暂估方式为“单到补差”
          // 调整单不需要辅计量及辅数量
          for (int i = 0; i < itemVO.length; i++) {
            itemVO[i].setCastunitid(null);
            itemVO[i].setNassistnum(null);
            itemVO[i].setNSettleNum(nSettleNum);
            itemVO[i].setNSettleMny(nSettleMny);
            // 采购管理结算后生成入库调整单时将原暂估单据的Id和行ID传入存货核算2004/04/06
            if (!sStockTypeCode.equals("4T") && !sStockTypeCode.equals("47")) {
              itemVO[i].setNadjustnum(nSettleNum);
              itemVO[i].setCadjustbillid(itemVO[i].getCicbillid());
              itemVO[i].setCadjustbillitemid(itemVO[i].getCicitemid());
            }
          }
          if (sCYZRmode.trim().equals("成本")) {
            // 差异转入方式为“转成本”，单据类型为“成本调整单”
            headerVO.setCbilltypecode("I9");
            headerVO.setBestimateflag(new UFBoolean(false));
            itemVO[0].setCbilltypecode("I9");
            itemVO[0].setNnumber(null);
            itemVO[0].setNprice(null);
            if (nSettleMny != null && nGaugeMny != null) {
              double d = nSettleMny.doubleValue() - nGaugeMny.doubleValue();
              itemVO[0].setNmoney(new UFDouble(d));
            }

            // v5新增
            itemVO[0].setBretractflag(new UFBoolean(false));
            if (!sStockTypeCode.equals("4T") && !sStockTypeCode.equals("47")) {
              itemVO[0].setNadjustnum(nSettleNum);
            }

            // 对调整单,若金额为空或为0,不向存货核算传送
            if (itemVO[0].getNmoney() != null && Math.abs(itemVO[0].getNmoney().doubleValue()) > 0.0) {
              vReturn.addElement(billVO);
            }
          }
          else {
            // 差异转入方式为“转损益”，单据类型为“损益调整单”
            headerVO.setCbilltypecode("IG");
            headerVO.setBestimateflag(new UFBoolean(false));
            itemVO[0].setCbilltypecode("IG");
            itemVO[0].setNnumber(null);
            itemVO[0].setNprice(null);

            itemVO[0].setBretractflag(new UFBoolean(false));
            if (nSettleMny != null && nGaugeMny != null) {
              double d = nSettleMny.doubleValue() - nGaugeMny.doubleValue();
              itemVO[0].setNmoney(new UFDouble(d));
            }
            // 合理损耗处理
            if ("Y".equalsIgnoreCase(strIntoCost)) {
              itemVO[0].setNreasonalwastnum(settlebillitemVo.getNreasonalwastnum());
              itemVO[0].setNreasonalwastprice(settlebillitemVo.getNreasonalwastprice());
              itemVO[0].setNreasonalwastmny(settlebillitemVo.getNreasonalwastmny());
            }

            // since V502,
            // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--zhongm,2007-11-12-bgn
            itemVO[0].setNadjustnum(null);
            itemVO[0].setCadjustbillid(null);
            itemVO[0].setCadjustbillitemid(null);
            // since V502,
            // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--zhongm,2007-11-12-end

            // 对调整单,若金额为空或为0,不向存货核算传送
            if (itemVO[0].getNmoney() != null && Math.abs(itemVO[0].getNmoney().doubleValue()) > 0.0) {
              vReturn.addElement(billVO);
            }
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    if (vReturn.size() > 0) {
      BillVO returnVOs[] = new BillVO[vReturn.size()];
      vReturn.copyInto(returnVOs);
      return returnVOs;
    }
    return null;
  }

  /**
   * 功能描述:采购结算时，依据入库单是否暂估和暂估方式不同,向存货核算系统传递数据(单张单据传送)
   * 输入参数:入库单体VO(结算用VO，含入库单头信息),暂估方式，差异转入方式,结算单体VO,当前操作员,当前日期，入库单体[],计价方式,辅数量，库存组织,
   * 退税参数 返回值:存货核算VO集合 作者：熊海情 修改：晁志平 For V30 注：V30自动结算、手工结算、异存货结算等节点效率优化用
   * 
   * @since v502, 支持精度处理 , by czp
   * @since v502, 效率处理 , by czp，思路：
   *        <p>
   *        将VO对照放到循环外边完成，此处传入 billVO_0是与stock对应的VO对照后的VO,表体行长度为1
   *        <p>
   *        strIntoCost : 结算时发票合理损耗是否进入成本 ， PO75
   * @since v55, 支持费用暂估的第一次调差，将暂估费用存货对应的第一行费用发票分开处理
   *        <p>
   *        增加参数，SettlebillVO settlebillVO, 结算单VO
   *        <p>
   *        增加参数，HashMap<String, ArrayList<UFDouble>> mapUnitWeightAndVolume,
   *        单位体积、单位重量哈希表
   */
  private BillVO[] transferIAData1(BillVO billVO_0, StockVO stockVo,
      String strZGmode, String strCYZRmode, SettlebillItemVO settleItemVo,
      String strOperator, UFDate dCurrDate, GeneralHItemVO[] generalHItemVOs,
      UFDouble ufdAssistNum, String strCalBodyId, ArrayList paraListDigits,
      String strIntoCost,
      // since v55, 支持费用暂估的第一次调差，或回冲，将暂估费用存货对应的第一行费用发票分开处理
      SettlebillVO settlebillVO, // 结算VO
      HashMap<String, ArrayList<UFDouble>> mapUnitWeightAndVolume// 存货基本ID={单位体积、单位重量哈希表}
  ) throws BusinessException {
    Vector vReturn = new Vector();
    String strPkCorp = null;
    try {
      strPkCorp = stockVo.getPk_corp();
      // 入库单VO转换为存货核算VO,并且返回该VO及入库单暂估标志
      Vector vConvertToPuSelfVos = convertVOForIA1(billVO_0, stockVo,
          strOperator, dCurrDate, strCalBodyId, settleItemVo);
      UFDouble nSettleNum = settleItemVo.getNsettlenum();
      UFDouble nSettleMny = settleItemVo.getNmoney();
      UFDouble nGaugeMny = settleItemVo.getNgaugemny();
      UFDouble nPrice = settleItemVo.getNprice();
      BillVO billVO = (BillVO) vConvertToPuSelfVos.elementAt(0);
      IBillHeaderVO headerVO = (IBillHeaderVO) billVO.getParentVO();
      IBillItemVO[] itemVOsLenIs1 = (IBillItemVO[]) billVO.getChildrenVO();
      UFBoolean bZG = (UFBoolean) vConvertToPuSelfVos.elementAt(1);
      String sStockTypeCode = (String) vConvertToPuSelfVos.elementAt(2);

      // 非空，由调用者保证
      int iPriceDigit = ((Integer) paraListDigits.get(0)).intValue();
      int iMnyDigit = ((Integer) paraListDigits.get(1)).intValue();
      int iNumDigit = ((Integer) paraListDigits.get(2)).intValue();

      /*
       * V502 调整， FENGPING， 2007-12-27， 
       * 4.8 采购结算形成的合理损耗数量不进入成本的方案调整 
       * 4.8.1 业务描述
       *   测试问题，原来需求方案的进一步完善。
       *   目前产品处理时，合理损耗如果不进入成本，在已暂估并且为单到补差时，合理损耗部分体现在损益调整单中，其他情况则体现在存货采购入库单上。如合理损耗不进成本，应统一体现在损益调整单上，用户配置模板时也不会困惑，产品也更清晰。
       * 4.8.2 解决方案 
       * 1、存货核算采购入库单去掉“合理损耗数量”、“合理损耗金额”字段。 
       * 2、采购结算时，参数“采购结算时合理损耗是否进入成本”如果为“是”，则结算后生成的存货采购入库单或者入库调整单成本金额包括合理损耗金额，和原有处理一致。
       * 3、采购结算时，参数“采购结算时合理损耗是否进入成本”如果为“否”，则结算后生成的存货采购入库单或者入库调整单成本金额不包括合理损耗金额，并且不再将合理损耗数量、合理损耗金额传递到存货采购入库单和入库调整单；合理损耗部分生成损益调整单，损益调整单上的合理损耗数量、合理损耗金额为结算合理损耗数量和金额。
       */

      BillVO gBillVOReasonWaste = null;
      if (settleItemVo.getNreasonalwastnum() != null
          && Math.abs(settleItemVo.getNreasonalwastnum().doubleValue()) >= PuPubVO.getDigitVal(iNumDigit).doubleValue()
          && "N".equalsIgnoreCase(strIntoCost)) {
        gBillVOReasonWaste = new BillVO();
        IBillHeaderVO gheaderVO = (IBillHeaderVO) headerVO.clone();
        IBillItemVO gitemVO = (IBillItemVO) itemVOsLenIs1[0].clone();

        gheaderVO.setCbilltypecode("IG");
        gitemVO.setCbilltypecode("IG");
        //
        gitemVO.setNreasonalwastnum(settleItemVo.getNreasonalwastnum());
        gitemVO.setNreasonalwastprice(settleItemVo.getNreasonalwastprice());
        gitemVO.setNreasonalwastmny(settleItemVo.getNreasonalwastmny());
        //
        gitemVO.setNnumber(null);
        gitemVO.setNprice(null);
        gitemVO.setNmoney(settleItemVo.getNreasonalwastmny());

        // since V502,
        // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--czp&zhongm,2007-11-12-bgn
        gitemVO.setNadjustnum(null);
        gitemVO.setCadjustbillid(null);
        gitemVO.setCadjustbillitemid(null);
        // since V502,
        // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--czp&zhongm,2007-11-12-end

        //按存货核算要求,如果是合理损耗的IG单,要打上True标志 
        gitemVO.setBpuwaste(UFBoolean.TRUE);
        //将合理损耗上的成本要求清零
        for(Integer i=1;i<=8;++i){
          gitemVO.setAttributeValue("nfactor" + i,new UFDouble(0.0));
        }

        Vector vTemp = new Vector();
        vTemp.addElement(gitemVO);
        IBillItemVO tempVO[] = new IBillItemVO[1];
        vTemp.copyInto(tempVO);
        gBillVOReasonWaste.setChildrenVO(tempVO);
        gBillVOReasonWaste.setParentVO(gheaderVO);
      }
      if (gBillVOReasonWaste != null) {
        vReturn.addElement(gBillVOReasonWaste);
      }
      /*
       * ------------- 未暂估分支-----------------------------------------------
       */
      if (bZG == null || !bZG.booleanValue()) {
        // 入库单未暂估,单据类型为“采购入库单”
        headerVO.setBestimateflag(new UFBoolean(false));
        headerVO.setCbilltypecode("I2");
        itemVOsLenIs1[0].setCbilltypecode("I2");
        itemVOsLenIs1[0].setNnumber(nSettleNum);
        itemVOsLenIs1[0].setNmoney(nSettleMny);

        // 合理损耗处理
        if ("Y".equalsIgnoreCase(strIntoCost)) {
          itemVOsLenIs1[0].setNreasonalwastnum(settleItemVo.getNreasonalwastnum());
          itemVOsLenIs1[0].setNreasonalwastprice(settleItemVo.getNreasonalwastprice());
          itemVOsLenIs1[0].setNreasonalwastmny(settleItemVo.getNreasonalwastmny());
        }
        //

        if (nPrice != null) {
          itemVOsLenIs1[0].setNprice(nPrice);
        }
        else if (nSettleMny != null && nSettleNum != null
            && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
          // since v502, 支持精度处理
          itemVOsLenIs1[0].setNprice(nSettleMny.div(nSettleNum, iPriceDigit));
        }
        itemVOsLenIs1[0].setNassistnum(
            (itemVOsLenIs1[0].getCastunitid() == null || itemVOsLenIs1[0].getCastunitid().trim().equals("")) 
            ? null : ufdAssistNum);
        vReturn.addElement(billVO);
      }

      /*
       * -----------------暂估分支-------------------------------------
       */
      else {
        // 入库单已暂估
        headerVO.setBestimateflag(new UFBoolean(true));
        // 如果暂估的委外入库单,不管暂估参数设置,改为"单到补差"
        if (sStockTypeCode.trim().equals("47")) {
          strZGmode = "单到补差";
        }
        /*
         * since v55, 支持运费暂估的回冲，要生成新的费用调整单,而且IA单据按费用接口传递到存货核算
         * 如果是基于费用暂估入库单行结算，则要单独处理暂估费用行，取费用调整金额 返回值有三种情况: 1)、null，不必拆分处理
         * 2)、零，拆分处理 3)、非零，拆分处理
         */
        UFDouble ufdAdjustMny = getAdjustMnyForFirstFeeSettle(
            stockVo, settleItemVo, settlebillVO, mapUnitWeightAndVolume, iMnyDigit);
        /*
         * -----------------暂估分支:暂估方式为“单到回冲”，则传送的单据类型为“采购入库单”和“暂估回冲单”--------
         */
        if (strZGmode.trim().equals("单到回冲")) {
          // 先生成“采购入库单”
          if (sStockTypeCode.trim().equals("47")) {
            headerVO.setCbilltypecode("ID");
            itemVOsLenIs1[0].setCbilltypecode("ID");
          }
          else {
            headerVO.setCbilltypecode("I2");
            itemVOsLenIs1[0].setCbilltypecode("I2");
          }
          itemVOsLenIs1[0].setNnumber(nSettleNum);
          itemVOsLenIs1[0].setNmoney(nSettleMny);

          // 合理损耗处理
          if ("Y".equalsIgnoreCase(strIntoCost)) {
            itemVOsLenIs1[0].setNreasonalwastnum(settleItemVo.getNreasonalwastnum());
            itemVOsLenIs1[0].setNreasonalwastprice(settleItemVo.getNreasonalwastprice());
            itemVOsLenIs1[0].setNreasonalwastmny(settleItemVo.getNreasonalwastmny());
          }
          //

          if (nPrice != null) {
            itemVOsLenIs1[0].setNprice(nPrice);
          }
          else if (nSettleMny != null && nSettleNum != null && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
            itemVOsLenIs1[0].setNprice(nSettleMny.div(nSettleNum, iPriceDigit));
          }
          itemVOsLenIs1[0].setNassistnum(
              (itemVOsLenIs1[0].getCastunitid() == null || itemVOsLenIs1[0].getCastunitid().trim().equals("")) 
              ? null : ufdAssistNum);
          //按存货核算要求修改
          ((IBillHeaderVO) billVO.getParentVO()).setBestimateflag(new UFBoolean(false)); 
          // 再生成“暂估回冲单”
          BillVO gRedVO = new BillVO();
          IBillHeaderVO gRedHeaderVO = (IBillHeaderVO) headerVO.clone();
          IBillItemVO gRedItemVO = (IBillItemVO) itemVOsLenIs1[0].clone();

          // 合理损耗处理
          gRedItemVO.setNreasonalwastnum(null);
          gRedItemVO.setNreasonalwastprice(null);
          gRedItemVO.setNreasonalwastmny(null);
          //
          if (nSettleNum != null) {
            gRedItemVO.setNnumber(PuPubVO.getUFDouble_NullAsZero(nSettleNum).multiply(-1.0));
          }
          if (nGaugeMny != null){
            gRedItemVO.setNmoney(new UFDouble(-nGaugeMny.doubleValue()));
          }
          // 支持第一次回冲运费，注意，此处回冲金额应该为暂估的运费金额，而不是本次结算分摊的金额
          if (ufdAdjustMny != null && ufdAdjustMny.doubleValue() != 0.0) {
            gRedItemVO.setNmoney(PuPubVO.getUFDouble_NullAsZero(
                gRedItemVO.getNmoney()).sub(PuPubVO.getUFDouble_NullAsZero(stockVo.getNfeemny())));
          }
          if (gRedItemVO.getNmoney() != null 
              && nSettleNum != null
              && Math.abs(nSettleNum.doubleValue()) >= 0.0) {
            gRedItemVO.setNprice(PuPubVO.getUFDouble_NullAsZero(gRedItemVO.getNmoney()).div(nSettleNum, iPriceDigit));
          }
          gRedItemVO.setNassistnum(
              (gRedItemVO.getCastunitid() == null || gRedItemVO.getCastunitid().trim().equals("")) ? null : ufdAssistNum);
          if (gRedItemVO.getNassistnum() != null){
            gRedItemVO.setNassistnum(gRedItemVO.getNassistnum().multiply(-1));
          }
          Vector vTemp = new Vector();
          vTemp.addElement(gRedItemVO);
          IBillItemVO tempVO[] = new IBillItemVO[1];
          vTemp.copyInto(tempVO);
          gRedVO.setChildrenVO(tempVO);
          gRedVO.setParentVO(gRedHeaderVO);
          //按存货核算要求修改
          ((IBillHeaderVO) gRedVO.getParentVO()).setBestimateflag(new UFBoolean(true)); 
          // 先传“暂估回冲单”，再传“采购入库单”
          vReturn.addElement(gRedVO);
          vReturn.addElement(billVO);
        }
        /*
         * -------------暂估分支:暂估方式为“单到补差”---------------------------------------------------
         */
        else {
          // 调整单不需要辅计量及辅数量
          itemVOsLenIs1[0].setCastunitid(null);
          itemVOsLenIs1[0].setNassistnum(null);
          itemVOsLenIs1[0].setNSettleNum(nSettleNum);
          itemVOsLenIs1[0].setNSettleMny(nSettleMny);
          // 调整单不需要数量、单价
          itemVOsLenIs1[0].setNnumber(null);
          itemVOsLenIs1[0].setNprice(null);
          // 调整金额为结算金额-暂估金额
          if (nSettleMny != null && nGaugeMny != null) {
            itemVOsLenIs1[0].setNmoney(nSettleMny.sub(nGaugeMny));
          }
          /*
           * 采购管理结算后生成入库调整单时将原暂估单据的Id和行ID传入存货核算 since v502, 如果是委外加工入库单，则不传递
           */
          if (!sStockTypeCode.equals("4T") && !sStockTypeCode.equals("47")) {
            itemVOsLenIs1[0].setNadjustnum(nSettleNum);
            itemVOsLenIs1[0].setCadjustbillid(itemVOsLenIs1[0].getCicbillid());
            itemVOsLenIs1[0].setCadjustbillitemid(itemVOsLenIs1[0].getCicitemid());
          }
          // 调整单暂估标志为否
          headerVO.setBestimateflag(UFBoolean.FALSE);
          // 是否采购费用结算标志为否
          itemVOsLenIs1[0].setBretractflag(UFBoolean.FALSE);
          /*
           * -------------暂估分支:暂估方式为“单到补差”:差异转入方式为“转成本”，单据类型为“成本调整单”--------
           */
          if (strCYZRmode.trim().equals("成本")) {
            headerVO.setCbilltypecode("I9");
            itemVOsLenIs1[0].setCbilltypecode("I9");
          }
          /*
           * -------------暂估分支:暂估方式为“单到补差”:差异转入方式为“转损益”，单据类型为“损益调整单”--------
           */
          else {
            headerVO.setCbilltypecode("IG");
            itemVOsLenIs1[0].setCbilltypecode("IG");
            // since V502,如果是损益调整单，要清空调整单的调整ID及调整数量信息--zhongm,2007-11-12-bgn
            itemVOsLenIs1[0].setNadjustnum(null);
            itemVOsLenIs1[0].setCadjustbillid(null);
            itemVOsLenIs1[0].setCadjustbillitemid(null);
            // since V502,如果是损益调整单，要清空调整单的调整ID及调整数量信息--zhongm,2007-11-12-end

            // 合理损耗处理
            if ("Y".equalsIgnoreCase(strIntoCost)) {
              itemVOsLenIs1[0].setNreasonalwastnum(settleItemVo.getNreasonalwastnum());
              itemVOsLenIs1[0].setNreasonalwastprice(settleItemVo.getNreasonalwastprice());
              itemVOsLenIs1[0].setNreasonalwastmny(settleItemVo.getNreasonalwastmny());
            }
          }
          // 非空，则要拆分处理
          BillVO voEstFee = null;
          IBillItemVO itemEstFee = null;
          if (ufdAdjustMny != null) {
            // 生成新单据头
            IBillHeaderVO headerEstFee = (IBillHeaderVO) headerVO.clone();
            headerEstFee.setBEstFeeBill(UFBoolean.TRUE);

            // 生成新单据行，金额取单独拆分出来的费用,拆分费用M-暂估费用
            itemEstFee = (IBillItemVO) itemVOsLenIs1[0].clone();
            itemEstFee.setNmoney(ufdAdjustMny.sub(stockVo.getNfeemny()));
            // 是否采购费用结算标志为是
            itemEstFee.setBretractflag(UFBoolean.TRUE);
            // 生成新单据行，相应的成本要素要取单独拆分出来的费用，拆分费用M
            itemEstFee.setNfactor1(ufdAdjustMny);
            // 生成新单据行，其它的成本要素设置为空
            itemEstFee.setNfactor2(null);
            itemEstFee.setNfactor3(null);
            itemEstFee.setNfactor4(null);
            itemEstFee.setNfactor5(null);
            // 维持原有逻辑，IG不处理
            if (!"IG".equals(itemEstFee.getCbilltypecode())) {
              // 暂估数量作为调整数量
              itemEstFee.setNadjustnum(stockVo.getNinnum());
            }
            //
            voEstFee = new BillVO();
            voEstFee.setChildrenVO(new IBillItemVO[] {itemEstFee});
            voEstFee.setParentVO(headerEstFee);

            // 原行，金额要处理掉单独拆分出来的费用,结算金额-拆分费用M
            itemVOsLenIs1[0].setNmoney(itemVOsLenIs1[0].getNmoney().sub(ufdAdjustMny));
            // 原行，相应的成本要素要处理掉单独拆分出来的费用,相应的成本要素金额-拆分费用M
            itemVOsLenIs1[0].setAttributeValue("nfactor" + stockVo.getIfactorno(),
            // 相应的成本要素金额-拆分费用M
            PuPubVO.getUFDouble_NullAsZero(
                itemVOsLenIs1[0].getAttributeValue("nfactor"  + stockVo.getIfactorno())).sub(ufdAdjustMny));
            // 注意，数量、单价均为空(维持原有逻辑：不必重新计算)
          }
          // 对调整单,若金额为空或为0,不向存货核算传送---货物对应的存货核算单据
          if (itemVOsLenIs1[0].getNmoney() != null && Math.abs(itemVOsLenIs1[0].getNmoney().doubleValue()) > 0.0) {
            vReturn.addElement(billVO);
          }
          // 对调整单,若金额为空或为0,不向存货核算传送---暂估运费对应的存货核算单据
          if (itemEstFee != null && Math.abs(itemEstFee.getNmoney().doubleValue()) > 0.0) {
            vReturn.addElement(voEstFee);
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      PubDMO.throwBusinessException(e);
    }
    if (vReturn.size() > 0) {
      BillVO returnVOs[] = new BillVO[vReturn.size()];
      vReturn.copyInto(returnVOs);
      return returnVOs;
    }
    return null;
  }

  /*
   * <p>结算单行出现第一次暂估费用分摊时，获取需要区分出来的暂估费用针对第一行相应费用发票的调整金额
   *  
   * <p>返回值有三种情况:
   *  
   * <p>1)、null，不必拆分处理
   * <p>2)、零，拆分处理 
   * <p>3)、非零，拆分处理
   * 
   * @since v55
   */
  private UFDouble getAdjustMnyForFirstFeeSettle(StockVO stockVo,
      SettlebillItemVO settleItemVo, SettlebillVO settlebillVO,
      HashMap<String, ArrayList<UFDouble>> mapUnitWeightAndVolume, int iMnyDigit)
      throws BusinessException {
    // 不是第一次，返回空，不必处理
    if (!settleItemVo.isFirstEstFeeSettle()) {
      SCMEnv.out("没有拆分传递存货核算，原因如下：");/*-=notranslate=-*/
      SCMEnv.out("settleItemVo.isFirstEstFeeSettle()==false");
      return null;
    }
    // 暂估费用存货ID为空，返回空，不必处理
    if (PuPubVO.getString_TrimZeroLenAsNull(stockVo.getCfeeid()) == null) {
      SCMEnv.out("没有拆分传递存货核算，原因如下：");/*-=notranslate=-*/
      SCMEnv
          .out("PuPubVO.getString_TrimZeroLenAsNull(stock.getCfeeid()) == null");
      return null;
    }
    // 暂估费用金额为空，返回空，不必处理
    if (PuPubVO.getUFDouble_ZeroAsNull(stockVo.getNfeemny()) == null) {
      SCMEnv.out("没有拆分传递存货核算，原因如下：");/*-=notranslate=-*/
      SCMEnv.out("PuPubVO.getUFDouble_ZeroAsNull(stock.getNfeemny()) == null");
      return null;
    }
    // 暂估费用存货ID在成本要素中是第几位为空，返回空，不必处理
    if (stockVo.getIfactorno() == null) {
      SCMEnv.out("没有拆分传递存货核算，原因如下：");/*-=notranslate=-*/
      SCMEnv.out("stock.getIfactorno() == null");
      return null;
    }
    // 分摊方式为空，返回空，不处理
    if (stockVo.getFapportionmode() == null) {
      SCMEnv.out("没有拆分传递存货核算，原因如下：");/*-=notranslate=-*/
      SCMEnv.out("stock.getFapportionmode() == null");
      return null;
    }
    // 是第一次费用结算，暂估费用ID、暂估金额均非空，但不进入成本，是不存在的情况,抛异常
    if (stockVo.getBcalculatecost() == null
        || !stockVo.getBcalculatecost().booleanValue()) {
      throw new BusinessException(
          "是第一次费用结算，暂估费用ID、暂估金额均非空，但不进入成本，此情况是业务规则不允许出现的!");/*-=notranslate=-*/
    }
    // 结算单成本要素分摊到的金额为空，返回零
    if (PuPubVO.getUFDouble_ZeroAsNull(settleItemVo.getAttributeValue("nfactor"
        + stockVo.getIfactorno())) == null) {
      SCMEnv
          .out("PuPubVO.getUFDouble_ZeroAsNull(settleItemVo.getAttributeValue(“nfactor"
              + stockVo.getIfactorno() + "”)) == null");
      return new UFDouble(0.0);
    }
    // 暂估费用行费用金额
    UFDouble ufdNfeemny = stockVo.getNfeemny();
    // 发票费用：发票行是费用行，存货与入库单暂估费用存货匹配，且是第一次出现的发票行
    UFDouble ufdNFeeFirstmny = null;
    // 参与分摊数(货物发票的数量、金额、重量、体积)
    UFDouble ufdDistribute = null;
    // 参与分摊总数(货物发票的累计数量、累计金额、累计重量、累计体积)
    UFDouble ufdDistributeTotal = new UFDouble(0.0);
    // 分摊因数：参与分摊数/参与分摊总数
    UFDouble ufdDistributeRate = null;
    // 需要区分出来的费用调整金额
    UFDouble ufdAdjustMny = null;
    // 单位体积
    UFDouble ufdUnitVolum = new UFDouble(0.0);
    // 单位重量
    UFDouble ufdUnitWeight = new UFDouble(0.0);

    // 发票费用：发票行是费用行，存货与入库单暂估费用存货匹配，且是第一次出现的发票行
    SettlebillItemVO[] items = settlebillVO.getBodyVO();
    for (SettlebillItemVO item : items) {
      if (item.isFeeRow() && stockVo.getCfeeid().equals(item.getCmangid())) {
        ufdNFeeFirstmny = item.getNmoney();
        break;
      }
    }
    // 确定分摊方式{0数量 1金额 2体积 3重量}
    int iDistrType = stockVo.getFapportionmode().intValue();
    // 单位体积、单位重量
    ArrayList<UFDouble> listUnitInfos = mapUnitWeightAndVolume.get(settleItemVo
        .getCbaseid());
    if (listUnitInfos != null && listUnitInfos.size() >= 2) {
      ufdUnitVolum = PuPubVO.getUFDouble_NullAsZero(listUnitInfos.get(0));
      ufdUnitWeight = PuPubVO.getUFDouble_NullAsZero(listUnitInfos.get(1));
    }
    // 参与分摊数
    ufdDistribute = settleItemVo.getDistributeValue(iDistrType, ufdUnitVolum,
        ufdUnitWeight);
    // 参与分摊总数(针对结算单参与分摊行)
    for (SettlebillItemVO item : items) {
      if (item.isDistribute()) {
        ufdDistributeTotal = ufdDistributeTotal.add(item.getDistributeValue(
            iDistrType, ufdUnitVolum, ufdUnitWeight));
      }
    }
    // 分摊总数为零，返回零
    if (ufdDistributeTotal.doubleValue() == 0.0) {
      return ufdDistributeTotal;
    }
    // 分摊因数：参与分摊数/参与分摊总数
    ufdDistributeRate = ufdDistribute.div(ufdDistributeTotal);
    // 需要区分出来的费用金额 = (结算数量/结算数量累计)*发票费用
    ufdAdjustMny = ufdNFeeFirstmny.multiply(ufdDistributeRate, iMnyDigit);
    //
    return ufdAdjustMny;
  }

  /**
   * 功能描述:向存货核算系统传递数据。（服务于费用单独结算）
   * 输入参数:入库单头VO,入库单体VO,差异转入方式,结算单体VO,当前操作员,当前日期，库存组织 返回值:存货核算VO集合 作者：熊海情 修改：晁志平
   * For V30
   * 
   * @modify zhf
   * @修改时间 2008-07-11
   * @修改说明 v55 费用结算进行了扩展 1》支持调拨入库单 其他入库单 2》支持已暂估 已结算 或 签字直接传存货核算
   *       对已暂估和签字直接传存货核算的入库单 调整单的调整目标为 库存入库单据信息 对已结算调整目标是货物结算单据信息
   */
  private BillVO[] transferIADataForFee(BillVO billVo,
      GeneralHHeaderVO stockHeadVO, UFBoolean[] m_bIsentercost,
      GeneralHItemVO stockBodyVO, String sCYZRmode, SettlebillItemVO VO,
      String cOperator, UFDate dCurrDate, String cCalbody, int iMnyDigit,
      int iNumDigit, String strEstiDealMode) throws BusinessException {
    Vector vReturn = new Vector();
    String strPkCorp = null;
    try {
      strPkCorp = stockHeadVO.getPk_corp();
      // 入库单VO转换为存货核算VO,并且返回该VO及入库单暂估标志
      Vector v = convertVOForIA(billVo, stockHeadVO, stockBodyVO, VO
          .getCsettlebillid(), VO.getCsettlebill_bid(), cOperator, dCurrDate,
          cCalbody);
      UFDouble nSettleMny = VO.getNmoney();
      // zhf
      UFDouble nfactor1 = VO.getNfactor1();
      UFDouble nfactor2 = VO.getNfactor2();
      UFDouble nfactor3 = VO.getNfactor3();
      UFDouble nfactor4 = VO.getNfactor4();
      UFDouble nfactor5 = VO.getNfactor5();
      // end
      BillVO billVO = (BillVO) v.elementAt(0);
      IBillHeaderVO headerVO = (IBillHeaderVO) billVO.getParentVO();
      IBillItemVO itemVO[] = (IBillItemVO[]) billVO.getChildrenVO();
      UFBoolean bZG = (UFBoolean) v.elementAt(1);
      String sStockTypeCode = (String) v.elementAt(2);

      // 费用单独结算,向存货传送调整单
      // 调整单不需要辅计量及辅数量
      for (int i = 0; i < itemVO.length; i++) {
        itemVO[i].setCastunitid(null);
        itemVO[i].setNassistnum(null);
        // 采购管理结算后生成入库调整单时将原库存单据的Id和行ID传入存货核算2004/04/06
        // if (bZG != null && bZG.booleanValue()) {
        //if (!ScmConst.m_purchaseInit.equalsIgnoreCase(sStockTypeCode)) {
          itemVO[i].setCadjustbillid(itemVO[i].getCicbillid());
          itemVO[i].setCadjustbillitemid(itemVO[i].getCicitemid());
        //}
        // }
        //
      }
      if ("成本".equals(sCYZRmode.trim())) {
        // 差异转入方式为“转成本”，单据类型为“成本调整单”
        headerVO.setCbilltypecode("I9");
        headerVO.setBestimateflag(new UFBoolean(false));

        // v5新增
        // zhf modify for v55 支持已暂估的入库单进行费用结算 而已暂估的入库单不必根据结算次数分单
        // 默认赋值 如入库行多次结算 下面继续处理
        itemVO[0].setCbilltypecode("I9");
        itemVO[0].setNnumber(null);
        itemVO[0].setNprice(null);
        itemVO[0].setNmoney(nSettleMny);
        itemVO[0].setBretractflag(new UFBoolean(true));
        itemVO[0].setNadjustnum(stockBodyVO.getNinnum());// 入库数量或暂估数量
        // 传入成本要素

        int ilen = m_bIsentercost == null ? 0 : m_bIsentercost.length;
        for (int j = 0; j < ilen; j++) {
          if (j == 0 && m_bIsentercost[0].booleanValue())
            itemVO[0].setNfactor1(nfactor1);
          if (j == 1 && m_bIsentercost[1].booleanValue())
            itemVO[0].setNfactor2(nfactor2);
          if (j == 2 && m_bIsentercost[2].booleanValue())
            itemVO[0].setNfactor3(nfactor3);
          if (j == 3 && m_bIsentercost[3].booleanValue())
            itemVO[0].setNfactor4(nfactor4);
          if (j == 4 && m_bIsentercost[4].booleanValue())
            itemVO[0].setNfactor5(nfactor5);
        }

        // end

        if (ScmConst.m_allocationIn.equalsIgnoreCase(sStockTypeCode)) {// 调拨入库单费用结算
          if (stockBodyVO != null
              && !stockBodyVO.getCfirsttype().trim().equals(""))// 区分自制情况--当系统未启用内部交易模块时会存在自制调拨入库情况
            if (!stockBodyVO.getBtoinzgflag().booleanValue()
                && !ScmConst.m_sBillZZJDBDD.equalsIgnoreCase(stockBodyVO
                    .getCfirsttype())
                && !ScmConst.m_sBillZZNDBDD.equalsIgnoreCase(stockBodyVO
                    .getCfirsttype())) {
              itemVO = rearrangeBillItemVOForFee(itemVO[0], m_bIsentercost, VO,
                  2, bZG, iMnyDigit, iNumDigit, strEstiDealMode);
            }
        }
        else {
          if (!bZG.booleanValue()
              && !ScmConst.m_otherIn.equalsIgnoreCase(sStockTypeCode)) {

            itemVO = rearrangeBillItemVOForFee(itemVO[0], m_bIsentercost, VO,
                0, bZG, iMnyDigit, iNumDigit, strEstiDealMode);
            //
            for (int i = 0; i < itemVO.length; i++) {
              itemVO[i].setCbilltypecode("I9");
              itemVO[i].setNnumber(null);
              itemVO[i].setNprice(null);
              itemVO[i].setBretractflag(new UFBoolean(true));
            }
          }
        }

        // zhf end 2008-07-10
        billVO.setChildrenVO(itemVO);

        // // 对调整单,若金额为空或为0,不向存货核算传送-----zhf v55调整 支持费用暂估 把对金额的判
        // 放到对暂估金额进行调整处

        // if (itemVO[0].getNmoney() != null
        // && Math.abs(itemVO[0].getNmoney().doubleValue()) > 0.0) {
        vReturn.addElement(billVO);
        // }
      }
      else {
        // 差异转入方式为“转损益”，单据类型为“损益调整单”
        headerVO.setCbilltypecode("IG");
        headerVO.setBestimateflag(new UFBoolean(false));
        itemVO[0].setCbilltypecode("IG");
        itemVO[0].setNnumber(null);
        itemVO[0].setNprice(null);
        itemVO[0].setNmoney(nSettleMny);

        // since V502,
        // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--zhongm,2007-11-12-bgn
        itemVO[0].setNadjustnum(null);
        // itemVO[0].setCadjustbillid(null);------（zhf）暂时先不进行清空，在采购费用结算明细表要记录这两个字段用于反操作的控制，记录后再进行清空
        // itemVO[0].setCadjustbillitemid(null);
        // since V502,
        // 如果是损益调整单，要清空调整单的调整ID及调整数量信息--zhongm,2007-11-12-end

        // zhf-------------
        int ilen = m_bIsentercost == null ? 0 : m_bIsentercost.length;
        for (int j = 0; j < ilen; j++) {
          if (j == 0 && m_bIsentercost[0].booleanValue())
            itemVO[0].setNfactor1(nfactor1);
          if (j == 1 && m_bIsentercost[1].booleanValue())
            itemVO[0].setNfactor2(nfactor2);
          if (j == 2 && m_bIsentercost[2].booleanValue())
            itemVO[0].setNfactor3(nfactor3);
          if (j == 3 && m_bIsentercost[3].booleanValue())
            itemVO[0].setNfactor4(nfactor4);
          if (j == 4 && m_bIsentercost[4].booleanValue())
            itemVO[0].setNfactor5(nfactor5);
        }
        // end

        itemVO[0].setBretractflag(new UFBoolean(true));
        // // 对调整单,若金额为空或为0,不向存货核算传送
        // if (itemVO[0].getNmoney() != null
        // && Math.abs(itemVO[0].getNmoney().doubleValue()) > 0.0) {
        vReturn.addElement(billVO);
        // }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    if (vReturn.size() > 0) {
      BillVO returnVOs[] = new BillVO[vReturn.size()];
      vReturn.copyInto(returnVOs);
      return returnVOs;
    }
    return null;
  }

  /**
   * 费用发票结算，根据对应的多次结算的入库单行拆行
   * 采购入库单10，结算两次，数量分别为6、4，对应采购结算单的行1、行2，针对该行入库单费用结算，原有处理，
   * 对已结算数量生成一行入库调整单；修改为，生成两行入库调整单，分别对应原结算单的行1、行2，
   * 需要将原结算单行1、行2通过IA入库单的（cadjustbillid、cadjustbillitemid）传递到IA 2006-03-29 xhq
   * 
   * @modify zhf
   * @修改日期 2007-07-12
   * @修改说明 添加支持内部交易调拨入库结算的查询 for v55 ---nreasonalwastnum 合理损耗数量 原版代码并未使用
   *       本版删除对该字段的查询取值 修改参数 boolean bisvmi---->int sourceFlag 扩展为支持三种类型结算单据的查询
   *       0 采购普通业务 1 vmi 2 内部交易调拨入库结算
   * @合并项目问题：czp_NC_SCM_PU5.02_费用结算-单到回冲-存在暂估成本与结算无差异的采购入库单行时-费用结算成功-但成本计算失败_2008-8-13_init
   */
  public IBillItemVO[] rearrangeBillItemVOForFee(IBillItemVO itemVO,
      UFBoolean[] m_bIsentercost, SettlebillItemVO VO, int sourceFlag,
      UFBoolean bZG, int iMnyDigit, int iNumDigit, String strEstiDealMode)
      throws Exception {

    Hashtable hSettle = null;
    if (sourceFlag == 0) {// 采购普通货物结算
      hSettle = new PubDMO().queryHtResultFromAnyTable("po_settlebill_b",
          "cstockrow", new String[] {
              "csettlebillid", "csettlebill_bid", "nsettlenum"
          }, " dr = 0 and cstockrow = '" + itemVO.getCbill_bid() + "'");
    }
    else if (sourceFlag == 1) {// 采购vmi货物结算
      hSettle = new PubDMO().queryHtResultFromAnyTable("po_settlebill_b",
          "cvmiid", new String[] {
              "csettlebillid", "csettlebill_bid", "nsettlenum"
          }, " dr = 0 and cvmiid = '" + itemVO.getCbill_bid() + "'");
    }
    else {// 内部交易调拨入库结算
      hSettle = new PubDMO().queryHtResultFromAnyTable("to_settlelist_b A inner join to_settlelist_bb B on A.csettlelist_bid = B.csettlelist_bid ",
          "A.cothersrcbid", new String[] {
              "A.csettlelistid", "B.csettlelist_bbid", "A.nnumber"
          },//
          " A.dr = 0 and B.dr = 0 and B.cdowncorpid = '"+VO.getPk_corp()+"' and cothersrcbid = '" + itemVO.getCbill_bid() + "'");
    }
    if (hSettle == null || hSettle.size() == 0)
      return new IBillItemVO[] {
        itemVO
      };

    Vector vTemp = null, v1 = new Vector();
    Object key = null, data = null, d[] = null;
    UFDouble nSettleNum = null;// nSettleMny = null, nGaugeMny = null;
    String unitCode = itemVO.getPk_corp();
    IBillItemVO tempVO = null;

    Enumeration keys = hSettle.keys();
    double total = 0, dd = 0;
    while (keys.hasMoreElements()) {
      key = keys.nextElement();
      data = hSettle.get(key);
      if (data != null) {
        vTemp = (Vector) data;
        if (vTemp != null && vTemp.size() > 0) {
          for (int i = 0; i < vTemp.size(); i++) {
            d = (Object[]) vTemp.elementAt(i);
            if (d == null || d.length < 3)
              continue;
            if (d[2] != null)
              nSettleNum = new UFDouble(d[2].toString());
            else
              nSettleNum = new UFDouble(0);
            // since v53
            // if (Math.abs(nSettleNum.doubleValue()) < nc.bs.ps.vmi.VMIDMO
            // .getUFDoubleForLocalDigit(unitCode)
            // .doubleValue())
            if (Math.abs(nSettleNum.doubleValue()) < PuPubVO.getDigitVal(
                iNumDigit).doubleValue()) {
              continue;
            }

            tempVO = (IBillItemVO) itemVO.clone();
            tempVO.setNadjustnum(nSettleNum);
            total += nSettleNum.doubleValue();

//            if (d[3] != null)
//              nSettleMny = new UFDouble(d[3].toString());
//            else
//              nSettleMny = new UFDouble(0);
//            if (d[4] != null)
//              nGaugeMny = new UFDouble(d[4].toString());
//            else
//              nGaugeMny = new UFDouble(0);

            // since v55, 修正设计缺陷，历史版本未考虑单到回冲情况!

            // 如果是单到回冲，则无论是否已经暂估，都传递结算单ID做为调整单ID
            if ("单到回冲".equals(strEstiDealMode)) {
              if (d[0] != null)
                tempVO.setCadjustbillid(d[0].toString());
              if (d[1] != null)
                tempVO.setCadjustbillitemid(d[1].toString());
            }
            // 单到补丁差或未暂估情况--------v55调整支持暂估过的入库单做费用结算
            else {
              // 如果采购结算没有产生调整单,则继续传库存单据ID, 否则传结算单据ID
              // 2006-10-24 LJQ
//              double ddd = Math.abs(nSettleMny.doubleValue()
//                  - nGaugeMny.doubleValue());
              // 暂估过，单到补丁且结算金额与暂估金额有差异，即产生过调整单，入库调整单传结算单ID
//              if (bZG.booleanValue()) {
//                if (d[0] != null)
//                  tempVO.setCadjustbillid(d[0].toString());
//                if (d[1] != null)
//                  tempVO.setCadjustbillitemid(d[1].toString());
//              }
              // 未暂估，入库调整单传结算单ID
//              else {
                if (d[0] != null)
                  tempVO.setCadjustbillid(d[0].toString());
                if (d[1] != null)
                  tempVO.setCadjustbillitemid(d[1].toString());
//              }
            }
            //
            v1.addElement(tempVO);
          }
        }
      }
    }

    if (v1.size() == 0)
      return new IBillItemVO[] {
        itemVO
      };

    IBillItemVO bodyVO[] = new IBillItemVO[v1.size()];
    v1.copyInto(bodyVO);

    double ddd = 0;
    UFDouble dCurVal = new UFDouble(0.0);// 当前分配的金额
    UFDouble dAllUsed = new UFDouble(0.0);// 已经分配过所有金额汇总，倒挤用到

    // zhf
    UFDouble ufCurFactor1 = new UFDouble(0.0), ufCurFactor2 = new UFDouble(0.0), ufCurFactor3 = new UFDouble(
        0.0), ufCurFactor4 = new UFDouble(0.0), ufCurFactor5 = new UFDouble(0.0);// 当前分配的成本要素
    UFDouble ufAllFactor1 = new UFDouble(0.0), ufAllFactor2 = new UFDouble(0.0), ufAllFactor3 = new UFDouble(
        0.0), ufAllFactor4 = new UFDouble(0.0), ufAllFactor5 = new UFDouble(0.0);// 已经分配过所以成本要素汇总，倒挤用到
    int ilen = m_bIsentercost == null ? 0 : m_bIsentercost.length;
    // end

    String s = null;
    for (int i = 0; i < bodyVO.length; i++) {
      s = VO.getCstockrow();
      if (sourceFlag == 1)
        s = VO.getCvmiid();
      if (bodyVO[i].getCbill_bid().equals(s)) {
        // since v53
        if (Math.abs(total) < PuPubVO.getDigitVal(iNumDigit).doubleValue()) {
          // if (Math.abs(total) < nc.bs.ps.vmi.VMIDMO
          // .getUFDoubleForLocalDigit(unitCode).doubleValue())
          bodyVO[i].setNmoney(VO.getNmoney());

          for (int j = 0; j < ilen; j++) {
            if (j == 0 && m_bIsentercost[0].booleanValue())
              bodyVO[i].setNfactor1(VO.getNfactor1());
            if (j == 1 && m_bIsentercost[1].booleanValue())
              bodyVO[i].setNfactor2(VO.getNfactor2());
            if (j == 2 && m_bIsentercost[2].booleanValue())
              bodyVO[i].setNfactor3(VO.getNfactor3());
            if (j == 3 && m_bIsentercost[3].booleanValue())
              bodyVO[i].setNfactor4(VO.getNfactor4());
            if (j == 4 && m_bIsentercost[4].booleanValue())
              bodyVO[i].setNfactor5(VO.getNfactor5());
          }

        }
        else {
          dCurVal = VO.getNmoney().multiply(
              bodyVO[i].getNadjustnum().div(total), iMnyDigit);

          // int ilen = m_bIsentercost==null?0:m_bIsentercost.length;
          for (int j = 0; j < ilen; j++) {
            if (j == 0 && VO.getNfactor1() != null
                && Math.abs(VO.getNfactor1().doubleValue()) > 0
                && m_bIsentercost[0].booleanValue()) {
              ufCurFactor1 = VO.getNfactor1().multiply(
                  bodyVO[i].getNadjustnum().div(total), iMnyDigit);
            }
            if (j == 1 && VO.getNfactor2() != null
                && Math.abs(VO.getNfactor2().doubleValue()) > 0
                && m_bIsentercost[1].booleanValue()) {
              ufCurFactor2 = VO.getNfactor2().multiply(
                  bodyVO[i].getNadjustnum().div(total), iMnyDigit);
            }
            if (j == 2 && VO.getNfactor3() != null
                && Math.abs(VO.getNfactor3().doubleValue()) > 0
                && m_bIsentercost[2].booleanValue()) {
              ufCurFactor3 = VO.getNfactor3().multiply(
                  bodyVO[i].getNadjustnum().div(total), iMnyDigit);
            }
            if (j == 3 && VO.getNfactor4() != null
                && Math.abs(VO.getNfactor4().doubleValue()) > 0
                && m_bIsentercost[3].booleanValue()) {
              ufCurFactor4 = VO.getNfactor4().multiply(
                  bodyVO[i].getNadjustnum().div(total), iMnyDigit);
            }
            if (j == 4 && VO.getNfactor5() != null
                && Math.abs(VO.getNfactor5().doubleValue()) > 0
                && m_bIsentercost[4].booleanValue()) {
              ufCurFactor5 = VO.getNfactor5().multiply(
                  bodyVO[i].getNadjustnum().div(total), iMnyDigit);
            }
          }

          if ((i == bodyVO.length - 1) && i != 0) {
            dCurVal = VO.getNmoney().sub(dAllUsed);

            for (int j = 0; j < ilen; j++) {
              if (j == 0 && VO.getNfactor1() != null) {
                ufCurFactor1 = VO.getNfactor1().sub(ufAllFactor1);
              }
              if (j == 1 && VO.getNfactor2() != null) {
                ufCurFactor2 = VO.getNfactor2().sub(ufAllFactor2);
              }
              if (j == 2 && VO.getNfactor3() != null) {
                ufCurFactor3 = VO.getNfactor3().sub(ufAllFactor3);
              }
              if (j == 3 && VO.getNfactor4() != null) {
                ufCurFactor4 = VO.getNfactor4().sub(ufAllFactor4);
              }
              if (j == 4 && VO.getNfactor5() != null) {
                ufCurFactor5 = VO.getNfactor5().sub(ufAllFactor5);
              }
            }
          }
          else {
            dAllUsed = dAllUsed.add(dCurVal);

            for (int j = 0; j < ilen; j++) {
              if (j == 0 && VO.getNfactor1() != null) {
                ufAllFactor1 = ufAllFactor1.add(ufCurFactor1);
              }
              if (j == 1 && VO.getNfactor2() != null) {
                ufAllFactor2 = ufAllFactor2.add(ufCurFactor2);
              }
              if (j == 2 && VO.getNfactor3() != null) {
                ufAllFactor3 = ufAllFactor3.add(ufCurFactor3);
              }
              if (j == 3 && VO.getNfactor4() != null) {
                ufAllFactor4 = ufAllFactor4.add(ufCurFactor4);
              }
              if (j == 4 && VO.getNfactor5() != null) {
                ufAllFactor5 = ufAllFactor5.add(ufCurFactor5);
              }
            }
          }
          //
          bodyVO[i].setNmoney(dCurVal);
          bodyVO[i].setNfactor1(ufCurFactor1);
          bodyVO[i].setNfactor2(ufCurFactor2);
          bodyVO[i].setNfactor3(ufCurFactor3);
          bodyVO[i].setNfactor4(ufCurFactor4);
          bodyVO[i].setNfactor5(ufCurFactor5);
        }
      }
    }
    return bodyVO;
  }

  /**
   * 功能描述:结算单作废时删除存货核算相关单据 输入参数: String cGeneralhid[], 入库单头ID[] String
   * cOperator, 操作员ID 作者：熊海情 修改：晁志平 For V30
   */
  private void deleteBillFromOutters(String cGeneralhid[], String strLoginCorp,
      String cOperator) throws BusinessException {
    // IIAToPUBill myService = null;
    try {
      // myService = (IIAToPUBill) new
      // InterServBO().getInterInstance(ProductCode.PROD_IA,InterRegister.IA0101);
      // myService = (IIAToPUBill)
      // NCLocator.getInstance().lookup(IIAToPUBill.class.getName());
      // myService.deleteBillFromOutterArray(cGeneralhid, cPkcorp,
      // cOperator);
      IIAToPU myService = (IIAToPU) NCLocator.getInstance().lookup(
          IIAToPU.class.getName());
      myService.unSettlePU(cGeneralhid, PuUtils.getClintLink(strLoginCorp,
          cOperator, BsPuTool.getLoginDate()));
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 功能描述:业务类型为直运时，订单生成发票结算 作者：熊海情 修改：晁志平 For V30
   */
  public boolean doDirectInvoiceBalance(String accountYear, UFDate currentDate,
      String busitypeID, String operatorID, String strLoginCorpId,
      InvoiceVO invoiceVO, String cStoreOrganizationID[], String strOprType)
      throws BusinessException {
    String vSettlebillcode = "";
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();
    boolean bGetBillCodeSucc = false;
    SettlebillVO voBillcode = null;
    try {
      // 生成结算单号
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      SettlebillHeaderVO head = new SettlebillHeaderVO();
      head.setPk_corp(strLoginCorpId);
      voBillcode = new SettlebillVO(1);
      voBillcode.setParentVO(head);
      voBillcode.setChildrenVO(new SettlebillItemVO[] {
        new SettlebillItemVO()
      });
      do {
        vSettlebillcode = billCode.getSysBillNO(voBillcode);
      }
      while (isSettlebillCodeDuplicate(strLoginCorpId, vSettlebillcode));
      bGetBillCodeSucc = true;

      timer.addExecutePhase("生成结算单号");

      DirectInvoiceSettle directInvoiceSettle = new DirectInvoiceSettle(
          accountYear, currentDate, busitypeID, operatorID, strLoginCorpId,
          vSettlebillcode);
      // 执行结算
      Vector v = directInvoiceSettle.doBalance(invoiceVO, cStoreOrganizationID, strOprType);

      timer.addExecutePhase("执行结算");

      // 存货核算启用,向存货核算传送数据
      if (v != null && v.size() > 0) {
        IinvoiceVO invoiceVOs[] = (IinvoiceVO[]) v.elementAt(0);
        SettlebillVO settlebillVO = (SettlebillVO) v.elementAt(1);
        if (invoiceVOs != null && invoiceVOs.length > 0) {
          ICreateCorpQueryService myService0 = null;
          myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
              .getInstance().lookup(ICreateCorpQueryService.class.getName());
          boolean bIAStartUp = myService0.isEnabled(strLoginCorpId, "IA");
          if (bIAStartUp) {
            saveBillFromOutterForDirect(invoiceVOs, cStoreOrganizationID,
                currentDate, settlebillVO, operatorID, strLoginCorpId);
          }
        }
        timer.addExecutePhase("向存货核算传送数据");
        //
        timer.showAllExecutePhase("业务类型为直运时，订单生成发票结算时间分布");

        return true;
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            nc.bs.pu.pub.GetSysBillCode billCode1 = new nc.bs.pu.pub.GetSysBillCode();
            billCode1.returnBillNo(voBillcode);
          }
          catch (Exception ex) {
            /* 已经抛出异常!{此处注释针对工具检测未抛出} */
            nc.bs.pu.pub.PubDMO.throwBusinessException(ex);
          }
        }
      }
    }
    catch (Exception e) {
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(voBillcode);
        }
        catch (Exception ex) {
          /* 已经抛出异常!{此处注释针对工具检测未抛出} */
          nc.bs.pu.pub.PubDMO.throwBusinessException(e);
        }
      }
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    timer.showAllExecutePhase("业务类型为直运时，订单生成发票结算时间分布");
    return false;
  }

  /**
   * 功能描述:入库单生成发票时结算 作者：熊海情 修改：晁志平 For V30
   * 增加是否需要给入库单加锁处理(有两种情况：发票保存时不需要加锁、发票审批时需要)
   */
  public ArrayList doStockToInvoiceSettle(String accountYear,
      UFDate currentDate, String busitypeID, String operatorID,
      String unitCode, InvoiceVO invoiceVO,
      GeneralBillHeaderVO generalBillHeaderVOs[],
      GeneralBillItemVO generalBillItemVOs[], GeneralBb3VO generalBb3VOs[],
      String sEstMode, String sDiffMode, UFBoolean ufbNeedLock, String strOprType)
      throws BusinessException {

    ArrayList listLockId = null;
    boolean bLockSucc = false;
    String vSettlebillcode = "";
    SettlebillVO voBillCode = null;
    boolean bGetBillCodeSucc = false;
    UFBoolean bSucceed = new UFBoolean(false);

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    try {
      
      // 生成结算单号
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      SettlebillHeaderVO head = new SettlebillHeaderVO();
      head.setPk_corp(unitCode);
      voBillCode = new SettlebillVO(1);
      voBillCode.setParentVO(head);
      voBillCode.setChildrenVO(new SettlebillItemVO[] {
        new SettlebillItemVO()
      });
      do {
        vSettlebillcode = billCode.getSysBillNO(voBillCode);
      }
      while (isSettlebillCodeDuplicate(unitCode, vSettlebillcode));
      voBillCode.getHeadVO().setVsettlebillcode(vSettlebillcode);
      bGetBillCodeSucc = true;

      timer.addExecutePhase("生成结算单号");

      // 来自库存的入库单VO转化为采购结算的入库单VO
      GeneralHHeaderVO generalHHeaderVOs[] = new GeneralHHeaderVO[generalBillHeaderVOs.length];
      InvoiceItemVO invoiceItemVO[] = invoiceVO.getBodyVO();
      InvoiceHeaderVO invoiceHeaderVO = invoiceVO.getHeadVO();
      for (int i = 0; i < generalHHeaderVOs.length; i++) {
        generalHHeaderVOs[i] = new GeneralHHeaderVO();
        generalHHeaderVOs[i].setCbiztype(generalBillHeaderVOs[i]
            .getCbiztypeid());
        generalHHeaderVOs[i].setCdptid(generalBillHeaderVOs[i].getCdptid());
        generalHHeaderVOs[i].setCgeneralhid(generalBillHeaderVOs[i]
            .getCgeneralhid());
        generalHHeaderVOs[i].setCoperatorid(generalBillHeaderVOs[i]
            .getCoperatorid());
        generalHHeaderVOs[i].setCproviderid(generalBillHeaderVOs[i]
            .getCproviderid());
        generalHHeaderVOs[i].setPk_corp(generalBillHeaderVOs[i].getPk_corp());

        // since v502,增加处理采购公司
        generalHHeaderVOs[i].setPk_purcorp(PuPubVO
            .getString_TrimZeroLenAsNull(generalBillHeaderVOs[i]
                .getAttributeValue("pk_purcorp")));
        //
        generalHHeaderVOs[i].setVbillcode(generalBillHeaderVOs[i]
            .getVbillcode());

        // 20071019
        generalHHeaderVOs[i].setCdispatcherid(generalBillHeaderVOs[i]
            .getCdispatcherid());

        generalHHeaderVOs[i].setCbilltypecode(generalBillHeaderVOs[i]
            .getCbilltypecode());
        generalHHeaderVOs[i].setCwarehouseid(generalBillHeaderVOs[i]
            .getCwarehouseid());
        generalHHeaderVOs[i]
            .setCstoreorganization((String) generalBillHeaderVOs[i]
                .getAttributeValue("pk_calbody"));
        generalHHeaderVOs[i].setCbizid(generalBillHeaderVOs[i].getCbizid());

        generalHHeaderVOs[i].setVuserdef1(invoiceHeaderVO.getVdef1());
        generalHHeaderVOs[i].setVuserdef2(invoiceHeaderVO.getVdef2());
        generalHHeaderVOs[i].setVuserdef3(invoiceHeaderVO.getVdef3());
        generalHHeaderVOs[i].setVuserdef4(invoiceHeaderVO.getVdef4());
        generalHHeaderVOs[i].setVuserdef5(invoiceHeaderVO.getVdef5());
        generalHHeaderVOs[i].setVuserdef6(invoiceHeaderVO.getVdef6());
        generalHHeaderVOs[i].setVuserdef7(invoiceHeaderVO.getVdef7());
        generalHHeaderVOs[i].setVuserdef8(invoiceHeaderVO.getVdef8());
        generalHHeaderVOs[i].setVuserdef9(invoiceHeaderVO.getVdef9());
        generalHHeaderVOs[i].setVuserdef10(invoiceHeaderVO.getVdef10());

        generalHHeaderVOs[i].setVuserdef11(invoiceHeaderVO.getVdef11());
        generalHHeaderVOs[i].setVuserdef12(invoiceHeaderVO.getVdef12());
        generalHHeaderVOs[i].setVuserdef13(invoiceHeaderVO.getVdef13());
        generalHHeaderVOs[i].setVuserdef14(invoiceHeaderVO.getVdef14());
        generalHHeaderVOs[i].setVuserdef15(invoiceHeaderVO.getVdef15());
        generalHHeaderVOs[i].setVuserdef16(invoiceHeaderVO.getVdef16());
        generalHHeaderVOs[i].setVuserdef17(invoiceHeaderVO.getVdef17());
        generalHHeaderVOs[i].setVuserdef18(invoiceHeaderVO.getVdef18());
        generalHHeaderVOs[i].setVuserdef19(invoiceHeaderVO.getVdef19());
        generalHHeaderVOs[i].setVuserdef20(invoiceHeaderVO.getVdef20());

        generalHHeaderVOs[i].setPk_defdoc1(invoiceHeaderVO.getPKDefDoc1());
        generalHHeaderVOs[i].setPk_defdoc2(invoiceHeaderVO.getPKDefDoc2());
        generalHHeaderVOs[i].setPk_defdoc3(invoiceHeaderVO.getPKDefDoc3());
        generalHHeaderVOs[i].setPk_defdoc4(invoiceHeaderVO.getPKDefDoc4());
        generalHHeaderVOs[i].setPk_defdoc5(invoiceHeaderVO.getPKDefDoc5());
        generalHHeaderVOs[i].setPk_defdoc6(invoiceHeaderVO.getPKDefDoc6());
        generalHHeaderVOs[i].setPk_defdoc7(invoiceHeaderVO.getPKDefDoc7());
        generalHHeaderVOs[i].setPk_defdoc8(invoiceHeaderVO.getPKDefDoc8());
        generalHHeaderVOs[i].setPk_defdoc9(invoiceHeaderVO.getPKDefDoc9());
        generalHHeaderVOs[i].setPk_defdoc10(invoiceHeaderVO.getPKDefDoc10());

        generalHHeaderVOs[i].setPk_defdoc11(invoiceHeaderVO.getPKDefDoc11());
        generalHHeaderVOs[i].setPk_defdoc12(invoiceHeaderVO.getPKDefDoc12());
        generalHHeaderVOs[i].setPk_defdoc13(invoiceHeaderVO.getPKDefDoc13());
        generalHHeaderVOs[i].setPk_defdoc14(invoiceHeaderVO.getPKDefDoc14());
        generalHHeaderVOs[i].setPk_defdoc15(invoiceHeaderVO.getPKDefDoc15());
        generalHHeaderVOs[i].setPk_defdoc16(invoiceHeaderVO.getPKDefDoc16());
        generalHHeaderVOs[i].setPk_defdoc17(invoiceHeaderVO.getPKDefDoc17());
        generalHHeaderVOs[i].setPk_defdoc18(invoiceHeaderVO.getPKDefDoc18());
        generalHHeaderVOs[i].setPk_defdoc19(invoiceHeaderVO.getPKDefDoc19());
        generalHHeaderVOs[i].setPk_defdoc20(invoiceHeaderVO.getPKDefDoc20());
      }

      GeneralHItemVO generalHItemVOs[] = new GeneralHItemVO[generalBillItemVOs.length];
      for (int i = 0; i < generalHItemVOs.length; i++) {
        generalHItemVOs[i] = new GeneralHItemVO();
        // since v502,
        generalHItemVOs[i].setCastunitid(generalBillItemVOs[i].getCastunitid());
        generalHItemVOs[i].setHsl(generalBillItemVOs[i].getHsl());
        //
        generalHItemVOs[i].setCgeneralbid(generalBillItemVOs[i]
            .getCgeneralbid());
        generalHItemVOs[i].setCgeneralhid(generalBillItemVOs[i]
            .getCgeneralhid());
        generalHItemVOs[i].setCinventoryid(generalBillItemVOs[i]
            .getCinventoryid());
        generalHItemVOs[i].setCbaseid(generalBillItemVOs[i].getCinvbasid());
        generalHItemVOs[i].setDbizdate(generalBillItemVOs[i].getDbizdate());
        generalHItemVOs[i].setCsourcebillbid(generalBillItemVOs[i]
            .getCsourcebillbid());
        generalHItemVOs[i].setCsourcebillhid(generalBillItemVOs[i]
            .getCsourcebillhid());
        generalHItemVOs[i].setCsourcetype(generalBillItemVOs[i]
            .getCsourcetype());
        generalHItemVOs[i].setNinnum(generalBillItemVOs[i].getNinnum());
        generalHItemVOs[i].setNmny(generalBillItemVOs[i].getNmny());
        generalHItemVOs[i].setVsourcebillcode(generalBillItemVOs[i]
            .getVsourcebillcode());

        generalHItemVOs[i].setCfirstbillbid(generalBillItemVOs[i]
            .getCfirstbillbid());
        generalHItemVOs[i].setCfirstbillhid(generalBillItemVOs[i]
            .getCfirstbillhid());
        generalHItemVOs[i].setCfirsttype(generalBillItemVOs[i].getCfirsttype());
        generalHItemVOs[i].setPk_invoicecorp((String) generalBillItemVOs[i]
            .getAttributeValue("pk_invoicecorp"));
        generalHItemVOs[i].setBzgflag(generalBillItemVOs[i].getBzgflag());
        Object oTemp = generalBillItemVOs[i].getAttributeValue("bzgyfflag");
        if (oTemp == null)
          generalHItemVOs[i].setBzgyfflag(new UFBoolean(false));
        else
          generalHItemVOs[i].setBzgyfflag(new UFBoolean(oTemp.toString()));

        generalHItemVOs[i].setVfree1(invoiceItemVO[i].getVfree1());
        generalHItemVOs[i].setVfree2(invoiceItemVO[i].getVfree2());
        generalHItemVOs[i].setVfree3(invoiceItemVO[i].getVfree3());
        generalHItemVOs[i].setVfree4(invoiceItemVO[i].getVfree4());
        generalHItemVOs[i].setVfree5(invoiceItemVO[i].getVfree5());
        generalHItemVOs[i].setVbatchcode(generalBillItemVOs[i].getVbatchcode());

        generalHItemVOs[i].setVuserdef1(invoiceItemVO[i].getVdef1());
        generalHItemVOs[i].setVuserdef2(invoiceItemVO[i].getVdef2());
        generalHItemVOs[i].setVuserdef3(invoiceItemVO[i].getVdef3());
        generalHItemVOs[i].setVuserdef4(invoiceItemVO[i].getVdef4());
        generalHItemVOs[i].setVuserdef5(invoiceItemVO[i].getVdef5());
        generalHItemVOs[i].setVuserdef6(invoiceItemVO[i].getVdef6());
        generalHItemVOs[i].setVuserdef7(invoiceItemVO[i].getVdef7());
        generalHItemVOs[i].setVuserdef8(invoiceItemVO[i].getVdef8());
        generalHItemVOs[i].setVuserdef9(invoiceItemVO[i].getVdef9());
        generalHItemVOs[i].setVuserdef10(invoiceItemVO[i].getVdef10());

        generalHItemVOs[i].setVuserdef11(invoiceItemVO[i].getVdef11());
        generalHItemVOs[i].setVuserdef12(invoiceItemVO[i].getVdef12());
        generalHItemVOs[i].setVuserdef13(invoiceItemVO[i].getVdef13());
        generalHItemVOs[i].setVuserdef14(invoiceItemVO[i].getVdef14());
        generalHItemVOs[i].setVuserdef15(invoiceItemVO[i].getVdef15());
        generalHItemVOs[i].setVuserdef16(invoiceItemVO[i].getVdef16());
        generalHItemVOs[i].setVuserdef17(invoiceItemVO[i].getVdef17());
        generalHItemVOs[i].setVuserdef18(invoiceItemVO[i].getVdef18());
        generalHItemVOs[i].setVuserdef19(invoiceItemVO[i].getVdef19());
        generalHItemVOs[i].setVuserdef20(invoiceItemVO[i].getVdef20());

        generalHItemVOs[i].setPk_defdoc1(invoiceItemVO[i].getPKDefDoc1());
        generalHItemVOs[i].setPk_defdoc2(invoiceItemVO[i].getPKDefDoc2());
        generalHItemVOs[i].setPk_defdoc3(invoiceItemVO[i].getPKDefDoc3());
        generalHItemVOs[i].setPk_defdoc4(invoiceItemVO[i].getPKDefDoc4());
        generalHItemVOs[i].setPk_defdoc5(invoiceItemVO[i].getPKDefDoc5());
        generalHItemVOs[i].setPk_defdoc6(invoiceItemVO[i].getPKDefDoc6());
        generalHItemVOs[i].setPk_defdoc7(invoiceItemVO[i].getPKDefDoc7());
        generalHItemVOs[i].setPk_defdoc8(invoiceItemVO[i].getPKDefDoc8());
        generalHItemVOs[i].setPk_defdoc9(invoiceItemVO[i].getPKDefDoc9());
        generalHItemVOs[i].setPk_defdoc10(invoiceItemVO[i].getPKDefDoc10());

        generalHItemVOs[i].setPk_defdoc11(invoiceItemVO[i].getPKDefDoc11());
        generalHItemVOs[i].setPk_defdoc12(invoiceItemVO[i].getPKDefDoc12());
        generalHItemVOs[i].setPk_defdoc13(invoiceItemVO[i].getPKDefDoc13());
        generalHItemVOs[i].setPk_defdoc14(invoiceItemVO[i].getPKDefDoc14());
        generalHItemVOs[i].setPk_defdoc15(invoiceItemVO[i].getPKDefDoc15());
        generalHItemVOs[i].setPk_defdoc16(invoiceItemVO[i].getPKDefDoc16());
        generalHItemVOs[i].setPk_defdoc17(invoiceItemVO[i].getPKDefDoc17());
        generalHItemVOs[i].setPk_defdoc18(invoiceItemVO[i].getPKDefDoc18());
        generalHItemVOs[i].setPk_defdoc19(invoiceItemVO[i].getPKDefDoc19());
        generalHItemVOs[i].setPk_defdoc20(invoiceItemVO[i].getPKDefDoc20());

        generalHItemVOs[i].setCprojectid(generalBillItemVOs[i].getCprojectid());
        generalHItemVOs[i].setCprojectphaseid(generalBillItemVOs[i]
            .getCprojectphaseid());
        generalHItemVOs[i].setVfirstbillcode(generalBillItemVOs[i]
            .getVfirstbillcode());
      }

      timer.addExecutePhase("来自库存的入库单VO转化为采购结算的入库单VO");

      // 执行结算
      StockToInvoiceSettle stockToInvoice = new StockToInvoiceSettle(
          accountYear, currentDate, busitypeID, operatorID, unitCode,
          vSettlebillcode);
      Vector v = stockToInvoice.doBalance(invoiceVO, generalHHeaderVOs,
          generalHItemVOs, generalBb3VOs, strOprType);

      timer.addExecutePhase("执行结算");

      if (v != null && v.size() > 0) {
        bSucceed = new UFBoolean(true);
        StockVO stockVOs[] = (StockVO[]) v.elementAt(0);
        SettlebillVO settlebillVO = (SettlebillVO) v.elementAt(1);
        // 判断存货核算是否启用
        if (stockVOs != null && stockVOs.length > 0) {
          ICreateCorpQueryService myService0 = null;
          String[] saLockId = null;
          myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
              .getInstance().lookup(ICreateCorpQueryService.class.getName());
          boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");
          if (bIAStartUp) {
            // 对参与结算的入库单ID加锁(解锁在采购发票审批：N_25_APPROVE中完成)
            if (ufbNeedLock.booleanValue()) {
              listLockId = new ArrayList();
              int iLen = stockVOs.length;
              for (int i = 0; i < iLen; i++) {
                if (stockVOs[i].getCgeneralhid() != null) {
                  listLockId.add(stockVOs[i].getCgeneralhid());
                }
                if (stockVOs[i].getCgeneralbid() != null) {
                  listLockId.add(stockVOs[i].getCgeneralbid());
                }
                if (stockVOs[i].getCgeneralbb3() != null) {
                  listLockId.add(stockVOs[i].getCgeneralbb3());
                }
              }
              if (listLockId != null && listLockId.size() > 0) {
                saLockId = new String[listLockId.size()];
                saLockId = (String[]) listLockId.toArray(saLockId);
                bLockSucc = LockTool.setLockForPks(saLockId, operatorID);
                if (!bLockSucc) {
                  throw new Exception(nc.bs.ml.NCLangResOnserver.getInstance()
                      .getStrByID("40040502", "UPP40040502-000040")/*
                                                                     * @res
                                                                     * "参与结算的入库单或红发票正在被占用，本次发票趋动的自动结算失败!"
                                                                     */);
                }
              }
            }
            // 向存货核算传送数据
            ArrayList listPara = new ArrayList();
            listPara.add(sEstMode);
            listPara.add(sDiffMode);
            listPara.add(settlebillVO);
            listPara.add(operatorID);
            listPara.add(currentDate);
            listPara.add(generalHItemVOs);
            listPara.add(null);
            listPara.add(null);// since v55
            listPara.add(null);// since v55
            saveBillFromOutter1(listPara);
          }
        }
      }
      else {
        // 结算失败,回退结算单号
        if (bGetBillCodeSucc) {
          try {
            nc.bs.pu.pub.GetSysBillCode billCode1 = new nc.bs.pu.pub.GetSysBillCode();
            billCode1.returnBillNo(voBillCode);
          }
          catch (Exception ex) {
            /* 已经抛出异常!{此处注释针对工具检测未抛出} */
            nc.bs.pu.pub.PubDMO.throwBusinessException(ex);
          }
        }
      }
      timer.addExecutePhase("向存货核算传送数据(总)");

      timer.showAllExecutePhase("入库单生成发票时结算时间分布");

    }
    catch (Exception e) {
      // 结算失败,回退结算单号
      if (bGetBillCodeSucc) {
        try {
          nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
          billCode.returnBillNo(voBillCode);
        }
        catch (Exception ex) {
          /* 已经抛出异常!{此处注释针对工具检测未抛出} */
          nc.bs.pu.pub.PubDMO.throwBusinessException(e);
        }
      }
      /* 调用采购公用方法按规范抛出异常 */
      if (bLockSucc && listLockId != null && listLockId.size() > 0) {
        String saLockId[] = new String[listLockId.size()];
        saLockId = (String[]) listLockId.toArray(saLockId);
        try {
          LockTool.releaseLockForPks(saLockId, operatorID);
        }
        catch (Exception ee) {
          nc.bs.pu.pub.PubDMO.throwBusinessException(ee);
        }
      }
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    ArrayList list = new ArrayList();
    list.add(listLockId);
    list.add(bSucceed);
    return list;
  }

  /**
   * 此处插入方法说明。 功能描述:判断发票种类 输入参数: 返回值:0：费用发票；1：折扣发票；2：一般发票；-1：其他 异常处理:
   * 日期:2003/02/10
   * 
   * @return int
   * @param bodyKey
   *          java.util.Vector
   * @param feeVOs
   *          nc.vo.ps.settle.FeeinvoiceVO[]
   * @param discountVOs
   *          nc.vo.ps.settle.FeeinvoiceVO[]
   * @param specialVOs
   *          nc.vo.ps.settle.FeeinvoiceVO[]
   */
  private int[] getFeeType(Vector vbodyKey, FeeinvoiceVO[] feeVOs,
      FeeinvoiceVO[] discountVOs, FeeinvoiceVO[] specialVOs) {
    if (vbodyKey == null || vbodyKey.size() == 0)
      return null;
    String bodyKey[] = new String[vbodyKey.size()];
    vbodyKey.copyInto(bodyKey);

    int nType[] = new int[bodyKey.length];
    for (int i = 0; i < bodyKey.length; i++) {
      nType[i] = -1;

      String s1 = bodyKey[i];
      if (s1 == null || s1.trim().length() == 0)
        continue;
      s1 = s1.trim();

      // 是否费用发票
      int jLen = feeVOs == null ? 0 : feeVOs.length;
      for (int j = 0; j < jLen; j++) {
        String s2 = feeVOs[j].getCinvoice_bid();
        if (s2 == null || s2.trim().length() == 0)
          continue;
        s2 = s2.trim();
        if (s1.equals(s2)) {
          nType[i] = 0;
          break;
        }
      }

      if (nType[i] < 0) {
        // 是否折扣发票
        for (int j = 0; j < discountVOs.length; j++) {
          String s2 = discountVOs[j].getCinvoice_bid();
          if (s2 == null || s2.trim().length() == 0)
            continue;
          s2 = s2.trim();
          if (s1.equals(s2)) {
            nType[i] = 1;
            break;
          }
        }
      }

      if (nType[i] < 0) {
        // 是否一般发票
        for (int j = 0; j < discountVOs.length; j++) {
          String s2 = discountVOs[j].getCinvoice_bid();
          if (s2 == null || s2.trim().length() == 0)
            continue;
          s2 = s2.trim();
          if (s1.equals(s2)) {
            nType[i] = 2;
            break;
          }
        }
      }
    }

    return nType;
  }

  /**
   * 功能描述:判断发票是否为费用/折扣 作者：熊海情 修改：晁志平 For V30
   */
  private Hashtable isFeeDiscount(String cbaseid[]) throws BusinessException {
    Hashtable t = new Hashtable();
    try {
      SettleDMO dmo = new SettleDMO();
      boolean b[] = dmo.isFeeDiscount(cbaseid);
      if (b != null && b.length > 0) {
        for (int i = 0; i < b.length; i++) {
          t.put(cbaseid[i], new UFBoolean(b[i]));
        }
      }
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
    return t;
  }

  /*
   * 结算单作废，恢复相关的入库单(VMI汇总)、发票数据为结算前数据
   */
  private void onDis_DoRegret(SettlebillVO vo, String strPkCorp,
      String strOprId, CostfactorVO[] factors, UFBoolean ufbZGYF) throws BusinessException {
    //
    if (vo == null || vo.getBodyVO() == null || vo.getBodyVO().length <= 0) {
      SCMEnv.out("结算单或结算单表体为NULL，直接返回!");
      return;
    }

    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    SettlebillItemVO[] items = vo.getBodyVO();
    int iLen = items.length;
    // 入库单行主键归类
    String strTmp = null;
    Vector vStockKey = new Vector();
    for (int i = 0; i < iLen; i++) {
      strTmp = items[i].getCstockrow();
      if (strTmp == null || strTmp.length() == 0 || vStockKey.contains(strTmp))
        continue;
      vStockKey.addElement(strTmp);
    }

    timer.addExecutePhase("入库单行主键归类");

    // 判断发票是否为费用/折扣
    Hashtable tFeeDiscount = null;
    if (items != null && iLen > 0) {
      Vector vTemp = new Vector();
      for (int i = 0; i < iLen; i++) {
        strTmp = items[i].getCinvoice_bid();
        if (strTmp != null && strTmp.trim().length() > 0)
          vTemp.addElement(items[i].getCbaseid());
      }
      if (vTemp.size() > 0) {
        String saTmp[] = new String[vTemp.size()];
        vTemp.copyInto(saTmp);
        tFeeDiscount = isFeeDiscount(saTmp);
      }
    }
    timer.addExecutePhase("判断发票是否为费用/折扣");

    // 发票行主键归类（包括普通和费用-折扣两类）
    Vector vInvoiceKey = new Vector();
    Vector vFeeKey = new Vector();
    for (int i = 0; i < iLen; i++) {
      strTmp = items[i].getCinvoice_bid();
      if (strTmp == null || strTmp.length() == 0) {
        continue;
      }
      String cbaseid = items[i].getCbaseid();
      UFBoolean b = (UFBoolean) tFeeDiscount.get(cbaseid);
      if (b.booleanValue()) {
        if (!vFeeKey.contains(strTmp)) {
          vFeeKey.addElement(strTmp);
        }
      }
      else {
        if (!vInvoiceKey.contains(strTmp)) {
          vInvoiceKey.addElement(strTmp);
        }
      }
    }
    timer.addExecutePhase("发票行主键归类（包括普通和费用、折扣两类）");

    // 查询入库单、发票、费用发票
    java.util.ArrayList batchList = null;
    String stockBodyKey[] = new String[vStockKey.size()];
    vStockKey.copyInto(stockBodyKey);
    String invoiceBodyKey[] = new String[vInvoiceKey.size()];
    vInvoiceKey.copyInto(invoiceBodyKey);
    String feeBodyKey[] = new String[vFeeKey.size()];
    vFeeKey.copyInto(feeBodyKey);

    batchList = queryDetailBatchForDispose(strPkCorp, stockBodyKey,
        invoiceBodyKey, feeBodyKey);

    timer.addExecutePhase("查询入库单、发票、费用发票");

    // 查询费用发票,确定结算单的费用发票是否进入成本
    Vector v0 = new Vector();
    if (batchList != null && batchList.size() == 3) {
      java.util.ArrayList list = (java.util.ArrayList) batchList.get(2);
      if (list != null && list.size() > 0) {
        FeeinvoiceVO feeTempVOs[] = (FeeinvoiceVO[]) list.get(0);
        if (feeTempVOs != null && feeTempVOs.length > 0) {
          for (int i = 0; i < feeTempVOs.length; i++)
            v0.addElement(feeTempVOs[i]);
        }
      }
    }

    FeeinvoiceVO feeTempVOs[] = new FeeinvoiceVO[v0.size()];
    v0.copyInto(feeTempVOs);

    timer.addExecutePhase("查询费用发票,确定结算单的费用发票是否进入成本");

    // 记录费用是否进入成本
    UFBoolean[] m_bIsentercost = null;
    if (feeTempVOs != null && feeTempVOs.length > 0) {
      // 成本要素ID，是否进入成本唯一组合
      Vector vBCost = new Vector();
      Vector vTemp = new Vector();
      vBCost.addElement(factors[0].getHeadVO().getBisentercost());
      vTemp.addElement(factors[0].getHeadVO().getCcostfactorid().trim());
      for (int i = 1; i < factors.length; i++) {
        String s1 = factors[i].getHeadVO().getCcostfactorid().trim();
        if (!vTemp.contains(s1)) {
          vTemp.addElement(s1);
          vBCost.addElement(factors[i].getHeadVO().getBisentercost());
        }
      }
      m_bIsentercost = new UFBoolean[vBCost.size()];
      vBCost.copyInto(m_bIsentercost);
    }

    timer.addExecutePhase("记录费用是否进入成本");

    // 恢复入库单数据
    StockVO stockVOs[] = null;
    if (batchList != null && batchList.size() == 3) {
      Object oTemp = batchList.get(0);
      if (oTemp != null && vStockKey != null && vStockKey.size() > 0) {
        stockVOs = (StockVO[]) oTemp;
        stockVOs = onDis_RestoreStock(vStockKey, items, stockVOs);
      }
    }

    timer.addExecutePhase("恢复入库单数据");

    // 恢复发票数据
    IinvoiceVO iinvoiceVOs[] = null;
    if (batchList != null && batchList.size() == 3) {
      Object oTemp = batchList.get(1);
      if (oTemp != null && vInvoiceKey != null && vInvoiceKey.size() > 0) {
        iinvoiceVOs = (IinvoiceVO[]) oTemp;
        iinvoiceVOs = onDis_RestoreInvoice(vInvoiceKey, items, iinvoiceVOs,
            m_bIsentercost);
      }
    }

    timer.addExecutePhase("恢复发票数据");

    // 恢复费用发票和折扣数据
    FeeinvoiceVO feeVOs[] = null;
    FeeinvoiceVO discountVOs[] = null;
    FeeinvoiceVO specialVOs[] = null;
    if (vFeeKey != null && vFeeKey.size() > 0) {
      Vector v = null;
      if (batchList != null && batchList.size() == 3) {
        Object oTemp = batchList.get(2);
        if (oTemp != null) {
          java.util.ArrayList list0 = (java.util.ArrayList) oTemp;
          v = onDis_RestoreFee(vFeeKey, items, list0);
        }
      }

      if (v == null || v.size() < 3) {
        throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
            .getStrByID("40040502", "UPP40040502-000041")/*
                                                           * @res
                                                           * "恢复费用发票和折扣数据时出现数据不匹配！"
                                                           */);
      }

      Vector v1 = (Vector) v.elementAt(0);
      Vector v2 = (Vector) v.elementAt(1);
      Vector v3 = (Vector) v.elementAt(2);
      feeVOs = new FeeinvoiceVO[v1.size()];
      v1.copyInto(feeVOs);
      discountVOs = new FeeinvoiceVO[v2.size()];
      v2.copyInto(discountVOs);
      specialVOs = new FeeinvoiceVO[v3.size()];
      v3.copyInto(specialVOs);
    }
    timer.addExecutePhase("恢复费用发票和折扣数据");

    // vo,stockVOs,iinvoiceVOs,feeVOs,discountVOs,specialVOs,getClientEnvironment().getUser().getPrimaryKey()
    java.util.ArrayList listPara = new java.util.ArrayList();
    listPara.add(vo);
    listPara.add(stockVOs);
    listPara.add(iinvoiceVOs);
    listPara.add(feeVOs);
    listPara.add(discountVOs);
    listPara.add(specialVOs);
    listPara.add(strOprId);
    listPara.add(strPkCorp);
    //
    discardSettlebill(listPara, ufbZGYF);

    timer.addExecutePhase("作废操作（总）");

    timer.showAllExecutePhase("结算单作废（核心算法）时间分布");
  }

  /**
   * 此处插入方法说明。 功能描述:恢复费用发票和折扣数据（效率优化，提供批次查询功能） 输入参数: 返回值:需要恢复的费用发票VO和折扣VO 异常处理:
   * 修改日期：2003/02/10 xhq
   */
  private Vector onDis_RestoreFee(Vector vFeeKey, SettlebillItemVO[] VOs,
      java.util.ArrayList list) throws BusinessException {
    // 批次查询对应的费用发票和折扣
    String bodyKey[] = new String[vFeeKey.size()];
    vFeeKey.copyInto(bodyKey);

    if (list == null || list.size() == 0)
      throw new nc.vo.pub.BusinessException("找不到费用发票和折扣！");
    ;
    FeeinvoiceVO feeVO[] = (FeeinvoiceVO[]) list.get(0);
    FeeinvoiceVO discountVO[] = (FeeinvoiceVO[]) list.get(1);
    FeeinvoiceVO specialVO[] = (FeeinvoiceVO[]) list.get(2);

    // 获得发票种类
    int nType[] = getFeeType(vFeeKey, feeVO, discountVO, specialVO);
    if (nType == null || nType.length == 0)
      throw new nc.vo.pub.BusinessException("找不到费用发票种类！");

    //
    Vector v = new Vector();
    Vector v1 = new Vector();
    Vector v2 = new Vector();
    Vector v3 = new Vector();

    for (int i = 0; i < vFeeKey.size(); i++) {
      String s = (String) vFeeKey.elementAt(i);
      double nSettlemny = 0.0;
      for (int j = 0; j < VOs.length; j++) {
        String ss = VOs[j].getCinvoice_bid();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          nSettlemny += VOs[j].getNmoney().doubleValue();
          // s0=VOs[j].getCinvoiceid();
        }
      }

      if (nType[i] == 1) {
        // 修改折扣的累计结算金额
        for (int j = 0; j < discountVO.length; j++) {
          String ss = discountVO[j].getCinvoice_bid();
          if (ss == null || ss.trim().length() == 0)
            continue;
          ss = ss.trim();
          if (s.equals(ss)) {
            double d = discountVO[j].getNaccumsettlemny().doubleValue();
            d -= nSettlemny;
            discountVO[j].setNaccumsettlemny(new UFDouble(d).add(new UFDouble(
                0.0), BsPuTool.getCCurrDecimal(null)));

            // 需要恢复的折扣VO返回
            v2.addElement(discountVO[j]);
          }
        }
      }

      else if (nType[i] == 0) {
        // 修改费用发票的累计结算金额
        for (int j = 0; j < feeVO.length; j++) {
          String ss = feeVO[j].getCinvoice_bid();
          if (ss == null || ss.trim().length() == 0)
            continue;
          ss = ss.trim();
          if (s.equals(ss)) {
            double d = feeVO[j].getNaccumsettlemny().doubleValue();
            d -= nSettlemny;
            feeVO[j].setNaccumsettlemny(new UFDouble(d).add(new UFDouble(0.0),
                BsPuTool.getCCurrDecimal(null)));

            // 需要恢复的费用发票VO返回
            v1.addElement(feeVO[j]);
          }
        }
      }

      else if (nType[i] == 2) {
        // 修改一般发票的累计结算金额
        for (int j = 0; j < specialVO.length; j++) {
          String ss = specialVO[j].getCinvoice_bid();
          if (ss == null || ss.trim().length() == 0)
            continue;
          ss = ss.trim();
          if (s.equals(ss)) {
            double d = specialVO[j].getNaccumsettlemny().doubleValue();
            d -= nSettlemny;
            specialVO[j].setNaccumsettlemny(new UFDouble(d).add(new UFDouble(
                0.0), BsPuTool.getCCurrDecimal(null)));

            // 需要恢复的一般发票VO返回
            v3.addElement(specialVO[j]);
          }
        }
      }

      else {
        throw new nc.vo.pub.BusinessException(nc.bs.ml.NCLangResOnserver
            .getInstance().getStrByID("40040502", "UPP40040502-000042")/*
                                                                         * @res
                                                                         * "找不到费用发票和折扣！"
                                                                         */);
      }
    }

    v.addElement(v1);
    v.addElement(v2);
    v.addElement(v3);
    return v;
  }

  /**
   * 此处插入方法说明。 功能描述:恢复发票数据（优化效率，提供批次查询功能） 输入参数: 返回值:需要恢复的发票VO 异常处理:
   * 修改日期：2003/02/10 xhq
   */
  private IinvoiceVO[] onDis_RestoreInvoice(Vector vInvoiceKey,
      SettlebillItemVO[] VOs, IinvoiceVO invoiceVOs[],
      UFBoolean[] m_bIsentercost) throws nc.vo.pub.BusinessException {
    // 批次查询发票细节
    String bodyKey[] = new String[vInvoiceKey.size()];
    vInvoiceKey.copyInto(bodyKey);

    if (invoiceVOs == null || invoiceVOs.length == 0) {
      throw new nc.vo.pub.BusinessException(nc.bs.ml.NCLangResOnserver
          .getInstance().getStrByID("40040502", "UPP40040502-000043")/*
                                                                       * @res
                                                                       * "找不到发票！"
                                                                       */);
    }

    //
    Vector v = new Vector();
    for (int i = 0; i < vInvoiceKey.size(); i++) {
      String s = (String) vInvoiceKey.elementAt(i);
      double nSettlenum = 0.0;
      double nSettlemny = 0.0;
      for (int j = 0; j < VOs.length; j++) {
        String ss = VOs[j].getCinvoice_bid();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          nSettlenum += VOs[j].getNsettlenum().doubleValue();
          if (VOs[j].getNreasonalwastnum() != null)
            nSettlenum += VOs[j].getNreasonalwastnum().doubleValue();
          nSettlemny += VOs[j].getNmoney().doubleValue();
          if (VOs[j].getNreasonalwastmny() != null)
            nSettlemny += VOs[j].getNreasonalwastmny().doubleValue();

          UFDouble d1 = null;
          UFDouble d2 = VOs[j].getNsettledisctmny();
          if (m_bIsentercost != null && m_bIsentercost.length > 0) {
            double sum = 0.0;
            for (int k = 0; k < m_bIsentercost.length; k++) {
              if (k == 0 && m_bIsentercost[k].booleanValue()
                  && VOs[j].getNfactor1() != null)
                sum += VOs[j].getNfactor1().doubleValue();
              if (k == 1 && m_bIsentercost[k].booleanValue()
                  && VOs[j].getNfactor2() != null)
                sum += VOs[j].getNfactor2().doubleValue();
              if (k == 2 && m_bIsentercost[k].booleanValue()
                  && VOs[j].getNfactor3() != null)
                sum += VOs[j].getNfactor3().doubleValue();
              if (k == 3 && m_bIsentercost[k].booleanValue()
                  && VOs[j].getNfactor4() != null)
                sum += VOs[j].getNfactor4().doubleValue();
              if (k == 4 && m_bIsentercost[k].booleanValue()
                  && VOs[j].getNfactor5() != null)
                sum += VOs[j].getNfactor5().doubleValue();
            }
            d1 = new UFDouble(sum);
          }
          if (d1 != null)
            nSettlemny -= d1.doubleValue();
          if (d2 != null)
            nSettlemny -= d2.doubleValue();

          // s0=VOs[j].getCinvoiceid();
        }
      }

      // 修改累计结算数量和累计结算金额
      for (int j = 0; j < invoiceVOs.length; j++) {
        String ss = invoiceVOs[j].getCinvoice_bid();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          double d = invoiceVOs[j].getNaccumsettlenum().doubleValue();
          d -= nSettlenum;
          invoiceVOs[j].setNaccumsettlenum(new UFDouble(d));
          d = invoiceVOs[j].getNaccumsettlemny().doubleValue();
          d -= nSettlemny;
          invoiceVOs[j].setNaccumsettlemny(new UFDouble(d));

          // 需要恢复的发票VO返回
          v.addElement(invoiceVOs[j]);
        }
      }
    }

    if (v.size() > 0) {
      IinvoiceVO vos[] = new IinvoiceVO[v.size()];
      v.copyInto(vos);
      return vos;
    }

    return null;
  }

  /**
   * 功能描述:恢复入库单数据（优化效率，提供批次处理功能） 返回值:需要恢复的入库单VO
   */
  private StockVO[] onDis_RestoreStock(Vector vStockKey,
      SettlebillItemVO VOs[], StockVO stockVOs[])
      throws nc.vo.pub.BusinessException {
    // 批次查询入库单细节
    String bodyKey[] = new String[vStockKey.size()];
    vStockKey.copyInto(bodyKey);

    if (stockVOs == null || stockVOs.length == 0) {
      SCMEnv.out("没有入库单数据！恢复入库单数据方法直接返回 NULL ！");
      return null;
    }
    Vector v = new Vector();
    for (int i = 0; i < vStockKey.size(); i++) {
      String s = (String) vStockKey.elementAt(i);
      double nSettlenum = 0.0;
      double nGaugemny = 0.0;// 
      double nWastenum = 0.0;
      // double nSettlemny = 0.0;// for NJYR

      for (int j = 0; j < VOs.length; j++) {
        String ss = VOs[j].getCstockrow();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          nSettlenum += VOs[j].getNsettlenum().doubleValue();
          nGaugemny += VOs[j].getNgaugemny().doubleValue();
          nWastenum += VOs[j].getNreasonalwastnum().doubleValue();
          // s0 = VOs[j].getCstockid();
          // nSettlemny += VOs[j].getNmoney().doubleValue();// for NJYR
        }
      }

      // 修改累计结算数量和累计结算金额
      for (int j = 0; j < stockVOs.length; j++) {
        String ss = stockVOs[j].getCgeneralbid();
        if (ss == null || ss.length() == 0)
          continue;
        ss = ss.trim();
        if (s.equals(ss)) {
          double d = stockVOs[j].getNaccumsettlenum().doubleValue();
          d -= nSettlenum;
          stockVOs[j].setNaccumsettlenum(new UFDouble(d));
          d = stockVOs[j].getNaccumsettlemny().doubleValue();
          d -= nGaugemny; // for NJYR , 不用此字段
          // d -= nSettlemny;//for NJYR
          stockVOs[j].setNaccumsettlemny(new UFDouble(d).add(new UFDouble(0.0),
              BsPuTool.getCCurrDecimal(null)));

          // //累计冲减数量
          // d = 0;
          // if(stockVOs[j].getNaccumwashnum() != null) d =
          // stockVOs[j].getNaccumwashnum().doubleValue();
          // if(stockVOs[j].getBzgyfflag().booleanValue()) d -=
          // nSettlenum - nWastenum;
          // stockVOs[j].setNaccumwashnum(new UFDouble(d));

          // 需要恢复的入库单VO返回
          v.addElement(stockVOs[j]);
        }
      }
    }

    if (v.size() > 0) {
      StockVO vos[] = new StockVO[v.size()];
      v.copyInto(vos);
      return vos;
    }

    return null;
  }

  /**
   * 功能：作废结算单 参数：ArrayList |-SettlebillVO[]，结算单VO[]{注意：可能存在表体为NULL的单据}
   * |-String，公司主键 |-CostfactorVO[],成本要素VO[] |-String，操作员主键 返回：ArrayList:暂为空
   * 异常：BusinessException 创建：2004-07-06 作者：晁志平
   */
  public ArrayList onDiscard(ArrayList listPara) throws BusinessException {
    ICreateCorpQueryService myService0 = null;
    nc.vo.scm.pu.Timer timer = new nc.vo.scm.pu.Timer();
    timer.start();

    try {
      if (listPara == null || listPara.size() < 3) {
        SCMEnv.out("程序BUG，参数传入不正确，直接返回NULL!");
        return null;
      }
      SettlebillVO[] vos = (SettlebillVO[]) listPara.get(0);
      String strPkCorp = (String) listPara.get(1);
      String strOprId = (String) listPara.get(2);
      nc.vo.ps.factor.CostfactorVO[] factors = (nc.vo.ps.factor.CostfactorVO[]) listPara
          .get(3);
      int iLen = vos.length;
      // zhf add
      checkSettleDel(vos);
      // end

      // 取消结算成功,回退结算单号
      myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ICreateCorpQueryService.class.getName());
      boolean bAPStartUp = myService0.isEnabled(strPkCorp, "AP");
      nc.bs.pu.pub.GetSysBillCode billCode = new nc.bs.pu.pub.GetSysBillCode();
      for (int i = 0; i < vos.length; i++) {
        billCode.returnBillNo(vos[i]);

        // 非VMI类型的结算单作废时向应付系统传送数据
        SettlebillItemVO bodyVO[] = vos[i].getBodyVO();
        boolean bVirtual = false;// 是否存在虚拟发票
        Vector vTemp = new Vector();
        for (int j = 0; j < bodyVO.length; j++) {
          String s = bodyVO[j].getCinvoiceid();
          if (s != null && s.trim().length() > 0 && !vTemp.contains(s))
            vTemp.addElement(s);
        }
        if (vTemp.size() > 0) {
          String cInvoiceID[] = new String[vTemp.size()];
          vTemp.copyInto(cInvoiceID);
          cInvoiceID = new SettleDMO().getVirtualInvoices(cInvoiceID);
          if (cInvoiceID != null && cInvoiceID.length > 0)
            bVirtual = true;
        }

        boolean bIsFromVMI = isFromVMI(vos[i]);
        if (!bIsFromVMI) {
          if (bAPStartUp) {
            // 调用接口
            String s[] = new String[bodyVO.length];
            for (int j = 0; j < s.length; j++)
              s[j] = bodyVO[j].getCinvoiceid();
            if (bVirtual)
              deleteBillForARAP(s, strOprId);
          }
        }
      }

      // 查询前台未加载过的表体数据
      ArrayList listHid = new ArrayList();
      ArrayList listHts = new ArrayList();
      String[] saHid = null;
      String[] saHts = null;
      for (int i = 0; i < iLen; i++) {
        if (vos[i].getBodyVO() == null || vos[i].getBodyVO().length <= 0) {
          listHid.add(vos[i].getHeadVO().getPrimaryKey());
          listHts.add(vos[i].getHeadVO().getTs());
        }
      }
      if (listHid.size() > 0) {
        int iLenNullBody = listHid.size();
        saHid = new String[iLenNullBody];
        listHid.toArray(saHid);
        saHts = new String[iLenNullBody];
        listHts.toArray(saHts);
        ArrayList listAllBody = querySettleBodyBatch(strPkCorp, saHid, saHts,
            new UFBoolean(false));
        if (listAllBody == null || listAllBody.size() != iLenNullBody) {
          throw new BusinessException(nc.bs.ml.NCLangResOnserver.getInstance()
              .getStrByID("40040502", "UPP40040502-000044")/*
                                                             * @res
                                                             * "发生并发操作，请刷新界面重新进行作废操作！"
                                                             */);
        }
        int iPos = 0;
        for (int i = 0; i < iLen; i++) {
          if (vos[i].getBodyVO() == null || vos[i].getBodyVO().length <= 0) {
            vos[i].setChildrenVO((SettlebillItemVO[]) listAllBody.get(iPos));
            iPos++;
          }
        }
      }
      timer.addExecutePhase("查询前台未加载过的表体数据");

      //公司是否暂估应付
      UFBoolean ufbZGYF = SysInitBO_Client.getParaBoolean(strPkCorp, "PO52");
      // 作废操作
      for (int i = 0; i < iLen; i++) {
        onDis_DoRegret(vos[i], strPkCorp, strOprId, factors, ufbZGYF);
      }
      timer.addExecutePhase("作废操作");

      timer.showAllExecutePhase("作废结算单时间分布");

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return null;
  }

  /**
   * 方法功能描述：校验结算单是否可删除： 1>对于货物结算单如存在依赖的费用结算单不可删除
   * 2>对于费用结算单如含有第一次进行暂估费用处理结算行必须在该入库行的其他费用结算单删除后才可删除
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * 
   * @param vos
   *          结算单集合
   * @throws BusinessException
   *           <p>
   * @author zhanghongfang
   * @time 2008-7-30 上午10:28:22
   */
  private void checkSettleDel(SettlebillVO[] vos) throws BusinessException {
    try {
      ToICDMO setDmo = new ToICDMO();
      // 判断是否有依赖的费用结算单（针对货物结算产生的结算单删除时校验）
      HashMap<String, UFBoolean> tmpMap = setDmo.getFeeSettleInfor(vos);// 费用结算的删除

      if (tmpMap != null && tmpMap.size() > 0) {
        for (String key : tmpMap.keySet()) {
          if (tmpMap.get(key).booleanValue())
            throw new BusinessException(nc.bs.ml.NCLangResOnserver
                .getInstance().getStrByID("40040504", "UPP40040504-000025")/*
                                                                             * @res
                                                                             * "存在相关联的结算单，不能删除 "
                                                                             */);
        }
      }
      ArrayList<String> list = new ArrayList<String>();
      SettlebillItemVO[] itemVos = null;
      for (SettlebillVO vo : vos) {
        itemVos = vo.getBodyVO();
        for (SettlebillItemVO itemVO : itemVos) {
          if ((itemVO.getCstockrow() == null || itemVO.getCstockrow().trim()
              .length() == 0)
              && (itemVO.getCvmiid() == null || itemVO.getCvmiid().trim()
                  .length() == 0))
            continue;
          list.add(itemVO.getCsettlebill_bid().trim());
        }
      }
      if (list != null && list.size() > 0) {
        // 针对是否是否进行了费用暂估处理的费用结算单删除校验
        checkDelSettleBill(list);
      }
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 功能描述:为提高打开接点时的效率，一次性取出多个初始参数 输入参数:公司编码 返回值:Vector 作者：yye 修改：
   */
  public Vector getInitParaForSalesUI(String a_strUnitCode)
      throws BusinessException {

    Vector l_vecReturn = new Vector();

    try {
      ISysInitQry l_SysInitDMO = (ISysInitQry) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ISysInitQry.class.getName());

      // 获得系统设置的分单方式
      nc.vo.pub.para.SysInitVO l_initVO = l_SysInitDMO.queryByParaCode(
          a_strUnitCode, "PO20");
      nc.vo.pub.para.SysInitVO l_tempVO = l_SysInitDMO.queryByParaCode(
          a_strUnitCode, "BD301");

      // 获得系统设置的暂估方式和差异转入方式
      nc.vo.pub.para.SysInitVO l_aryinitVO[] = null;

      // 获得系统设置的数量容差控制和数量容差数值
      nc.vo.pub.para.SysInitVO l_arynumVO[] = null;

      // 获得系统设置的单价容差控制和单价容差数值
      nc.vo.pub.para.SysInitVO l_arypriceVO[] = null;

      Hashtable t = l_SysInitDMO.queryBatchParaValues(a_strUnitCode,
          new String[] {
              "PO12", "PO13", "PO02", "PO03", "PO04", "PO05"
          });
      if (t != null && t.size() > 0) {
        nc.vo.pub.para.SysInitVO tempVO1 = new nc.vo.pub.para.SysInitVO();
        tempVO1.setInitcode("PO12");
        tempVO1.setValue(t.get("PO12").toString());

        nc.vo.pub.para.SysInitVO tempVO2 = new nc.vo.pub.para.SysInitVO();
        tempVO2.setInitcode("PO13");
        tempVO2.setValue(t.get("PO13").toString());
        l_aryinitVO = new nc.vo.pub.para.SysInitVO[] {
            tempVO1, tempVO2
        };

        nc.vo.pub.para.SysInitVO tempVO3 = new nc.vo.pub.para.SysInitVO();
        tempVO3.setInitcode("PO02");
        tempVO3.setValue(t.get("PO02").toString());
        nc.vo.pub.para.SysInitVO tempVO4 = new nc.vo.pub.para.SysInitVO();
        tempVO4.setInitcode("PO03");
        tempVO4.setValue(t.get("PO03").toString());
        l_arynumVO = new nc.vo.pub.para.SysInitVO[] {
            tempVO3, tempVO4
        };

        nc.vo.pub.para.SysInitVO tempVO5 = new nc.vo.pub.para.SysInitVO();
        tempVO5.setInitcode("PO04");
        tempVO5.setValue(t.get("PO04").toString());
        nc.vo.pub.para.SysInitVO tempVO6 = new nc.vo.pub.para.SysInitVO();
        tempVO6.setInitcode("PO05");
        tempVO6.setValue(t.get("PO05").toString());
        l_arypriceVO = new nc.vo.pub.para.SysInitVO[] {
            tempVO5, tempVO6
        };
      }

      // *******************************************************************************************
      ICreateCorpQueryService l_CreatecorpBO = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
          .getInstance().lookup(ICreateCorpQueryService.class.getName());

      // 销售是否启用
      boolean bSOStartUp = l_CreatecorpBO.isEnabled(a_strUnitCode, "SO");

      // 库存是否启用
      boolean bICStartUp = l_CreatecorpBO.isEnabled(a_strUnitCode, "IC");

      // ********************************************************************************************

      l_vecReturn.addElement(l_initVO);
      l_vecReturn.addElement(l_tempVO);
      l_vecReturn.addElement(l_aryinitVO);
      l_vecReturn.addElement(l_arynumVO);
      l_vecReturn.addElement(l_arypriceVO);
      l_vecReturn.addElement(new Boolean(bSOStartUp));
      l_vecReturn.addElement(new Boolean(bICStartUp));

    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }

    return l_vecReturn;

  }

  /**
   * 功能描述:查询结算单体（批次） 输入参数:单位编码，头ID，头TS 作者：熊海情 修改：晁志平 For V30 区分打印查询与作废查询
   */
  public ArrayList querySettleBodyBatch(String unitCode, String key[],
      String ts[], UFBoolean ufbNeedFindOthers) throws BusinessException {

    SettlebillItemVO bodyVO[] = null;

    try {
      SettleDMO dmo = new SettleDMO();
      bodyVO = dmo.querySettleBodyBatch(unitCode, key, ts);

      if (ufbNeedFindOthers.booleanValue()) {
        // 根据表体来源：入库单 、VMI汇总分别处理
        Vector vBodyStock = new Vector();
        Vector vBodyVmi = new Vector();
        int iLen = bodyVO.length;
        for (int i = 0; i < iLen; i++) {
          if (bodyVO[i].getCvmiid() != null) {
            vBodyVmi.addElement(bodyVO[i]);
          }
          else {
            vBodyStock.addElement(bodyVO[i]);
          }
        }
        // 单独处理:入库单{入库单号、供应商、部门、业务员}
        SettlebillItemVO[] bodys = null;
        int iLenSpec = 0;
        String[] saBillCode = null, saVendorName = null, saKey;
        //
        Vector vAllWithName = new Vector();
        //
        if (vBodyStock.size() > 0) {
          bodys = new SettlebillItemVO[vBodyStock.size()];
          vBodyStock.copyInto(bodys);
          iLenSpec = bodys.length;
          // 查询入库单号
          saBillCode = dmo.queryStockCode(bodys);
          // 查询供应商、部门、业务员
          saKey = new String[iLenSpec];
          for (int j = 0; j < iLenSpec; j++)
            saKey[j] = bodys[j].getCstockid();
          ArrayList list2 = dmo.queryVendorName(saKey);
          saVendorName = (String[]) list2.get(0);
          String cDeptName[] = (String[]) list2.get(1);
          String cEmployeeName[] = (String[]) list2.get(2);
          for (int j = 0; j < iLenSpec; j++) {
            bodys[j].setVbillcode(saBillCode[j]);
            bodys[j].setCvendorname(saVendorName[j]);
            bodys[j].setCdeptname(cDeptName[j]);
            bodys[j].setCemployeename(cEmployeeName[j]);
            vAllWithName.addElement(bodys[j]);
          }
        }
        // 单独处理:VMI汇总{VMI汇总号、供应商}
        if (vBodyVmi.size() > 0) {
          bodys = new SettlebillItemVO[vBodyVmi.size()];
          vBodyVmi.copyInto(bodys);
          iLenSpec = bodys.length;
          // 查询VMI汇总单号
          saBillCode = dmo.queryVMIBillCode(bodys);
          // 查询供应商
          saKey = new String[iLenSpec];
          for (int j = 0; j < iLenSpec; j++)
            saKey[j] = bodys[j].getCvmiid();
          saVendorName = dmo.queryVendorName_Vmi(saKey);
          for (int j = 0; j < iLenSpec; j++) {
            bodys[j].setVbillcode(saBillCode[j]);
            bodys[j].setCvendorname(saVendorName[j]);
            vAllWithName.addElement(bodys[j]);
          }
        }
        // 共同处理:入库单、VMI汇总{发票号}
        bodyVO = new SettlebillItemVO[vAllWithName.size()];
        vAllWithName.copyInto(bodyVO);
        iLen = bodyVO.length;
        saBillCode = dmo.queryInvoiceCode(bodyVO);
        if (saBillCode != null) {
          for (int i = 0; i < iLen; i++) {
            if (saBillCode[i] == null)
              continue;
            bodyVO[i].setVinvoicecode(saBillCode[i]);
          }
        }
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    ArrayList list = new ArrayList();
    for (int i = 0; i < key.length; i++) {
      Vector v = new Vector();
      String s1 = key[i].trim();
      for (int j = 0; j < bodyVO.length; j++) {
        String s2 = bodyVO[j].getCsettlebillid().trim();
        if (s1.equals(s2))
          v.addElement(bodyVO[j]);
      }
      SettlebillItemVO bodyVOs[] = new SettlebillItemVO[v.size()];
      v.copyInto(bodyVOs);
      if (bodyVOs == null || bodyVOs.length == 0)
        return null;
      list.add(bodyVOs);
    }
    return list;
  }

  /**
   * 功能描述:查询入库单(过滤VMI、受托代销业务类型) 输入参数:单位编码、查询条件VO数组、标志值 返回值:入库单VO[] 作者：熊海情 修改：晁志平
   * For V30
   */
  public StockVO[] queryStockForNone(ArrayList list, ConditionVO conditionVO[])
      throws BusinessException {

    String sUnitCode = (String) list.get(0);
    UFBoolean bShow = (UFBoolean) list.get(1);
    StockVO vo[] = null;
    try {
      SettleDMO dmo = new SettleDMO();
      // 分解查询条件
      String sCondition = "";

      ArrayList listRet = dealCondVosForPower(conditionVO);
      conditionVO = (ConditionVO[]) listRet.get(0);
      String strDataPowerSql = (String) listRet.get(1);

      int iLen = conditionVO == null ? 0 : conditionVO.length;
      for (int i = 0; i < iLen; i++) {
        String sName = conditionVO[i].getFieldCode().trim();
        String sOpera = conditionVO[i].getOperaCode().trim();
        String sValue = conditionVO[i].getValue();
        String sSQL = conditionVO[i].getSQLStr();
        String sReplace = null;
        if (sName.equals("dbilldate") && sValue != null && sValue.length() > 0) {
          sReplace = "dbilldate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("ddate") && sValue != null && sValue.length() > 0) {
          sReplace = "dbilldate " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vbillcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "vbillcode " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc where invcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cinvclassid") && sValue != null
            && sValue.length() > 0) {
          try {
            nc.bs.ps.estimate.EstimateDMO ddmo = new nc.bs.ps.estimate.EstimateDMO();
            String sClassCode[] = ddmo.getSubInvClassCode(sValue);
            if (sClassCode != null && sClassCode.length > 0) {
              sValue = "(";
              for (int j = 0; j < sClassCode.length; j++) {
                if (j < sClassCode.length - 1)
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "' or ";
                else
                  sValue += "invclasscode " + sOpera + " '" + sClassCode[j]
                      + "')";
              }
              sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and " + sValue + ")";
            }
            else {
              sReplace = "B.cinvbasid in (select pk_invbasdoc from bd_invbasdoc A,bd_invcl C where "
                  + "A.pk_invcl = C.pk_invcl and invclasscode "
                  + sOpera
                  + " '"
                  + sValue + "')";
            }
            String s = getReplacedSQL(sSQL, sName, sReplace);
            sCondition += s;
          }
          catch (Exception e) {
            /* 不影响业务操作，此异常不必抛出 */
            SCMEnv.out(e);
            return null;
          }
        }
        else if (sName.equals("cvendorbaseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cproviderid in (select pk_cumandoc from bd_cumandoc A, bd_cubasdoc B where custcode "
              + sOpera
              + " '"
              + sValue
              + "'and A.pk_cubasdoc = B.pk_cubasdoc and (custflag = '1' or custflag = '3'))";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cdeptid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cdptid in (select pk_deptdoc from bd_deptdoc where deptcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("cbiztype") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cbiztype in (select pk_busitype from bd_busitype where busicode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        else if (sName.equals("vordercode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cfirstbillhid in (select corderid from po_order where vordercode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单体自定义项
        else if (sName.indexOf("ic_general_b.vuserdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 入库单头自定义项
        else if (sName.indexOf("vuserdef") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "A." + sName + " " + sOpera + " '" + sValue + "'";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 合同号
        else if (sName.equals("vcontractcode") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cfirstbillhid in (select corderid from po_order_b A, ct_manage B where ccontractid = pk_ct_manage and ct_code "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 体备注
        else if (sName.indexOf("ic_general_b.vnotebody") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B." + sName.substring(sName.indexOf(".") + 1) + " "
              + sOpera;
          if ("like".equalsIgnoreCase(sOpera)) {
            sReplace += " '%" + sValue + "%'";
          }
          else {
            sReplace += " '" + sValue + "'";
          }
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 收货公司
        else if (sName.equals("pk_stockcorp") && sValue != null
            && sValue.length() > 0) {
          sReplace = "A.pk_corp in (select pk_corp from bd_corp where unitcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 发票号:入库单行ID生成了指定发票号的发票
        else if (sName.indexOf("vinvoicecode") >= 0 && sValue != null
            && sValue.length() > 0) {
          sReplace = "B.cgeneralbid in (select B.cupsourcebillrowid from po_invoice A, po_invoice_b B where A.cinvoiceid = B.cinvoiceid and vinvoicecode "
              + sOpera + " '" + sValue + "' and A.dr = 0 and B.dr = 0)";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 仓库
        else if (sName.equals("cwarehouseid") && sValue != null
            && sValue.length() > 0) {
          sReplace = "cwarehouseid in (select pk_stordoc from bd_stordoc where storcode "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
        // 制单人
        else if ((sName.equals("coperatorid") || sName.equals("coperator"))
            && sValue != null && sValue.length() > 0) {
          sReplace = "A.coperatorid in (select cuserid from sm_user where user_code "
              + sOpera + " '" + sValue + "')";
          String s = getReplacedSQL(sSQL, sName, sReplace);
          sCondition += s;
        }
      }

      sCondition = PubDMO.processFirst(sCondition);
      /** 查询入库单 */
      // 赠品属性约束
      sCondition += " and upper(flargess) = 'N'";
      // 过滤结算完成
      sCondition += " and upper(isok) = 'N'";
      // 过滤仓库“是否计算存货成本”属性为否
      sCondition += " and coalesce(S.iscalculatedinvcost,'N') = 'Y' ";
      // 过滤VMI、受托代销, 直运, 存货不处理类等业务类型入斓バ
      sCondition += " and BT.verifyrule not in ('V','S','N') ";

      if (bShow.booleanValue()) {
        sCondition += " and (nprice is null or nprice = 0) ";
      }
      if (strDataPowerSql != null)
        sCondition += " and " + strDataPowerSql;

      // 精度处理
      int iDigitLocalCurrType = 2;
      try {
        iDigitLocalCurrType = BsPuTool.getCCurrDecimal(sUnitCode);
      }
      catch (Exception e) {
        throw new SQLException(e.getMessage());
      }
      vo = dmo.queryStock(sUnitCode, sCondition, iDigitLocalCurrType, true);
      Vector vTemp = new Vector();
      if (vo != null && vo.length > 0) {
        // v5支持集中采购调整
        // 查询入库单调整，收货公司与当前登录公司不一致，则返回前增加处理:
        vo = dmo.preDealStockVO(sUnitCode, vo);

        for (int i = 0; i < vo.length; i++)
          vTemp.addElement(vo[i].getCprovidermangid());
        String sVendorMangID[] = new String[vTemp.size()];
        vTemp.copyInto(sVendorMangID);
        String sVendorBaseID[] = getVendorBaseKey(sVendorMangID);
        // 计算未结算数量，本币未结算金额
        vTemp = new Vector();
        for (int i = 0; i < vo.length; i++) {
          vo[i].setCproviderbaseid(sVendorBaseID[i]);
          UFDouble d1 = vo[i].getNinnum();
          UFDouble d2 = vo[i].getNaccumsettlenum();
          UFDouble d3 = vo[i].getNsignnum();
          if (d1 != null && d2 != null && d3 != null) {
            if (Math.abs(d2.doubleValue()) < Math.abs(d3.doubleValue()))
              d2 = d3;
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlenum(new UFDouble(d));
          }
          else {
            vo[i].setNnosettlenum(new UFDouble(0));
          }
          d1 = vo[i].getNmoney();
          d2 = vo[i].getNaccumsettlemny();
          // since v502
          if (d1 != null && d2 != null && d2.doubleValue() != 0.0) {
            double d = d1.doubleValue() - d2.doubleValue();
            vo[i].setNnosettlemny(new UFDouble(d).add(new UFDouble(0.0),
                BsPuTool.getCCurrDecimal(null)));
          }
          else {
            // 支持未结算数量=入库数量时，直接使用入库金额
            if (PuPubVO.getUFDouble_NullAsZero(vo[i].getNinnum()).equals(
                PuPubVO.getUFDouble_NullAsZero(vo[i].getNnosettlenum()))) {
              vo[i].setNnosettlemny(vo[i].getNmoney().add(new UFDouble(0.0),
                  BsPuTool.getCCurrDecimal(null)));
            }
            // 如果未结算数量!=入库数量时，未结算金额=未结算数量*单价
            else {
              vo[i].setNnosettlemny(PuPubVO.getUFDouble_NullAsZero(
                  vo[i].getNprice()).multiply(
                  PuPubVO.getUFDouble_NullAsZero(vo[i].getNnosettlenum())));
              vo[i].setNnosettlemny(vo[i].getNnosettlemny().add(
                  new UFDouble(0.0), BsPuTool.getCCurrDecimal(null)));
            }
          }
          // 数据潜在错误修正，since v53
          if (!bShow.booleanValue()
              && Math.abs(vo[i].getNnosettlemny().doubleValue()) == 0.0) {
            continue;
          }
          vTemp.addElement(vo[i]);
        }
      }

      if (vTemp.size() > 0) {
        vo = new StockVO[vTemp.size()];
        vTemp.copyInto(vo);
      }
      else {
        vo = null;
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    return vo;
  }

  public void isUnauditableForSale(String csaleid) throws BusinessException {
    try {
      new SettleDMO().isUnauditableForSale(csaleid);
    }
    catch (Exception e) {
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 
   * 父类方法重写
   * <p>支持入库单部分结算暂估 by zhf
   * 
   * @see nc.itf.ps.settle.ISettle#estimateForPartSettle(nc.vo.ps.settle.StockVO[], nc.vo.ps.estimate.EstimateVO[], java.lang.String, nc.vo.pub.lang.UFDate, nc.vo.pub.lang.UFBoolean, java.lang.String)
   */
  public void estimateForPartSettle(StockVO VOs[], EstimateVO estVO[],
      String cOperator, UFDate dCurrDate, UFBoolean bZGYF, String strLoginCorpId)
      throws BusinessException {
    EstimateDMO dmo1 = null;
    ICreateCorpQueryService myService0 = null;
    nc.bs.pu.pub.PubImpl myService1 = null;
    ISysInitQry myService2 = null;

    try {
      dmo1 = new EstimateDMO();

      // 暂估时单价和金额的精度控制
      myService1 = new nc.bs.pu.pub.PubImpl();
      int digit[] = myService1.getDigitBatch(VOs[0].getPk_corp(), new String[] {
          "BD301", "BD505", "BD502"
      });
      if (digit == null || digit.length == 0 || digit.length < 3) {
        throw new BusinessException(NCLangResOnserver.getInstance().getStrByID(
            "40040503", "UPP40040503-000008")/*
                                               * @res "获取本位币精度或单价精度异常!"
                                               */);
      }
      myService2 = (ISysInitQry) nc.bs.framework.common.NCLocator.getInstance()
          .lookup(ISysInitQry.class.getName());
      String sCurrTypeID = myService2.getPkValue(VOs[0].getPk_corp(), "BD301");

      // 入库单表体打上正常标志，重新计算暂估单价和暂估金额
      Vector vAllBodyVoB = new Vector();
      Vector vAllBodyVoBB3 = new Vector();
      for (int i = 0; i < VOs.length; i++) {
        GeneralHItemVO bodyVO = new GeneralHItemVO();
        bodyVO.setCgeneralbid(VOs[i].getCgeneralbid());
        bodyVO.setBzgflag(new UFBoolean(true));
        bodyVO.setDzgdate(dCurrDate);
        if (bZGYF.booleanValue())
          bodyVO.setBzgyfflag(bZGYF);
        vAllBodyVoB.addElement(bodyVO);

        GeneralBb3VO bb3VO = new GeneralBb3VO();
        bb3VO.setCgeneralbid(VOs[i].getCgeneralbid());
        if (VOs[i].getNprice() != null) {
          double d = PubDMO.getRoundDouble(digit[1], VOs[i].getNprice()
              .doubleValue());

          bb3VO.setNpprice(new UFDouble(d));

          if (estVO != null && estVO.length > 0) {
            bb3VO.setNzygfprice(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNtaxprice())
                .add(new UFDouble(0.0), digit[1]));
          }
        }
        if (VOs[i].getNmoney() != null) {
          double d = PubDMO.getRoundDouble(digit[0], VOs[i].getNmoney()
              .doubleValue());
          bb3VO.setNpmoney(new UFDouble(d));// 暂估金额
          if (estVO != null && estVO.length > 0) {
            bb3VO.setNzgyfmoney(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNtotalmoney())
                .add(new UFDouble(0.0), digit[0]));
          }
        }
        // zhf add for v55
        if (estVO[i].getCurrencytypeid() != null) {
          bb3VO.setCurrencytypeid(estVO[i].getCurrencytypeid());
        }
        if (estVO[i].getNexchangeotobrate() != null) {
          bb3VO.setNexchangeotobrate(estVO[i].getNexchangeotobrate());
        }
        if (estVO[i].getNoriginalcurmny() != null) {
          bb3VO.setNoriginalcurmny(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNoriginalcurmny())
              .add(new UFDouble(0.0), digit[0]));
        }
        if (estVO[i].getNorgtaxmoney() != null) {
          bb3VO.setNorgtaxMoney(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNorgtaxmoney())
              .add(new UFDouble(0.0), digit[0]));
        }
        if (estVO[i].getNoriginalnetprice() != null) {
          bb3VO.setNoriginalnetprice(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNoriginalnetprice())
              .add(new UFDouble(0.0), digit[1]));
          bb3VO.setNorgnettaxprice(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNorgnettaxprice())
              .add(new UFDouble(0.0), digit[1]));
        }
        if (estVO[i].getNoriginaltaxpricemny() != null) {
          bb3VO.setNoriginaltaxpricemny(PuPubVO.getUFDouble_NullAsZero(estVO[i].getNoriginaltaxpricemny())
              .add(new UFDouble(0.0), digit[0]));
        }

        // end
        vAllBodyVoBB3.addElement(bb3VO);
      }

      if (vAllBodyVoB.size() > 0) {
        GeneralHItemVO[] bodyVOs = new GeneralHItemVO[vAllBodyVoB.size()];
        vAllBodyVoB.copyInto(bodyVOs);
        dmo1.updateBillBody(bodyVOs);
      }

      if (vAllBodyVoBB3.size() > 0) {
        GeneralBb3VO bb3VOs[] = new GeneralBb3VO[vAllBodyVoBB3.size()];
        vAllBodyVoBB3.copyInto(bb3VOs);
        dmo1.updateBillBb3(bb3VOs);
      }

      // 判断存货核算是否启用
      if (VOs != null && VOs.length > 0) {
        String unitCode = VOs[0].getPk_corp();
        myService0 = (ICreateCorpQueryService) nc.bs.framework.common.NCLocator
            .getInstance().lookup(ICreateCorpQueryService.class.getName());
        boolean bIAStartUp = myService0.isEnabled(unitCode, "IA");

        if (bIAStartUp) {
          // 调用接口,向存货核算系统传送数据
          saveBillFromOutterForPartSettle(VOs, cOperator, dCurrDate, new int[] {
              digit[0], digit[1], digit[2]
          });
        }

        // 暂估应付
        if (bZGYF.booleanValue() && myService0.isEnabled(unitCode, "AP")) {
          // *****传暂估应付
          IEstimate myService3 = (IEstimate) nc.bs.framework.common.NCLocator
              .getInstance().lookup(IEstimate.class.getName());
          ArrayList list = new ArrayList();
          list.add(sCurrTypeID);
          list.add(cOperator);
          list.add(dCurrDate);
          list.add(strLoginCorpId);
          list.add(UFBoolean.FALSE);
          list.add(null);// since v53
          myService3.saveBillForARAP(estVO, list);
        }
      }
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 父类方法重写 : StockVO[] ==>> EstimateVO[]
   * 
   * @see nc.itf.ps.settle.ISettle#switchVOForZGYF(nc.vo.ps.settle.StockVO[],
   *      nc.vo.pub.lang.UFBoolean)
   */
  public EstimateVO[] switchVOForZGYF(StockVO VOs[], UFBoolean bZGYF)
      throws BusinessException {

    Vector vTemp = new Vector();
    for (int i = 0; i < VOs.length; i++) {
      EstimateVO tempVO = new EstimateVO();

      // since v502,要记录各个公司---BGN-----
      tempVO.setPk_invoicecorp(VOs[i].getPk_corp());
      tempVO.setPk_purcorp(VOs[i].getPk_purcorp());
      // since v502,要记录各个公司---END-----

      tempVO.setPk_corp(VOs[i].getPk_stockcorp());
      tempVO.setCprovidermangid(VOs[i].getCprovidermangid());
      tempVO.setCgeneralhid(VOs[i].getCgeneralhid());
      tempVO.setCbiztype(VOs[i].getCbiztype());
      tempVO.setDbilldate(VOs[i].getDbizdate());
      tempVO.setCgeneralbid(VOs[i].getCgeneralbid());
      tempVO.setCproviderbaseid(VOs[i].getCproviderbaseid());
      tempVO.setCbaseid(VOs[i].getCbaseid());
      tempVO.setCmangid(VOs[i].getCmangid());

      tempVO.setNinnum(VOs[i].getNinnum());
      tempVO.setNprice(VOs[i].getNprice());
      tempVO.setNmoney(VOs[i].getNmoney());
      tempVO.setNcbtaxprice(VOs[i].getNtaxprice());
      tempVO.setNcbtotalmoney(VOs[i].getNtotalmoney());

      tempVO.setCfirsttype(VOs[i].getCfirsttype());
      tempVO.setCfirstbillbid(VOs[i].getCfirstbillbid());
      tempVO.setCfirstbillhid(VOs[i].getCfirstbillhid());
      tempVO.setCbilltypecode(VOs[i].getCbilltype());

      // 表头自定义项
      tempVO.setVuserdefh1(VOs[i].getVuserdefh1());
      tempVO.setVuserdefh2(VOs[i].getVuserdefh2());
      tempVO.setVuserdefh3(VOs[i].getVuserdefh3());
      tempVO.setVuserdefh4(VOs[i].getVuserdefh4());
      tempVO.setVuserdefh5(VOs[i].getVuserdefh5());
      tempVO.setVuserdefh6(VOs[i].getVuserdefh6());
      tempVO.setVuserdefh7(VOs[i].getVuserdefh7());
      tempVO.setVuserdefh8(VOs[i].getVuserdefh8());
      tempVO.setVuserdefh9(VOs[i].getVuserdefh9());
      tempVO.setVuserdefh10(VOs[i].getVuserdefh10());

      tempVO.setVuserdefh11(VOs[i].getVuserdefh11());
      tempVO.setVuserdefh12(VOs[i].getVuserdefh12());
      tempVO.setVuserdefh13(VOs[i].getVuserdefh13());
      tempVO.setVuserdefh14(VOs[i].getVuserdefh14());
      tempVO.setVuserdefh15(VOs[i].getVuserdefh15());
      tempVO.setVuserdefh16(VOs[i].getVuserdefh16());
      tempVO.setVuserdefh17(VOs[i].getVuserdefh17());
      tempVO.setVuserdefh18(VOs[i].getVuserdefh18());
      tempVO.setVuserdefh19(VOs[i].getVuserdefh19());
      tempVO.setVuserdefh20(VOs[i].getVuserdefh20());

      // 表头自定义项PK
      tempVO.setPk_defdoch1(VOs[i].getPk_defdoch1());
      tempVO.setPk_defdoch2(VOs[i].getPk_defdoch2());
      tempVO.setPk_defdoch3(VOs[i].getPk_defdoch3());
      tempVO.setPk_defdoch4(VOs[i].getPk_defdoch4());
      tempVO.setPk_defdoch5(VOs[i].getPk_defdoch5());
      tempVO.setPk_defdoch6(VOs[i].getPk_defdoch6());
      tempVO.setPk_defdoch7(VOs[i].getPk_defdoch7());
      tempVO.setPk_defdoch8(VOs[i].getPk_defdoch8());
      tempVO.setPk_defdoch9(VOs[i].getPk_defdoch9());
      tempVO.setPk_defdoch10(VOs[i].getPk_defdoch10());

      tempVO.setPk_defdoch11(VOs[i].getPk_defdoch11());
      tempVO.setPk_defdoch12(VOs[i].getPk_defdoch12());
      tempVO.setPk_defdoch13(VOs[i].getPk_defdoch13());
      tempVO.setPk_defdoch14(VOs[i].getPk_defdoch14());
      tempVO.setPk_defdoch15(VOs[i].getPk_defdoch15());
      tempVO.setPk_defdoch16(VOs[i].getPk_defdoch16());
      tempVO.setPk_defdoch17(VOs[i].getPk_defdoch17());
      tempVO.setPk_defdoch18(VOs[i].getPk_defdoch18());
      tempVO.setPk_defdoch19(VOs[i].getPk_defdoch19());
      tempVO.setPk_defdoch20(VOs[i].getPk_defdoch20());

      // 表体自定义项
      tempVO.setVuserdef1(VOs[i].getVuserdefb1());
      tempVO.setVuserdef2(VOs[i].getVuserdefb2());
      tempVO.setVuserdef3(VOs[i].getVuserdefb3());
      tempVO.setVuserdef4(VOs[i].getVuserdefb4());
      tempVO.setVuserdef5(VOs[i].getVuserdefb5());
      tempVO.setVuserdef6(VOs[i].getVuserdefb6());
      tempVO.setVuserdef7(VOs[i].getVuserdefb7());
      tempVO.setVuserdef8(VOs[i].getVuserdefb8());
      tempVO.setVuserdef9(VOs[i].getVuserdefb9());
      tempVO.setVuserdef10(VOs[i].getVuserdefb10());

      tempVO.setVuserdef11(VOs[i].getVuserdefb11());
      tempVO.setVuserdef12(VOs[i].getVuserdefb12());
      tempVO.setVuserdef13(VOs[i].getVuserdefb13());
      tempVO.setVuserdef14(VOs[i].getVuserdefb14());
      tempVO.setVuserdef15(VOs[i].getVuserdefb15());
      tempVO.setVuserdef16(VOs[i].getVuserdefb16());
      tempVO.setVuserdef17(VOs[i].getVuserdefb17());
      tempVO.setVuserdef18(VOs[i].getVuserdefb18());
      tempVO.setVuserdef19(VOs[i].getVuserdefb19());
      tempVO.setVuserdef20(VOs[i].getVuserdefb20());

      // 表体自定义项PK
      tempVO.setPk_defdocb1(VOs[i].getPk_defdocb1());
      tempVO.setPk_defdocb2(VOs[i].getPk_defdocb2());
      tempVO.setPk_defdocb3(VOs[i].getPk_defdocb3());
      tempVO.setPk_defdocb4(VOs[i].getPk_defdocb4());
      tempVO.setPk_defdocb5(VOs[i].getPk_defdocb5());
      tempVO.setPk_defdocb6(VOs[i].getPk_defdocb6());
      tempVO.setPk_defdocb7(VOs[i].getPk_defdocb7());
      tempVO.setPk_defdocb8(VOs[i].getPk_defdocb8());
      tempVO.setPk_defdocb9(VOs[i].getPk_defdocb9());
      tempVO.setPk_defdocb10(VOs[i].getPk_defdocb10());

      tempVO.setPk_defdocb11(VOs[i].getPk_defdocb11());
      tempVO.setPk_defdocb12(VOs[i].getPk_defdocb12());
      tempVO.setPk_defdocb13(VOs[i].getPk_defdocb13());
      tempVO.setPk_defdocb14(VOs[i].getPk_defdocb14());
      tempVO.setPk_defdocb15(VOs[i].getPk_defdocb15());
      tempVO.setPk_defdocb16(VOs[i].getPk_defdocb16());
      tempVO.setPk_defdocb17(VOs[i].getPk_defdocb17());
      tempVO.setPk_defdocb18(VOs[i].getPk_defdocb18());
      tempVO.setPk_defdocb19(VOs[i].getPk_defdocb19());
      tempVO.setPk_defdocb20(VOs[i].getPk_defdocb20());

      tempVO.setCprojectid(VOs[i].getCprojectid());
      tempVO.setCprojectphaseid(VOs[i].getCprojectphaseid());
      tempVO.setCdptid(VOs[i].getCdeptid());
      tempVO.setCoperatorid(VOs[i].getCoperatorid());
      tempVO.setVbatchcode(VOs[i].getVbatchcode());
      tempVO.setVfirstbillcode(VOs[i].getVfirstbillcode());

      tempVO.setBMoney(VOs[i].getBMoney());
      tempVO.setNPricePolicy(VOs[i].getNPricePolicy());

      // since v502
      tempVO.setCcalbodyid(VOs[i].getCstoreorganization());

      vTemp.addElement(tempVO);
    }

    EstimateVO estimates[] = new EstimateVO[vTemp.size()];
    vTemp.copyInto(estimates);

    EstimateImpl setTool = new EstimateImpl();
    // 设置税率、扣税类别
    setTool.setTaxRateDiscountType(estimates);
    // 设置收票公司(收票公司为空，取收货公司)本位币
    setTool.setLocalCurrForInvoiceCorp(estimates);
    // //
    // ISysInitQry myService = (ISysInitQry) nc.bs.framework.common.NCLocator
    // .getInstance().lookup(ISysInitQry.class.getName());
    // String sPricePolicy = myService.getParaString(VOs[0].getPk_corp(),
    // "PO28");

    // // 获取暂估价
    // try {
    // new EstimateImpl().setEstimateVosInfos(estimates, VOs[0]
    // .getPk_corp(), "N", null);//-----------------zhf5
    // } catch (Exception e) {
    // PubDMO.throwBusinessException(e);
    // }
    //
    return estimates;
  }

  /*
   * 服务一: 支持入库单部分结算暂估
   */
  private void saveBillFromOutterForPartSettle(StockVO VOs[], String cOperator,
      UFDate dCurrDate, int nMnyPriceAssDecimal[]) throws BusinessException {
    // IIAToPUBill myService = null;

    try {
      // myService = (IIAToPUBill)
      // NCLocator.getInstance().lookup(IIAToPUBill.class.getName());
      BillVO billVOs[] = transferIADataForPartSettle(VOs, cOperator, dCurrDate,
          nMnyPriceAssDecimal);

      // 对存货核算单进行处理: 相同表头的单据组合成一张单据
      // (1) 存货核算单据来源单据头ID唯一性组合
      Vector v = new Vector();
      Vector vTemp0 = new Vector();
      vTemp0.addElement(((IBillHeaderVO) billVOs[0].getParentVO()).getCbillid()
          .trim());
      v.addElement(billVOs[0]);
      for (int i = 1; i < billVOs.length; i++) {
        String s1 = ((IBillHeaderVO) billVOs[i].getParentVO()).getCbillid()
            .trim();
        if (!vTemp0.contains(s1)) {
          vTemp0.addElement(s1);
          v.addElement(billVOs[i]);
        }
      }

      // (3) 所有存货核算单据体的来源单据头ID相同, 归为同一张存货核算单据
      Vector vv = new Vector();
      for (int i = 0; i < v.size(); i++) {
        BillVO tempVO = (BillVO) v.elementAt(i);
        String s1 = ((IBillHeaderVO) tempVO.getParentVO()).getCbillid().trim();
        Vector vTemp = new Vector();
        for (int j = 0; j < billVOs.length; j++) {
          String s2 = ((IBillHeaderVO) billVOs[j].getParentVO()).getCbillid()
              .trim();
          if (s1.equals(s2)) {
            IBillItemVO tempItemVO[] = (IBillItemVO[]) billVOs[j]
                .getChildrenVO();
            for (int k = 0; k < tempItemVO.length; k++)
              vTemp.addElement(tempItemVO[k]);
          }
        }

        IBillItemVO tempItemVOs[] = new IBillItemVO[vTemp.size()];
        vTemp.copyInto(tempItemVOs);

        // 重新设置表体行号
        for (int j = 0; j < tempItemVOs.length; j++)
          tempItemVOs[j].setIrownumber(new Integer(j));

        tempVO.setChildrenVO(tempItemVOs);
        vv.addElement(tempVO);
      }

      // (4) 整理需向存货传送的单据
      billVOs = null;
      billVOs = new BillVO[vv.size()];
      vv.copyInto(billVOs);

      // 传送数据
      if (billVOs == null || billVOs.length == 0)
        return;
      String s1 = ((IBillHeaderVO) billVOs[0].getParentVO())
          .getCsourcemodulename();
      String s2 = ((IBillItemVO[]) billVOs[0].getChildrenVO())[0]
          .getCsourcebilltypecode();

      //
      String sTime = (new UFDateTime(new Date())).toString();
      for (int i = 0; i < billVOs.length; i++) {
        ((IBillHeaderVO) billVOs[i].getParentVO()).setVbillcode(null);
        ((IBillHeaderVO) billVOs[i].getParentVO()).setTmaketime(sTime);
        ((IBillHeaderVO) billVOs[i].getParentVO()).setTlastmaketime(sTime);
        ((IBillHeaderVO) billVOs[i].getParentVO())
            .setClastoperatorid(cOperator);
        IBillItemVO bodyVO[] = (IBillItemVO[]) billVOs[i].getChildrenVO();
        if (bodyVO != null && bodyVO.length > 0) {
          for (int j = 0; j < bodyVO.length; j++)
            bodyVO[j].setVbillcode(null);
        }
      }
      // 保存前处理
      dealBeforeCallIaSave(billVOs);
      // 调用IA保存
      IIAToPU myService = (IIAToPU) NCLocator.getInstance().lookup(
          IIAToPU.class.getName());
      // myService.saveBillFromOutterArray(billVOs, s1, s2);
      myService.estimatePU(billVOs, PuUtils.getClintLink(VOs[0].getPk_corp(),
          cOperator, dCurrDate));
    }
    catch (Exception e) {
      PubDMO.throwBusinessException(e);
    }
  }

  /**
   * 服务二: 支持入库单部分结算暂估
   * 
   * @since v502, 支持单价精度处理， By czp
   */
  private BillVO[] transferIADataForPartSettle(StockVO[] VOs, String cOperator,
      UFDate dCurrDate, int nMnyPriceAssDecimal[]) throws BusinessException {
    if (VOs == null || VOs.length == 0) {
      SCMEnv.out("传入参数为空，直接返回NULL；调用堆栈如下：");
      SCMEnv.out(new Exception());
      return null;
    }
    BillVO billVO[] = null;
    int iLen = VOs.length;
    try {
      // 设置存货表体VO所需的数据
      IBillItemVO bodyVO[] = new IBillItemVO[iLen];
      for (int i = 0; i < bodyVO.length; i++) {
        bodyVO[i] = new IBillItemVO();

        bodyVO[i].setPk_corp(VOs[i].getPk_corp());
        bodyVO[i].setCbilltypecode("I2");
        bodyVO[i].setCbill_bid(VOs[i].getCgeneralbid());
        bodyVO[i].setCbillid(VOs[i].getCgeneralhid());

        bodyVO[i].setCsourcebillid(VOs[i].getCgeneralhid());
        bodyVO[i].setCsourcebillitemid(VOs[i].getCgeneralbid());
        bodyVO[i].setCsourcebilltypecode("45");
        bodyVO[i].setFpricemodeflag(null);

        // V5新增:库存入库单相关信息
        bodyVO[i].setCicbilltype(VOs[i].getCbilltype());
        bodyVO[i].setCicbillcode(VOs[i].getVbillcode());
        bodyVO[i].setCicbillid(VOs[i].getCgeneralhid());
        bodyVO[i].setCicitemid(VOs[i].getCgeneralbid());

        bodyVO[i].setCinventoryid(VOs[i].getCmangid());
        bodyVO[i].setVbatch(VOs[i].getVbatchcode());
        bodyVO[i].setNnumber(VOs[i].getNinnum());

        /*
         * UFDouble d1 = VOs[i].getNmoney(); UFDouble d2 = null; if (d1 == null)
         * d1 = new UFDouble(0.0); if (d2 == null) d2 = new UFDouble(0.0);
         * double d = d1.doubleValue() + d2.doubleValue();
         * bodyVO[i].setNmoney(new
         * UFDouble(PubDMO.getRoundDouble(nMnyPriceDecimal[0], d)));
         * bodyVO[i].setNdrawsummny(d2); d1 = bodyVO[i].getNmoney(); d2 =
         * bodyVO[i].getNnumber(); if (d2 != null && d2.doubleValue() != 0.0) {
         * bodyVO[i].setNprice(d1.div(d2, nMnyPriceDecimal[1])); }
         */
        // since v502
        bodyVO[i].setNprice(VOs[i].getNprice());
        bodyVO[i].setNmoney(VOs[i].getNmoney());
        bodyVO[i].setNdrawsummny(new UFDouble(0.0));
        //
        bodyVO[i].setNplanedprice(null);
        bodyVO[i].setNplanedmny(null);

        UFDouble d1 = bodyVO[i].getNmoney();
        UFDouble d2 = bodyVO[i].getNplanedmny();
        if (d1 == null)
          d1 = new UFDouble(0.0);
        if (d2 == null)
          d2 = new UFDouble(0.0);
        double d = d1.doubleValue() - d2.doubleValue();
        bodyVO[i].setNinvarymny(null);

        bodyVO[i].setCastunitid(PuPubVO.getString_TrimZeroLenAsNull(VOs[i]
            .getCastunitid()));
        bodyVO[i].setNchangerate(VOs[i].getHsl());

        // zlq 金六福 采购部分结算自动生成存货暂估单据未传递辅数量////
        UFDouble assistnum = null;
        if (!(bodyVO[i].getCastunitid() == null || bodyVO[i].getCastunitid()
            .trim().equals(""))) {
          assistnum = bodyVO[i].getNnumber().div(bodyVO[i].getNchangerate(),
              nMnyPriceAssDecimal[2]);
        }
        bodyVO[i].setNassistnum(assistnum);
        // ///////////////////////////////////////////////////////

        bodyVO[i].setCfirstbillid(VOs[i].getCfirstbillhid());

        bodyVO[i].setCfirstbillitemid(VOs[i].getCfirstbillbid());
        bodyVO[i].setCfirstbilltypecode(VOs[i].getCfirsttype());
        bodyVO[i].setIrownumber(new Integer(i));
        bodyVO[i].setVbillcode(VOs[i].getVbillcode());
        bodyVO[i].setVsourcebillcode(VOs[i].getVbillcode());

        bodyVO[i].setVfree1(VOs[i].getVfree1());
        bodyVO[i].setVfree2(VOs[i].getVfree2());
        bodyVO[i].setVfree3(VOs[i].getVfree3());
        bodyVO[i].setVfree4(VOs[i].getVfree4());
        bodyVO[i].setVfree5(VOs[i].getVfree5());

        bodyVO[i].setCprojectid(VOs[i].getCprojectid());
        bodyVO[i].setCprojectphase(VOs[i].getCprojectphaseid());

        bodyVO[i].setVdef1(VOs[i].getVuserdefb1());
        bodyVO[i].setVdef2(VOs[i].getVuserdefb2());
        bodyVO[i].setVdef3(VOs[i].getVuserdefb3());
        bodyVO[i].setVdef4(VOs[i].getVuserdefb4());
        bodyVO[i].setVdef5(VOs[i].getVuserdefb5());
        bodyVO[i].setVdef6(VOs[i].getVuserdefb6());
        bodyVO[i].setVdef7(VOs[i].getVuserdefb7());
        bodyVO[i].setVdef8(VOs[i].getVuserdefb8());
        bodyVO[i].setVdef9(VOs[i].getVuserdefb9());
        bodyVO[i].setVdef10(VOs[i].getVuserdefb10());

        bodyVO[i].setVdef11(VOs[i].getVuserdefb11());
        bodyVO[i].setVdef12(VOs[i].getVuserdefb12());
        bodyVO[i].setVdef13(VOs[i].getVuserdefb13());
        bodyVO[i].setVdef14(VOs[i].getVuserdefb14());
        bodyVO[i].setVdef15(VOs[i].getVuserdefb15());
        bodyVO[i].setVdef16(VOs[i].getVuserdefb16());
        bodyVO[i].setVdef17(VOs[i].getVuserdefb17());
        bodyVO[i].setVdef18(VOs[i].getVuserdefb18());
        bodyVO[i].setVdef19(VOs[i].getVuserdefb19());
        bodyVO[i].setVdef20(VOs[i].getVuserdefb20());

        bodyVO[i].setPk_defdoc1(VOs[i].getPk_defdocb1());
        bodyVO[i].setPk_defdoc2(VOs[i].getPk_defdocb2());
        bodyVO[i].setPk_defdoc3(VOs[i].getPk_defdocb3());
        bodyVO[i].setPk_defdoc4(VOs[i].getPk_defdocb4());
        bodyVO[i].setPk_defdoc5(VOs[i].getPk_defdocb5());
        bodyVO[i].setPk_defdoc6(VOs[i].getPk_defdocb6());
        bodyVO[i].setPk_defdoc7(VOs[i].getPk_defdocb7());
        bodyVO[i].setPk_defdoc8(VOs[i].getPk_defdocb8());
        bodyVO[i].setPk_defdoc9(VOs[i].getPk_defdocb9());
        bodyVO[i].setPk_defdoc10(VOs[i].getPk_defdocb10());

        bodyVO[i].setPk_defdoc11(VOs[i].getPk_defdocb11());
        bodyVO[i].setPk_defdoc12(VOs[i].getPk_defdocb12());
        bodyVO[i].setPk_defdoc13(VOs[i].getPk_defdocb13());
        bodyVO[i].setPk_defdoc14(VOs[i].getPk_defdocb14());
        bodyVO[i].setPk_defdoc15(VOs[i].getPk_defdocb15());
        bodyVO[i].setPk_defdoc16(VOs[i].getPk_defdocb16());
        bodyVO[i].setPk_defdoc17(VOs[i].getPk_defdocb17());
        bodyVO[i].setPk_defdoc18(VOs[i].getPk_defdocb18());
        bodyVO[i].setPk_defdoc19(VOs[i].getPk_defdocb19());
        bodyVO[i].setPk_defdoc20(VOs[i].getPk_defdocb20());

        bodyVO[i].setDbizdate(VOs[i].getDbizdate());
        bodyVO[i].setCvendorid(VOs[i].getCvendorid());
      }

      // 设置存货表头VO所需的数据
      Vector vDistVo = new Vector();
      HashMap hDistKey = new HashMap();
      String strHid = null;
      for (int i = 0; i < iLen; i++) {
        if (VOs[i] == null) {
          continue;
        }
        strHid = VOs[i].getCgeneralhid();
        if (strHid == null || hDistKey.containsKey(strHid)) {
          continue;
        }
        vDistVo.addElement(VOs[i]);
        hDistKey.put(strHid, "");
      }
      hDistKey = null;
      int iRealCnt = vDistVo.size();
      IBillHeaderVO headVO[] = new IBillHeaderVO[iRealCnt];
      StockVO Vo = null;
      for (int i = 0; i < iRealCnt; i++) {
        headVO[i] = new IBillHeaderVO();
        Vo = (StockVO) vDistVo.elementAt(i);
        headVO[i].setPk_corp(Vo.getPk_corp());
        if (Vo.getCbilltype().trim().equals("47")) {
          headVO[i].setCbilltypecode("ID");
        }
        else {
          headVO[i].setCbilltypecode("I2");
        }
        headVO[i].setCbillid(Vo.getCgeneralhid());

        headVO[i].setDbilldate(dCurrDate);
        headVO[i].setCsourcemodulename("PO");
        headVO[i].setFdispatchflag(new Integer(0));
        String s = Vo.getCdispatcherid();
        if (s != null && s.length() > 0)
          headVO[i].setCdispatchid(Vo.getCdispatcherid());
        else
          headVO[i].setCdispatchid(null);

        headVO[i].setCbiztypeid(Vo.getCbiztype());
        headVO[i].setCstockrdcenterid(Vo.getCstoreorganization());
        // headVO[i].setCrdcenterid(Vo.getCstoreorganization());
        headVO[i].setCwarehouseid(Vo.getCwarehouseid());

        headVO[i].setCdeptid(Vo.getCdeptid());
        headVO[i].setCoperatorid(cOperator);
        headVO[i].setCcustomvendorid(Vo.getCprovidermangid());

        headVO[i].setVnote(Vo.getVnote());
        headVO[i].setBestimateflag(new UFBoolean(true));
        headVO[i].setCwarehousemanagerid(Vo.getCwhsmanagerid());
        headVO[i].setCemployeeid(Vo.getCbizid());

        headVO[i].setVbillcode(Vo.getVbillcode());
        headVO[i].setBwithdrawalflag(new UFBoolean(false));
        headVO[i].setBdisableflag(new UFBoolean(false));
        headVO[i].setBauditedflag(new UFBoolean(false));

        headVO[i].setVdef1(Vo.getVuserdefh1());
        headVO[i].setVdef2(Vo.getVuserdefh2());
        headVO[i].setVdef3(Vo.getVuserdefh3());
        headVO[i].setVdef4(Vo.getVuserdefh4());
        headVO[i].setVdef5(Vo.getVuserdefh5());
        headVO[i].setVdef6(Vo.getVuserdefh6());
        headVO[i].setVdef7(Vo.getVuserdefh7());
        headVO[i].setVdef8(Vo.getVuserdefh8());
        headVO[i].setVdef9(Vo.getVuserdefh9());
        headVO[i].setVdef10(Vo.getVuserdefh10());

        headVO[i].setVdef11(Vo.getVuserdefh11());
        headVO[i].setVdef12(Vo.getVuserdefh12());
        headVO[i].setVdef13(Vo.getVuserdefh13());
        headVO[i].setVdef14(Vo.getVuserdefh14());
        headVO[i].setVdef15(Vo.getVuserdefh15());
        headVO[i].setVdef16(Vo.getVuserdefh16());
        headVO[i].setVdef17(Vo.getVuserdefh17());
        headVO[i].setVdef18(Vo.getVuserdefh18());
        headVO[i].setVdef19(Vo.getVuserdefh19());
        headVO[i].setVdef20(Vo.getVuserdefh20());

        headVO[i].setPk_defdoc1(Vo.getPk_defdoch1());
        headVO[i].setPk_defdoc2(Vo.getPk_defdoch2());
        headVO[i].setPk_defdoc3(Vo.getPk_defdoch3());
        headVO[i].setPk_defdoc4(Vo.getPk_defdoch4());
        headVO[i].setPk_defdoc5(Vo.getPk_defdoch5());
        headVO[i].setPk_defdoc6(Vo.getPk_defdoch6());
        headVO[i].setPk_defdoc7(Vo.getPk_defdoch7());
        headVO[i].setPk_defdoc8(Vo.getPk_defdoch8());
        headVO[i].setPk_defdoc9(Vo.getPk_defdoch9());
        headVO[i].setPk_defdoc10(Vo.getPk_defdoch10());

        headVO[i].setPk_defdoc11(Vo.getPk_defdoch11());
        headVO[i].setPk_defdoc12(Vo.getPk_defdoch12());
        headVO[i].setPk_defdoc13(Vo.getPk_defdoch13());
        headVO[i].setPk_defdoc14(Vo.getPk_defdoch14());
        headVO[i].setPk_defdoc15(Vo.getPk_defdoch15());
        headVO[i].setPk_defdoc16(Vo.getPk_defdoch16());
        headVO[i].setPk_defdoc17(Vo.getPk_defdoch17());
        headVO[i].setPk_defdoc18(Vo.getPk_defdoch18());
        headVO[i].setPk_defdoc19(Vo.getPk_defdoch19());
        headVO[i].setPk_defdoc20(Vo.getPk_defdoch20());
      }

      // 组合存货的表头和表体VO
      billVO = new BillVO[headVO.length];
      for (int i = 0; i < billVO.length; i++) {
        billVO[i] = new BillVO();
        billVO[i].setParentVO(headVO[i]);

        Vector vTemp = new Vector();
        String s1 = headVO[i].getCbillid().trim();
        for (int j = 0; j < bodyVO.length; j++) {
          String s2 = bodyVO[j].getCbillid().trim();
          if (s1.equals(s2)) {
            bodyVO[j].setCbilltypecode(headVO[i].getCbilltypecode());
            if (headVO[i].getCbilltypecode().equals("ID")) {
              bodyVO[j].setCsourcebilltypecode("47");
            }
            vTemp.addElement(bodyVO[j]);
          }
        }
        IBillItemVO tempBodyVO[] = new IBillItemVO[vTemp.size()];
        vTemp.copyInto(tempBodyVO);

        billVO[i].setChildrenVO(tempBodyVO);
      }
    }
    catch (Exception e) {
      /* 调用采购公用方法按规范抛出异常 */
      nc.bs.pu.pub.PubDMO.throwBusinessException(e);
    }
    // 返回存货核算所需要的VO
    return billVO;
  }

  /**
   * 根据登录公司获取本位币金额精度,BD505
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * 
   * @param strLoginCorp
   * @return
   * @throws BusinessException
   *           <p>
   * @author czp
   * @time 2007-12-10 下午12:32:14
   */
  public int getLocalCurMnyDigit(String strLoginCorp) throws BusinessException {
    //
    int iMnyDigit = 2;
    PubImpl myPubService = new PubImpl();
    int nMnyDecimal[] = myPubService.getDigitBatch(strLoginCorp, new String[] {
      "BD301"
    });
    if (nMnyDecimal != null && nMnyDecimal.length >= 1) {
      iMnyDigit = nMnyDecimal[0];
    }
    //
    return iMnyDigit;
  }

  /**
   * 方法功能描述：对是第一次暂估运费结算的费用结算行 进行检查如存在该行的其他费用结算单 则含有该行的费用结算单不能被删除（保证对暂估运费的处理 即
   * 含有byffirstsettle=Y 的费用结算单必须在最后被删除）
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * 
   * @param settleRowList
   * @return
   * @throws BusinessException
   * @author zhanghongfang
   * @time 2008-7-30 上午10:12:15
   * @modify by zhaoyha at 2008.11.3
   * @modify by zhaoyha at 2008.12.4
   */
  public void checkDelSettleBill(ArrayList<String> settleRowList)
      throws BusinessException {
    HashMap settleInfor = null;

    if (settleRowList != null && settleRowList.size() > 0) {
      try {
        PubDMO pubDmo = new PubDMO();
        SettleDMO dmo = new SettleDMO();
        
        //查找第一次进行暂估费用的结算的入库单行和暂估的费用ID
        settleInfor = pubDmo.queryArrayValues(
            "po_settlebill_b a inner join ic_general_bb3 b on cstockrow=cgeneralbid",
            "a.csettlebill_bid", new String[] {"a.cstockrow","b.cfeeid"},
            settleRowList.toArray(new String[0]), 
            " a.dr=0 and a.byffirstsettle = 'Y' and b.dr=0");

        if (settleInfor != null && settleInfor.size() > 0) {
          // 存放byffirstsettle=y的入库行
          ArrayList<String> firstlist = new ArrayList<String>();
          // 存放暂估费用存货ID(结算单上第一次结算)
          ArrayList<String> feeIDs = new ArrayList<String>();
          Object[] obj = null;
          for (Object key : settleInfor.keySet()) {
            obj = (Object[]) settleInfor.get(key);
            if (obj[0] == null || obj[0].toString().trim().length() == 0
                || obj[1] == null || obj[1].toString().trim().length() == 0)
              // 过滤掉行ID或暂估费用ID为空的入库单行
              continue;
            firstlist.add(obj[0].toString().trim());
            feeIDs.add(obj[1].toString().trim());
          }
          if (firstlist.size() > 0) {
            settleInfor.clear();
            //拼接Where条件
            TempTableUtil tempTabUtil=new TempTableUtil();
            StringBuilder conditions=new StringBuilder();
            /**
              查找第一次费用结算后是否再进行过相同费用的结算
              在结算单子表中查询满足以下条件的行:
                1.结算单中的入库单行ID包含在已经查出的第一次费用结算列表(firstlist)中 且
                2.结算单行"运费是否第一次结算"标志为'N' 且
                3.结算单行ID不包含在本次删除的结算单行ID列表中 且
                4.结算单必须进行过相同的费用结算,即结算单头ID包含于有相同费用结算的结算单头ID列表中
             **/
            conditions.append(" dr=0 and byffirstsettle = 'N'");
            conditions.append(" and csettlebill_bid not in ");
            conditions.append(tempTabUtil.getSubSql(settleRowList));
            conditions.append(" and csettlebillid  in (");
            conditions.append("select csettlebillid from po_settlebill_b where dr=0 and cmangid in ");
            conditions.append(tempTabUtil.getSubSql(feeIDs));
            conditions.append(") ");
            settleInfor = pubDmo.queryArrayValues("po_settlebill_b",
                "cstockrow", 
                new String[] {"csettlebill_bid"},
                firstlist.toArray(new String[0]),
                conditions.toString()
                );
            if (settleInfor != null && settleInfor.size() > 0) {
              throw new BusinessException(nc.bs.ml.NCLangResOnserver
                  .getInstance().getStrByID("40040504", "UPP40040504-000025")/*
                   * @res
                   * "存在相关联的结算单，不能删除 "
                   */);
            }
          }
        }
      }
      catch (Exception e) {
        PubDMO.throwBusinessException(e);
      }
    }
  }
  
  /**
   * 
   * 方法功能描述：检查入库单中的仓库是否为非成本计算仓。
   * <p>如,分收集结业务,对跨公司的入库单,判断仓库是否为非成本计算仓(资产仓)
   * <p>如果是非成本仓,则不能结算
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * @param stockHeaderVOs
   * @throws Exception
   * <p>
   * @author zhaoyha
   * @time 2008-11-10 上午09:51:56
   */
  public void checkCalculateInvCost(GeneralBillHeaderVO[] stockHeaderVOs) throws Exception{
    //集采业务,对跨公司的入库单,判断仓库是否为非成本计算仓(资产仓)
    if(stockHeaderVOs==null || stockHeaderVOs.length==0) return;
    PubDMO pubDmo = new PubDMO();
    List<String> warehouseIDs=new ArrayList<String>();
    //保存headerVO<仓库ID,入库单头VO>
    Map<String,GeneralBillHeaderVO> mapHeaderVO=new HashMap<String,GeneralBillHeaderVO>();
    for(GeneralBillHeaderVO stockHvo:stockHeaderVOs){
      //生成仓库ID
      String warehouseID=stockHvo.getCwarehouseid();
      if(warehouseID!=null && warehouseID.length()>0){
        warehouseIDs.add(warehouseID);
        //保存headerVO
        mapHeaderVO.put(warehouseID, stockHvo);
      }
    }
    if(warehouseIDs.size()==0) return;
    //调用公用方法查询仓库信息
    Map storeInfo = pubDmo.queryArrayValues("bd_stordoc",
        "pk_stordoc", new String[] {
          "iscalculatedinvcost"
        }, warehouseIDs.toArray(new String[0]), " dr=0 ");
    //检查仓库是否为成本计算仓库
    StringBuilder errMsg=new StringBuilder();
    if(storeInfo!=null){
      for(Object o:storeInfo.entrySet()){
        Map.Entry entry=(Map.Entry)o;
        Object[] value=(Object[]) entry.getValue();
        if(value!=null && value.length>0 && value[0]!=null && 
            "N".equalsIgnoreCase(value[0].toString().trim())){
          errMsg.append(mapHeaderVO.get(entry.getKey()).getVbillcode()+"\r\n");
        }
      }
    }
    if(errMsg.length()>0){
      throw new BusinessException(NCLangResOnserver
          .getInstance().getStrByID("40040502", "UPP40040502-000238")
          /*"以下入库单中的仓库为非成本计算仓，不能进行结算："*/+"\r\n"+errMsg.toString());
    } 
  }
  
  /**
   *获取费用类发票的供应商ID[]{基本ID、管理ID}
   */
  private String[] getVendorId(
      FeeinvoiceVO feeVOs[], 
      FeeinvoiceVO discountVOs[],
      FeeinvoiceVO specialVOs[]) throws BusinessException{
    if((feeVOs == null || feeVOs.length == 0)
        && (discountVOs == null || discountVOs.length == 0)
        && (specialVOs == null || specialVOs.length == 0)){
      return null;
    }
    ArrayList<String> listBid = new ArrayList<String>();
    if(feeVOs != null && feeVOs.length > 0){
      for(int i=0; i<feeVOs.length; i++){
        listBid.add(feeVOs[i].getCinvoiceid());
      }
    }
    if(discountVOs != null && discountVOs.length > 0){
      for(int i=0; i<feeVOs.length; i++){
        listBid.add(discountVOs[i].getCinvoiceid());
      }
    }
    if(specialVOs != null && specialVOs.length > 0){
      for(int i=0; i<feeVOs.length; i++){
        listBid.add(specialVOs[i].getCinvoiceid());
      }
    }
    String[] saRet = null;
    try{
      Object[][] oa2Ret = new PubDMO().queryArrayValue(
        "po_invoice", 
        "cinvoiceid", 
        new String[]{"dinvoicedate", "cinvoiceid", "cvendorbaseid", "cvendormangid"},
        listBid.toArray(new String[listBid.size()])
        );
      if(oa2Ret == null || oa2Ret.length == 0){
        return null;
      }
      saRet = new String[2];
      UFDate ufdBase = PuPubVO.getUFDate(oa2Ret[0][0]);
      String strHidBase = (String) oa2Ret[0][1];
      UFDate ufdCurr = null;
      String strHidCurr = null;
      saRet[0] = (String) oa2Ret[0][2];
      saRet[1] = (String) oa2Ret[0][3];
      for(int i=1; i<oa2Ret.length; i++){
        ufdCurr = PuPubVO.getUFDate(oa2Ret[i][0]);
        strHidCurr = (String) oa2Ret[i][1];
        //取发票日期较大者，如果发票日期相同，取后生成的发票
        if(ufdCurr.compareTo(ufdBase) > 0
            || (ufdCurr.compareTo(ufdBase) == 0 && strHidCurr.compareTo(strHidBase) > 0)){
          saRet[0] = (String) oa2Ret[i][2];
          saRet[1] = (String) oa2Ret[i][3];
          ufdBase = ufdCurr;
          strHidBase = strHidCurr;
        }
      }
    }catch(Exception e){
      PubDMO.throwBusinessException(e);
    }
    return saRet;
    
  }
  
  /**
   * 
   * 方法功能描述：根据红兰对冲后的结果（标志），得到可参与自动结算的入库单或发票VO。
   * <p>
   * <b>examples:</b>
   * <p>
   * 使用示例
   * <p>
   * <b>参数说明</b>
   * @param <T>
   * @param attendRBFlag  是否已经参与红兰对冲标志数组
   * @param allVos  所有查询到的入库单或发票VO数组
   * @return  可参与自动结算的入库单或发票VO数组
   * <p>
   * @author zhaoyha
   * @time 2009-10-14 下午02:29:36
   */
  private <T extends CircularlyAccessibleValueObject> T[] getAutoSettleVO(
      boolean[] attendRBFlag,T[] allVos){
    List<T> settleVos=new ArrayList<T>();
    for(int i=0;i<allVos.length;++i)
      if(!attendRBFlag[i]) settleVos.add(allVos[i]);
    if(0==settleVos.size()) return null;
    return  new ListToArrayTool<T>().convertToArray(settleVos);
  }
  
  
  /*
   * add by ouyangzhb  2011-07-06
   * 获取要结算的发票
   */
  public InvoiceVO[] getInvoiceVO(IinvoiceVO[] vos){
	  
	  IUAPQueryBS iService = (IUAPQueryBS) NCLocator.getInstance().lookup(
				IUAPQueryBS.class.getName());
	  
	  ArrayList<InvoiceVO> volist = new  ArrayList<InvoiceVO>();
	  ArrayList hids = new ArrayList();
	  ArrayList bids = new ArrayList();
	  for(int i=0;i<vos.length;i++){
		  hids.add(vos[i].getCinvoiceid());
		  bids.add(vos[i].getCinvoice_bid());
	  }
	  String inHids = SQLUtil.formInSQL("cinvoiceid", hids);
	  String inBids = SQLUtil.formInSQL("cinvoice_bid", bids);
	  try {
		InvoiceDMO idom = new InvoiceDMO();
		String hsql = "select * from po_invoice  where dr=0 "+inHids ;
		ArrayList<InvoiceHeaderVO> hvolist = new ArrayList<InvoiceHeaderVO>();
		   hvolist = (ArrayList<InvoiceHeaderVO>) iService
			.executeQuery(hsql, new BeanListProcessor(
					InvoiceHeaderVO.class));
		
		String bsql = "select * from po_invoice_b  where dr=0 "+inBids ;
		ArrayList<InvoiceItemVO> childvolist = new ArrayList<InvoiceItemVO>();
		   childvolist = (ArrayList<InvoiceItemVO>) iService
			.executeQuery(bsql, new BeanListProcessor(
					InvoiceItemVO.class));
		
		
		for(int a=0;a<hvolist.size();a++ ){
			ArrayList<InvoiceItemVO> bvolist = new ArrayList<InvoiceItemVO>();
			InvoiceVO vo = new InvoiceVO();
			String cinvoiceid = hvolist.get(a).getCinvoiceid();
			vo.setParentVO(hvolist.get(a));
			for(int b=0;b<childvolist.size();b++){
				String bcinvoiceid = childvolist.get(b).getCinvoiceid();
				if(bcinvoiceid!=null&&bcinvoiceid.equals(cinvoiceid)){
					bvolist.add(childvolist.get(b));
				}
			}
			if(bvolist!=null&&bvolist.size()>0){
				InvoiceItemVO[] childvo = new InvoiceItemVO[bvolist.size()];
				bvolist.toArray(childvo);
				vo.setChildrenVO(childvo);
				volist.add(vo);
			}
			
		}
		 
	} catch (SystemException e) {
		e.printStackTrace();
	} catch (NamingException e) {
		e.printStackTrace();
	} catch (BusinessException e) {
		e.printStackTrace();
	}
	 
	  if(volist!=null&&volist.size()>0){
		  InvoiceVO[] invoicevos = new InvoiceVO[volist.size()];
		  volist.toArray(invoicevos);
		  return invoicevos;
	  }else{
		  return null;
	  }
	  
  }
  
 
  
}
